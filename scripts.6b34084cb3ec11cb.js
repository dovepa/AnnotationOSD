function OpenSeadragon(n){return new OpenSeadragon.Viewer(n)}(function(n){n.version={versionStr:"4.0.0",major:parseInt("4",10),minor:parseInt("0",10),revision:parseInt("0",10)};var e,t={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},s=Object.prototype.toString,a=Object.prototype.hasOwnProperty;n.isFunction=function(r){return"function"===n.type(r)},n.isArray=Array.isArray||function(r){return"array"===n.type(r)},n.isWindow=function(r){return r&&"object"==typeof r&&"setInterval"in r},n.type=function(r){return null==r?String(r):t[s.call(r)]||"object"},n.isPlainObject=function(r){if(!r||"object"!==OpenSeadragon.type(r)||r.nodeType||n.isWindow(r)||r.constructor&&!a.call(r,"constructor")&&!a.call(r.constructor.prototype,"isPrototypeOf"))return!1;var i;for(var o in r)i=o;return void 0===i||a.call(r,i)},n.isEmptyObject=function(r){for(var i in r)return!1;return!0},n.freezeObject=function(r){return n.freezeObject=Object.freeze?Object.freeze:function(i){return i},n.freezeObject(r)},n.supportsCanvas=(e=document.createElement("canvas"),!(!n.isFunction(e.getContext)||!e.getContext("2d"))),n.isCanvasTainted=function(r){var i=!1;try{r.getContext("2d").getImageData(0,0,1,1)}catch(o){i=!0}return i},n.supportsAddEventListener=!(!document.documentElement.addEventListener||!document.addEventListener),n.supportsRemoveEventListener=!(!document.documentElement.removeEventListener||!document.removeEventListener),n.supportsEventListenerOptions=function(){var r=0;if(n.supportsAddEventListener)try{var i={get capture(){return r++,!1},get once(){return r++,!1},get passive(){return r++,!1}};window.addEventListener("test",null,i),window.removeEventListener("test",null,i)}catch(o){r=0}return 3<=r}(),n.getCurrentPixelDensityRatio=function(){if(n.supportsCanvas){var r=document.createElement("canvas").getContext("2d"),i=window.devicePixelRatio||1;return r=r.webkitBackingStorePixelRatio||r.mozBackingStorePixelRatio||r.msBackingStorePixelRatio||r.oBackingStorePixelRatio||r.backingStorePixelRatio||1,Math.max(i,1)/r}return 1},n.pixelDensityRatio=n.getCurrentPixelDensityRatio()})(OpenSeadragon),function(n){function t(r){}n.extend=function(){var r,i,o,h,l,c=arguments[0]||{},u=arguments.length,d=!1,g=1;for("boolean"==typeof c&&(d=c,c=arguments[1]||{},g=2),"object"==typeof c||OpenSeadragon.isFunction(c)||(c={}),u===g&&(c=this,--g);g<u;g++)if(null!==(r=arguments[g])||void 0!==r)for(i in r){var v=Object.getOwnPropertyDescriptor(r,i);void 0!==v?v.get||v.set?Object.defineProperty(c,i,v):c!==(o=v.value)&&(d&&o&&(OpenSeadragon.isPlainObject(o)||(h=OpenSeadragon.isArray(o)))?(v=c[i],h?(h=!1,l=v&&OpenSeadragon.isArray(v)?v:[]):l=v&&OpenSeadragon.isPlainObject(v)?v:{},c[i]=OpenSeadragon.extend(d,l,o)):void 0!==o&&(c[i]=o)):n.console.warn('Could not copy inherited property "'+i+'".')}return c},n.extend(n,{DEFAULT_SETTINGS:{xmlPath:null,tileSources:null,tileHost:null,initialPage:0,crossOriginPolicy:!1,ajaxWithCredentials:!1,loadTilesWithAjax:!1,ajaxHeaders:{},splitHashDataForPost:!1,panHorizontal:!0,panVertical:!0,constrainDuringPan:!1,wrapHorizontal:!1,wrapVertical:!1,visibilityRatio:.5,minPixelRatio:.5,defaultZoomLevel:0,minZoomLevel:null,maxZoomLevel:null,homeFillsViewer:!1,clickTimeThreshold:300,clickDistThreshold:5,dblClickTimeThreshold:300,dblClickDistThreshold:20,springStiffness:6.5,animationTime:1.2,gestureSettingsMouse:{dragToPan:!0,scrollToZoom:!0,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsTouch:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsPen:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsUnknown:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!1,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},zoomPerClick:2,zoomPerScroll:1.2,zoomPerDblClickDrag:1.2,zoomPerSecond:1,blendTime:0,alwaysBlend:!1,autoHideControls:!0,immediateRender:!1,minZoomImageRatio:.9,maxZoomPixelRatio:1.1,smoothTileEdgesMinZoom:1.1,iOSDevice:function(){if("object"!=typeof navigator)return!1;var r=navigator.userAgent;return"string"==typeof r&&(-1!==r.indexOf("iPhone")||-1!==r.indexOf("iPad")||-1!==r.indexOf("iPod"))}(),pixelsPerWheelLine:40,pixelsPerArrowPress:40,autoResize:!0,preserveImageSizeOnResize:!1,minScrollDeltaTime:50,rotationIncrement:90,showSequenceControl:!0,sequenceControlAnchor:null,preserveViewport:!1,preserveOverlays:!1,navPrevNextWrap:!1,showNavigationControl:!0,navigationControlAnchor:null,showZoomControl:!0,showHomeControl:!0,showFullPageControl:!0,showRotationControl:!1,showFlipControl:!1,controlsFadeDelay:2e3,controlsFadeLength:1500,mouseNavEnabled:!0,showNavigator:!1,navigatorElement:null,navigatorId:null,navigatorPosition:null,navigatorSizeRatio:.2,navigatorMaintainSizeRatio:!1,navigatorTop:null,navigatorLeft:null,navigatorHeight:null,navigatorWidth:null,navigatorAutoResize:!0,navigatorAutoFade:!0,navigatorRotate:!0,navigatorBackground:"#000",navigatorOpacity:.8,navigatorBorderColor:"#555",navigatorDisplayRegionColor:"#900",degrees:0,flipped:!1,opacity:1,preload:!1,compositeOperation:null,imageSmoothingEnabled:!0,placeholderFillStyle:null,subPixelRoundingForTransparency:null,showReferenceStrip:!1,referenceStripScroll:"horizontal",referenceStripElement:null,referenceStripHeight:null,referenceStripWidth:null,referenceStripPosition:"BOTTOM_LEFT",referenceStripSizeRatio:.2,collectionRows:3,collectionColumns:0,collectionLayout:"horizontal",collectionMode:!1,collectionTileSize:800,collectionTileMargin:80,imageLoaderLimit:0,maxImageCacheCount:200,timeout:3e4,useCanvas:!0,prefixUrl:"/images/",navImages:{zoomIn:{REST:"zoomin_rest.png",GROUP:"zoomin_grouphover.png",HOVER:"zoomin_hover.png",DOWN:"zoomin_pressed.png"},zoomOut:{REST:"zoomout_rest.png",GROUP:"zoomout_grouphover.png",HOVER:"zoomout_hover.png",DOWN:"zoomout_pressed.png"},home:{REST:"home_rest.png",GROUP:"home_grouphover.png",HOVER:"home_hover.png",DOWN:"home_pressed.png"},fullpage:{REST:"fullpage_rest.png",GROUP:"fullpage_grouphover.png",HOVER:"fullpage_hover.png",DOWN:"fullpage_pressed.png"},rotateleft:{REST:"rotateleft_rest.png",GROUP:"rotateleft_grouphover.png",HOVER:"rotateleft_hover.png",DOWN:"rotateleft_pressed.png"},rotateright:{REST:"rotateright_rest.png",GROUP:"rotateright_grouphover.png",HOVER:"rotateright_hover.png",DOWN:"rotateright_pressed.png"},flip:{REST:"flip_rest.png",GROUP:"flip_grouphover.png",HOVER:"flip_hover.png",DOWN:"flip_pressed.png"},previous:{REST:"previous_rest.png",GROUP:"previous_grouphover.png",HOVER:"previous_hover.png",DOWN:"previous_pressed.png"},next:{REST:"next_rest.png",GROUP:"next_grouphover.png",HOVER:"next_hover.png",DOWN:"next_pressed.png"}},debugMode:!1,debugGridColor:["#437AB2","#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E","#E6AB02","#A6761D","#666666"],silenceMultiImageWarnings:!1},SIGNAL:"----seadragon----",delegate:function(r,i){return function(){var o=arguments;return i.apply(r,o=void 0===o?[]:o)}},BROWSERS:{UNKNOWN:0,IE:1,FIREFOX:2,SAFARI:3,CHROME:4,OPERA:5,EDGE:6,CHROMEEDGE:7},SUBPIXEL_ROUNDING_OCCURRENCES:{NEVER:0,ONLY_AT_REST:1,ALWAYS:2},_viewers:new Map,getViewer:function(r){return n._viewers.get(this.getElement(r))},getElement:function(r){return"string"==typeof r?document.getElementById(r):r},getElementPosition:function(r){var i,o,h=new n.Point;for(o=e(r=n.getElement(r),i="fixed"===n.getElementStyle(r).position);o;)h.x+=r.offsetLeft,h.y+=r.offsetTop,i&&(h=h.plus(n.getPageScroll())),o=e(r=o,i="fixed"===n.getElementStyle(r).position);return h},getElementOffset:function(r){var i,o=(r=n.getElement(r))&&r.ownerDocument,h={top:0,left:0};return o?(i=o.documentElement,void 0!==r.getBoundingClientRect&&(h=r.getBoundingClientRect()),new n.Point(h.left+((o=o===o.window?o:9===o.nodeType&&(o.defaultView||o.parentWindow)).pageXOffset||i.scrollLeft)-(i.clientLeft||0),h.top+(o.pageYOffset||i.scrollTop)-(i.clientTop||0))):new n.Point},getElementSize:function(r){return r=n.getElement(r),new n.Point(r.clientWidth,r.clientHeight)},getElementStyle:document.documentElement.currentStyle?function(r){return(r=n.getElement(r)).currentStyle}:function(r){return r=n.getElement(r),window.getComputedStyle(r,"")},getCssPropertyWithVendorPrefix:function(r){var i={};return n.getCssPropertyWithVendorPrefix=function(o){if(void 0!==i[o])return i[o];var h=document.createElement("div").style,l=null;if(void 0!==h[o])l=o;else for(var c=["Webkit","Moz","MS","O","webkit","moz","ms","o"],u=n.capitalizeFirstLetter(o),d=0;d<c.length;d++){var g=c[d]+u;if(void 0!==h[g]){l=g;break}}return i[o]=l},n.getCssPropertyWithVendorPrefix(r)},capitalizeFirstLetter:function(r){return r.charAt(0).toUpperCase()+r.slice(1)},positiveModulo:function(r,i){return(r%=i)<0&&(r+=i),r},pointInElement:function(h,i){h=n.getElement(h);var o=n.getElementOffset(h);return h=n.getElementSize(h),i.x>=o.x&&i.x<o.x+h.x&&i.y<o.y+h.y&&i.y>=o.y},getMousePosition:function(r){if("number"==typeof r.pageX)n.getMousePosition=function(i){var o=new n.Point;return o.x=i.pageX,o.y=i.pageY,o};else{if("number"!=typeof r.clientX)throw new Error("Unknown event mouse position, no known technique.");n.getMousePosition=function(i){var o=new n.Point;return o.x=i.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,o.y=i.clientY+document.body.scrollTop+document.documentElement.scrollTop,o}}return n.getMousePosition(r)},getPageScroll:function(){var r=document.documentElement||{},i=document.body||{};if("number"==typeof window.pageXOffset)n.getPageScroll=function(){return new n.Point(window.pageXOffset,window.pageYOffset)};else if(i.scrollLeft||i.scrollTop)n.getPageScroll=function(){return new n.Point(document.body.scrollLeft,document.body.scrollTop)};else{if(!r.scrollLeft&&!r.scrollTop)return new n.Point(0,0);n.getPageScroll=function(){return new n.Point(document.documentElement.scrollLeft,document.documentElement.scrollTop)}}return n.getPageScroll()},setPageScroll:function(r){if(void 0!==window.scrollTo)n.setPageScroll=function(h){window.scrollTo(h.x,h.y)};else{var i=n.getPageScroll();if(i.x===r.x&&i.y===r.y)return;document.body.scrollLeft=r.x,document.body.scrollTop=r.y;var o=n.getPageScroll();if(o.x!==i.x&&o.y!==i.y)return void(n.setPageScroll=function(h){document.body.scrollLeft=h.x,document.body.scrollTop=h.y});if(document.documentElement.scrollLeft=r.x,document.documentElement.scrollTop=r.y,(o=n.getPageScroll()).x!==i.x&&o.y!==i.y)return void(n.setPageScroll=function(h){document.documentElement.scrollLeft=h.x,document.documentElement.scrollTop=h.y});n.setPageScroll=function(h){}}n.setPageScroll(r)},getWindowSize:function(){var r=document.documentElement||{},i=document.body||{};if("number"==typeof window.innerWidth)n.getWindowSize=function(){return new n.Point(window.innerWidth,window.innerHeight)};else if(r.clientWidth||r.clientHeight)n.getWindowSize=function(){return new n.Point(document.documentElement.clientWidth,document.documentElement.clientHeight)};else{if(!i.clientWidth&&!i.clientHeight)throw new Error("Unknown window size, no known technique.");n.getWindowSize=function(){return new n.Point(document.body.clientWidth,document.body.clientHeight)}}return n.getWindowSize()},makeCenteredNode:function(r){r=n.getElement(r);var i=[n.makeNeutralElement("div"),n.makeNeutralElement("div"),n.makeNeutralElement("div")];return n.extend(i[0].style,{display:"table",height:"100%",width:"100%"}),n.extend(i[1].style,{display:"table-row"}),n.extend(i[2].style,{display:"table-cell",verticalAlign:"middle",textAlign:"center"}),i[0].appendChild(i[1]),i[1].appendChild(i[2]),i[2].appendChild(r),i[0]},makeNeutralElement:function(o){var i=document.createElement(o);return(o=i.style).background="transparent none",o.border="none",o.margin="0px",o.padding="0px",o.position="static",i},now:function(){return n.now=Date.now?Date.now:function(){return(new Date).getTime()},n.now()},makeTransparentImage:function(r){var i=n.makeNeutralElement("img");return i.src=r,i},setElementOpacity:function(r,i,o){r=n.getElement(r),o&&!n.Browser.alpha&&(i=Math.round(i)),n.Browser.opacity?r.style.opacity=i<1?i:"":i<1?(i=Math.round(100*i),r.style.filter="alpha(opacity="+i+")"):r.style.filter=""},setElementTouchActionNone:function(r){void 0!==(r=n.getElement(r)).style.touchAction?r.style.touchAction="none":void 0!==r.style.msTouchAction&&(r.style.msTouchAction="none")},setElementPointerEvents:function(r,i){void 0!==(r=n.getElement(r)).style&&void 0!==r.style.pointerEvents&&(r.style.pointerEvents=i)},setElementPointerEventsNone:function(r){n.setElementPointerEvents(r,"none")},addClass:function(r,i){(r=n.getElement(r)).className?-1===(" "+r.className+" ").indexOf(" "+i+" ")&&(r.className+=" "+i):r.className=i},indexOf:function(r,i,o){return this.indexOf=Array.prototype.indexOf?function(h,l,c){return h.indexOf(l,c)}:function(h,l,g){var u,d;if(g=g||0,!h)throw new TypeError;if(0===(d=h.length)||d<=g)return-1;for(u=g=g<0?d-Math.abs(g):g;u<d;u++)if(h[u]===l)return u;return-1},this.indexOf(r,i,o)},removeClass:function(r,i){var o,h,l=[];for(o=(r=n.getElement(r)).className.split(/\s+/),h=0;h<o.length;h++)o[h]&&o[h]!==i&&l.push(o[h]);r.className=l.join(" ")},normalizeEventListenerOptions:function(r){return void 0!==r?"boolean"==typeof r?n.supportsEventListenerOptions?{capture:r}:r:n.supportsEventListenerOptions?r:void 0!==r.capture&&r.capture:!!n.supportsEventListenerOptions&&{capture:!1}},addEvent:function(){if(n.supportsAddEventListener)return function(r,i,o,h){h=n.normalizeEventListenerOptions(h),(r=n.getElement(r)).addEventListener(i,o,h)};if(document.documentElement.attachEvent&&document.attachEvent)return function(r,i,o){(r=n.getElement(r)).attachEvent("on"+i,o)};throw new Error("No known event model.")}(),removeEvent:function(){if(n.supportsRemoveEventListener)return function(r,i,o,h){h=n.normalizeEventListenerOptions(h),(r=n.getElement(r)).removeEventListener(i,o,h)};if(document.documentElement.detachEvent&&document.detachEvent)return function(r,i,o){(r=n.getElement(r)).detachEvent("on"+i,o)};throw new Error("No known event model.")}(),cancelEvent:function(r){r.preventDefault()},eventIsCanceled:function(r){return r.defaultPrevented},stopEvent:function(r){r.stopPropagation()},createCallback:function(r,i){var o,h=[];for(o=2;o<arguments.length;o++)h.push(arguments[o]);return function(){var l,c=h.concat([]);for(l=0;l<arguments.length;l++)c.push(arguments[l]);return i.apply(r,c)}},getUrlParameter:function(r){return(r=a[r])||null},getUrlProtocol:function(r){return null===(r=r.match(/^([a-z]+:)\/\//i))?window.location.protocol:r[1].toLowerCase()},createAjaxRequest:function(r){var i;try{i=!!new ActiveXObject("Microsoft.XMLHTTP")}catch(o){i=!1}if(i)n.createAjaxRequest=window.XMLHttpRequest?function(o){return o?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")};else{if(!window.XMLHttpRequest)throw new Error("Browser doesn't support XMLHttpRequest.");n.createAjaxRequest=function(){return new XMLHttpRequest}}return n.createAjaxRequest(r)},makeAjaxRequest:function(r,i,o){var h,l,c,u;n.isPlainObject(r)&&(i=r.success,o=r.error,h=r.withCredentials,l=r.headers,c=r.responseType||null,u=r.postData||null,r=r.url);var d=n.getUrlProtocol(r),g=n.createAjaxRequest("file:"===d);if(!n.isFunction(i))throw new Error("makeAjaxRequest requires a success callback");g.onreadystatechange=function(){4===g.readyState&&(g.onreadystatechange=function(){},200<=g.status&&g.status<300||0===g.status&&"http:"!==d&&"https:"!==d?i(g):n.isFunction(o)?o(g):n.console.error("AJAX request returned %d: %s",g.status,r))};var v=u?"POST":"GET";try{if(g.open(v,r,!0),c&&(g.responseType=c),l)for(var w in l)Object.prototype.hasOwnProperty.call(l,w)&&l[w]&&g.setRequestHeader(w,l[w]);h&&(g.withCredentials=!0),g.send(u)}catch(T){n.console.error("%s while making AJAX request: %s",T.name,T.message),g.onreadystatechange=function(){},n.isFunction(o)&&o(g,T)}return g},jsonp:function(r){var i,o=r.url,h=document.head||document.getElementsByTagName("head")[0]||document.documentElement,l=r.callbackName||"openseadragon"+n.now(),c=window[l],u=r.param||"callback",d=r.callback;o=o.replace(/(=)\?(&|$)|\?\?/i,"$1"+l+"$2"),o+=(/\?/.test(o)?"&":"?")+u+"="+l,window[l]=function(g){if(c)window[l]=c;else try{delete window[l]}catch(v){}d&&n.isFunction(d)&&d(g)},i=document.createElement("script"),void 0===r.async&&!1===r.async||(i.async="async"),r.scriptCharset&&(i.charset=r.scriptCharset),i.src=o,i.onload=i.onreadystatechange=function(g,v){(v||!i.readyState||/loaded|complete/.test(i.readyState))&&(i.onload=i.onreadystatechange=null,h&&i.parentNode&&h.removeChild(i),i=void 0)},h.insertBefore(i,h.firstChild)},createFromDZI:function(){throw"OpenSeadragon.createFromDZI is deprecated, use Viewer.open."},parseXml:function(r){if(window.DOMParser)n.parseXml=function(i){return(new DOMParser).parseFromString(i,"text/xml")};else{if(!window.ActiveXObject)throw new Error("Browser doesn't support XML DOM.");n.parseXml=function(i){var o=null;return(o=new ActiveXObject("Microsoft.XMLDOM")).async=!1,o.loadXML(i),o}}return n.parseXml(r)},parseJSON:function(r){return n.parseJSON=window.JSON.parse,n.parseJSON(r)},imageFormatSupported:function(r){return!!s[(r=r||"").toLowerCase()]},setImageFormatsSupported:function(r){n.extend(s,r)}}),n.console=window.console||{log:t,debug:t,info:t,warn:t,error:t,assert:t};var s={bmp:!(n.Browser={vendor:n.BROWSERS.UNKNOWN,version:0,alpha:!0}),jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1},a={};function e(r,i){return i&&r!==document.body?document.body:r.offsetParent}(function(){var r=navigator.appVersion,i=navigator.userAgent;switch(navigator.appName){case"Microsoft Internet Explorer":window.attachEvent&&window.ActiveXObject&&(n.Browser.vendor=n.BROWSERS.IE,n.Browser.version=parseFloat(i.substring(i.indexOf("MSIE")+5,i.indexOf(";",i.indexOf("MSIE")))));break;case"Netscape":window.addEventListener&&(0<=i.indexOf("Edge")?(n.Browser.vendor=n.BROWSERS.EDGE,n.Browser.version=parseFloat(i.substring(i.indexOf("Edge")+5))):0<=i.indexOf("Edg")?(n.Browser.vendor=n.BROWSERS.CHROMEEDGE,n.Browser.version=parseFloat(i.substring(i.indexOf("Edg")+4))):0<=i.indexOf("Firefox")?(n.Browser.vendor=n.BROWSERS.FIREFOX,n.Browser.version=parseFloat(i.substring(i.indexOf("Firefox")+8))):0<=i.indexOf("Safari")?(n.Browser.vendor=0<=i.indexOf("Chrome")?n.BROWSERS.CHROME:n.BROWSERS.SAFARI,n.Browser.version=parseFloat(i.substring(i.substring(0,i.indexOf("Safari")).lastIndexOf("/")+1,i.indexOf("Safari")))):null!==new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(i)&&(n.Browser.vendor=n.BROWSERS.IE,n.Browser.version=parseFloat(RegExp.$1)));break;case"Opera":n.Browser.vendor=n.BROWSERS.OPERA,n.Browser.version=parseFloat(r)}var o,h,l=window.location.search.substring(1).split("&");for(h=0;h<l.length;h++)if(0<(u=(o=l[h]).indexOf("="))){var c=o.substring(0,u),u=o.substring(u+1);try{a[c]=decodeURIComponent(u)}catch(d){n.console.error("Ignoring malformed URL parameter: %s=%s",c,u)}}n.Browser.alpha=!(n.Browser.vendor===n.BROWSERS.CHROME&&n.Browser.version<2),n.Browser.opacity=!0,n.Browser.vendor===n.BROWSERS.IE&&n.Browser.version<11&&n.console.error("Internet Explorer versions < 11 are not supported by OpenSeadragon")})(),function(r){var i=r.requestAnimationFrame||r.mozRequestAnimationFrame||r.webkitRequestAnimationFrame||r.msRequestAnimationFrame,o=r.cancelAnimationFrame||r.mozCancelAnimationFrame||r.webkitCancelAnimationFrame||r.msCancelAnimationFrame;if(i&&o)n.requestAnimationFrame=function(){return i.apply(r,arguments)},n.cancelAnimationFrame=function(){return o.apply(r,arguments)};else{var h,l=[],c=[],u=0;n.requestAnimationFrame=function(d){return l.push([++u,d]),h=h||setInterval(function(){if(l.length){var g=n.now(),v=c;for(c=l,l=v;c.length;)c.shift()[1](g)}else clearInterval(h),h=void 0},20),u},n.cancelAnimationFrame=function(d){var g,v;for(g=0,v=l.length;g<v;g+=1)if(l[g][0]===d)return void l.splice(g,1);for(g=0,v=c.length;g<v;g+=1)if(c[g][0]===d)return void c.splice(g,1)}}}(window)}(OpenSeadragon),function(n,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():n.OpenSeadragon=t()}(this,function(){return OpenSeadragon}),function(n){var t={supportsFullScreen:!1,isFullScreen:function(){return!1},getFullScreenElement:function(){return null},requestFullScreen:function(){},exitFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",fullScreenErrorEventName:""};document.exitFullscreen?(t.supportsFullScreen=!0,t.getFullScreenElement=function(){return document.fullscreenElement},t.requestFullScreen=function(s){return s.requestFullscreen()},t.exitFullScreen=function(){document.exitFullscreen()},t.fullScreenEventName="fullscreenchange",t.fullScreenErrorEventName="fullscreenerror"):document.msExitFullscreen?(t.supportsFullScreen=!0,t.getFullScreenElement=function(){return document.msFullscreenElement},t.requestFullScreen=function(s){return s.msRequestFullscreen()},t.exitFullScreen=function(){document.msExitFullscreen()},t.fullScreenEventName="MSFullscreenChange",t.fullScreenErrorEventName="MSFullscreenError"):document.webkitExitFullscreen?(t.supportsFullScreen=!0,t.getFullScreenElement=function(){return document.webkitFullscreenElement},t.requestFullScreen=function(s){return s.webkitRequestFullscreen()},t.exitFullScreen=function(){document.webkitExitFullscreen()},t.fullScreenEventName="webkitfullscreenchange",t.fullScreenErrorEventName="webkitfullscreenerror"):document.webkitCancelFullScreen?(t.supportsFullScreen=!0,t.getFullScreenElement=function(){return document.webkitCurrentFullScreenElement},t.requestFullScreen=function(s){return s.webkitRequestFullScreen()},t.exitFullScreen=function(){document.webkitCancelFullScreen()},t.fullScreenEventName="webkitfullscreenchange",t.fullScreenErrorEventName="webkitfullscreenerror"):document.mozCancelFullScreen&&(t.supportsFullScreen=!0,t.getFullScreenElement=function(){return document.mozFullScreenElement},t.requestFullScreen=function(s){return s.mozRequestFullScreen()},t.exitFullScreen=function(){document.mozCancelFullScreen()},t.fullScreenEventName="mozfullscreenchange",t.fullScreenErrorEventName="mozfullscreenerror"),t.isFullScreen=function(){return null!==t.getFullScreenElement()},t.cancelFullScreen=function(){n.console.error("cancelFullScreen is deprecated. Use exitFullScreen instead."),t.exitFullScreen()},n.extend(n,t)}(OpenSeadragon),function(n){n.EventSource=function(){this.events={}},n.EventSource.prototype={addOnceHandler:function(t,s,a,e){var r=this;e=e||1;var i=0;this.addHandler(t,function o(h){++i===e&&r.removeHandler(t,o),s(h)},a)},addHandler:function(t,s,a){var e=this.events[t];e||(this.events[t]=e=[]),s&&n.isFunction(s)&&(e[e.length]={handler:s,userData:a||null})},removeHandler:function(t,s){var a,e=this.events[t],r=[];if(e&&n.isArray(e)){for(a=0;a<e.length;a++)e[a].handler!==s&&r.push(e[a]);this.events[t]=r}},numberOfHandlers:function(t){return(t=this.events[t])?t.length:0},removeAllHandlers:function(t){if(t)this.events[t]=[];else for(var s in this.events)this.events[s]=[]},getHandler:function(t){var s=this.events[t];return s&&s.length?(s=1===s.length?[s[0]]:Array.apply(null,s),function(a,e){var r,i=s.length;for(r=0;r<i;r++)s[r]&&(e.eventSource=a,e.userData=s[r].userData,s[r].handler(e))}):null},raiseEvent:function(t,s){(t=this.getHandler(t))&&t(this,s=s||{})}}}(OpenSeadragon),function(n){var t=[],s={};n.MouseTracker=function(y){t.push(this);var f=arguments;n.isPlainObject(y)||(y={element:f[0],clickTimeThreshold:f[1],clickDistThreshold:f[2]}),this.hash=Math.random(),this.element=n.getElement(y.element),this.clickTimeThreshold=y.clickTimeThreshold||n.DEFAULT_SETTINGS.clickTimeThreshold,this.clickDistThreshold=y.clickDistThreshold||n.DEFAULT_SETTINGS.clickDistThreshold,this.dblClickTimeThreshold=y.dblClickTimeThreshold||n.DEFAULT_SETTINGS.dblClickTimeThreshold,this.dblClickDistThreshold=y.dblClickDistThreshold||n.DEFAULT_SETTINGS.dblClickDistThreshold,this.userData=y.userData||null,this.stopDelay=y.stopDelay||50,this.preProcessEventHandler=y.preProcessEventHandler||null,this.contextMenuHandler=y.contextMenuHandler||null,this.enterHandler=y.enterHandler||null,this.leaveHandler=y.leaveHandler||null,this.exitHandler=y.exitHandler||null,this.overHandler=y.overHandler||null,this.outHandler=y.outHandler||null,this.pressHandler=y.pressHandler||null,this.nonPrimaryPressHandler=y.nonPrimaryPressHandler||null,this.releaseHandler=y.releaseHandler||null,this.nonPrimaryReleaseHandler=y.nonPrimaryReleaseHandler||null,this.moveHandler=y.moveHandler||null,this.scrollHandler=y.scrollHandler||null,this.clickHandler=y.clickHandler||null,this.dblClickHandler=y.dblClickHandler||null,this.dragHandler=y.dragHandler||null,this.dragEndHandler=y.dragEndHandler||null,this.pinchHandler=y.pinchHandler||null,this.stopHandler=y.stopHandler||null,this.keyDownHandler=y.keyDownHandler||null,this.keyUpHandler=y.keyUpHandler||null,this.keyHandler=y.keyHandler||null,this.focusHandler=y.focusHandler||null,this.blurHandler=y.blurHandler||null;var p=this;s[this.hash]={click:function(m){var x,F;M(p,F={originalEvent:x=m,eventType:"click",pointerType:"mouse",isEmulated:!1}),F.preventDefault&&!F.defaultPrevented&&n.cancelEvent(x),F.stopPropagation&&n.stopEvent(x)},dblclick:function(m){var x,F;M(p,F={originalEvent:x=m,eventType:"dblclick",pointerType:"mouse",isEmulated:!1}),F.preventDefault&&!F.defaultPrevented&&n.cancelEvent(x),F.stopPropagation&&n.stopEvent(x)},keydown:function(m){var _,x,F,O;F=null,M(_=p,O={originalEvent:x=m,eventType:"keydown",pointerType:"",isEmulated:!1}),_.keyDownHandler&&!O.preventGesture&&!O.defaultPrevented&&_.keyDownHandler(F={eventSource:_,keyCode:x.keyCode||x.charCode,ctrl:x.ctrlKey,shift:x.shiftKey,alt:x.altKey,meta:x.metaKey,originalEvent:x,preventDefault:O.preventDefault||O.defaultPrevented,userData:_.userData}),(F&&F.preventDefault||O.preventDefault&&!O.defaultPrevented)&&n.cancelEvent(x),O.stopPropagation&&n.stopEvent(x)},keyup:function(m){var _,x,F,O;F=null,M(_=p,O={originalEvent:x=m,eventType:"keyup",pointerType:"",isEmulated:!1}),_.keyUpHandler&&!O.preventGesture&&!O.defaultPrevented&&_.keyUpHandler(F={eventSource:_,keyCode:x.keyCode||x.charCode,ctrl:x.ctrlKey,shift:x.shiftKey,alt:x.altKey,meta:x.metaKey,originalEvent:x,preventDefault:O.preventDefault||O.defaultPrevented,userData:_.userData}),(F&&F.preventDefault||O.preventDefault&&!O.defaultPrevented)&&n.cancelEvent(x),O.stopPropagation&&n.stopEvent(x)},keypress:function(m){var _,x,F,O;F=null,M(_=p,O={originalEvent:x=m,eventType:"keypress",pointerType:"",isEmulated:!1}),_.keyHandler&&!O.preventGesture&&!O.defaultPrevented&&_.keyHandler(F={eventSource:_,keyCode:x.keyCode||x.charCode,ctrl:x.ctrlKey,shift:x.shiftKey,alt:x.altKey,meta:x.metaKey,originalEvent:x,preventDefault:O.preventDefault||O.defaultPrevented,userData:_.userData}),(F&&F.preventDefault||O.preventDefault&&!O.defaultPrevented)&&n.cancelEvent(x),O.stopPropagation&&n.stopEvent(x)},focus:function(m){var _,x,F;M(_=p,F={originalEvent:x=m,eventType:"focus",pointerType:"",isEmulated:!1}),_.focusHandler&&!F.preventGesture&&_.focusHandler({eventSource:_,originalEvent:x,userData:_.userData})},blur:function(m){var _,x,F;M(_=p,F={originalEvent:x=m,eventType:"blur",pointerType:"",isEmulated:!1}),_.blurHandler&&!F.preventGesture&&_.blurHandler({eventSource:_,originalEvent:x,userData:_.userData})},contextmenu:function(m){var _,x,F,O;F=null,M(_=p,O={originalEvent:x=m,eventType:"contextmenu",pointerType:"mouse",isEmulated:!1}),_.contextMenuHandler&&!O.preventGesture&&!O.defaultPrevented&&(F={eventSource:_,position:j(I(x),_.element),originalEvent:O.originalEvent,preventDefault:O.preventDefault||O.defaultPrevented,userData:_.userData},_.contextMenuHandler(F)),(F&&F.preventDefault||O.preventDefault&&!O.defaultPrevented)&&n.cancelEvent(x),O.stopPropagation&&n.stopEvent(x)},wheel:function(m){q(p,m,m)},mousewheel:function(m){K(p,m)},DOMMouseScroll:function(m){K(p,m)},MozMousePixelScroll:function(m){K(p,m)},losecapture:function(m){var _,x,F,O;F={id:n.MouseTracker.mousePointerId,type:"mouse"},M(_=p,O={originalEvent:x=m,eventType:"lostpointercapture",pointerType:"mouse",isEmulated:!1}),x.target===_.element&&A(_,F,!1),O.stopPropagation&&n.stopEvent(x)},mouseenter:function(m){Y(p,m)},mouseleave:function(m){Q(p,m)},mouseover:function(m){et(p,m)},mouseout:function(m){$(p,m)},mousedown:function(m){S(p,m)},mouseup:function(m){R(p,m)},mousemove:function(m){D(p,m)},touchstart:function(m){!function(_,x){var F,O,k,G=x.changedTouches.length,X=_.getActivePointersListByType("touch");F=n.now(),X.getLength()>x.touches.length-G&&n.console.warn("Tracked touch contact count doesn't match event.touches.length");var J={originalEvent:x,eventType:"pointerdown",pointerType:"touch",isEmulated:!1};for(M(_,J),O=0;O<G;O++)N(_,J,k={id:x.changedTouches[O].identifier,type:"touch",isPrimary:0===X.getLength(),currentPos:I(x.changedTouches[O]),currentTime:F}),W(_,J,k,0),A(_,k,!0);J.preventDefault&&!J.defaultPrevented&&n.cancelEvent(x),J.stopPropagation&&n.stopEvent(x)}(p,m)},touchend:function(m){!function(_,x){var F,O,k,G=x.changedTouches.length;F=n.now();var X={originalEvent:x,eventType:"pointerup",pointerType:"touch",isEmulated:!1};for(M(_,X),O=0;O<G;O++)U(_,X,k={id:x.changedTouches[O].identifier,type:"touch",currentPos:I(x.changedTouches[O]),currentTime:F},0),A(_,k,!1),B(_,X,k);X.preventDefault&&!X.defaultPrevented&&n.cancelEvent(x),X.stopPropagation&&n.stopEvent(x)}(p,m)},touchmove:function(m){!function(_,x){var F,O,G=x.changedTouches.length;F=n.now();var X={originalEvent:x,eventType:"pointermove",pointerType:"touch",isEmulated:!1};for(M(_,X),O=0;O<G;O++)Z(_,X,{id:x.changedTouches[O].identifier,type:"touch",currentPos:I(x.changedTouches[O]),currentTime:F});X.preventDefault&&!X.defaultPrevented&&n.cancelEvent(x),X.stopPropagation&&n.stopEvent(x)}(p,m)},touchcancel:function(m){!function(_,x){var F,k=x.changedTouches.length,G={originalEvent:x,eventType:"pointercancel",pointerType:"touch",isEmulated:!1};for(M(_,G),F=0;F<k;F++)z(_,0,{id:x.changedTouches[F].identifier,type:"touch"});G.stopPropagation&&n.stopEvent(x)}(p,m)},gesturestart:function(m){n.eventIsCanceled(m=m)||m.preventDefault()},gesturechange:function(m){n.eventIsCanceled(m=m)||m.preventDefault()},gotpointercapture:function(m){var _,x,F;M(_=p,F={originalEvent:x=m,eventType:"gotpointercapture",pointerType:T(x),isEmulated:!1}),x.target===_.element&&A(_,{id:x.pointerId,type:T(x)},!0),F.stopPropagation&&n.stopEvent(x)},lostpointercapture:function(m){var _,x,F;M(_=p,F={originalEvent:x=m,eventType:"lostpointercapture",pointerType:T(x),isEmulated:!1}),x.target===_.element&&A(_,{id:x.pointerId,type:T(x)},!1),F.stopPropagation&&n.stopEvent(x)},pointerenter:function(m){Y(p,m)},pointerleave:function(m){Q(p,m)},pointerover:function(m){et(p,m)},pointerout:function(m){$(p,m)},pointerdown:function(m){S(p,m)},pointerup:function(m){R(p,m)},pointermove:function(m){D(p,m)},pointercancel:function(m){var _,x,F,O;_=p,F={id:(x=m).pointerId,type:T(x)},M(_,O={originalEvent:x,eventType:"pointercancel",pointerType:F.type,isEmulated:!1}),z(_,0,F),O.stopPropagation&&n.stopEvent(x)},pointerupcaptured:function(m){var _,x;(_=p).getActivePointersListByType(T(x=m)).getById(x.pointerId)&&b(_,x),n.stopEvent(x)},pointermovecaptured:function(m){var _,x;(_=p).getActivePointersListByType(T(x=m)).getById(x.pointerId)&&L(_,x),n.stopEvent(x)},tracking:!1,activePointersLists:[],lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null,sentDragEvent:!1},this.hasGestureHandlers=!!(this.pressHandler||this.nonPrimaryPressHandler||this.releaseHandler||this.nonPrimaryReleaseHandler||this.clickHandler||this.dblClickHandler||this.dragHandler||this.dragEndHandler||this.pinchHandler),this.hasScrollHandler=!!this.scrollHandler,n.MouseTracker.havePointerEvents&&n.setElementPointerEvents(this.element,"auto"),this.exitHandler&&n.console.error("MouseTracker.exitHandler is deprecated. Use MouseTracker.leaveHandler instead."),y.startDisabled||this.setTracking(!0)},n.MouseTracker.prototype={destroy:function(){var y;for(d(this),this.element=null,y=0;y<t.length;y++)if(t[y]===this){t.splice(y,1);break}s[this.hash]=null,delete s[this.hash]},isTracking:function(){return s[this.hash].tracking},setTracking:function(y){return(y?function(f){var p,m,_=s[f.hash];if(!_.tracking){for(m=0;m<n.MouseTracker.subscribeEvents.length;m++)n.addEvent(f.element,p=n.MouseTracker.subscribeEvents[m],_[p],p===n.MouseTracker.wheelEventName&&{passive:!1,capture:!1});u(f),_.tracking=!0}}:d)(this),this},getActivePointersListByType:function(y){var f,p,m=s[this.hash],_=m.activePointersLists.length;for(f=0;f<_;f++)if(m.activePointersLists[f].type===y)return m.activePointersLists[f];return p=new n.MouseTracker.GesturePointList(y),m.activePointersLists.push(p),p},getActivePointerCount:function(){var y,f=s[this.hash],p=f.activePointersLists.length,m=0;for(y=0;y<p;y++)m+=f.activePointersLists[y].getLength();return m},preProcessEventHandler:function(){},contextMenuHandler:function(){},enterHandler:function(){},leaveHandler:function(){},exitHandler:function(){},overHandler:function(){},outHandler:function(){},pressHandler:function(){},nonPrimaryPressHandler:function(){},releaseHandler:function(){},nonPrimaryReleaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyDownHandler:function(){},keyUpHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}};var o,h,l,c,a=function(){try{return window.self!==window.top}catch(y){return!0}}();function e(y){try{return y.addEventListener&&y.removeEventListener}catch(f){return}}function r(y,f){return y.hash.toString()+f.type+f.id.toString()}function i(){var y,f,p,m,_,x=o.length,F=n.now();for(m=F-l,l=F,y=0;y<x;y++)(p=(f=o[y]).gPoint).direction=Math.atan2(p.currentPos.y-f.lastPos.y,p.currentPos.x-f.lastPos.x),_=f.lastPos.distanceTo(p.currentPos),f.lastPos=p.currentPos,p.speed=1e3*_/(1+m)*.75+.25*p.speed}function u(y){var f,p,m,_,x,F=s[y.hash],O=F.activePointersLists.length;for(f=0;f<O;f++)if(0<(m=F.activePointersLists[f]).getLength()){for(x=[],_=m.asArray(),p=0;p<_.length;p++)x.push(_[p]);for(p=0;p<x.length;p++)C(y,m,x[p])}for(f=0;f<O;f++)F.activePointersLists.pop();F.sentDragEvent=!1}function d(y){var f,p,m=s[y.hash];if(m.tracking){for(p=0;p<n.MouseTracker.subscribeEvents.length;p++)n.removeEvent(y.element,f=n.MouseTracker.subscribeEvents[p],m[f],!1);u(y),m.tracking=!1}}function g(y,f){if(y=s[y.hash],"pointerevent"===f)return{upName:"pointerup",upHandler:y.pointerupcaptured,moveName:"pointermove",moveHandler:y.pointermovecaptured};if("mouse"===f)return{upName:"pointerup",upHandler:y.pointerupcaptured,moveName:"pointermove",moveHandler:y.pointermovecaptured};if("touch"===f)return{upName:"touchend",upHandler:y.touchendcaptured,moveName:"touchmove",moveHandler:y.touchmovecaptured};throw new Error("MouseTracker.getCaptureEventParams: Unknown pointer type.")}function v(y,f){var p;if(n.MouseTracker.havePointerCapture)if(n.MouseTracker.havePointerEvents){if(!(p=y.getActivePointersListByType(f.type).getById(f.id))||!p.captured)return;try{y.element.releasePointerCapture(f.id)}catch(m){}}else y.element.releaseCapture();else p=g(y,n.MouseTracker.havePointerEvents?"pointerevent":f.type),a&&e(window.top)&&n.removeEvent(window.top,p.upName,p.upHandler,!0),n.removeEvent(n.MouseTracker.captureElement,p.moveName,p.moveHandler,!0),n.removeEvent(n.MouseTracker.captureElement,p.upName,p.upHandler,!0);A(y,f,!1)}function w(y){return n.MouseTracker.havePointerEvents?y.pointerId:n.MouseTracker.mousePointerId}function T(y){return n.MouseTracker.havePointerEvents?y.pointerType||(n.Browser.vendor===n.BROWSERS.IE?"mouse":""):"mouse"}function E(y){return!n.MouseTracker.havePointerEvents||y.isPrimary}function I(y){return n.getMousePosition(y)}function H(y,f){return j(I(y),f)}function j(y,f){return f=n.getElementOffset(f),y.minus(f)}function V(y,f){return new n.Point((y.x+f.x)/2,(y.y+f.y)/2)}function K(y,f){var p={target:f.target||f.srcElement,type:"wheel",shiftKey:f.shiftKey||!1,clientX:f.clientX,clientY:f.clientY,pageX:f.pageX||f.clientX,pageY:f.pageY||f.clientY,deltaMode:"MozMousePixelScroll"===f.type?0:1,deltaX:0,deltaZ:0};p.deltaY="mousewheel"===n.MouseTracker.wheelEventName?-f.wheelDelta/n.DEFAULT_SETTINGS.pixelsPerWheelLine:f.detail,q(y,p,f)}function q(y,f,p){var m,_,x=null;m=f.deltaY<0?1:-1,M(y,_={originalEvent:f,eventType:"wheel",pointerType:"mouse",isEmulated:f!==p}),y.scrollHandler&&!_.preventGesture&&!_.defaultPrevented&&(x={eventSource:y,pointerType:"mouse",position:H(f,y.element),scroll:m,shift:f.shiftKey,isTouchEvent:!1,originalEvent:p,preventDefault:_.preventDefault||_.defaultPrevented,userData:y.userData},y.scrollHandler(x)),_.stopPropagation&&n.stopEvent(p),(x&&x.preventDefault||_.preventDefault&&!_.defaultPrevented)&&n.cancelEvent(p)}function Y(y,f){var p={id:w(f),type:T(f),isPrimary:E(f),currentPos:I(f),currentTime:n.now()};M(y,f={originalEvent:f,eventType:"pointerenter",pointerType:p.type,isEmulated:!1}),N(y,f,p)}function Q(y,f){var p={id:w(f),type:T(f),isPrimary:E(f),currentPos:I(f),currentTime:n.now()};M(y,f={originalEvent:f,eventType:"pointerleave",pointerType:p.type,isEmulated:!1}),B(y,f,p)}function et(y,f){var _,x,F,O,k,p={id:w(f),type:T(f),isPrimary:E(f),currentPos:I(f),currentTime:n.now()},m={originalEvent:f,eventType:"pointerover",pointerType:p.type,isEmulated:!1};M(y,m),x=m,(k=(O=(_=y).getActivePointersListByType((F=p).type)).getById(F.id))?F=k:(F.captured=!1,F.insideElementPressed=!1),_.overHandler&&_.overHandler({eventSource:_,pointerType:F.type,position:j(F.currentPos,_.element),buttons:O.buttons,pointers:_.getActivePointerCount(),insideElementPressed:F.insideElementPressed,buttonDownAny:0!==O.buttons,isTouchEvent:"touch"===F.type,originalEvent:x.originalEvent,userData:_.userData}),m.preventDefault&&!m.defaultPrevented&&n.cancelEvent(f),m.stopPropagation&&n.stopEvent(f)}function $(y,f){var _,x,F,O,k,p={id:w(f),type:T(f),isPrimary:E(f),currentPos:I(f),currentTime:n.now()},m={originalEvent:f,eventType:"pointerout",pointerType:p.type,isEmulated:!1};M(y,m),x=m,(k=(O=(_=y).getActivePointersListByType((F=p).type)).getById(F.id))?F=k:(F.captured=!1,F.insideElementPressed=!1),_.outHandler&&_.outHandler({eventSource:_,pointerType:F.type,position:F.currentPos&&j(F.currentPos,_.element),buttons:O.buttons,pointers:_.getActivePointerCount(),insideElementPressed:F.insideElementPressed,buttonDownAny:0!==O.buttons,isTouchEvent:"touch"===F.type,originalEvent:x.originalEvent,userData:_.userData}),m.preventDefault&&!m.defaultPrevented&&n.cancelEvent(f),m.stopPropagation&&n.stopEvent(f)}function S(y,f){var p={id:w(f),type:T(f),isPrimary:E(f),currentPos:I(f),currentTime:n.now()},m=n.MouseTracker.havePointerEvents&&"touch"===p.type&&n.Browser.vendor!==n.BROWSERS.IE,_={originalEvent:f,eventType:"pointerdown",pointerType:p.type,isEmulated:!1};M(y,_),W(y,_,p,f.button),_.preventDefault&&!_.defaultPrevented&&n.cancelEvent(f),_.stopPropagation&&n.stopEvent(f),_.shouldCapture&&(m?A(y,p,!0):function(x,F){var O;if(n.MouseTracker.havePointerCapture)if(n.MouseTracker.havePointerEvents)try{x.element.setPointerCapture(F.id)}catch(k){return void n.console.warn("setPointerCapture() called on invalid pointer ID")}else x.element.setCapture(!0);else O=g(x,n.MouseTracker.havePointerEvents?"pointerevent":F.type),a&&e(window.top)&&n.addEvent(window.top,O.upName,O.upHandler,!0),n.addEvent(n.MouseTracker.captureElement,O.upName,O.upHandler,!0),n.addEvent(n.MouseTracker.captureElement,O.moveName,O.moveHandler,!0);A(x,F,!0)}(y,p))}function R(y,f){b(y,f)}function b(y,f){var p,m={originalEvent:f,eventType:"pointerup",pointerType:(p={id:w(f),type:T(f),isPrimary:E(f),currentPos:I(f),currentTime:n.now()}).type,isEmulated:!1};M(y,m),U(y,m,p,f.button),m.preventDefault&&!m.defaultPrevented&&n.cancelEvent(f),m.stopPropagation&&n.stopEvent(f),m.shouldReleaseCapture&&(f.target===y.element?v(y,p):A(y,p,!1))}function D(y,f){L(y,f)}function L(y,f){var p={id:w(f),type:T(f),isPrimary:E(f),currentPos:I(f),currentTime:n.now()},m={originalEvent:f,eventType:"pointermove",pointerType:p.type,isEmulated:!1};M(y,m),Z(y,m,p),m.preventDefault&&!m.defaultPrevented&&n.cancelEvent(f),m.stopPropagation&&n.stopEvent(f)}function P(y,f){return f.speed=0,f.direction=0,f.contactPos=f.currentPos,f.contactTime=f.currentTime,f.lastPos=f.currentPos,f.lastTime=f.currentTime,y.add(f)}function C(y,f,p){var m,_=f.getById(p.id);return _?(_.captured&&(n.console.warn("stopTrackingPointer() called on captured pointer"),v(y,_)),f.removeContact(),m=f.removeById(p.id)):m=f.getLength(),m}function M(y,f){f.eventSource=y,f.eventPhase=f.originalEvent&&void 0!==f.originalEvent.eventPhase?f.originalEvent.eventPhase:0,f.defaultPrevented=n.eventIsCanceled(f.originalEvent),f.shouldCapture=!1,f.shouldReleaseCapture=!1,f.userData=y.userData,function(p,m){switch(m.eventType){case"pointermove":case"pointerdown":case"pointerup":m.isStoppable=!0,m.isCancelable=!0,m.preventDefault=!1,m.preventGesture=!p.hasGestureHandlers,m.stopPropagation=!1;break;case"pointerover":case"pointerout":case"contextmenu":case"keydown":case"keyup":case"keypress":m.isStoppable=!0,m.isCancelable=!0,m.preventDefault=!1,m.preventGesture=!1,m.stopPropagation=!1;break;case"wheel":m.isStoppable=!0,m.isCancelable=!0,m.preventDefault=!1,m.preventGesture=!p.hasScrollHandler,m.stopPropagation=!1;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":m.isStoppable=!0,m.isCancelable=!1,m.preventDefault=!1,m.preventGesture=!1,m.stopPropagation=!1;break;case"click":m.isStoppable=!0,m.isCancelable=!0,m.preventDefault=!!p.clickHandler,m.preventGesture=!1,m.stopPropagation=!1;break;case"dblclick":m.isStoppable=!0,m.isCancelable=!0,m.preventDefault=!!p.dblClickHandler,m.preventGesture=!1,m.stopPropagation=!1;break;default:m.isStoppable=!1,m.isCancelable=!1,m.preventDefault=!1,m.preventGesture=!1,m.stopPropagation=!1}}(y,f),y.preProcessEventHandler&&y.preProcessEventHandler(f)}function A(y,f,p){(f=(y=y.getActivePointersListByType(f.type)).getById(f.id))?p&&!f.captured?(f.captured=!0,y.captureCount++):!p&&f.captured&&(f.captured=!1,y.captureCount--,y.captureCount<0&&(y.captureCount=0,n.console.warn("updatePointerCaptured() - pointsList.captureCount went negative"))):n.console.warn("updatePointerCaptured() called on untracked pointer")}function N(y,f,p){var m,_=y.getActivePointersListByType(p.type);(m=_.getById(p.id))?(m.insideElement=!0,m.lastPos=m.currentPos,m.lastTime=m.currentTime,m.currentPos=p.currentPos,m.currentTime=p.currentTime,p=m):(p.captured=!1,p.insideElementPressed=!1,p.insideElement=!0,P(_,p)),y.enterHandler&&y.enterHandler({eventSource:y,pointerType:p.type,position:j(p.currentPos,y.element),buttons:_.buttons,pointers:y.getActivePointerCount(),insideElementPressed:p.insideElementPressed,buttonDownAny:0!==_.buttons,isTouchEvent:"touch"===p.type,originalEvent:f.originalEvent,userData:y.userData})}function B(y,f,p){var m,_=y.getActivePointersListByType(p.type);(m=_.getById(p.id))?(m.captured?(m.insideElement=!1,m.lastPos=m.currentPos,m.lastTime=m.currentTime,m.currentPos=p.currentPos,m.currentTime=p.currentTime):C(y,_,m),p=m):(p.captured=!1,p.insideElementPressed=!1),(y.leaveHandler||y.exitHandler)&&(f={eventSource:y,pointerType:p.type,position:p.currentPos&&j(p.currentPos,y.element),buttons:_.buttons,pointers:y.getActivePointerCount(),insideElementPressed:p.insideElementPressed,buttonDownAny:0!==_.buttons,isTouchEvent:"touch"===p.type,originalEvent:f.originalEvent,userData:y.userData},y.leaveHandler&&y.leaveHandler(f),y.exitHandler&&y.exitHandler(f))}function W(y,f,p,m){var _,x=s[y.hash],F=y.getActivePointersListByType(p.type);void 0!==f.originalEvent.buttons?F.buttons=f.originalEvent.buttons:0===m?F.buttons|=1:1===m?F.buttons|=4:2===m?F.buttons|=2:3===m?F.buttons|=8:4===m?F.buttons|=16:5===m&&(F.buttons|=32),0===m?((_=F.getById(p.id))?(_.insideElementPressed=!0,_.insideElement=!0,_.originalTarget=f.originalEvent.target,_.contactPos=p.currentPos,_.contactTime=p.currentTime,_.lastPos=_.currentPos,_.lastTime=_.currentTime,_.currentPos=p.currentPos,_.currentTime=p.currentTime,p=_):(p.captured=!1,p.insideElementPressed=!0,p.insideElement=!0,p.originalTarget=f.originalEvent.target,P(F,p)),F.addContact(),f.preventGesture||f.defaultPrevented?(f.shouldCapture=!1,f.shouldReleaseCapture=!1):(f.shouldCapture=!0,f.shouldReleaseCapture=!1,f.preventDefault=!0,(y.dragHandler||y.dragEndHandler||y.pinchHandler)&&n.MouseTracker.gesturePointVelocityTracker.addPoint(y,p),1===F.contacts?y.pressHandler&&!f.preventGesture&&y.pressHandler({eventSource:y,pointerType:p.type,position:j(p.contactPos,y.element),buttons:F.buttons,isTouchEvent:"touch"===p.type,originalEvent:f.originalEvent,userData:y.userData}):2===F.contacts&&y.pinchHandler&&"touch"===p.type&&(x.pinchGPoints=F.asArray(),x.lastPinchDist=x.currentPinchDist=x.pinchGPoints[0].currentPos.distanceTo(x.pinchGPoints[1].currentPos),x.lastPinchCenter=x.currentPinchCenter=V(x.pinchGPoints[0].currentPos,x.pinchGPoints[1].currentPos)))):(f.shouldCapture=!1,f.shouldReleaseCapture=!1,y.nonPrimaryPressHandler&&!f.preventGesture&&!f.defaultPrevented&&(f.preventDefault=!0,y.nonPrimaryPressHandler({eventSource:y,pointerType:p.type,position:j(p.currentPos,y.element),button:m,buttons:F.buttons,isTouchEvent:"touch"===p.type,originalEvent:f.originalEvent,userData:y.userData})))}function U(y,f,p,m){var _,x,F,O=s[y.hash],k=y.getActivePointersListByType(p.type),G=!1;void 0!==f.originalEvent.buttons?k.buttons=f.originalEvent.buttons:0===m?k.buttons^=-2:1===m?k.buttons^=-5:2===m?k.buttons^=-3:3===m?k.buttons^=-9:4===m?k.buttons^=-17:5===m&&(k.buttons^=-33),f.shouldCapture=!1,0===m?((x=k.getById(p.id))?(k.removeContact(),x.captured&&(G=!0),x.lastPos=x.currentPos,x.lastTime=x.currentTime,x.currentPos=p.currentPos,x.currentTime=p.currentTime,x.insideElement||C(y,k,x),_=x.currentPos,F=x.currentTime):(p.captured=!1,p.insideElementPressed=!1,p.insideElement=!0,P(k,p),x=p),!f.preventGesture&&!f.defaultPrevented&&(G?(f.shouldReleaseCapture=!0,f.preventDefault=!0,(y.dragHandler||y.dragEndHandler||y.pinchHandler)&&n.MouseTracker.gesturePointVelocityTracker.removePoint(y,x),0===k.contacts?(y.releaseHandler&&_&&y.releaseHandler({eventSource:y,pointerType:x.type,position:j(_,y.element),buttons:k.buttons,insideElementPressed:x.insideElementPressed,insideElementReleased:x.insideElement,isTouchEvent:"touch"===x.type,originalEvent:f.originalEvent,userData:y.userData}),y.dragEndHandler&&O.sentDragEvent&&y.dragEndHandler({eventSource:y,pointerType:x.type,position:j(x.currentPos,y.element),speed:x.speed,direction:x.direction,shift:f.originalEvent.shiftKey,isTouchEvent:"touch"===x.type,originalEvent:f.originalEvent,userData:y.userData}),O.sentDragEvent=!1,(y.clickHandler||y.dblClickHandler)&&x.insideElement&&(F=F-x.contactTime<=y.clickTimeThreshold&&x.contactPos.distanceTo(_)<=y.clickDistThreshold,y.clickHandler&&y.clickHandler({eventSource:y,pointerType:x.type,position:j(x.currentPos,y.element),quick:F,shift:f.originalEvent.shiftKey,isTouchEvent:"touch"===x.type,originalEvent:f.originalEvent,originalTarget:x.originalTarget,userData:y.userData}),y.dblClickHandler&&F&&(k.clicks++,1===k.clicks?(O.lastClickPos=_,O.dblClickTimeOut=setTimeout(function(){k.clicks=0},y.dblClickTimeThreshold)):2===k.clicks&&(clearTimeout(O.dblClickTimeOut),k.clicks=0,O.lastClickPos.distanceTo(_)<=y.dblClickDistThreshold&&y.dblClickHandler({eventSource:y,pointerType:x.type,position:j(x.currentPos,y.element),shift:f.originalEvent.shiftKey,isTouchEvent:"touch"===x.type,originalEvent:f.originalEvent,userData:y.userData}),O.lastClickPos=null)))):2===k.contacts&&y.pinchHandler&&"touch"===x.type&&(O.pinchGPoints=k.asArray(),O.lastPinchDist=O.currentPinchDist=O.pinchGPoints[0].currentPos.distanceTo(O.pinchGPoints[1].currentPos),O.lastPinchCenter=O.currentPinchCenter=V(O.pinchGPoints[0].currentPos,O.pinchGPoints[1].currentPos))):(f.shouldReleaseCapture=!1,y.releaseHandler&&_&&(y.releaseHandler({eventSource:y,pointerType:x.type,position:j(_,y.element),buttons:k.buttons,insideElementPressed:x.insideElementPressed,insideElementReleased:x.insideElement,isTouchEvent:"touch"===x.type,originalEvent:f.originalEvent,userData:y.userData}),f.preventDefault=!0)))):(f.shouldReleaseCapture=!1,y.nonPrimaryReleaseHandler&&!f.preventGesture&&!f.defaultPrevented&&(f.preventDefault=!0,y.nonPrimaryReleaseHandler({eventSource:y,pointerType:p.type,position:j(p.currentPos,y.element),button:m,buttons:k.buttons,isTouchEvent:"touch"===p.type,originalEvent:f.originalEvent,userData:y.userData})))}function Z(y,f,p){var m,_,x=s[y.hash],F=y.getActivePointersListByType(p.type);void 0!==f.originalEvent.buttons&&(F.buttons=f.originalEvent.buttons),(m=F.getById(p.id))&&(m.lastPos=m.currentPos,m.lastTime=m.currentTime,m.currentPos=p.currentPos,m.currentTime=p.currentTime,f.shouldCapture=!1,f.shouldReleaseCapture=!1,y.stopHandler&&"mouse"===p.type&&(clearTimeout(y.stopTimeOut),y.stopTimeOut=setTimeout(function(){var O,k,G;k=f.originalEvent,G=p.type,(O=y).stopHandler&&O.stopHandler({eventSource:O,pointerType:G,position:H(k,O.element),buttons:O.getActivePointersListByType(G).buttons,isTouchEvent:"touch"===G,originalEvent:k,userData:O.userData})},y.stopDelay)),0===F.contacts?y.moveHandler&&y.moveHandler({eventSource:y,pointerType:p.type,position:j(p.currentPos,y.element),buttons:F.buttons,isTouchEvent:"touch"===p.type,originalEvent:f.originalEvent,userData:y.userData}):1===F.contacts?(y.moveHandler&&(m=F.asArray()[0],y.moveHandler({eventSource:y,pointerType:m.type,position:j(m.currentPos,y.element),buttons:F.buttons,isTouchEvent:"touch"===m.type,originalEvent:f.originalEvent,userData:y.userData})),y.dragHandler&&!f.preventGesture&&!f.defaultPrevented&&(_=(m=F.asArray()[0]).currentPos.minus(m.lastPos),y.dragHandler({eventSource:y,pointerType:m.type,position:j(m.currentPos,y.element),buttons:F.buttons,delta:_,speed:m.speed,direction:m.direction,shift:f.originalEvent.shiftKey,isTouchEvent:"touch"===m.type,originalEvent:f.originalEvent,userData:y.userData}),f.preventDefault=!0,x.sentDragEvent=!0)):2===F.contacts&&(y.moveHandler&&(m=F.asArray(),y.moveHandler({eventSource:y,pointerType:m[0].type,position:j(V(m[0].currentPos,m[1].currentPos),y.element),buttons:F.buttons,isTouchEvent:"touch"===m[0].type,originalEvent:f.originalEvent,userData:y.userData})),y.pinchHandler&&"touch"===p.type&&!f.preventGesture&&!f.defaultPrevented&&(_=x.pinchGPoints[0].currentPos.distanceTo(x.pinchGPoints[1].currentPos))!==x.currentPinchDist&&(x.lastPinchDist=x.currentPinchDist,x.currentPinchDist=_,x.lastPinchCenter=x.currentPinchCenter,x.currentPinchCenter=V(x.pinchGPoints[0].currentPos,x.pinchGPoints[1].currentPos),y.pinchHandler({eventSource:y,pointerType:"touch",gesturePoints:x.pinchGPoints,lastCenter:j(x.lastPinchCenter,y.element),center:j(x.currentPinchCenter,y.element),lastDistance:x.lastPinchDist,distance:x.currentPinchDist,shift:f.originalEvent.shiftKey,originalEvent:f.originalEvent,userData:y.userData}),f.preventDefault=!0)))}function z(y,f,p){var m=y.getActivePointersListByType(p.type);(p=m.getById(p.id))&&C(y,m,p)}n.MouseTracker.gesturePointVelocityTracker=(o=[],l=h=0,{addPoint:function(y,f){y=r(y,f),o.push({guid:y,gPoint:f,lastPos:f.currentPos}),1===o.length&&(l=n.now(),h=window.setInterval(i,50))},removePoint:function(y,f){var p,m=r(y,f),_=o.length;for(p=0;p<_;p++)if(o[p].guid===m){o.splice(p,1),0==--_&&window.clearInterval(h);break}}}),n.MouseTracker.captureElement=document,n.MouseTracker.wheelEventName=n.Browser.vendor===n.BROWSERS.IE&&8<n.Browser.version||"onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll",n.MouseTracker.subscribeEvents=["click","dblclick","keydown","keyup","keypress","focus","blur","contextmenu",n.MouseTracker.wheelEventName],"DOMMouseScroll"===n.MouseTracker.wheelEventName&&n.MouseTracker.subscribeEvents.push("MozMousePixelScroll"),window.PointerEvent?(n.MouseTracker.havePointerEvents=!0,n.MouseTracker.subscribeEvents.push("pointerenter","pointerleave","pointerover","pointerout","pointerdown","pointerup","pointermove","pointercancel"),n.MouseTracker.havePointerCapture=(c=document.createElement("div"),n.isFunction(c.setPointerCapture)&&n.isFunction(c.releasePointerCapture)),n.MouseTracker.havePointerCapture&&n.MouseTracker.subscribeEvents.push("gotpointercapture","lostpointercapture")):(n.MouseTracker.havePointerEvents=!1,n.MouseTracker.subscribeEvents.push("mouseenter","mouseleave","mouseover","mouseout","mousedown","mouseup","mousemove"),n.MouseTracker.mousePointerId="legacy-mouse",n.MouseTracker.havePointerCapture=(c=document.createElement("div"),n.isFunction(c.setCapture)&&n.isFunction(c.releaseCapture)),n.MouseTracker.havePointerCapture&&n.MouseTracker.subscribeEvents.push("losecapture"),"ontouchstart"in window&&n.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel"),"ongesturestart"in window&&n.MouseTracker.subscribeEvents.push("gesturestart","gesturechange")),n.MouseTracker.GesturePointList=function(y){this._gPoints=[],this.type=y,this.buttons=0,this.contacts=0,this.clicks=0,this.captureCount=0},n.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(y){return this._gPoints.push(y)},removeById:function(y){var f,p=this._gPoints.length;for(f=0;f<p;f++)if(this._gPoints[f].id===y){this._gPoints.splice(f,1);break}return this._gPoints.length},getByIndex:function(y){return y<this._gPoints.length?this._gPoints[y]:null},getById:function(y){var f,p=this._gPoints.length;for(f=0;f<p;f++)if(this._gPoints[f].id===y)return this._gPoints[f];return null},getPrimary:function(y){var f,p=this._gPoints.length;for(f=0;f<p;f++)if(this._gPoints[f].isPrimary)return this._gPoints[f];return null},addContact:function(){++this.contacts,1<this.contacts&&("mouse"===this.type||"pen"===this.type)&&(n.console.warn("GesturePointList.addContact() Implausible contacts value"),this.contacts=1)},removeContact:function(){--this.contacts,this.contacts<0&&(this.contacts=0)}}}(OpenSeadragon),function(n){n.ControlAnchor={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4,ABSOLUTE:5},n.Control=function(t,s,a){var e=t.parentNode;"number"==typeof s&&(n.console.error("Passing an anchor directly into the OpenSeadragon.Control constructor is deprecated; please use an options object instead.  Support for this deprecated variant is scheduled for removal in December 2013"),s={anchor:s}),s.attachToViewer=void 0===s.attachToViewer||s.attachToViewer,this.autoFade=void 0===s.autoFade||s.autoFade,this.element=t,this.anchor=s.anchor,this.container=a,this.anchor===n.ControlAnchor.ABSOLUTE?(this.wrapper=n.makeNeutralElement("div"),this.wrapper.style.position="absolute",this.wrapper.style.top="number"==typeof s.top?s.top+"px":s.top,this.wrapper.style.left="number"==typeof s.left?s.left+"px":s.left,this.wrapper.style.height="number"==typeof s.height?s.height+"px":s.height,this.wrapper.style.width="number"==typeof s.width?s.width+"px":s.width,this.wrapper.style.margin="0px",this.wrapper.style.padding="0px",this.element.style.position="relative",this.element.style.top="0px",this.element.style.left="0px",this.element.style.height="100%",this.element.style.width="100%"):(this.wrapper=n.makeNeutralElement("div"),this.wrapper.style.display="inline-block",this.anchor===n.ControlAnchor.NONE&&(this.wrapper.style.width=this.wrapper.style.height="100%")),this.wrapper.appendChild(this.element),s.attachToViewer?this.anchor===n.ControlAnchor.TOP_RIGHT||this.anchor===n.ControlAnchor.BOTTOM_RIGHT?this.container.insertBefore(this.wrapper,this.container.firstChild):this.container.appendChild(this.wrapper):e.appendChild(this.wrapper)},n.Control.prototype={destroy:function(){this.wrapper.removeChild(this.element),this.anchor!==n.ControlAnchor.NONE&&this.container.removeChild(this.wrapper)},isVisible:function(){return"none"!==this.wrapper.style.display},setVisible:function(t){this.wrapper.style.display=t?this.anchor===n.ControlAnchor.ABSOLUTE?"block":"inline-block":"none"},setOpacity:function(t){n.setElementOpacity(this.element[n.SIGNAL]&&n.Browser.vendor===n.BROWSERS.IE?this.element:this.wrapper,t,!0)}}}(OpenSeadragon),function(n){function t(s,a){var e,r=s.controls;for(e=r.length-1;0<=e;e--)if(r[e].element===a)return e;return-1}n.ControlDock=function(s){var a,e,r=["topleft","topright","bottomright","bottomleft"];for(n.extend(!0,this,{id:"controldock-"+n.now()+"-"+Math.floor(1e6*Math.random()),container:n.makeNeutralElement("div"),controls:[]},s),this.container.onsubmit=function(){return!1},this.element&&(this.element=n.getElement(this.element),this.element.appendChild(this.container),this.element.style.position="relative",this.container.style.width="100%",this.container.style.height="100%"),e=0;e<r.length;e++)this.controls[a=r[e]]=n.makeNeutralElement("div"),this.controls[a].style.position="absolute",a.match("left")&&(this.controls[a].style.left="0px"),a.match("right")&&(this.controls[a].style.right="0px"),a.match("top")&&(this.controls[a].style.top="0px"),a.match("bottom")&&(this.controls[a].style.bottom="0px");this.container.appendChild(this.controls.topleft),this.container.appendChild(this.controls.topright),this.container.appendChild(this.controls.bottomright),this.container.appendChild(this.controls.bottomleft)},n.ControlDock.prototype={addControl:function(s,a){var e=null;if(!(0<=t(this,s=n.getElement(s)))){switch(a.anchor){case n.ControlAnchor.TOP_RIGHT:e=this.controls.topright,s.style.position="relative",s.style.paddingRight="0px",s.style.paddingTop="0px";break;case n.ControlAnchor.BOTTOM_RIGHT:e=this.controls.bottomright,s.style.position="relative",s.style.paddingRight="0px",s.style.paddingBottom="0px";break;case n.ControlAnchor.BOTTOM_LEFT:e=this.controls.bottomleft,s.style.position="relative",s.style.paddingLeft="0px",s.style.paddingBottom="0px";break;case n.ControlAnchor.TOP_LEFT:e=this.controls.topleft,s.style.position="relative",s.style.paddingLeft="0px",s.style.paddingTop="0px";break;default:e=this.container,s.style.margin="0px",s.style.padding="0px"}this.controls.push(new n.Control(s,a,e)),s.style.display="inline-block"}},removeControl:function(s){return 0<=(s=t(this,s=n.getElement(s)))&&(this.controls[s].destroy(),this.controls.splice(s,1)),this},clearControls:function(){for(;0<this.controls.length;)this.controls.pop().destroy();return this},areControlsEnabled:function(){var s;for(s=this.controls.length-1;0<=s;s--)if(this.controls[s].isVisible())return!0;return!1},setControlsEnabled:function(s){var a;for(a=this.controls.length-1;0<=a;a--)this.controls[a].setVisible(s);return this}}}(OpenSeadragon),OpenSeadragon.Placement=OpenSeadragon.freezeObject({CENTER:0,TOP_LEFT:1,TOP:2,TOP_RIGHT:3,RIGHT:4,BOTTOM_RIGHT:5,BOTTOM:6,BOTTOM_LEFT:7,LEFT:8,properties:{0:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1},1:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},2:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},3:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!0,isVerticallyCentered:!1,isBottom:!1},4:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!0,isBottom:!1},5:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!1,isBottom:!0},6:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},7:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},8:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1}}}),function(n){var t={},s=1;function a(f){return f=n.getElement(f),new n.Point(0===f.clientWidth?1:f.clientWidth,0===f.clientHeight?1:f.clientHeight)}function e(f,p){if(p instanceof n.Overlay)return p;var m=null;if(p.element)m=n.getElement(p.element);else{var _=p.id||"openseadragon-overlay-"+Math.floor(1e7*Math.random());(m=n.getElement(p.id))||((m=document.createElement("a")).href="#/overlay/"+_),m.id=_,n.addClass(m,p.className||"openseadragon-overlay")}var x=p.location,F=p.width,O=p.height;if(!x){_=p.x;var k=p.y;void 0!==p.px&&(_=(f=f.viewport.imageToViewportRectangle(new n.Rect(p.px,p.py,F||0,O||0))).x,k=f.y,F=void 0!==F?f.width:void 0,O=void 0!==O?f.height:void 0),x=new n.Point(_,k)}return(k=p.placement)&&"string"===n.type(k)&&(k=n.Placement[p.placement.toUpperCase()]),new n.Overlay({element:m,location:x,placement:k,onDraw:p.onDraw,checkResize:p.checkResize,width:F,height:O,rotationMode:p.rotationMode})}function r(f,p){var m;for(m=f.length-1;0<=m;m--)if(f[m].element===p)return m;return-1}function i(f,p){return n.requestAnimationFrame(function(){p(f)})}function o(f){n.requestAnimationFrame(function(){!function(p){var m,_,x;if(p.controlsShouldFade){for(m=n.now(),_=1-(m-=p.controlsFadeBeginTime)/p.controlsFadeLength,_=Math.min(1,_),_=Math.max(0,_),x=p.controls.length-1;0<=x;x--)p.controls[x].autoFade&&p.controls[x].setOpacity(_);0<_&&o(p)}}(f)})}function h(f){f.autoHideControls&&(f.controlsShouldFade=!0,f.controlsFadeBeginTime=n.now()+f.controlsFadeDelay,window.setTimeout(function(){o(f)},f.controlsFadeDelay))}function l(f){var p;for(f.controlsShouldFade=!1,p=f.controls.length-1;0<=p;p--)f.controls[p].setOpacity(1)}function c(){l(this)}function u(){h(this)}function d(f){var p={tracker:f.eventSource,position:f.position,originalEvent:f.originalEvent,preventDefault:f.preventDefault};this.raiseEvent("canvas-contextmenu",p),f.preventDefault=p.preventDefault}function g(f){var p={originalEvent:f.originalEvent,preventDefaultAction:!1,preventVerticalPan:f.preventVerticalPan||!this.panVertical,preventHorizontalPan:f.preventHorizontalPan||!this.panHorizontal};if(this.raiseEvent("canvas-key",p),p.preventDefaultAction||f.ctrl||f.alt||f.meta)f.preventDefault=!1;else switch(f.keyCode){case 38:p.preventVerticalPan||(f.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new n.Point(0,-this.pixelsPerArrowPress))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 40:p.preventVerticalPan||(f.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new n.Point(0,this.pixelsPerArrowPress))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 37:p.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new n.Point(-this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 39:p.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new n.Point(this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),f.preventDefault=!0;break;default:f.preventDefault=!1}}function v(f){var p={originalEvent:f.originalEvent,preventDefaultAction:!1,preventVerticalPan:f.preventVerticalPan||!this.panVertical,preventHorizontalPan:f.preventHorizontalPan||!this.panHorizontal};if(this.raiseEvent("canvas-key",p),p.preventDefaultAction||f.ctrl||f.alt||f.meta)f.preventDefault=!1;else switch(f.keyCode){case 43:case 61:this.viewport.zoomBy(1.1),this.viewport.applyConstraints(),f.preventDefault=!0;break;case 45:this.viewport.zoomBy(.9),this.viewport.applyConstraints(),f.preventDefault=!0;break;case 48:this.viewport.goHome(),this.viewport.applyConstraints(),f.preventDefault=!0;break;case 119:case 87:p.preventVerticalPan||(f.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new n.Point(0,-40))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 115:case 83:p.preventVerticalPan||(f.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new n.Point(0,40))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 97:p.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new n.Point(-40,0))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 100:p.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new n.Point(40,0))),this.viewport.applyConstraints()),f.preventDefault=!0;break;case 114:this.viewport.setRotation(this.viewport.flipped?this.viewport.getRotation()-this.rotationIncrement:this.viewport.getRotation()+this.rotationIncrement),this.viewport.applyConstraints(),f.preventDefault=!0;break;case 82:this.viewport.setRotation(this.viewport.flipped?this.viewport.getRotation()+this.rotationIncrement:this.viewport.getRotation()-this.rotationIncrement),this.viewport.applyConstraints(),f.preventDefault=!0;break;case 102:this.viewport.toggleFlip(),f.preventDefault=!0;break;case 106:this.goToPreviousPage();break;case 107:this.goToNextPage();break;default:f.preventDefault=!1}}function w(f){document.activeElement===this.canvas||this.canvas.focus(),this.viewport.flipped&&(f.position.x=this.viewport.getContainerSize().x-f.position.x);var p={tracker:f.eventSource,position:f.position,quick:f.quick,shift:f.shift,originalEvent:f.originalEvent,originalTarget:f.originalTarget,preventDefaultAction:!1};this.raiseEvent("canvas-click",p),!p.preventDefaultAction&&this.viewport&&f.quick&&(!0===(p=this.gestureSettingsByDeviceType(f.pointerType)).clickToZoom&&(this.viewport.zoomBy(f.shift?1/this.zoomPerClick:this.zoomPerClick,p.zoomToRefPoint?this.viewport.pointFromPixel(f.position,!0):null),this.viewport.applyConstraints()),p.dblClickDragToZoom&&(!0===t[this.hash].draggingToZoom?(t[this.hash].lastClickTime=null,t[this.hash].draggingToZoom=!1):t[this.hash].lastClickTime=n.now()))}function T(f){var p,m={tracker:f.eventSource,position:f.position,shift:f.shift,originalEvent:f.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-double-click",m),!m.preventDefaultAction&&this.viewport&&(p=this.gestureSettingsByDeviceType(f.pointerType)).dblClickToZoom&&(this.viewport.zoomBy(f.shift?1/this.zoomPerClick:this.zoomPerClick,p.zoomToRefPoint?this.viewport.pointFromPixel(f.position,!0):null),this.viewport.applyConstraints())}function E(f){var p,m={tracker:f.eventSource,pointerType:f.pointerType,position:f.position,delta:f.delta,speed:f.speed,direction:f.direction,shift:f.shift,originalEvent:f.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag",m),p=this.gestureSettingsByDeviceType(f.pointerType),!m.preventDefaultAction&&this.viewport)if(p.dblClickDragToZoom&&t[this.hash].draggingToZoom){var _=Math.pow(this.zoomPerDblClickDrag,f.delta.y/50);this.viewport.zoomBy(_)}else p.dragToPan&&!t[this.hash].draggingToZoom&&(this.panHorizontal||(f.delta.x=0),this.panVertical||(f.delta.y=0),this.viewport.flipped&&(f.delta.x=-f.delta.x),this.constrainDuringPan&&(m=this.viewport.deltaPointsFromPixels(f.delta.negate()),this.viewport.centerSpringX.target.value+=m.x,this.viewport.centerSpringY.target.value+=m.y,_=this.viewport.getConstrainedBounds(),this.viewport.centerSpringX.target.value-=m.x,this.viewport.centerSpringY.target.value-=m.y,_.xConstrained&&(f.delta.x=0),_.yConstrained&&(f.delta.y=0)),this.viewport.panBy(this.viewport.deltaPointsFromPixels(f.delta.negate()),p.flickEnabled&&!this.constrainDuringPan))}function I(f){var p,m={tracker:f.eventSource,pointerType:f.pointerType,position:f.position,speed:f.speed,direction:f.direction,shift:f.shift,originalEvent:f.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag-end",m),p=this.gestureSettingsByDeviceType(f.pointerType),!m.preventDefaultAction&&this.viewport){if(!t[this.hash].draggingToZoom&&p.flickEnabled&&f.speed>=p.flickMinSpeed){var _=0;this.panHorizontal&&(_=p.flickMomentum*f.speed*Math.cos(f.direction)),m=0,this.panVertical&&(m=p.flickMomentum*f.speed*Math.sin(f.direction)),f=this.viewport.pixelFromPoint(this.viewport.getCenter(!0)),m=this.viewport.pointFromPixel(new n.Point(f.x-_,f.y-m)),this.viewport.panTo(m,!1)}this.viewport.applyConstraints()}p.dblClickDragToZoom&&!0===t[this.hash].draggingToZoom&&(t[this.hash].draggingToZoom=!1)}function H(f){this.raiseEvent("canvas-enter",{tracker:f.eventSource,pointerType:f.pointerType,position:f.position,buttons:f.buttons,pointers:f.pointers,insideElementPressed:f.insideElementPressed,buttonDownAny:f.buttonDownAny,originalEvent:f.originalEvent})}function j(f){this.raiseEvent("canvas-exit",{tracker:f.eventSource,pointerType:f.pointerType,position:f.position,buttons:f.buttons,pointers:f.pointers,insideElementPressed:f.insideElementPressed,buttonDownAny:f.buttonDownAny,originalEvent:f.originalEvent})}function V(f){if(this.raiseEvent("canvas-press",{tracker:f.eventSource,pointerType:f.pointerType,position:f.position,insideElementPressed:f.insideElementPressed,insideElementReleased:f.insideElementReleased,originalEvent:f.originalEvent}),this.gestureSettingsByDeviceType(f.pointerType).dblClickDragToZoom){var p=t[this.hash].lastClickTime;f=n.now(),null!==p&&(f-p<this.dblClickTimeThreshold&&(t[this.hash].draggingToZoom=!0),t[this.hash].lastClickTime=null)}}function K(f){this.raiseEvent("canvas-release",{tracker:f.eventSource,pointerType:f.pointerType,position:f.position,insideElementPressed:f.insideElementPressed,insideElementReleased:f.insideElementReleased,originalEvent:f.originalEvent})}function q(f){this.raiseEvent("canvas-nonprimary-press",{tracker:f.eventSource,position:f.position,pointerType:f.pointerType,button:f.button,buttons:f.buttons,originalEvent:f.originalEvent})}function Y(f){this.raiseEvent("canvas-nonprimary-release",{tracker:f.eventSource,position:f.position,pointerType:f.pointerType,button:f.button,buttons:f.buttons,originalEvent:f.originalEvent})}function Q(f){var p,m,_,x={tracker:f.eventSource,pointerType:f.pointerType,gesturePoints:f.gesturePoints,lastCenter:f.lastCenter,center:f.center,lastDistance:f.lastDistance,distance:f.distance,shift:f.shift,originalEvent:f.originalEvent,preventDefaultPanAction:!1,preventDefaultZoomAction:!1,preventDefaultRotateAction:!1};this.raiseEvent("canvas-pinch",x),this.viewport&&((p=this.gestureSettingsByDeviceType(f.pointerType)).pinchToZoom&&(!x.preventDefaultPanAction||!x.preventDefaultZoomAction)&&(m=this.viewport.pointFromPixel(f.center,!0),p.zoomToRefPoint&&!x.preventDefaultPanAction&&(_=this.viewport.pointFromPixel(f.lastCenter,!0).minus(m),this.panHorizontal||(_.x=0),this.panVertical||(_.y=0),this.viewport.panBy(_,!0)),x.preventDefaultZoomAction||this.viewport.zoomBy(f.distance/f.lastDistance,m,!0),this.viewport.applyConstraints()),p.pinchRotate&&!x.preventDefaultRotateAction&&(x=Math.atan2(f.gesturePoints[0].currentPos.y-f.gesturePoints[1].currentPos.y,f.gesturePoints[0].currentPos.x-f.gesturePoints[1].currentPos.x),f=Math.atan2(f.gesturePoints[0].lastPos.y-f.gesturePoints[1].lastPos.y,f.gesturePoints[0].lastPos.x-f.gesturePoints[1].lastPos.x),this.viewport.setRotation(this.viewport.getRotation()+(x-f)*(180/Math.PI))))}function et(f){var p,m,_;(_=n.now())-this._lastScrollTime>this.minScrollDeltaTime?(this._lastScrollTime=_,this.raiseEvent("canvas-scroll",p={tracker:f.eventSource,position:f.position,scroll:f.scroll,shift:f.shift,originalEvent:f.originalEvent,preventDefaultAction:!1,preventDefault:!0}),!p.preventDefaultAction&&this.viewport&&(this.viewport.flipped&&(f.position.x=this.viewport.getContainerSize().x-f.position.x),(m=this.gestureSettingsByDeviceType(f.pointerType)).scrollToZoom&&(_=Math.pow(this.zoomPerScroll,f.scroll),this.viewport.zoomBy(_,m.zoomToRefPoint?this.viewport.pointFromPixel(f.position,!0):null),this.viewport.applyConstraints())),f.preventDefault=p.preventDefault):f.preventDefault=!0}function $(f){t[this.hash].mouseInside=!0,l(this),this.raiseEvent("container-enter",{tracker:f.eventSource,pointerType:f.pointerType,position:f.position,buttons:f.buttons,pointers:f.pointers,insideElementPressed:f.insideElementPressed,buttonDownAny:f.buttonDownAny,originalEvent:f.originalEvent})}function S(f){f.pointers<1&&(t[this.hash].mouseInside=!1,t[this.hash].animating||h(this)),this.raiseEvent("container-exit",{tracker:f.eventSource,pointerType:f.pointerType,position:f.position,buttons:f.buttons,pointers:f.pointers,insideElementPressed:f.insideElementPressed,buttonDownAny:f.buttonDownAny,originalEvent:f.originalEvent})}function R(f){(function(p){if(!p._opening&&t[p.hash]){if(p.autoResize||t[p.hash].forceResize){if(p._autoResizePolling){_=a(p.container);var m=t[p.hash].prevContainerSize;_.equals(m)||(t[p.hash].needsResize=!0)}t[p.hash].needsResize&&function(x,F){var X,O=x.viewport,k=O.getZoom(),G=O.getCenter();if(O.resize(F,x.preserveImageSizeOnResize),O.panTo(G,!0),x.preserveImageSizeOnResize)X=t[x.hash].prevContainerSize.x/F.x;else{var J=new n.Point(0,0);G=new n.Point(t[x.hash].prevContainerSize.x,t[x.hash].prevContainerSize.y).distanceTo(J),X=(J=new n.Point(F.x,F.y).distanceTo(J))/G*t[x.hash].prevContainerSize.x/F.x}O.zoomTo(k*X,null,!0),t[x.hash].prevContainerSize=F,t[x.hash].forceRedraw=!0,t[x.hash].needsResize=!1,t[x.hash].forceResize=!1}(p,_||a(p.container))}m=p.viewport.update();var _=p.world.update()||m;m&&p.raiseEvent("viewport-change"),p.referenceStrip&&(_=p.referenceStrip.update(p.viewport)||_),!(m=t[p.hash].animating)&&_&&(p.raiseEvent("animation-start"),l(p)),(m=m&&!_)&&(t[p.hash].animating=!1),(_||m||t[p.hash].forceRedraw||p.world.needsDraw())&&((x=p).imageLoader.clear(),x.drawer.clear(),x.world.draw(),x.raiseEvent("update-viewport",{}),p._drawOverlays(),p.navigator&&p.navigator.update(p.viewport),t[p.hash].forceRedraw=!1,_&&p.raiseEvent("animation")),m&&(p.raiseEvent("animation-finish"),t[p.hash].mouseInside||h(p)),t[p.hash].animating=_}var x})(f),f._updateRequestId=!!f.isOpen()&&i(f,R)}function b(f,p){return f?f+p:p}function D(){t[this.hash].lastZoomTime=n.now(),t[this.hash].zoomFactor=this.zoomPerSecond,t[this.hash].zooming=!0,C(this)}function L(){t[this.hash].lastZoomTime=n.now(),t[this.hash].zoomFactor=1/this.zoomPerSecond,t[this.hash].zooming=!0,C(this)}function P(){t[this.hash].zooming=!1}function C(f){n.requestAnimationFrame(n.delegate(f,M))}function M(){var f,p;t[this.hash].zooming&&this.viewport&&(p=(f=n.now())-t[this.hash].lastZoomTime,p=Math.pow(t[this.hash].zoomFactor,p/1e3),this.viewport.zoomBy(p),this.viewport.applyConstraints(),t[this.hash].lastZoomTime=f,C(this))}function A(){this.viewport&&(t[this.hash].zooming=!1,this.viewport.zoomBy(+this.zoomPerClick),this.viewport.applyConstraints())}function N(){this.viewport&&(t[this.hash].zooming=!1,this.viewport.zoomBy(1/this.zoomPerClick),this.viewport.applyConstraints())}function B(){this.buttonGroup&&(this.buttonGroup.emulateEnter(),this.buttonGroup.emulateLeave())}function W(){this.viewport&&this.viewport.goHome()}function U(){this.isFullPage()&&!n.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage()),this.buttonGroup&&this.buttonGroup.emulateLeave(),this.fullPageButton.element.focus(),this.viewport&&this.viewport.applyConstraints()}function Z(){if(this.viewport){var f=this.viewport.getRotation();this.viewport.flipped?f+=this.rotationIncrement:f-=this.rotationIncrement,this.viewport.setRotation(f)}}function z(){if(this.viewport){var f=this.viewport.getRotation();this.viewport.flipped?f-=this.rotationIncrement:f+=this.rotationIncrement,this.viewport.setRotation(f)}}function y(){this.viewport.toggleFlip()}n.Viewer=function(f){var p,x,m=arguments,_=this;if((f=n.isPlainObject(f)?f:{id:m[0],xmlPath:1<m.length?m[1]:void 0,prefixUrl:2<m.length?m[2]:void 0,controls:3<m.length?m[3]:void 0,overlays:4<m.length?m[4]:void 0}).config&&(n.extend(!0,f,f.config),delete f.config),n.extend(!0,this,{id:f.id,hash:f.hash||s++,initialPage:0,element:null,container:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,world:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttonGroup:null,profiler:null},n.DEFAULT_SETTINGS,f),void 0===this.hash)throw new Error("A hash must be defined, either by specifying options.id or options.hash.");for(void 0!==t[this.hash]&&n.console.warn("Hash "+this.hash+" has already been used."),t[this.hash]={fsBoundsDelta:new n.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,needsResize:!1,forceResize:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,fullPage:!1,onfullscreenchange:null,lastClickTime:null,draggingToZoom:!1},this._sequenceIndex=0,this._firstOpen=!0,this._updateRequestId=null,this._loadQueue=[],this.currentOverlays=[],this._updatePixelDensityRatioBind=null,this._lastScrollTime=n.now(),n.EventSource.call(this),this.addHandler("open-failed",function(x){x=n.getString("Errors.OpenFailed",x.eventSource,x.message),_._showMessage(x)}),n.ControlDock.call(this,f),this.xmlPath&&(this.tileSources=[this.xmlPath]),this.element=this.element||document.getElementById(this.id),this.canvas=n.makeNeutralElement("div"),this.canvas.className="openseadragon-canvas",(x=this.canvas.style).width="100%",x.height="100%",x.overflow="hidden",x.position="absolute",x.top="0px",x.left="0px",n.setElementTouchActionNone(this.canvas),""!==f.tabIndex&&(this.canvas.tabIndex=void 0===f.tabIndex?0:f.tabIndex),this.container.className="openseadragon-container",function(x){x.width="100%",x.height="100%",x.position="relative",x.overflow="hidden",x.left="0px",x.top="0px",x.textAlign="left"}(this.container.style),n.setElementTouchActionNone(this.container),this.container.insertBefore(this.canvas,this.container.firstChild),this.element.appendChild(this.container),this.bodyWidth=document.body.style.width,this.bodyHeight=document.body.style.height,this.bodyOverflow=document.body.style.overflow,this.docOverflow=document.documentElement.style.overflow,this.innerTracker=new n.MouseTracker({userData:"Viewer.innerTracker",element:this.canvas,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,contextMenuHandler:n.delegate(this,d),keyDownHandler:n.delegate(this,g),keyHandler:n.delegate(this,v),clickHandler:n.delegate(this,w),dblClickHandler:n.delegate(this,T),dragHandler:n.delegate(this,E),dragEndHandler:n.delegate(this,I),enterHandler:n.delegate(this,H),leaveHandler:n.delegate(this,j),pressHandler:n.delegate(this,V),releaseHandler:n.delegate(this,K),nonPrimaryPressHandler:n.delegate(this,q),nonPrimaryReleaseHandler:n.delegate(this,Y),scrollHandler:n.delegate(this,et),pinchHandler:n.delegate(this,Q)}),this.outerTracker=new n.MouseTracker({userData:"Viewer.outerTracker",element:this.container,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:n.delegate(this,$),leaveHandler:n.delegate(this,S)}),this.toolbar&&(this.toolbar=new n.ControlDock({element:this.toolbar})),this.bindStandardControls(),t[this.hash].prevContainerSize=a(this.container),window.ResizeObserver?(this._autoResizePolling=!1,this._resizeObserver=new ResizeObserver(function(){t[_.hash].needsResize=!0}),this._resizeObserver.observe(this.container,{})):this._autoResizePolling=!0,this.world=new n.World({viewer:this}),this.world.addHandler("add-item",function(x){_.source=_.world.getItemAt(0).source,t[_.hash].forceRedraw=!0,_._updateRequestId||(_._updateRequestId=i(_,R))}),this.world.addHandler("remove-item",function(x){_.source=_.world.getItemCount()?_.world.getItemAt(0).source:null,t[_.hash].forceRedraw=!0}),this.world.addHandler("metrics-change",function(x){_.viewport&&_.viewport._setContentBounds(_.world.getHomeBounds(),_.world.getContentFactor())}),this.world.addHandler("item-index-change",function(x){_.source=_.world.getItemAt(0).source}),this.viewport=new n.Viewport({containerSize:t[this.hash].prevContainerSize,springStiffness:this.springStiffness,animationTime:this.animationTime,minZoomImageRatio:this.minZoomImageRatio,maxZoomPixelRatio:this.maxZoomPixelRatio,visibilityRatio:this.visibilityRatio,wrapHorizontal:this.wrapHorizontal,wrapVertical:this.wrapVertical,defaultZoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel,viewer:this,degrees:this.degrees,flipped:this.flipped,navigatorRotate:this.navigatorRotate,homeFillsViewer:this.homeFillsViewer,margins:this.viewportMargins,silenceMultiImageWarnings:this.silenceMultiImageWarnings}),this.viewport._setContentBounds(this.world.getHomeBounds(),this.world.getContentFactor()),this.imageLoader=new n.ImageLoader({jobLimit:this.imageLoaderLimit,timeout:f.timeout}),this.tileCache=new n.TileCache({maxImageCacheCount:this.maxImageCacheCount}),this.drawer=new n.Drawer({viewer:this,viewport:this.viewport,element:this.canvas,debugGridColor:this.debugGridColor}),this.overlaysContainer=n.makeNeutralElement("div"),this.canvas.appendChild(this.overlaysContainer),this.drawer.canRotate()||(this.rotateLeft&&(p=this.buttonGroup.buttons.indexOf(this.rotateLeft),this.buttonGroup.buttons.splice(p,1),this.buttonGroup.element.removeChild(this.rotateLeft.element)),this.rotateRight&&(p=this.buttonGroup.buttons.indexOf(this.rotateRight),this.buttonGroup.buttons.splice(p,1),this.buttonGroup.element.removeChild(this.rotateRight.element))),this._addUpdatePixelDensityRatioEvent(),this.showNavigator&&(this.navigator=new n.Navigator({element:this.navigatorElement,id:this.navigatorId,position:this.navigatorPosition,sizeRatio:this.navigatorSizeRatio,maintainSizeRatio:this.navigatorMaintainSizeRatio,top:this.navigatorTop,left:this.navigatorLeft,width:this.navigatorWidth,height:this.navigatorHeight,autoResize:this.navigatorAutoResize,autoFade:this.navigatorAutoFade,prefixUrl:this.prefixUrl,viewer:this,navigatorRotate:this.navigatorRotate,background:this.navigatorBackground,opacity:this.navigatorOpacity,borderColor:this.navigatorBorderColor,displayRegionColor:this.navigatorDisplayRegionColor,crossOriginPolicy:this.crossOriginPolicy,animationTime:this.animationTime})),this.sequenceMode&&this.bindSequenceControls(),this.tileSources&&this.open(this.tileSources),p=0;p<this.customControls.length;p++)this.addControl(this.customControls[p].id,{anchor:this.customControls[p].anchor});n.requestAnimationFrame(function(){h(_)}),void 0===this.imageSmoothingEnabled||this.imageSmoothingEnabled||this.drawer.setImageSmoothingEnabled(this.imageSmoothingEnabled),n._viewers.set(this.element,this)},n.extend(n.Viewer.prototype,n.EventSource.prototype,n.ControlDock.prototype,{isOpen:function(){return!!this.world.getItemCount()},openDzi:function(f){return n.console.error("[Viewer.openDzi] this function is deprecated; use Viewer.open() instead."),this.open(f)},openTileSource:function(f){return n.console.error("[Viewer.openTileSource] this function is deprecated; use Viewer.open() instead."),this.open(f)},get buttons(){return n.console.warn("Viewer.buttons is deprecated; Please use Viewer.buttonGroup"),this.buttonGroup},open:function(f,p){var m=this;if(this.close(),!f)return this;if(this.sequenceMode&&n.isArray(f))return this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),void 0===p||isNaN(p)||(this.initialPage=p),this.tileSources=f,this._sequenceIndex=Math.max(0,Math.min(this.tileSources.length-1,this.initialPage)),this.tileSources.length&&(this.open(this.tileSources[this._sequenceIndex]),this.showReferenceStrip&&this.addReferenceStrip()),this._updateSequenceButtons(this._sequenceIndex),this;if(!(f=n.isArray(f)?f:[f]).length)return this;this._opening=!0;for(var O,_=f.length,x=0,F=0,k=function(){if(x+F===_)if(x){(m._firstOpen||!m.preserveViewport)&&(m.viewport.goHome(!0),m.viewport.update()),m._firstOpen=!1;var X=f[0];if(X.tileSource&&(X=X.tileSource),m.overlays&&!m.preserveOverlays)for(var J=0;J<m.overlays.length;J++)m.currentOverlays[J]=e(m,m.overlays[J]);m._drawOverlays(),m._opening=!1,m.raiseEvent("open",{source:X})}else m._opening=!1,m.raiseEvent("open-failed",O)},G=0;G<f.length;G++)!function(X){void 0!==(X=n.isPlainObject(X)&&X.tileSource?X:{tileSource:X}).index&&(n.console.error("[Viewer.open] setting indexes here is not supported; use addTiledImage instead"),delete X.index),void 0===X.collectionImmediately&&(X.collectionImmediately=!0);var J=X.success;X.success=function(tt){if(x++,X.tileSource.overlays)for(var rt=0;rt<X.tileSource.overlays.length;rt++)m.addOverlay(X.tileSource.overlays[rt]);J&&J(tt),k()};var it=X.error;X.error=function(tt){F++,O=O||tt,it&&it(tt),k()},m.addTiledImage(X)}(f[G]);return this},close:function(){return t[this.hash]?(this._opening=!1,this.navigator&&this.navigator.close(),this.preserveOverlays||(this.clearOverlays(),this.overlaysContainer.innerHTML=""),t[this.hash].animating=!1,this.world.removeAll(),this.imageLoader.clear(),this.raiseEvent("close"),this):this},destroy:function(){if(t[this.hash]){if(this.raiseEvent("before-destroy"),this._removeUpdatePixelDensityRatioEvent(),this.close(),this.clearOverlays(),this.overlaysContainer.innerHTML="",this._resizeObserver&&this._resizeObserver.disconnect(),this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),null!==this._updateRequestId&&(n.cancelAnimationFrame(this._updateRequestId),this._updateRequestId=null),this.drawer&&this.drawer.destroy(),this.navigator&&(this.navigator.destroy(),t[this.navigator.hash]=null,delete t[this.navigator.hash],this.navigator=null),this.buttonGroup)this.buttonGroup.destroy();else if(this.customButtons)for(;this.customButtons.length;)this.customButtons.pop().destroy();if(this.paging&&this.paging.destroy(),this.element)for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.container.onsubmit=null,this.clearControls(),this.innerTracker&&this.innerTracker.destroy(),this.outerTracker&&this.outerTracker.destroy(),t[this.hash]=null,delete t[this.hash],this.canvas=null,this.container=null,n._viewers.delete(this.element),this.element=null,this.raiseEvent("destroy"),this.removeAllHandlers()}},isMouseNavEnabled:function(){return this.innerTracker.isTracking()},setMouseNavEnabled:function(f){return this.innerTracker.setTracking(f),this.outerTracker.setTracking(f),this.raiseEvent("mouse-enabled",{enabled:f}),this},areControlsEnabled:function(){var f,p=this.controls.length;for(f=0;f<this.controls.length;f++)p=p&&this.controls[f].isVisible();return p},setControlsEnabled:function(f){return(f?l:h)(this),this.raiseEvent("controls-enabled",{enabled:f}),this},setDebugMode:function(f){for(var p=0;p<this.world.getItemCount();p++)this.world.getItemAt(p).debugMode=f;this.debugMode=f,this.forceRedraw()},isFullPage:function(){return t[this.hash].fullPage},setFullPage:function(f){var p,m,_=document.body,x=_.style,F=document.documentElement.style,O=this;if(f===this.isFullPage())return this;var k={fullPage:f,preventDefaultAction:!1};if(this.raiseEvent("pre-full-page",k),k.preventDefaultAction)return this;if(f){for(this.elementSize=n.getElementSize(this.element),this.pageScroll=n.getPageScroll(),this.elementMargin=this.element.style.margin,this.element.style.margin="0",this.elementPadding=this.element.style.padding,this.element.style.padding="0",this.bodyMargin=x.margin,this.docMargin=F.margin,x.margin="0",F.margin="0",this.bodyPadding=x.padding,this.docPadding=F.padding,x.padding="0",F.padding="0",this.bodyWidth=x.width,this.docWidth=F.width,x.width="100%",F.width="100%",this.bodyHeight=x.height,this.docHeight=F.height,x.height="100%",F.height="100%",this.bodyDisplay=x.display,x.display="block",this.previousBody=[],t[this.hash].prevElementParent=this.element.parentNode,t[this.hash].prevNextSibling=this.element.nextSibling,t[this.hash].prevElementWidth=this.element.style.width,t[this.hash].prevElementHeight=this.element.style.height,p=_.childNodes.length,m=0;m<p;m++)this.previousBody.push(_.childNodes[0]),_.removeChild(_.childNodes[0]);this.toolbar&&this.toolbar.element&&(this.toolbar.parentNode=this.toolbar.element.parentNode,this.toolbar.nextSibling=this.toolbar.element.nextSibling,_.appendChild(this.toolbar.element),n.addClass(this.toolbar.element,"fullpage")),n.addClass(this.element,"fullpage"),_.appendChild(this.element),this.element.style.height="100vh",this.element.style.width="100vw",this.toolbar&&this.toolbar.element&&(this.element.style.height=n.getElementSize(this.element).y-n.getElementSize(this.toolbar.element).y+"px"),t[this.hash].fullPage=!0,n.delegate(this,$)({})}else{for(this.element.style.margin=this.elementMargin,this.element.style.padding=this.elementPadding,x.margin=this.bodyMargin,F.margin=this.docMargin,x.padding=this.bodyPadding,F.padding=this.docPadding,x.width=this.bodyWidth,F.width=this.docWidth,x.height=this.bodyHeight,F.height=this.docHeight,x.display=this.bodyDisplay,_.removeChild(this.element),p=this.previousBody.length,m=0;m<p;m++)_.appendChild(this.previousBody.shift());n.removeClass(this.element,"fullpage"),t[this.hash].prevElementParent.insertBefore(this.element,t[this.hash].prevNextSibling),this.toolbar&&this.toolbar.element&&(_.removeChild(this.toolbar.element),n.removeClass(this.toolbar.element,"fullpage"),this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling),delete this.toolbar.parentNode,delete this.toolbar.nextSibling),this.element.style.width=t[this.hash].prevElementWidth,this.element.style.height=t[this.hash].prevElementHeight;var G=0,X=function(){n.setPageScroll(O.pageScroll);var J=n.getPageScroll();++G<10&&(J.x!==O.pageScroll.x||J.y!==O.pageScroll.y)&&n.requestAnimationFrame(X)};n.requestAnimationFrame(X),t[this.hash].fullPage=!1,n.delegate(this,S)({})}return this.navigator&&this.viewport&&this.navigator.update(this.viewport),this.raiseEvent("full-page",{fullPage:f}),this},setFullScreen:function(f){var p=this;if(!n.supportsFullScreen)return this.setFullPage(f);if(n.isFullScreen()===f)return this;var m={fullScreen:f,preventDefaultAction:!1};if(this.raiseEvent("pre-full-screen",m),m.preventDefaultAction)return this;if(f){if(this.setFullPage(!0),!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width,this.fullPageStyleHeight=this.element.style.height,this.element.style.width="100%",this.element.style.height="100%";var _=function(){var x=n.isFullScreen();x||(n.removeEvent(document,n.fullScreenEventName,_),n.removeEvent(document,n.fullScreenErrorEventName,_),p.setFullPage(!1),p.isFullPage()&&(p.element.style.width=p.fullPageStyleWidth,p.element.style.height=p.fullPageStyleHeight)),p.navigator&&p.viewport&&setTimeout(function(){p.navigator.update(p.viewport)}),p.raiseEvent("full-screen",{fullScreen:x})};n.addEvent(document,n.fullScreenEventName,_),n.addEvent(document,n.fullScreenErrorEventName,_),n.requestFullScreen(document.body)}else n.exitFullScreen();return this},isVisible:function(){return"hidden"!==this.container.style.visibility},isFullScreen:function(){return n.isFullScreen()&&this.isFullPage()},setVisible:function(f){return this.container.style.visibility=f?"":"hidden",this.raiseEvent("visible",{visible:f}),this},addTiledImage:function(f){n.console.assert(f,"[Viewer.addTiledImage] options is required"),n.console.assert(f.tileSource,"[Viewer.addTiledImage] options.tileSource is required"),n.console.assert(!f.replace||-1<f.index&&f.index<this.world.getItemCount(),"[Viewer.addTiledImage] if options.replace is used, options.index must be a valid index in Viewer.world");var p=this;f.replace&&(f.replaceItem=p.world.getItemAt(f.index)),this._hideMessage(),void 0===f.placeholderFillStyle&&(f.placeholderFillStyle=this.placeholderFillStyle),void 0===f.opacity&&(f.opacity=this.opacity),void 0===f.preload&&(f.preload=this.preload),void 0===f.compositeOperation&&(f.compositeOperation=this.compositeOperation),void 0===f.crossOriginPolicy&&(f.crossOriginPolicy=(void 0!==f.tileSource.crossOriginPolicy?f.tileSource:this).crossOriginPolicy),void 0===f.ajaxWithCredentials&&(f.ajaxWithCredentials=this.ajaxWithCredentials),void 0===f.loadTilesWithAjax&&(f.loadTilesWithAjax=this.loadTilesWithAjax),null==f.ajaxHeaders?f.ajaxHeaders=this.ajaxHeaders:n.isPlainObject(f.ajaxHeaders)&&n.isPlainObject(this.ajaxHeaders)&&(f.ajaxHeaders=n.extend({},this.ajaxHeaders,f.ajaxHeaders));var m={options:f};function _(O){for(var k=0;k<p._loadQueue.length;k++)if(p._loadQueue[k]===m){p._loadQueue.splice(k,1);break}0===p._loadQueue.length&&x(m),p.raiseEvent("add-item-failed",O),f.error&&f.error(O)}function x(O){p.collectionMode&&(p.world.arrange({immediately:O.options.collectionImmediately,rows:p.collectionRows,columns:p.collectionColumns,layout:p.collectionLayout,tileSize:p.collectionTileSize,tileMargin:p.collectionTileMargin}),p.world.setAutoRefigureSizes(!0))}function F(){for(var O,k;p._loadQueue.length&&(O=p._loadQueue[0]).tileSource;){if(p._loadQueue.splice(0,1),O.options.replace){var G=p.world.getIndexOfItem(O.options.replaceItem);-1!==G&&(O.options.index=G),p.world.removeItem(O.options.replaceItem)}k=new n.TiledImage({viewer:p,source:O.tileSource,viewport:p.viewport,drawer:p.drawer,tileCache:p.tileCache,imageLoader:p.imageLoader,x:O.options.x,y:O.options.y,width:O.options.width,height:O.options.height,fitBounds:O.options.fitBounds,fitBoundsPlacement:O.options.fitBoundsPlacement,clip:O.options.clip,placeholderFillStyle:O.options.placeholderFillStyle,opacity:O.options.opacity,preload:O.options.preload,degrees:O.options.degrees,flipped:O.options.flipped,compositeOperation:O.options.compositeOperation,springStiffness:p.springStiffness,animationTime:p.animationTime,minZoomImageRatio:p.minZoomImageRatio,wrapHorizontal:p.wrapHorizontal,wrapVertical:p.wrapVertical,immediateRender:p.immediateRender,blendTime:p.blendTime,alwaysBlend:p.alwaysBlend,minPixelRatio:p.minPixelRatio,smoothTileEdgesMinZoom:p.smoothTileEdgesMinZoom,iOSDevice:p.iOSDevice,crossOriginPolicy:O.options.crossOriginPolicy,ajaxWithCredentials:O.options.ajaxWithCredentials,loadTilesWithAjax:O.options.loadTilesWithAjax,ajaxHeaders:O.options.ajaxHeaders,debugMode:p.debugMode,subPixelRoundingForTransparency:p.subPixelRoundingForTransparency}),p.collectionMode&&p.world.setAutoRefigureSizes(!1),p.navigator&&(G=n.extend({},O.options,{replace:!1,originalTiledImage:k,tileSource:O.tileSource}),p.navigator.addTiledImage(G)),p.world.addItem(k,{index:O.options.index}),0===p._loadQueue.length&&x(O),1!==p.world.getItemCount()||p.preserveViewport||p.viewport.goHome(!0),O.options.success&&O.options.success({item:k})}}n.isArray(f.tileSource)?setTimeout(function(){_({message:"[Viewer.addTiledImage] Sequences can not be added; add them one at a time instead.",source:f.tileSource,options:f})}):(this._loadQueue.push(m),function(O,k,G,X,J){var it=O;if("string"===n.type(k))if(k.match(/^\s*<.*>\s*$/))k=n.parseXml(k);else if(k.match(/^\s*[{[].*[}\]]\s*$/))try{var tt=n.parseJSON(k);k=tt}catch(nt){}function rt(nt,st){nt.ready?X(nt):(nt.addHandler("ready",function(){X(nt)}),nt.addHandler("open-failed",function(ot){J({message:ot.message,source:st})}))}setTimeout(function(){if("string"===n.type(k))(k=new n.TileSource({url:k,crossOriginPolicy:(void 0!==G.crossOriginPolicy?G:O).crossOriginPolicy,ajaxWithCredentials:O.ajaxWithCredentials,ajaxHeaders:G.ajaxHeaders||O.ajaxHeaders,splitHashDataForPost:O.splitHashDataForPost,useCanvas:O.useCanvas,success:function(ot){X(ot.tileSource)}})).addHandler("open-failed",function(ot){J(ot)});else if(n.isPlainObject(k)||k.nodeType)if(void 0!==k.crossOriginPolicy||void 0===G.crossOriginPolicy&&void 0===O.crossOriginPolicy||(k.crossOriginPolicy=(void 0!==G.crossOriginPolicy?G:O).crossOriginPolicy),void 0===k.ajaxWithCredentials&&(k.ajaxWithCredentials=O.ajaxWithCredentials),void 0===k.useCanvas&&(k.useCanvas=O.useCanvas),n.isFunction(k.getTileUrl)){var nt=new n.TileSource(k);nt.getTileUrl=k.getTileUrl,X(nt)}else{var st=n.TileSource.determineType(it,k);st?(nt=st.prototype.configure.apply(it,[k]),rt(new st(nt),k)):J({message:"Unable to load TileSource",source:k})}else rt(k,k)})}(this,f.tileSource,f,function(O){m.tileSource=O,F()},function(O){O.options=f,_(O),F()}))},addSimpleImage:function(f){n.console.assert(f,"[Viewer.addSimpleImage] options is required"),n.console.assert(f.url,"[Viewer.addSimpleImage] options.url is required"),delete(f=n.extend({},f,{tileSource:{type:"image",url:f.url}})).url,this.addTiledImage(f)},addLayer:function(f){var p=this;n.console.error("[Viewer.addLayer] this function is deprecated; use Viewer.addTiledImage() instead.");var m=n.extend({},f,{success:function(_){p.raiseEvent("add-layer",{options:f,drawer:_.item})},error:function(_){p.raiseEvent("add-layer-failed",_)}});return this.addTiledImage(m),this},getLayerAtLevel:function(f){return n.console.error("[Viewer.getLayerAtLevel] this function is deprecated; use World.getItemAt() instead."),this.world.getItemAt(f)},getLevelOfLayer:function(f){return n.console.error("[Viewer.getLevelOfLayer] this function is deprecated; use World.getIndexOfItem() instead."),this.world.getIndexOfItem(f)},getLayersCount:function(){return n.console.error("[Viewer.getLayersCount] this function is deprecated; use World.getItemCount() instead."),this.world.getItemCount()},setLayerLevel:function(f,p){return n.console.error("[Viewer.setLayerLevel] this function is deprecated; use World.setItemIndex() instead."),this.world.setItemIndex(f,p)},removeLayer:function(f){return n.console.error("[Viewer.removeLayer] this function is deprecated; use World.removeItem() instead."),this.world.removeItem(f)},forceRedraw:function(){return t[this.hash].forceRedraw=!0,this},forceResize:function(){t[this.hash].needsResize=!0,t[this.hash].forceResize=!0},bindSequenceControls:function(){var f=n.delegate(this,c),p=n.delegate(this,u),m=n.delegate(this,this.goToNextPage),_=n.delegate(this,this.goToPreviousPage),x=this.navImages,F=!0;return this.showSequenceControl&&((this.previousButton||this.nextButton)&&(F=!1),this.previousButton=new n.Button({element:this.previousButton?n.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:n.getString("Tooltips.PreviousPage"),srcRest:b(this.prefixUrl,x.previous.REST),srcGroup:b(this.prefixUrl,x.previous.GROUP),srcHover:b(this.prefixUrl,x.previous.HOVER),srcDown:b(this.prefixUrl,x.previous.DOWN),onRelease:_,onFocus:f,onBlur:p}),this.nextButton=new n.Button({element:this.nextButton?n.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:n.getString("Tooltips.NextPage"),srcRest:b(this.prefixUrl,x.next.REST),srcGroup:b(this.prefixUrl,x.next.GROUP),srcHover:b(this.prefixUrl,x.next.HOVER),srcDown:b(this.prefixUrl,x.next.DOWN),onRelease:m,onFocus:f,onBlur:p}),this.navPrevNextWrap||this.previousButton.disable(),this.tileSources&&this.tileSources.length||this.nextButton.disable(),F&&(this.paging=new n.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.pagingControl=this.paging.element,this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:n.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||n.ControlAnchor.TOP_LEFT}))),this},bindStandardControls:function(){var f=n.delegate(this,D),p=n.delegate(this,P),m=n.delegate(this,A),_=n.delegate(this,L),x=n.delegate(this,N),F=n.delegate(this,W),O=n.delegate(this,U),k=n.delegate(this,Z),G=n.delegate(this,z),X=n.delegate(this,y),J=n.delegate(this,c),it=n.delegate(this,u),tt=this.navImages,rt=[],nt=!0;return this.showNavigationControl&&((this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton||this.flipButton)&&(nt=!1),this.showZoomControl&&(rt.push(this.zoomInButton=new n.Button({element:this.zoomInButton?n.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:n.getString("Tooltips.ZoomIn"),srcRest:b(this.prefixUrl,tt.zoomIn.REST),srcGroup:b(this.prefixUrl,tt.zoomIn.GROUP),srcHover:b(this.prefixUrl,tt.zoomIn.HOVER),srcDown:b(this.prefixUrl,tt.zoomIn.DOWN),onPress:f,onRelease:p,onClick:m,onEnter:f,onExit:p,onFocus:J,onBlur:it})),rt.push(this.zoomOutButton=new n.Button({element:this.zoomOutButton?n.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:n.getString("Tooltips.ZoomOut"),srcRest:b(this.prefixUrl,tt.zoomOut.REST),srcGroup:b(this.prefixUrl,tt.zoomOut.GROUP),srcHover:b(this.prefixUrl,tt.zoomOut.HOVER),srcDown:b(this.prefixUrl,tt.zoomOut.DOWN),onPress:_,onRelease:p,onClick:x,onEnter:_,onExit:p,onFocus:J,onBlur:it}))),this.showHomeControl&&rt.push(this.homeButton=new n.Button({element:this.homeButton?n.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:n.getString("Tooltips.Home"),srcRest:b(this.prefixUrl,tt.home.REST),srcGroup:b(this.prefixUrl,tt.home.GROUP),srcHover:b(this.prefixUrl,tt.home.HOVER),srcDown:b(this.prefixUrl,tt.home.DOWN),onRelease:F,onFocus:J,onBlur:it})),this.showFullPageControl&&rt.push(this.fullPageButton=new n.Button({element:this.fullPageButton?n.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:n.getString("Tooltips.FullPage"),srcRest:b(this.prefixUrl,tt.fullpage.REST),srcGroup:b(this.prefixUrl,tt.fullpage.GROUP),srcHover:b(this.prefixUrl,tt.fullpage.HOVER),srcDown:b(this.prefixUrl,tt.fullpage.DOWN),onRelease:O,onFocus:J,onBlur:it})),this.showRotationControl&&(rt.push(this.rotateLeftButton=new n.Button({element:this.rotateLeftButton?n.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:n.getString("Tooltips.RotateLeft"),srcRest:b(this.prefixUrl,tt.rotateleft.REST),srcGroup:b(this.prefixUrl,tt.rotateleft.GROUP),srcHover:b(this.prefixUrl,tt.rotateleft.HOVER),srcDown:b(this.prefixUrl,tt.rotateleft.DOWN),onRelease:k,onFocus:J,onBlur:it})),rt.push(this.rotateRightButton=new n.Button({element:this.rotateRightButton?n.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:n.getString("Tooltips.RotateRight"),srcRest:b(this.prefixUrl,tt.rotateright.REST),srcGroup:b(this.prefixUrl,tt.rotateright.GROUP),srcHover:b(this.prefixUrl,tt.rotateright.HOVER),srcDown:b(this.prefixUrl,tt.rotateright.DOWN),onRelease:G,onFocus:J,onBlur:it}))),this.showFlipControl&&rt.push(this.flipButton=new n.Button({element:this.flipButton?n.getElement(this.flipButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:n.getString("Tooltips.Flip"),srcRest:b(this.prefixUrl,tt.flip.REST),srcGroup:b(this.prefixUrl,tt.flip.GROUP),srcHover:b(this.prefixUrl,tt.flip.HOVER),srcDown:b(this.prefixUrl,tt.flip.DOWN),onRelease:X,onFocus:J,onBlur:it})),nt?(this.buttonGroup=new n.ButtonGroup({buttons:rt,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.navControl=this.buttonGroup.element,this.addHandler("open",n.delegate(this,B)),(this.toolbar||this).addControl(this.navControl,{anchor:this.navigationControlAnchor||n.ControlAnchor.TOP_LEFT})):this.customButtons=rt),this},currentPage:function(){return this._sequenceIndex},goToPage:function(f){return this.tileSources&&0<=f&&f<this.tileSources.length&&(this._sequenceIndex=f,this._updateSequenceButtons(f),this.open(this.tileSources[f]),this.referenceStrip&&this.referenceStrip.setFocus(f),this.raiseEvent("page",{page:f})),this},addOverlay:function(f,p,m,_){return m=n.isPlainObject(f)?f:{element:f,location:p,placement:m,onDraw:_},f=n.getElement(m.element),0<=r(this.currentOverlays,f)||(_=e(this,m),this.currentOverlays.push(_),_.drawHTML(this.overlaysContainer,this.viewport),this.raiseEvent("add-overlay",{element:f,location:m.location,placement:m.placement})),this},updateOverlay:function(f,p,m){var _;return f=n.getElement(f),0<=(_=r(this.currentOverlays,f))&&(this.currentOverlays[_].update(p,m),t[this.hash].forceRedraw=!0,this.raiseEvent("update-overlay",{element:f,location:p,placement:m})),this},removeOverlay:function(f){var p;return f=n.getElement(f),0<=(p=r(this.currentOverlays,f))&&(this.currentOverlays[p].destroy(),this.currentOverlays.splice(p,1),t[this.hash].forceRedraw=!0,this.raiseEvent("remove-overlay",{element:f})),this},clearOverlays:function(){for(;0<this.currentOverlays.length;)this.currentOverlays.pop().destroy();return t[this.hash].forceRedraw=!0,this.raiseEvent("clear-overlay",{}),this},getOverlayById:function(f){return f=n.getElement(f),0<=(f=r(this.currentOverlays,f))?this.currentOverlays[f]:null},_updateSequenceButtons:function(f){this.nextButton&&(this.tileSources&&this.tileSources.length-1!==f?this.nextButton.enable():this.navPrevNextWrap||this.nextButton.disable()),this.previousButton&&(0<f?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(f){this._hideMessage();var p=n.makeNeutralElement("div");p.appendChild(document.createTextNode(f)),this.messageDiv=n.makeCenteredNode(p),n.addClass(this.messageDiv,"openseadragon-message"),this.container.appendChild(this.messageDiv)},_hideMessage:function(){var f=this.messageDiv;f&&(f.parentNode.removeChild(f),delete this.messageDiv)},gestureSettingsByDeviceType:function(f){switch(f){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}},_drawOverlays:function(){var f,p=this.currentOverlays.length;for(f=0;f<p;f++)this.currentOverlays[f].drawHTML(this.overlaysContainer,this.viewport)},_cancelPendingImages:function(){this._loadQueue=[]},removeReferenceStrip:function(){this.showReferenceStrip=!1,this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null)},addReferenceStrip:function(){this.showReferenceStrip=!0,this.sequenceMode?!this.referenceStrip&&this.tileSources.length&&1<this.tileSources.length&&(this.referenceStrip=new n.ReferenceStrip({id:this.referenceStripElement,position:this.referenceStripPosition,sizeRatio:this.referenceStripSizeRatio,scroll:this.referenceStripScroll,height:this.referenceStripHeight,width:this.referenceStripWidth,tileSources:this.tileSources,prefixUrl:this.prefixUrl,useCanvas:this.useCanvas,viewer:this}),this.referenceStrip.setFocus(this._sequenceIndex)):n.console.warn('Attempting to display a reference strip while "sequenceMode" is off.')},_addUpdatePixelDensityRatioEvent:function(){this._updatePixelDensityRatioBind=this._updatePixelDensityRatio.bind(this),n.addEvent(window,"resize",this._updatePixelDensityRatioBind)},_removeUpdatePixelDensityRatioEvent:function(){n.removeEvent(window,"resize",this._updatePixelDensityRatioBind)},_updatePixelDensityRatio:function(){var f=n.pixelDensityRatio,p=n.getCurrentPixelDensityRatio();f!==p&&(n.pixelDensityRatio=p,this.world.resetItems(),this.forceRedraw())},goToPreviousPage:function(){var f=this._sequenceIndex-1;this.navPrevNextWrap&&f<0&&(f+=this.tileSources.length),this.goToPage(f)},goToNextPage:function(){var f=this._sequenceIndex+1;this.navPrevNextWrap&&f>=this.tileSources.length&&(f=0),this.goToPage(f)},isAnimating:function(){return t[this.hash].animating}})}(OpenSeadragon),function(n){function t(o){var h={tracker:o.eventSource,position:o.position,quick:o.quick,shift:o.shift,originalEvent:o.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-click",h),!h.preventDefaultAction&&o.quick&&this.viewer.viewport&&(this.panVertical||this.panHorizontal)&&(this.viewer.viewport.flipped&&(o.position.x=this.viewport.getContainerSize().x-o.position.x),o=this.viewport.pointFromPixel(o.position),this.panVertical?this.panHorizontal||(o.x=this.viewer.viewport.getCenter(!0).x):o.y=this.viewer.viewport.getCenter(!0).y,this.viewer.viewport.panTo(o),this.viewer.viewport.applyConstraints())}function s(o){var h={tracker:o.eventSource,position:o.position,delta:o.delta,speed:o.speed,direction:o.direction,shift:o.shift,originalEvent:o.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-drag",h),!h.preventDefaultAction&&this.viewer.viewport&&(this.panHorizontal||(o.delta.x=0),this.panVertical||(o.delta.y=0),this.viewer.viewport.flipped&&(o.delta.x=-o.delta.x),this.viewer.viewport.panBy(this.viewport.deltaPointsFromPixels(o.delta)),this.viewer.constrainDuringPan&&this.viewer.viewport.applyConstraints())}function a(o){o.insideElementPressed&&this.viewer.viewport&&this.viewer.viewport.applyConstraints()}function e(o){var h={tracker:o.eventSource,position:o.position,scroll:o.scroll,shift:o.shift,originalEvent:o.originalEvent,preventDefault:o.preventDefault};this.viewer.raiseEvent("navigator-scroll",h),o.preventDefault=h.preventDefault}function r(o,h){i(o,"rotate("+h+"deg)")}function i(o,h){o.style.webkitTransform=h,o.style.mozTransform=h,o.style.msTransform=h,o.style.oTransform=h,o.style.transform=h}n.Navigator=function(o){var h,d,g,l=o.viewer,c=this;function u(d){r(c.displayRegionContainer,d),r(c.displayRegion,-d),c.viewport.setRotation(d)}o.element||o.id?(o.element?(o.id&&n.console.warn("Given option.id for Navigator was ignored since option.element was provided and is being used instead."),o.id=o.element.id?o.element.id:"navigator-"+n.now(),this.element=o.element):this.element=document.getElementById(o.id),o.controlOptions={anchor:n.ControlAnchor.NONE,attachToViewer:!1,autoFade:!1}):(o.id="navigator-"+n.now(),this.element=n.makeNeutralElement("div"),o.controlOptions={anchor:n.ControlAnchor.TOP_RIGHT,attachToViewer:!0,autoFade:o.autoFade},o.position&&("BOTTOM_RIGHT"===o.position?o.controlOptions.anchor=n.ControlAnchor.BOTTOM_RIGHT:"BOTTOM_LEFT"===o.position?o.controlOptions.anchor=n.ControlAnchor.BOTTOM_LEFT:"TOP_RIGHT"===o.position?o.controlOptions.anchor=n.ControlAnchor.TOP_RIGHT:"TOP_LEFT"===o.position?o.controlOptions.anchor=n.ControlAnchor.TOP_LEFT:"ABSOLUTE"===o.position&&(o.controlOptions.anchor=n.ControlAnchor.ABSOLUTE,o.controlOptions.top=o.top,o.controlOptions.left=o.left,o.controlOptions.height=o.height,o.controlOptions.width=o.width))),this.element.id=o.id,this.element.className+=" navigator",(o=n.extend(!0,{sizeRatio:n.DEFAULT_SETTINGS.navigatorSizeRatio},o,{element:this.element,tabIndex:-1,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:o.animationTime,autoResize:!1,minZoomImageRatio:1,background:o.background,opacity:o.opacity,borderColor:o.borderColor,displayRegionColor:o.displayRegionColor})).minPixelRatio=this.minPixelRatio=l.minPixelRatio,n.setElementTouchActionNone(this.element),this.borderWidth=2,this.fudge=new n.Point(1,1),this.totalBorderWidths=new n.Point(2*this.borderWidth,2*this.borderWidth).minus(this.fudge),o.controlOptions.anchor!==n.ControlAnchor.NONE&&(g=this.borderWidth,(d=this.element.style).margin="0px",d.border=g+"px solid "+o.borderColor,d.padding="0px",d.background=o.background,d.opacity=o.opacity,d.overflow="hidden"),this.displayRegion=n.makeNeutralElement("div"),this.displayRegion.id=this.element.id+"-displayregion",this.displayRegion.className="displayregion",function(d,g){d.position="relative",d.top="0px",d.left="0px",d.fontSize="0px",d.overflow="hidden",d.border=g+"px solid "+o.displayRegionColor,d.margin="0px",d.padding="0px",d.background="transparent",d.float="left",d.cssFloat="left",d.styleFloat="left",d.zIndex=999999999,d.cursor="default"}(this.displayRegion.style,this.borderWidth),n.setElementPointerEventsNone(this.displayRegion),n.setElementTouchActionNone(this.displayRegion),this.displayRegionContainer=n.makeNeutralElement("div"),this.displayRegionContainer.id=this.element.id+"-displayregioncontainer",this.displayRegionContainer.className="displayregioncontainer",this.displayRegionContainer.style.width="100%",this.displayRegionContainer.style.height="100%",n.setElementPointerEventsNone(this.displayRegionContainer),n.setElementTouchActionNone(this.displayRegionContainer),l.addControl(this.element,o.controlOptions),this._resizeWithViewer=o.controlOptions.anchor!==n.ControlAnchor.ABSOLUTE&&o.controlOptions.anchor!==n.ControlAnchor.NONE,o.width&&o.height?(this.setWidth(o.width),this.setHeight(o.height)):this._resizeWithViewer&&(h=n.getElementSize(l.element),this.element.style.height=Math.round(h.y*o.sizeRatio)+"px",this.element.style.width=Math.round(h.x*o.sizeRatio)+"px",this.oldViewerSize=h,h=n.getElementSize(this.element),this.elementArea=h.x*h.y),this.oldContainerSize=new n.Point(0,0),n.Viewer.apply(this,[o]),this.displayRegionContainer.appendChild(this.displayRegion),this.element.getElementsByTagName("div")[0].appendChild(this.displayRegionContainer),o.navigatorRotate&&(u(o.viewer.viewport?o.viewer.viewport.getRotation():o.viewer.degrees||0),o.viewer.addHandler("rotate",function(d){u(d.degrees)})),this.innerTracker.destroy(),this.innerTracker=new n.MouseTracker({userData:"Navigator.innerTracker",element:this.element,dragHandler:n.delegate(this,s),clickHandler:n.delegate(this,t),releaseHandler:n.delegate(this,a),scrollHandler:n.delegate(this,e),preProcessEventHandler:function(d){"wheel"===d.eventType&&(d.preventDefault=!0)}}),this.outerTracker.userData="Navigator.outerTracker",n.setElementPointerEventsNone(this.canvas),n.setElementPointerEventsNone(this.container),this.addHandler("reset-size",function(){c.viewport&&c.viewport.goHome(!0)}),l.world.addHandler("item-index-change",function(d){window.setTimeout(function(){var g=c.world.getItemAt(d.previousIndex);c.world.setItemIndex(g,d.newIndex)},1)}),l.world.addHandler("remove-item",function(d){(d=c._getMatchingItem(d=d.item))&&c.world.removeItem(d)}),this.update(l.viewport)},n.extend(n.Navigator.prototype,n.EventSource.prototype,n.Viewer.prototype,{updateSize:function(){if(this.viewport){var o=new n.Point(0===this.container.clientWidth?1:this.container.clientWidth,0===this.container.clientHeight?1:this.container.clientHeight);o.equals(this.oldContainerSize)||(this.viewport.resize(o,!0),this.viewport.goHome(!0),this.oldContainerSize=o,this.drawer.clear(),this.world.draw())}},setWidth:function(o){this.width=o,this.element.style.width="number"==typeof o?o+"px":o,this._resizeWithViewer=!1},setHeight:function(o){this.height=o,this.element.style.height="number"==typeof o?o+"px":o,this._resizeWithViewer=!1},setFlip:function(o){return this.viewport.setFlip(o),this.setDisplayTransform(this.viewer.viewport.getFlip()?"scale(-1,1)":"scale(1,1)"),this},setDisplayTransform:function(o){i(this.displayRegion,o),i(this.canvas,o),i(this.element,o)},update:function(o){var h;if(l=n.getElementSize(this.viewer.element),this._resizeWithViewer&&l.x&&l.y&&!l.equals(this.oldViewerSize)&&(this.oldViewerSize=l,this.maintainSizeRatio||!this.elementArea?(h=l.x*this.sizeRatio,c=l.y*this.sizeRatio):(h=Math.sqrt(this.elementArea*(l.x/l.y)),c=this.elementArea/h),this.element.style.width=Math.round(h)+"px",this.element.style.height=Math.round(c)+"px",this.elementArea||(this.elementArea=h*c),this.updateSize()),o&&this.viewport){l=o.getBoundsNoRotate(!0),h=this.viewport.pixelFromPointNoRotate(l.getTopLeft(),!1),c=this.viewport.pixelFromPointNoRotate(l.getBottomRight(),!1).minus(this.totalBorderWidths),(o=this.displayRegion.style).display=this.world.getItemCount()?"block":"none",o.top=Math.round(h.y)+"px",o.left=Math.round(h.x)+"px";var l=Math.abs(h.x-c.x),c=Math.abs(h.y-c.y);o.width=Math.round(Math.max(l,0))+"px",o.height=Math.round(Math.max(c,0))+"px"}},addTiledImage:function(o){var h=this,l=o.originalTiledImage;return delete o.original,o=n.extend({},o,{success:function(c){var u=c.item;function d(){h._matchBounds(u,l)}u._originalForNavigator=l,h._matchBounds(u,l,!0),h._matchOpacity(u,l),h._matchCompositeOperation(u,l),l.addHandler("bounds-change",d),l.addHandler("clip-change",d),l.addHandler("opacity-change",function(){h._matchOpacity(u,l)}),l.addHandler("composite-operation-change",function(){h._matchCompositeOperation(u,l)})}}),n.Viewer.prototype.addTiledImage.apply(this,[o])},destroy:function(){return n.Viewer.prototype.destroy.apply(this)},_getMatchingItem:function(o){for(var l,h=this.world.getItemCount(),c=0;c<h;c++)if((l=this.world.getItemAt(c))._originalForNavigator===o)return l;return null},_matchBounds:function(o,h,l){var c=h.getBoundsNoRotate();o.setPosition(c.getTopLeft(),l),o.setWidth(c.width,l),o.setRotation(h.getRotation(),l),o.setClip(h.getClip()),o.setFlip(h.getFlip())},_matchOpacity:function(o,h){o.setOpacity(h.opacity)},_matchCompositeOperation:function(o,h){o.setCompositeOperation(h.compositeOperation)}})}(OpenSeadragon),function(n){var t={Errors:{Dzc:"Sorry, we don't support Deep Zoom Collections!",Dzi:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",Xml:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",ImageFormat:"Sorry, we don't support {0}-based Deep Zoom Images.",Security:"It looks like a security restriction stopped us from loading this Deep Zoom Image.",Status:"This space unintentionally left blank ({0} {1}).",OpenFailed:"Unable to open {0}: {1}"},Tooltips:{FullPage:"Toggle full page",Home:"Go home",ZoomIn:"Zoom in",ZoomOut:"Zoom out",NextPage:"Next page",PreviousPage:"Previous page",RotateLeft:"Rotate left",RotateRight:"Rotate right",Flip:"Flip Horizontally"}};n.extend(n,{getString:function(s){var a,e=s.split("."),r=null,i=arguments,o=t;for(a=0;a<e.length-1;a++)o=o[e[a]]||{};return"string"!=typeof(r=o[e[a]])&&(n.console.error("Untranslated source string:",s),r=""),r.replace(/\{\d+\}/g,function(h){return(h=parseInt(h.match(/\d+/),10)+1)<i.length?i[h]:""})},setString:function(s,a){var e,r=s.split("."),i=t;for(e=0;e<r.length-1;e++)i[r[e]]||(i[r[e]]={}),i=i[r[e]];i[r[e]]=a}})}(OpenSeadragon),function(n){n.Point=function(t,s){this.x="number"==typeof t?t:0,this.y="number"==typeof s?s:0},n.Point.prototype={clone:function(){return new n.Point(this.x,this.y)},plus:function(t){return new n.Point(this.x+t.x,this.y+t.y)},minus:function(t){return new n.Point(this.x-t.x,this.y-t.y)},times:function(t){return new n.Point(this.x*t,this.y*t)},divide:function(t){return new n.Point(this.x/t,this.y/t)},negate:function(){return new n.Point(-this.x,-this.y)},distanceTo:function(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))},squaredDistanceTo:function(t){return Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2)},apply:function(t){return new n.Point(t(this.x),t(this.y))},equals:function(t){return t instanceof n.Point&&this.x===t.x&&this.y===t.y},rotate:function(t,s){var a,e;if(s=s||new n.Point(0,0),t%90==0)switch(n.positiveModulo(t,360)){case 0:a=1,e=0;break;case 90:a=0,e=1;break;case 180:a=-1,e=0;break;case 270:a=0,e=-1}else{var r=t*Math.PI/180;a=Math.cos(r),e=Math.sin(r)}return new n.Point(r=a*(this.x-s.x)-e*(this.y-s.y)+s.x,s=e*(this.x-s.x)+a*(this.y-s.y)+s.y)},toString:function(){return"("+Math.round(100*this.x)/100+","+Math.round(100*this.y)/100+")"}}}(OpenSeadragon),function(n){n.TileSource=function(t,s,a,e,r,i){var h,o=this,l=arguments;if(l=n.isPlainObject(t)?t:{width:l[0],height:l[1],tileSize:l[2],tileOverlap:l[3],minLevel:l[4],maxLevel:l[5]},n.EventSource.call(this),n.extend(!0,this,l),!this.success)for(h=0;h<arguments.length;h++)if(n.isFunction(arguments[h])){this.success=arguments[h];break}this.success&&this.addHandler("ready",function(c){o.success(c)}),"string"===n.type(t)&&(this.url=t),this.url?(this.aspectRatio=1,this.dimensions=new n.Point(10,10),this._tileWidth=0,this._tileHeight=0,this.tileOverlap=0,this.minLevel=0,this.maxLevel=0,this.ready=!1,this.getImageInfo(this.url)):(this.ready=!0,this.aspectRatio=l.width&&l.height?l.width/l.height:1,this.dimensions=new n.Point(l.width,l.height),this.tileSize?(this._tileWidth=this._tileHeight=this.tileSize,delete this.tileSize):(this.tileWidth?(this._tileWidth=this.tileWidth,delete this.tileWidth):this._tileWidth=0,this.tileHeight?(this._tileHeight=this.tileHeight,delete this.tileHeight):this._tileHeight=0),this.tileOverlap=l.tileOverlap||0,this.minLevel=l.minLevel||0,this.maxLevel=null!=l.maxLevel?l.maxLevel:l.width&&l.height?Math.ceil(Math.log(Math.max(l.width,l.height))/Math.log(2)):0,this.success&&n.isFunction(this.success)&&this.success(this))},n.TileSource.prototype={getTileSize:function(t){return n.console.error("[TileSource.getTileSize] is deprecated. Use TileSource.getTileWidth() and TileSource.getTileHeight() instead"),this._tileWidth},getTileWidth:function(t){return this._tileWidth||this.getTileSize(t)},getTileHeight:function(t){return this._tileHeight||this.getTileSize(t)},setMaxLevel:function(t){this.maxLevel=t,this._memoizeLevelScale()},getLevelScale:function(t){return this._memoizeLevelScale(),this.getLevelScale(t)},_memoizeLevelScale:function(){var t,s={};for(t=0;t<=this.maxLevel;t++)s[t]=1/Math.pow(2,this.maxLevel-t);this.getLevelScale=function(a){return s[a]}},getNumTiles:function(e){var s=this.getLevelScale(e),a=Math.ceil(s*this.dimensions.x/this.getTileWidth(e));return e=Math.ceil(s*this.dimensions.y/this.getTileHeight(e)),new n.Point(a,e)},getPixelRatio:function(s){var a=this.dimensions.times(this.getLevelScale(s));return new n.Point(s=1/a.x*n.pixelDensityRatio,a=1/a.y*n.pixelDensityRatio)},getClosestLevel:function(){var t,s;for(t=this.minLevel+1;t<=this.maxLevel&&!(1<(s=this.getNumTiles(t)).x||1<s.y);t++);return t-1},getTileAtPoint:function(t,s){var a=0<=s.x&&s.x<=1&&0<=s.y&&s.y<=1/this.aspectRatio;n.console.assert(a,"[TileSource.getTileAtPoint] must be called with a valid point.");var e=this.dimensions.x*this.getLevelScale(t);return a=s.x*e,e*=s.y,a=Math.floor(a/this.getTileWidth(t)),e=Math.floor(e/this.getTileHeight(t)),1<=s.x&&(a=this.getNumTiles(t).x-1),s.y>=1/this.aspectRatio-1e-15&&(e=this.getNumTiles(t).y-1),new n.Point(a,e)},getTileBounds:function(h,l,u,e){var r=this.dimensions.times(this.getLevelScale(h)),i=this.getTileWidth(h),c=this.getTileHeight(h),o=0===l?0:i*l-this.tileOverlap;return h=0===u?0:c*u-this.tileOverlap,l=i+(0===l?1:2)*this.tileOverlap,c+=(0===u?1:2)*this.tileOverlap,u=1/r.x,l=Math.min(l,r.x-o),c=Math.min(c,r.y-h),e?new n.Rect(0,0,l,c):new n.Rect(o*u,h*u,l*u,c*u)},getImageInfo:function(t){var s,a,e,r,i,o=this;t&&-1<(i=(r=(e=t.split("/"))[e.length-1]).lastIndexOf("."))&&(e[e.length-1]=r.slice(0,i));var h=null;if(this.splitHashDataForPost){var l=t.indexOf("#");-1!==l&&(h=t.substring(l+1),t=t.substr(0,l))}s=function(c){"string"==typeof c&&(c=n.parseXml(c));var u=n.TileSource.determineType(o,c,t);u?(void 0===(a=u.prototype.configure.apply(o,[c,t,h])).ajaxWithCredentials&&(a.ajaxWithCredentials=o.ajaxWithCredentials),a=new u(a),o.ready=!0,o.raiseEvent("ready",{tileSource:a})):o.raiseEvent("open-failed",{message:"Unable to load TileSource",source:t})},t.match(/\.js$/)?(l=t.split("/").pop().replace(".js",""),n.jsonp({url:t,async:!1,callbackName:l,callback:s})):n.makeAjaxRequest({url:t,postData:h,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,success:function(c){c=function(u){var g,v=u.responseText,w=u.status;if(!u)throw new Error(n.getString("Errors.Security"));if(200!==u.status&&0!==u.status)throw w=u.status,new Error(n.getString("Errors.Status",w,404===w?"Not Found":u.statusText));if(v.match(/\s*<.*/))try{g=u.responseXML&&u.responseXML.documentElement?u.responseXML:n.parseXml(v)}catch(T){g=u.responseText}else if(v.match(/\s*[{[].*/))try{g=n.parseJSON(v)}catch(T){g=v}else g=v;return g}(c),s(c)},error:function(c,u){var d;try{d="HTTP "+c.status+" attempting to load TileSource: "+t}catch(g){d=(void 0!==u&&u.toString?u.toString():"Unknown error")+" attempting to load TileSource: "+t}n.console.error(d),o.raiseEvent("open-failed",{message:d,source:t,postData:h})}})},supports:function(t,s){return!1},configure:function(t,s,a){throw new Error("Method not implemented.")},getTileUrl:function(t,s,a){throw new Error("Method not implemented.")},getTilePostData:function(t,s,a){return null},getTileAjaxHeaders:function(t,s,a){return{}},getTileHashKey:function(t,s,a,e,r,i){return function o(h){return r?h+"+"+JSON.stringify(r):h}("string"!=typeof e?t+"/"+s+"_"+a:e)},tileExists:function(t,s,a){var e=this.getNumTiles(t);return t>=this.minLevel&&t<=this.maxLevel&&0<=s&&0<=a&&s<e.x&&a<e.y},hasTransparency:function(t,s,a,e){return!!t||s.match(".png")},downloadTileStart:function(t){var s=t.userData,a=new Image;function e(r){a?(a.onload=a.onerror=a.onabort=null,t.finish(r?null:a,s.request,r)):t.finish(null,s.request,"Image load failed: undefined Image instance.")}s.image=a,s.request=null,a.onload=function(){e()},a.onabort=a.onerror=function(){e("Image load aborted.")},t.loadWithAjax?s.request=n.makeAjaxRequest({url:t.src,withCredentials:t.ajaxWithCredentials,headers:t.ajaxHeaders,responseType:"arraybuffer",postData:t.postData,success:function(r){var i;try{i=new window.Blob([r.response])}catch(h){var o=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;"TypeError"===h.name&&o&&((o=new o).append(r.response),i=o.getBlob())}0===i.size?e("Empty image response."):a.src=(window.URL||window.webkitURL).createObjectURL(i)},error:function(r){e("Image load aborted - XHR error")}}):(!1!==t.crossOriginPolicy&&(a.crossOrigin=t.crossOriginPolicy),a.src=t.src)},downloadTileAbort:function(t){t.userData.request&&t.userData.request.abort();var s=t.userData.image;t.userData.image&&(s.onload=s.onerror=s.onabort=null)},createTileCache:function(t,s,a){t._data=s},destroyTileCache:function(t){t._data=null,t._renderedContext=null},getTileCacheData:function(t){return t._data},getTileCacheDataAsImage:function(t){return t._data},getTileCacheDataAsContext2D:function(t){if(!t._renderedContext){var s=document.createElement("canvas");s.width=t._data.width,s.height=t._data.height,t._renderedContext=s.getContext("2d"),t._renderedContext.drawImage(t._data,0,0),t._data=null}return t._renderedContext}},n.extend(!0,n.TileSource.prototype,n.EventSource.prototype),n.TileSource.determineType=function(t,s,a){for(var e in OpenSeadragon)if(e.match(/.+TileSource$/)&&n.isFunction(OpenSeadragon[e])&&n.isFunction(OpenSeadragon[e].prototype.supports)&&OpenSeadragon[e].prototype.supports.call(t,s,a))return OpenSeadragon[e];return n.console.error("No TileSource was able to open %s %s",a,s),null}}(OpenSeadragon),function(n){function t(s,a){var e,r,i=(d=a.Image).Url,o=d.Format,u=d.Size,h=d.DisplayRect||[],l=parseInt(u.Width,10),c=parseInt(u.Height,10),d=(u=parseInt(d.TileSize,10),parseInt(d.Overlap,10)),g=[];for(r=0;r<h.length;r++)e=h[r].Rect,g.push(new n.DisplayRect(parseInt(e.X,10),parseInt(e.Y,10),parseInt(e.Width,10),parseInt(e.Height,10),parseInt(e.MinLevel,10),parseInt(e.MaxLevel,10)));return n.extend(!0,{width:l,height:c,tileSize:u,tileOverlap:d,minLevel:null,maxLevel:null,tilesUrl:i,fileFormat:o,displayRects:g},a)}n.DziTileSource=function(s,a,e,r,i,o,h,l,c){var u,d,g,v;if(v=n.isPlainObject(s)?s:{width:s,height:a,tileSize:e,tileOverlap:r,tilesUrl:i,fileFormat:o,displayRects:h,minLevel:l,maxLevel:c},this._levelRects={},this.tilesUrl=v.tilesUrl,this.fileFormat=v.fileFormat,this.displayRects=v.displayRects,this.displayRects)for(u=this.displayRects.length-1;0<=u;u--)for(g=(d=this.displayRects[u]).minLevel;g<=d.maxLevel;g++)this._levelRects[g]||(this._levelRects[g]=[]),this._levelRects[g].push(d);n.TileSource.apply(this,[v])},n.extend(n.DziTileSource.prototype,n.TileSource.prototype,{supports:function(s,a){var e;return s.Image?e=s.Image.xmlns:s.documentElement&&("Image"!==s.documentElement.localName&&"Image"!==s.documentElement.tagName||(e=s.documentElement.namespaceURI)),-1!==(e=(e||"").toLowerCase()).indexOf("schemas.microsoft.com/deepzoom/2008")||-1!==e.indexOf("schemas.microsoft.com/deepzoom/2009")},configure:function(s,a,e){return s=(n.isPlainObject(s)?t:function(r,w){if(!w||!w.documentElement)throw new Error(n.getString("Errors.Xml"));var o,h,l,c,u,d=w.documentElement,g=d.localName||d.tagName,v=w.documentElement.namespaceURI,T=(w=null,[]);if("Image"===g)try{if(void 0===(c=d.getElementsByTagName("Size")[0])&&(c=d.getElementsByTagNameNS(v,"Size")[0]),w={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:d.getAttribute("Url"),Format:d.getAttribute("Format"),DisplayRect:null,Overlap:parseInt(d.getAttribute("Overlap"),10),TileSize:parseInt(d.getAttribute("TileSize"),10),Size:{Height:parseInt(c.getAttribute("Height"),10),Width:parseInt(c.getAttribute("Width"),10)}}},!n.imageFormatSupported(w.Image.Format))throw new Error(n.getString("Errors.ImageFormat",w.Image.Format.toUpperCase()));for(void 0===(o=d.getElementsByTagName("DisplayRect"))&&(o=d.getElementsByTagNameNS(v,"DisplayRect")[0]),u=0;u<o.length;u++)void 0===(l=(h=o[u]).getElementsByTagName("Rect")[0])&&(l=h.getElementsByTagNameNS(v,"Rect")[0]),T.push({Rect:{X:parseInt(l.getAttribute("X"),10),Y:parseInt(l.getAttribute("Y"),10),Width:parseInt(l.getAttribute("Width"),10),Height:parseInt(l.getAttribute("Height"),10),MinLevel:parseInt(h.getAttribute("MinLevel"),10),MaxLevel:parseInt(h.getAttribute("MaxLevel"),10)}});return T.length&&(w.Image.DisplayRect=T),t(0,w)}catch(E){throw E instanceof Error?E:new Error(n.getString("Errors.Dzi"))}else{if("Collection"===g)throw new Error(n.getString("Errors.Dzc"));if("Error"===g)throw d=d.getElementsByTagName("Message")[0].firstChild.nodeValue,new Error(d)}throw new Error(n.getString("Errors.Dzi"))})(this,s),a&&!s.tilesUrl&&(s.tilesUrl=a.replace(/([^/]+?)(\.(dzi|xml|js)?(\?[^/]*)?)?\/?$/,"$1_files/"),s.queryParams=-1!==a.search(/\.(dzi|xml|js)\?/)?a.match(/\?.*/):""),s},getTileUrl:function(s,a,e){return[this.tilesUrl,s,"/",a,"_",e,".",this.fileFormat,this.queryParams].join("")},tileExists:function(s,a,e){var r,i,o,h,l,c,u=this._levelRects[s];if(this.minLevel&&s<this.minLevel||this.maxLevel&&s>this.maxLevel)return!1;if(!u||!u.length)return!0;for(c=u.length-1;0<=c;c--)if(!(s<(r=u[c]).minLevel||s>r.maxLevel)&&(l=this.getLevelScale(s),h=(i=r.x*l)+r.width*l,l=(o=r.y*l)+r.height*l,i=Math.floor(i/this._tileWidth),o=Math.floor(o/this._tileWidth),h=Math.ceil(h/this._tileWidth),l=Math.ceil(l/this._tileWidth),i<=a&&a<h&&o<=e&&e<l))return!0;return!1}})}(OpenSeadragon),function(n){function t(a){var e=Array.isArray(a.profile)?a.profile[0]:a.profile,r=-1!==["http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://iiif.io/api/image/2/level0.json","level0","https://iiif.io/api/image/3/level0.json"].indexOf(e);return e=!1,2===a.version&&1<a.profile.length&&a.profile[1].supports&&(e=-1!==a.profile[1].supports.indexOf("sizeByW")),3===a.version&&a.extraFeatures&&(e=-1!==a.extraFeatures.indexOf("sizeByWh")),!r||e}function s(a){for(var e=[],r=0;r<a.sizes.length;r++)e.push({url:a._id+"/full/"+a.sizes[r].width+","+(3===a.version?a.sizes[r].height:"")+"/0/default."+a.tileFormat,width:a.sizes[r].width,height:a.sizes[r].height});return e.sort(function(i,o){return i.width-o.width})}n.IIIFTileSource=function(a){if(n.extend(!0,this,a),this._id=this["@id"]||this.id||this.identifier||null,!(this.height&&this.width&&this._id))throw new Error("IIIF required parameters (width, height, or id) not provided.");if(a.tileSizePerScaleFactor={},this.tileFormat=this.tileFormat||"jpg",this.version=a.version,this.tile_width&&this.tile_height)a.tileWidth=this.tile_width,a.tileHeight=this.tile_height;else if(this.tile_width)a.tileSize=this.tile_width;else if(this.tile_height)a.tileSize=this.tile_height;else if(this.tiles)if(1===this.tiles.length)a.tileWidth=this.tiles[0].width,a.tileHeight=this.tiles[0].height||this.tiles[0].width,this.scale_factors=this.tiles[0].scaleFactors;else{this.scale_factors=[];for(var e=0;e<this.tiles.length;e++)for(var r=0;r<this.tiles[e].scaleFactors.length;r++){var i=this.tiles[e].scaleFactors[r];this.scale_factors.push(i),a.tileSizePerScaleFactor[i]={width:this.tiles[e].width,height:this.tiles[e].height||this.tiles[e].width}}}else if(t(a)){for(var o=Math.min(this.height,this.width),h=[256,512,1024],l=[],c=0;c<h.length;c++)h[c]<=o&&l.push(h[c]);a.tileSize=0<l.length?Math.max.apply(null,l):o}else this.sizes&&0<this.sizes.length?(this.emulateLegacyImagePyramid=!0,a.levels=s(this),n.extend(!0,a,{width:a.levels[a.levels.length-1].width,height:a.levels[a.levels.length-1].height,tileSize:Math.max(a.height,a.width),tileOverlap:0,minLevel:0,maxLevel:a.levels.length-1}),this.levels=a.levels):n.console.error("Nothing in the info.json to construct image pyramids from");if(!a.maxLevel&&!this.emulateLegacyImagePyramid)if(this.scale_factors){var u=Math.max.apply(null,this.scale_factors);a.maxLevel=Math.round(Math.log(u)*Math.LOG2E)}else a.maxLevel=Number(Math.round(Math.log(Math.max(this.width,this.height),2)));n.TileSource.apply(this,[a])},n.extend(n.IIIFTileSource.prototype,n.TileSource.prototype,{supports:function(a,e){return!!(a.protocol&&"http://iiif.io/api/image"===a.protocol||a["@context"]&&("http://library.stanford.edu/iiif/image-api/1.1/context.json"===a["@context"]||"http://iiif.io/api/image/1/context.json"===a["@context"])||a.profile&&0===a.profile.indexOf("http://library.stanford.edu/iiif/image-api/compliance.html")||a.identifier&&a.width&&a.height||a.documentElement&&"info"===a.documentElement.tagName&&"http://library.stanford.edu/iiif/image-api/ns/"===a.documentElement.namespaceURI)},configure:function(a,e,r){if(n.isPlainObject(a)){if(a["@context"]){var i=a["@context"];if(Array.isArray(i))for(var o=0;o<i.length;o++)if("string"==typeof i[o]&&(/^http:\/\/iiif\.io\/api\/image\/[1-3]\/context\.json$/.test(i[o])||"http://library.stanford.edu/iiif/image-api/1.1/context.json"===i[o])){i=i[o];break}switch(i){case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":a.version=1;break;case"http://iiif.io/api/image/2/context.json":a.version=2;break;case"http://iiif.io/api/image/3/context.json":a.version=3;break;default:n.console.error("Data has a @context property which contains no known IIIF context URI.")}}else a["@context"]="http://iiif.io/api/image/1.0/context.json",a["@id"]=e.replace("/info.json",""),a.version=1;if(a.preferredFormats)for(var h=0;h<a.preferredFormats.length;h++)if(OpenSeadragon.imageFormatSupported(a.preferredFormats[h])){a.tileFormat=a.preferredFormats[h];break}return a}var l=function(g){if(!g||!g.documentElement)throw new Error(n.getString("Errors.Xml"));var u=g.documentElement;if(g=null,"info"===u.tagName)try{return function v(w,T,E){var I,H;if(3===w.nodeType&&E)(H=w.nodeValue.trim()).match(/^\d*$/)&&(H=Number(H)),T[E]?(n.isArray(T[E])||(T[E]=[T[E]]),T[E].push(H)):T[E]=H;else if(1===w.nodeType)for(I=0;I<w.childNodes.length;I++)v(w.childNodes[I],T,w.nodeName)}(u,g={}),g}catch(v){throw v instanceof Error?v:new Error(n.getString("Errors.IIIF"))}throw new Error(n.getString("Errors.IIIF"))}(a);return l["@context"]="http://iiif.io/api/image/1.0/context.json",l["@id"]=e.replace("/info.xml",""),l.version=1,l},getTileWidth:function(a){return this.emulateLegacyImagePyramid?n.TileSource.prototype.getTileWidth.call(this,a):(a=Math.pow(2,this.maxLevel-a),this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[a]?this.tileSizePerScaleFactor[a].width:this._tileWidth)},getTileHeight:function(a){return this.emulateLegacyImagePyramid?n.TileSource.prototype.getTileHeight.call(this,a):(a=Math.pow(2,this.maxLevel-a),this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[a]?this.tileSizePerScaleFactor[a].height:this._tileHeight)},getLevelScale:function(a){if(this.emulateLegacyImagePyramid){return 0<this.levels.length&&a>=this.minLevel&&a<=this.maxLevel?this.levels[a].width/this.levels[this.maxLevel].width:NaN}return n.TileSource.prototype.getLevelScale.call(this,a)},getNumTiles:function(a){return this.emulateLegacyImagePyramid?this.getLevelScale(a)?new n.Point(1,1):new n.Point(0,0):n.TileSource.prototype.getNumTiles.call(this,a)},getTileAtPoint:function(a,e){return this.emulateLegacyImagePyramid?new n.Point(0,0):n.TileSource.prototype.getTileAtPoint.call(this,a,e)},getTileUrl:function(a,e,r){if(this.emulateLegacyImagePyramid){var i=null;return 0<this.levels.length&&a>=this.minLevel&&a<=this.maxLevel?this.levels[a].url:i}var o,h,l,c,u,d=Math.pow(.5,this.maxLevel-a),g=Math.round(this.width*d),v=Math.round(this.height*d);return o=this.getTileWidth(a),h=this.getTileHeight(a),u=Math.round(o/d),i=Math.round(h/d),a=1===this.version?"native."+this.tileFormat:"default."+this.tileFormat,g<o&&v<h?(c=2===this.version&&g===this.width?"full":3===this.version&&g===this.width&&v===this.height?"max":3===this.version?g+","+v:g+",",l="full"):(v=e*u,g=r*i,u=Math.min(u,this.width-v),i=Math.min(i,this.height-g),l=0===e&&0===r&&u===this.width&&i===this.height?"full":[v,g,u,i].join(","),u=Math.round(u*d),d=Math.round(i*d),c=2===this.version&&u===this.width?"full":3===this.version&&u===this.width&&d===this.height?"max":3===this.version?u+","+d:u+","),[this._id,l,c,"0",a].join("/")},__testonly__:{canBeTiled:t,constructLevels:s}})}(OpenSeadragon),function(n){n.OsmTileSource=function(t,s,a,e,r){var i;(!(i=n.isPlainObject(t)?t:{width:t,height:s,tileSize:a,tileOverlap:e,tilesUrl:r}).width||!i.height)&&(i.width=65572864,i.height=65572864),i.tileSize||(i.tileSize=256,i.tileOverlap=0),i.tilesUrl||(i.tilesUrl="http://tile.openstreetmap.org/"),i.minLevel=8,n.TileSource.apply(this,[i])},n.extend(n.OsmTileSource.prototype,n.TileSource.prototype,{supports:function(t,s){return t.type&&"openstreetmaps"===t.type},configure:function(t,s,a){return t},getTileUrl:function(t,s,a){return this.tilesUrl+(t-8)+"/"+s+"/"+a+".png"}})}(OpenSeadragon),function(n){n.TmsTileSource=function(t,s,a,e,r){var i;i=n.isPlainObject(t)?t:{width:t,height:s,tileSize:a,tileOverlap:e,tilesUrl:r};var h=256*Math.ceil(i.width/256),l=256*Math.ceil(i.height/256);i.maxLevel=Math.ceil(Math.log(l<h?h/256:l/256)/Math.log(2))-1,i.tileSize=256,i.width=h,i.height=l,n.TileSource.apply(this,[i])},n.extend(n.TmsTileSource.prototype,n.TileSource.prototype,{supports:function(t,s){return t.type&&"tiledmapservice"===t.type},configure:function(t,s,a){return t},getTileUrl:function(t,s,a){var e=this.getNumTiles(t).y-1;return this.tilesUrl+t+"/"+s+"/"+(e-a)+".png"}})}(OpenSeadragon),function(n){n.ZoomifyTileSource=function(t){void 0===t.tileSize&&(t.tileSize=256),void 0===t.fileFormat&&(t.fileFormat="jpg",this.fileFormat=t.fileFormat);var s={x:t.width,y:t.height};for(t.imageSizes=[{x:t.width,y:t.height}],t.gridSize=[this._getGridSize(t.width,t.height,t.tileSize)];parseInt(s.x,10)>t.tileSize||parseInt(s.y,10)>t.tileSize;)s.x=Math.floor(s.x/2),s.y=Math.floor(s.y/2),t.imageSizes.push({x:s.x,y:s.y}),t.gridSize.push(this._getGridSize(s.x,s.y,t.tileSize));t.imageSizes.reverse(),t.gridSize.reverse(),t.minLevel=0,t.maxLevel=t.gridSize.length-1,OpenSeadragon.TileSource.apply(this,[t])},n.extend(n.ZoomifyTileSource.prototype,n.TileSource.prototype,{_getGridSize:function(t,s,a){return{x:Math.ceil(t/a),y:Math.ceil(s/a)}},_calculateAbsoluteTileNumber:function(t,s,a){for(var e=0,r={},i=0;i<t;i++)e+=(r=this.gridSize[i]).x*r.y;return e+((r=this.gridSize[t]).x*a+s)},supports:function(t,s){return t.type&&"zoomifytileservice"===t.type},configure:function(t,s,a){return t},getTileUrl:function(t,s,a){var e=this._calculateAbsoluteTileNumber(t,s,a);return e=Math.floor(e/256),this.tilesUrl+"TileGroup"+e+"/"+t+"-"+s+"-"+a+"."+this.fileFormat}})}(OpenSeadragon),function(n){n.LegacyTileSource=function(t){var s,a,e;(s=n.isArray(t)?{type:"legacy-image-pyramid",levels:t}:s).levels=function(r){var i,o,h=[];for(o=0;o<r.length;o++)(i=r[o]).height&&i.width&&i.url?h.push({url:i.url,width:Number(i.width),height:Number(i.height)}):n.console.error("Unsupported image format: %s",i.url||"<no URL>");return h.sort(function(l,c){return l.height-c.height})}(s.levels),0<s.levels.length?(a=s.levels[s.levels.length-1].width,e=s.levels[s.levels.length-1].height):(e=a=0,n.console.error("No supported image formats found")),n.extend(!0,s,{width:a,height:e,tileSize:Math.max(e,a),tileOverlap:0,minLevel:0,maxLevel:0<s.levels.length?s.levels.length-1:0}),n.TileSource.apply(this,[s]),this.levels=s.levels},n.extend(n.LegacyTileSource.prototype,n.TileSource.prototype,{supports:function(t,s){return t.type&&"legacy-image-pyramid"===t.type||t.documentElement&&"legacy-image-pyramid"===t.documentElement.getAttribute("type")},configure:function(t,s,a){return n.isPlainObject(t)?t.levels:function(e){if(!e||!e.documentElement)throw new Error(n.getString("Errors.Xml"));var r,i,o=e.documentElement,h=o.tagName,l=null,c=[];if("image"===h)try{for(l={type:o.getAttribute("type"),levels:[]},c=o.getElementsByTagName("level"),i=0;i<c.length;i++)l.levels.push({url:(r=c[i]).getAttribute("url"),width:parseInt(r.getAttribute("width"),10),height:parseInt(r.getAttribute("height"),10)});return l.levels}catch(u){throw u instanceof Error?u:new Error("Unknown error parsing Legacy Image Pyramid XML.")}else{if("collection"===h)throw new Error("Legacy Image Pyramid Collections not yet supported.");if("error"===h)throw new Error("Error: "+e)}throw new Error("Unknown element "+h)}(t)},getLevelScale:function(t){return 0<this.levels.length&&t>=this.minLevel&&t<=this.maxLevel?this.levels[t].width/this.levels[this.maxLevel].width:NaN},getNumTiles:function(t){return this.getLevelScale(t)?new n.Point(1,1):new n.Point(0,0)},getTileUrl:function(t,s,a){return 0<this.levels.length&&t>=this.minLevel&&t<=this.maxLevel?this.levels[t].url:null}})}(OpenSeadragon),function(n){n.ImageTileSource=function(t){t=n.extend({buildPyramid:!0,crossOriginPolicy:!1,ajaxWithCredentials:!1,useCanvas:!0},t),n.TileSource.apply(this,[t])},n.extend(n.ImageTileSource.prototype,n.TileSource.prototype,{supports:function(t,s){return t.type&&"image"===t.type},configure:function(t,s,a){return t},getImageInfo:function(t){var s=this._image=new Image,a=this;this.crossOriginPolicy&&(s.crossOrigin=this.crossOriginPolicy),this.ajaxWithCredentials&&(s.useCredentials=this.ajaxWithCredentials),n.addEvent(s,"load",function(){a.width=s.naturalWidth,a.height=s.naturalHeight,a.aspectRatio=a.width/a.height,a.dimensions=new n.Point(a.width,a.height),a._tileWidth=a.width,a._tileHeight=a.height,a.tileOverlap=0,a.minLevel=0,a.levels=a._buildLevels(),a.maxLevel=a.levels.length-1,a.ready=!0,a.raiseEvent("ready",{tileSource:a})}),n.addEvent(s,"error",function(){a.raiseEvent("open-failed",{message:"Error loading image at "+t,source:t})}),s.src=t},getLevelScale:function(t){return t>=this.minLevel&&t<=this.maxLevel?this.levels[t].width/this.levels[this.maxLevel].width:NaN},getNumTiles:function(t){return this.getLevelScale(t)?new n.Point(1,1):new n.Point(0,0)},getTileUrl:function(t,s,a){return t>=this.minLevel&&t<=this.maxLevel?this.levels[t].url:null},getContext2D:function(t,s,a){return t>=this.minLevel&&t<=this.maxLevel?this.levels[t].context2D:null},destroy:function(){this._freeupCanvasMemory()},_buildLevels:function(){var t=[{url:this._image.src,width:this._image.naturalWidth,height:this._image.naturalHeight}];if(!this.buildPyramid||!n.supportsCanvas||!this.useCanvas)return delete this._image,t;var s=this._image.naturalWidth,a=this._image.naturalHeight,e=document.createElement("canvas"),r=e.getContext("2d");if(e.width=s,e.height=a,r.drawImage(this._image,0,0,s,a),t[0].context2D=r,delete this._image,n.isCanvasTainted(e))return t;for(;2<=s&&2<=a;){s=Math.floor(s/2),a=Math.floor(a/2);var i=document.createElement("canvas"),o=i.getContext("2d");i.width=s,i.height=a,o.drawImage(e,0,0,s,a),t.splice(0,0,{context2D:o,width:s,height:a}),e=i,r=o}return t},_freeupCanvasMemory:function(){for(var t=0;t<this.levels.length;t++)this.levels[t].context2D&&(this.levels[t].context2D.canvas.height=0,this.levels[t].context2D.canvas.width=0)}})}(OpenSeadragon),function(n){n.TileSourceCollection=function(t,s,a,e){n.console.error("TileSourceCollection is deprecated; use World instead")}}(OpenSeadragon),function(n){function t(e){n.requestAnimationFrame(function(){var r,i;(r=e).shouldFade&&(i=n.now(),i=1-(i-=r.fadeBeginTime)/r.fadeLength,i=Math.min(1,i),i=Math.max(0,i),r.imgGroup&&n.setElementOpacity(r.imgGroup,i,!0),0<i&&t(r))})}function s(e,r){var i;e.element.disabled||(r>=n.ButtonState.GROUP&&e.currentState===n.ButtonState.REST&&((i=e).shouldFade=!1,i.imgGroup&&n.setElementOpacity(i.imgGroup,1,!0),e.currentState=n.ButtonState.GROUP),r>=n.ButtonState.HOVER&&e.currentState===n.ButtonState.GROUP&&(e.imgHover&&(e.imgHover.style.visibility=""),e.currentState=n.ButtonState.HOVER),r>=n.ButtonState.DOWN&&e.currentState===n.ButtonState.HOVER&&(e.imgDown&&(e.imgDown.style.visibility=""),e.currentState=n.ButtonState.DOWN))}function a(e,r){var i;e.element.disabled||(r<=n.ButtonState.HOVER&&e.currentState===n.ButtonState.DOWN&&(e.imgDown&&(e.imgDown.style.visibility="hidden"),e.currentState=n.ButtonState.HOVER),r<=n.ButtonState.GROUP&&e.currentState===n.ButtonState.HOVER&&(e.imgHover&&(e.imgHover.style.visibility="hidden"),e.currentState=n.ButtonState.GROUP),r<=n.ButtonState.REST&&e.currentState===n.ButtonState.GROUP&&((i=e).shouldFade=!0,i.fadeBeginTime=n.now()+i.fadeDelay,window.setTimeout(function(){t(i)},i.fadeDelay),e.currentState=n.ButtonState.REST))}n.ButtonState={REST:0,GROUP:1,HOVER:2,DOWN:3},n.Button=function(e){var r=this;n.EventSource.call(this),n.extend(!0,this,{tooltip:null,srcRest:null,srcGroup:null,srcHover:null,srcDown:null,clickTimeThreshold:n.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:n.DEFAULT_SETTINGS.clickDistThreshold,fadeDelay:0,fadeLength:2e3,onPress:null,onRelease:null,onClick:null,onEnter:null,onExit:null,onFocus:null,onBlur:null,userData:null},e),this.element=e.element||n.makeNeutralElement("div"),e.element||(this.imgRest=n.makeTransparentImage(this.srcRest),this.imgGroup=n.makeTransparentImage(this.srcGroup),this.imgHover=n.makeTransparentImage(this.srcHover),this.imgDown=n.makeTransparentImage(this.srcDown),this.imgRest.alt=this.imgGroup.alt=this.imgHover.alt=this.imgDown.alt=this.tooltip,n.setElementPointerEventsNone(this.imgRest),n.setElementPointerEventsNone(this.imgGroup),n.setElementPointerEventsNone(this.imgHover),n.setElementPointerEventsNone(this.imgDown),this.element.style.position="relative",n.setElementTouchActionNone(this.element),this.imgGroup.style.position=this.imgHover.style.position=this.imgDown.style.position="absolute",this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top="0px",this.imgGroup.style.left=this.imgHover.style.left=this.imgDown.style.left="0px",this.imgHover.style.visibility=this.imgDown.style.visibility="hidden",n.Browser.vendor===n.BROWSERS.FIREFOX&&n.Browser.version<3&&(this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top=""),this.element.appendChild(this.imgRest),this.element.appendChild(this.imgGroup),this.element.appendChild(this.imgHover),this.element.appendChild(this.imgDown)),this.addHandler("press",this.onPress),this.addHandler("release",this.onRelease),this.addHandler("click",this.onClick),this.addHandler("enter",this.onEnter),this.addHandler("exit",this.onExit),this.addHandler("focus",this.onFocus),this.addHandler("blur",this.onBlur),this.currentState=n.ButtonState.GROUP,this.fadeBeginTime=null,this.shouldFade=!1,this.element.style.display="inline-block",this.element.style.position="relative",this.element.title=this.tooltip,this.tracker=new n.MouseTracker({userData:"Button.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(i){i.insideElementPressed?(s(r,n.ButtonState.DOWN),r.raiseEvent("enter",{originalEvent:i.originalEvent})):i.buttonDownAny||s(r,n.ButtonState.HOVER)},focusHandler:function(i){r.tracker.enterHandler(i),r.raiseEvent("focus",{originalEvent:i.originalEvent})},leaveHandler:function(i){a(r,n.ButtonState.GROUP),i.insideElementPressed&&r.raiseEvent("exit",{originalEvent:i.originalEvent})},blurHandler:function(i){r.tracker.leaveHandler(i),r.raiseEvent("blur",{originalEvent:i.originalEvent})},pressHandler:function(i){s(r,n.ButtonState.DOWN),r.raiseEvent("press",{originalEvent:i.originalEvent})},releaseHandler:function(i){i.insideElementPressed&&i.insideElementReleased?(a(r,n.ButtonState.HOVER),r.raiseEvent("release",{originalEvent:i.originalEvent})):i.insideElementPressed?a(r,n.ButtonState.GROUP):s(r,n.ButtonState.HOVER)},clickHandler:function(i){i.quick&&r.raiseEvent("click",{originalEvent:i.originalEvent})},keyHandler:function(i){13===i.keyCode?(r.raiseEvent("click",{originalEvent:i.originalEvent}),r.raiseEvent("release",{originalEvent:i.originalEvent}),i.preventDefault=!0):i.preventDefault=!1}}),a(this,n.ButtonState.REST)},n.extend(n.Button.prototype,n.EventSource.prototype,{notifyGroupEnter:function(){s(this,n.ButtonState.GROUP)},notifyGroupExit:function(){a(this,n.ButtonState.REST)},disable:function(){this.notifyGroupExit(),this.element.disabled=!0,this.tracker.setTracking(!1),n.setElementOpacity(this.element,.2,!0)},enable:function(){this.element.disabled=!1,this.tracker.setTracking(!0),n.setElementOpacity(this.element,1,!0),this.notifyGroupEnter()},destroy:function(){this.imgRest&&(this.element.removeChild(this.imgRest),this.imgRest=null),this.imgGroup&&(this.element.removeChild(this.imgGroup),this.imgGroup=null),this.imgHover&&(this.element.removeChild(this.imgHover),this.imgHover=null),this.imgDown&&(this.element.removeChild(this.imgDown),this.imgDown=null),this.removeAllHandlers(),this.tracker.destroy(),this.element=null}})}(OpenSeadragon),function(n){n.ButtonGroup=function(t){n.extend(!0,this,{buttons:[],clickTimeThreshold:n.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:n.DEFAULT_SETTINGS.clickDistThreshold,labelText:""},t);var s,a=this.buttons.concat([]),e=this;if(this.element=t.element||n.makeNeutralElement("div"),!t.group)for(this.element.style.display="inline-block",s=0;s<a.length;s++)this.element.appendChild(a[s].element);n.setElementTouchActionNone(this.element),this.tracker=new n.MouseTracker({userData:"ButtonGroup.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(r){var i;for(i=0;i<e.buttons.length;i++)e.buttons[i].notifyGroupEnter()},leaveHandler:function(r){var i;if(!r.insideElementPressed)for(i=0;i<e.buttons.length;i++)e.buttons[i].notifyGroupExit()}})},n.ButtonGroup.prototype={emulateEnter:function(){this.tracker.enterHandler({eventSource:this.tracker})},emulateLeave:function(){this.tracker.leaveHandler({eventSource:this.tracker})},destroy:function(){for(;this.buttons.length;){var t=this.buttons.pop();this.element.removeChild(t.element),t.destroy()}this.tracker.destroy(),this.element=null}}}(OpenSeadragon),function(n){n.Rect=function(t,s,a,e,r){var i,o;this.x="number"==typeof t?t:0,this.y="number"==typeof s?s:0,this.width="number"==typeof a?a:0,this.height="number"==typeof e?e:0,this.degrees="number"==typeof r?r:0,this.degrees=n.positiveModulo(this.degrees,360),270<=this.degrees?(i=this.getTopRight(),this.x=i.x,this.y=i.y,o=this.height,this.height=this.width,this.width=o,this.degrees-=270):180<=this.degrees?(i=this.getBottomRight(),this.x=i.x,this.y=i.y,this.degrees-=180):90<=this.degrees&&(i=this.getBottomLeft(),this.x=i.x,this.y=i.y,o=this.height,this.height=this.width,this.width=o,this.degrees-=90)},n.Rect.fromSummits=function(t,s,a){var e=t.distanceTo(s),r=t.distanceTo(a);return a=s.minus(t),s=Math.atan(a.y/a.x),a.x<0?s+=Math.PI:a.y<0&&(s+=2*Math.PI),new n.Rect(t.x,t.y,e,r,s/Math.PI*180)},n.Rect.prototype={clone:function(){return new n.Rect(this.x,this.y,this.width,this.height,this.degrees)},getAspectRatio:function(){return this.width/this.height},getTopLeft:function(){return new n.Point(this.x,this.y)},getBottomRight:function(){return new n.Point(this.x+this.width,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getTopRight:function(){return new n.Point(this.x+this.width,this.y).rotate(this.degrees,this.getTopLeft())},getBottomLeft:function(){return new n.Point(this.x,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getCenter:function(){return new n.Point(this.x+this.width/2,this.y+this.height/2).rotate(this.degrees,this.getTopLeft())},getSize:function(){return new n.Point(this.width,this.height)},equals:function(t){return t instanceof n.Rect&&this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height&&this.degrees===t.degrees},times:function(t){return new n.Rect(this.x*t,this.y*t,this.width*t,this.height*t,this.degrees)},translate:function(t){return new n.Rect(this.x+t.x,this.y+t.y,this.width,this.height,this.degrees)},union:function(t){var s=this.getBoundingBox(),a=t.getBoundingBox(),e=Math.min(s.x,a.x),r=Math.min(s.y,a.y);return t=Math.max(s.x+s.width,a.x+a.width),a=Math.max(s.y+s.height,a.y+a.height),new n.Rect(e,r,t-e,a-r)},intersection:function(t){var E,I,H,j,V,K,s=1e-10,a=[],e=this.getTopLeft();t.containsPoint(e,s)&&a.push(e),e=this.getTopRight(),t.containsPoint(e,s)&&a.push(e),e=this.getBottomLeft(),t.containsPoint(e,s)&&a.push(e),e=this.getBottomRight(),t.containsPoint(e,s)&&a.push(e),e=t.getTopLeft(),this.containsPoint(e,s)&&a.push(e),e=t.getTopRight(),this.containsPoint(e,s)&&a.push(e),e=t.getBottomLeft(),this.containsPoint(e,s)&&a.push(e),e=t.getBottomRight(),this.containsPoint(e,s)&&a.push(e);for(var r=this._getSegments(),i=t._getSegments(),o=0;o<r.length;o++)for(var h=r[o],l=0;l<i.length;l++){var c=i[l];H=c[0],j=c[1],void 0,void 0,V=(I=h[1]).minus(E=h[0]),(c=0==(I=-(K=j.minus(H)).x*V.y+V.x*K.y)?null:(j=(V.x*(E.y-H.y)-V.y*(E.x-H.x))/I,I=(K.x*(E.y-H.y)-K.y*(E.x-H.x))/I,-s<=j&&j<=1-s&&-s<=I&&I<=1-s?new n.Point(E.x+I*V.x,E.y+I*V.y):null))&&a.push(c)}if(0===a.length)return null;for(var u=a[0].x,d=a[0].x,g=a[0].y,v=a[0].y,w=1;w<a.length;w++){var T=a[w];T.x<u&&(u=T.x),T.x>d&&(d=T.x),T.y<g&&(g=T.y),T.y>v&&(v=T.y)}return new n.Rect(u,g,d-u,v-g)},_getSegments:function(){var t=this.getTopLeft(),s=this.getTopRight(),a=this.getBottomLeft(),e=this.getBottomRight();return[[t,s],[s,e],[e,a],[a,t]]},rotate:function(t,s){if(0===(t=n.positiveModulo(t,360)))return this.clone();s=s||this.getCenter();var a=this.getTopLeft().rotate(t,s);return t=(t=this.getTopRight().rotate(t,s).minus(a)).apply(function(e){return Math.abs(e)<1e-15?0:e}),s=Math.atan(t.y/t.x),t.x<0?s+=Math.PI:t.y<0&&(s+=2*Math.PI),new n.Rect(a.x,a.y,this.width,this.height,s/Math.PI*180)},getBoundingBox:function(){if(0===this.degrees)return this.clone();var t=this.getTopLeft(),s=this.getTopRight(),a=this.getBottomLeft(),e=this.getBottomRight(),r=Math.min(t.x,s.x,a.x,e.x),i=Math.max(t.x,s.x,a.x,e.x),o=Math.min(t.y,s.y,a.y,e.y);return e=Math.max(t.y,s.y,a.y,e.y),new n.Rect(r,o,i-r,e-o)},getIntegerBoundingBox:function(){var t=this.getBoundingBox(),s=Math.floor(t.x),a=Math.floor(t.y),e=Math.ceil(t.width+t.x-s);return t=Math.ceil(t.height+t.y-a),new n.Rect(s,a,e,t)},containsPoint:function(t,s){s=s||0;var a=this.getTopLeft(),e=this.getTopRight(),r=this.getBottomLeft(),i=e.minus(a),o=r.minus(a);return(t.x-a.x)*i.x+(t.y-a.y)*i.y>=-s&&(t.x-e.x)*i.x+(t.y-e.y)*i.y<=s&&(t.x-a.x)*o.x+(t.y-a.y)*o.y>=-s&&(t.x-r.x)*o.x+(t.y-r.y)*o.y<=s},toString:function(){return"["+Math.round(100*this.x)/100+", "+Math.round(100*this.y)/100+", "+Math.round(100*this.width)/100+"x"+Math.round(100*this.height)/100+", "+Math.round(100*this.degrees)/100+"deg]"}}}(OpenSeadragon),function(n){var t={};function s(c){c.quick&&(c="horizontal"===this.scroll?Math.floor(c.position.x/this.panelWidth):Math.floor(c.position.y/this.panelHeight),this.viewer.goToPage(c)),this.element.focus()}function a(c){if(this.dragging=!0,this.element){var u=Number(this.element.style.marginLeft.replace("px","")),d=Number(this.element.style.marginTop.replace("px","")),g=Number(this.element.style.width.replace("px","")),v=Number(this.element.style.height.replace("px","")),w=n.getElementSize(this.viewer.canvas);"horizontal"===this.scroll?0<-c.delta.x?u>-(g-w.x)&&(this.element.style.marginLeft=u+2*c.delta.x+"px",r(this,w.x,u+2*c.delta.x)):-c.delta.x<0&&u<0&&(this.element.style.marginLeft=u+2*c.delta.x+"px",r(this,w.x,u+2*c.delta.x)):0<-c.delta.y?d>-(v-w.y)&&(this.element.style.marginTop=d+2*c.delta.y+"px",r(this,w.y,d+2*c.delta.y)):-c.delta.y<0&&d<0&&(this.element.style.marginTop=d+2*c.delta.y+"px",r(this,w.y,d+2*c.delta.y))}}function e(c){if(this.element){var u=Number(this.element.style.marginLeft.replace("px","")),d=Number(this.element.style.marginTop.replace("px","")),g=Number(this.element.style.width.replace("px","")),v=Number(this.element.style.height.replace("px","")),w=n.getElementSize(this.viewer.canvas);"horizontal"===this.scroll?0<c.scroll?u>-(g-w.x)&&(this.element.style.marginLeft=u-60*c.scroll+"px",r(this,w.x,u-60*c.scroll)):c.scroll<0&&u<0&&(this.element.style.marginLeft=u-60*c.scroll+"px",r(this,w.x,u-60*c.scroll)):c.scroll<0?d>w.y-v&&(this.element.style.marginTop=d+60*c.scroll+"px",r(this,w.y,d+60*c.scroll)):0<c.scroll&&d<0&&(this.element.style.marginTop=d+60*c.scroll+"px",r(this,w.y,d+60*c.scroll)),c.preventDefault=!0}}function r(c,u,d){var g,v,w,T,E;for(g="horizontal"===c.scroll?c.panelWidth:c.panelHeight,v=Math.ceil(u/g)+5,T=v=(v=(w=Math.ceil((Math.abs(d)+u)/g)+1)-v)<0?0:v;T<w&&T<c.panels.length;T++)if(!(E=c.panels[T]).activePanel){var I=c.viewer.tileSources[T];I=new n.Viewer({id:E.id,tileSources:[I=I.referenceStripThumbnailUrl?{type:"image",url:I.referenceStripThumbnailUrl}:I],element:E,navigatorSizeRatio:c.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,loadTilesWithAjax:c.viewer.loadTilesWithAjax,ajaxHeaders:c.viewer.ajaxHeaders,useCanvas:c.useCanvas}),n.setElementPointerEventsNone(I.canvas),n.setElementPointerEventsNone(I.container),I.innerTracker.setTracking(!1),I.outerTracker.setTracking(!1),c.miniViewers[E.id]=I,E.activePanel=!0}}function i(c){c=c.eventSource.element,"horizontal"===this.scroll?c.style.marginBottom="0px":c.style.marginLeft="0px"}function o(c){c=c.eventSource.element,"horizontal"===this.scroll?c.style.marginBottom="-"+n.getElementSize(c).y/2+"px":c.style.marginLeft="-"+n.getElementSize(c).x/2+"px"}function h(c){if(c.ctrl||c.alt||c.meta)c.preventDefault=!1;else switch(c.keyCode){case 38:case 39:e.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),c.preventDefault=!0;break;case 40:case 37:e.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),c.preventDefault=!0;break;default:c.preventDefault=!1}}function l(c){if(c.ctrl||c.alt||c.meta)c.preventDefault=!1;else switch(c.keyCode){case 61:case 48:case 119:case 87:case 100:e.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),c.preventDefault=!0;break;case 45:case 115:case 83:case 97:e.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),c.preventDefault=!0;break;default:c.preventDefault=!1}}n.ReferenceStrip=function(c){var u,d,g,v=c.viewer,w=n.getElementSize(v.element);for(c.id||(c.id="referencestrip-"+n.now(),this.element=n.makeNeutralElement("div"),this.element.id=c.id,this.element.className="referencestrip"),c=n.extend(!0,{sizeRatio:n.DEFAULT_SETTINGS.referenceStripSizeRatio,position:n.DEFAULT_SETTINGS.referenceStripPosition,scroll:n.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:n.DEFAULT_SETTINGS.clickTimeThreshold},c,{element:this.element}),n.extend(this,c),t[this.id]={animating:!1},this.minPixelRatio=this.viewer.minPixelRatio,this.element.tabIndex=0,(d=this.element.style).marginTop="0px",d.marginRight="0px",d.marginBottom="0px",d.marginLeft="0px",d.left="0px",d.bottom="0px",d.border="0px",d.background="#000",d.position="relative",n.setElementTouchActionNone(this.element),n.setElementOpacity(this.element,.8),this.viewer=v,this.tracker=new n.MouseTracker({userData:"ReferenceStrip.tracker",element:this.element,clickHandler:n.delegate(this,s),dragHandler:n.delegate(this,a),scrollHandler:n.delegate(this,e),enterHandler:n.delegate(this,i),leaveHandler:n.delegate(this,o),keyDownHandler:n.delegate(this,h),keyHandler:n.delegate(this,l),preProcessEventHandler:function(T){"wheel"===T.eventType&&(T.preventDefault=!0)}}),c.width&&c.height?(this.element.style.width=c.width+"px",this.element.style.height=c.height+"px",v.addControl(this.element,{anchor:n.ControlAnchor.BOTTOM_LEFT})):"horizontal"===c.scroll?(this.element.style.width=w.x*c.sizeRatio*v.tileSources.length+12*v.tileSources.length+"px",this.element.style.height=w.y*c.sizeRatio+"px",v.addControl(this.element,{anchor:n.ControlAnchor.BOTTOM_LEFT})):(this.element.style.height=w.y*c.sizeRatio*v.tileSources.length+12*v.tileSources.length+"px",this.element.style.width=w.x*c.sizeRatio+"px",v.addControl(this.element,{anchor:n.ControlAnchor.TOP_LEFT})),this.panelWidth=w.x*this.sizeRatio+8,this.panelHeight=w.y*this.sizeRatio+8,this.panels=[],this.miniViewers={},g=0;g<v.tileSources.length;g++)(u=n.makeNeutralElement("div")).id=this.element.id+"-"+g,u.style.width=this.panelWidth+"px",u.style.height=this.panelHeight+"px",u.style.display="inline",u.style.float="left",u.style.cssFloat="left",u.style.styleFloat="left",u.style.padding="2px",n.setElementTouchActionNone(u),n.setElementPointerEventsNone(u),this.element.appendChild(u),u.activePanel=!1,this.panels.push(u);r(this,"vertical"===this.scroll?w.y:w.x,0),this.setFocus(0)},n.ReferenceStrip.prototype={setFocus:function(c){var u,d=this.element.querySelector("#"+this.element.id+"-"+c),g=n.getElementSize(this.viewer.canvas),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),T=-Number(this.element.style.marginLeft.replace("px","")),E=-Number(this.element.style.marginTop.replace("px",""));this.currentSelected!==d&&(this.currentSelected&&(this.currentSelected.style.background="#000"),this.currentSelected=d,this.currentSelected.style.background="#999","horizontal"===this.scroll?(u=Number(c)*(this.panelWidth+3))>T+g.x-this.panelWidth?(u=Math.min(u,v-g.x),this.element.style.marginLeft=-u+"px",r(this,g.x,-u)):u<T&&(u=Math.max(0,u-g.x/2),this.element.style.marginLeft=-u+"px",r(this,g.x,-u)):(u=Number(c)*(this.panelHeight+3))>E+g.y-this.panelHeight?(u=Math.min(u,w-g.y),this.element.style.marginTop=-u+"px",r(this,g.y,-u)):u<E&&(u=Math.max(0,u-g.y/2),this.element.style.marginTop=-u+"px",r(this,g.y,-u)),this.currentPage=c,i.call(this,{eventSource:this.tracker}))},update:function(){return!!t[this.id].animating},destroy:function(){if(this.miniViewers)for(var c in this.miniViewers)this.miniViewers[c].destroy();this.tracker.destroy(),this.element&&this.viewer.removeControl(this.element)}}}(OpenSeadragon),function(n){n.DisplayRect=function(t,s,a,e,r,i){n.Rect.apply(this,[t,s,a,e]),this.minLevel=r,this.maxLevel=i},n.extend(n.DisplayRect.prototype,n.Rect.prototype)}(OpenSeadragon),function(n){n.Spring=function(t){var s=arguments;"object"!=typeof t&&(t={initial:s.length&&"number"==typeof s[0]?s[0]:void 0,springStiffness:1<s.length?s[1].springStiffness:5,animationTime:1<s.length?s[1].animationTime:1.5}),n.console.assert("number"==typeof t.springStiffness&&0!==t.springStiffness,"[OpenSeadragon.Spring] options.springStiffness must be a non-zero number"),n.console.assert("number"==typeof t.animationTime&&0<=t.animationTime,"[OpenSeadragon.Spring] options.animationTime must be a number greater than or equal to 0"),t.exponential&&(this._exponential=!0,delete t.exponential),n.extend(!0,this,t),this.current={value:"number"==typeof this.initial?this.initial:this._exponential?0:1,time:n.now()},n.console.assert(!this._exponential||0!==this.current.value,"[OpenSeadragon.Spring] value must be non-zero for exponential springs"),this.start={value:this.current.value,time:this.current.time},this.target={value:this.current.value,time:this.current.time},this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},n.Spring.prototype={resetTo:function(t){n.console.assert(!this._exponential||0!==t,"[OpenSeadragon.Spring.resetTo] target must be non-zero for exponential springs"),this.start.value=this.target.value=this.current.value=t,this.start.time=this.target.time=this.current.time=n.now(),this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},springTo:function(t){n.console.assert(!this._exponential||0!==t,"[OpenSeadragon.Spring.springTo] target must be non-zero for exponential springs"),this.start.value=this.current.value,this.start.time=this.current.time,this.target.value=t,this.target.time=this.start.time+1e3*this.animationTime,this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},shiftBy:function(t){this.start.value+=t,this.target.value+=t,this._exponential&&(n.console.assert(0!==this.target.value&&0!==this.start.value,"[OpenSeadragon.Spring.shiftBy] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},setExponential:function(t){this._exponential=t,this._exponential&&(n.console.assert(0!==this.current.value&&0!==this.target.value&&0!==this.start.value,"[OpenSeadragon.Spring.setExponential] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},update:function(){var t,s;this.current.time=n.now(),this._exponential?(t=this.start._logValue,s=this.target._logValue):(t=this.start.value,s=this.target.value),a=this.current.time>=this.target.time?s:t+(s-t)*(e=this.springStiffness,a=(this.current.time-this.start.time)/(this.target.time-this.start.time),(1-Math.exp(e*-a))/(1-Math.exp(-e)));var a,e=this.current.value;return this.current.value=this._exponential?Math.exp(a):a,e!==this.current.value},isAtTargetValue:function(){return this.current.value===this.target.value}}}(OpenSeadragon),function(n){n.ImageJob=function(t){n.extend(!0,this,{timeout:n.DEFAULT_SETTINGS.timeout,jobId:null},t),this.data=null,this.userData={},this.errorMsg=null},n.ImageJob.prototype={start:function(){var t=this,s=this.abort;this.jobId=window.setTimeout(function(){t.finish(null,null,"Image load exceeded timeout ("+t.timeout+" ms)")},this.timeout),this.abort=function(){t.source.downloadTileAbort(t),"function"==typeof s&&s()},this.source.downloadTileStart(this)},finish:function(t,s,a){this.data=t,this.request=s,this.errorMsg=a,this.jobId&&window.clearTimeout(this.jobId),this.callback(this)}},n.ImageLoader=function(t){n.extend(!0,this,{jobLimit:n.DEFAULT_SETTINGS.imageLoaderLimit,timeout:n.DEFAULT_SETTINGS.timeout,jobQueue:[],jobsInProgress:0},t)},n.ImageLoader.prototype={addJob:function(t){t.source||(n.console.error("ImageLoader.prototype.addJob() requires [options.source]. TileSource since new API defines how images are fetched. Creating a dummy TileSource."),t.source={downloadTileStart:(a=n.TileSource.prototype).downloadTileStart,downloadTileAbort:a.downloadTileAbort});var s=this,a=new n.ImageJob(a={src:t.src,tile:t.tile||{},source:t.source,loadWithAjax:t.loadWithAjax,ajaxHeaders:t.loadWithAjax?t.ajaxHeaders:null,crossOriginPolicy:t.crossOriginPolicy,ajaxWithCredentials:t.ajaxWithCredentials,postData:t.postData,callback:function(e){var r,i,o;i=e,o=t.callback,(r=s).jobsInProgress--,(!r.jobLimit||r.jobsInProgress<r.jobLimit)&&0<r.jobQueue.length&&(r.jobQueue.shift().start(),r.jobsInProgress++),o(i.data,i.errorMsg,i.request)},abort:t.abort,timeout:this.timeout});!this.jobLimit||this.jobsInProgress<this.jobLimit?(a.start(),this.jobsInProgress++):this.jobQueue.push(a)},clear:function(){for(var t=0;t<this.jobQueue.length;t++){var s=this.jobQueue[t];"function"==typeof s.abort&&s.abort()}this.jobQueue=[]}}}(OpenSeadragon),function(n){n.Tile=function(t,s,a,e,r,i,o,h,l,c,u,d){this.level=t,this.x=s,this.y=a,this.bounds=e,this.sourceBounds=c,this.exists=r,this._url=i,this.postData=u,this.context2D=o,this.loadWithAjax=h,this.ajaxHeaders=l,void 0===d&&(n.console.warn("Tile constructor needs 'cacheKey' variable: creation tile cache in Tile class is deprecated. TileSource.prototype.getTileHashKey will be used."),d=n.TileSource.prototype.getTileHashKey(t,s,a,i,l,u)),this.cacheKey=d,this.loaded=!1,this.loading=!1,this.element=null,this.imgElement=null,this.style=null,this.position=null,this.size=null,this.flipped=!1,this.blendStart=null,this.opacity=null,this.squaredDistance=null,this.visibility=null,this.hasTransparency=!1,this.beingDrawn=!1,this.lastTouchTime=0,this.isRightMost=!1,this.isBottomMost=!1},n.Tile.prototype={toString:function(){return this.level+"/"+this.x+"_"+this.y},_hasTransparencyChannel:function(){return console.warn("Tile.prototype._hasTransparencyChannel() has been deprecated and will be removed in the future. Use TileSource.prototype.hasTransparency() instead."),!!this.context2D||this.getUrl().match(".png")},drawHTML:function(t){if(this.cacheImageRecord)if(this.loaded){if(!this.element){var s=this.getImage();if(!s)return;this.element=n.makeNeutralElement("div"),this.imgElement=s.cloneNode(),this.imgElement.style.msInterpolationMode="nearest-neighbor",this.imgElement.style.width="100%",this.imgElement.style.height="100%",this.style=this.element.style,this.style.position="absolute"}this.element.parentNode!==t&&t.appendChild(this.element),this.imgElement.parentNode!==this.element&&this.element.appendChild(this.imgElement),this.style.top=this.position.y+"px",this.style.left=this.position.x+"px",this.style.height=this.size.y+"px",this.style.width=this.size.x+"px",this.flipped&&(this.style.transform="scaleX(-1)"),n.setElementOpacity(this.element,this.opacity)}else n.console.warn("Attempting to draw tile %s when it's not yet loaded.",this.toString());else n.console.warn("[Tile.drawHTML] attempting to draw tile %s when it's not cached",this.toString())},get image(){return n.console.error("[Tile.image] property has been deprecated. Use [Tile.prototype.getImage] instead."),this.getImage()},get url(){return n.console.error("[Tile.url] property has been deprecated. Use [Tile.prototype.getUrl] instead."),this.getUrl()},getImage:function(){return this.cacheImageRecord.getImage()},getUrl:function(){return"function"==typeof this._url?this._url():this._url},getCanvasContext:function(){return this.context2D||this.cacheImageRecord.getRenderedContext()},drawCanvas:function(t,s,a,e,r,i){var o,h=this.position.times(n.pixelDensityRatio),l=this.size.times(n.pixelDensityRatio);if(this.context2D||this.cacheImageRecord)if(o=this.getCanvasContext(),this.loaded&&o){var c,u;t.save(),t.globalAlpha=this.opacity,"number"==typeof a&&1!==a&&(h=h.times(a),l=l.times(a)),e instanceof n.Point&&(h=h.plus(e)),1===t.globalAlpha&&this.hasTransparency&&(r&&(h.x=Math.round(h.x),h.y=Math.round(h.y),l.x=Math.round(l.x),l.y=Math.round(l.y)),t.clearRect(h.x,h.y,l.x,l.y)),s({context:t,tile:this,rendered:o}),this.sourceBounds?(c=Math.min(this.sourceBounds.width,o.canvas.width),u=Math.min(this.sourceBounds.height,o.canvas.height)):(c=o.canvas.width,u=o.canvas.height),t.translate(h.x+l.x/2,0),this.flipped&&t.scale(-1,1),t.drawImage(o.canvas,0,0,c,u,-l.x/2,h.y,l.x,l.y),t.restore()}else n.console.warn("Attempting to draw tile %s when it's not yet loaded.",this.toString());else n.console.warn("[Tile.drawCanvas] attempting to draw tile %s when it's not cached",this.toString())},getScaleForEdgeSmoothing:function(){var t;if(this.cacheImageRecord)t=this.cacheImageRecord.getRenderedContext();else{if(!this.context2D)return n.console.warn("[Tile.drawCanvas] attempting to get tile scale %s when tile's not cached",this.toString()),1;t=this.context2D}return t.canvas.width/(this.size.x*n.pixelDensityRatio)},getTranslationForEdgeSmoothing:function(t,s,a){var e=Math.max(1,Math.ceil((a.x-s.x)/2));return s=Math.max(1,Math.ceil((a.y-s.y)/2)),new n.Point(e,s).minus(this.position.times(n.pixelDensityRatio).times(t||1).apply(function(r){return r%1}))},unload:function(){this.imgElement&&this.imgElement.parentNode&&this.imgElement.parentNode.removeChild(this.imgElement),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.imgElement=null,this.loaded=!1,this.loading=!1}}}(OpenSeadragon),function(n){n.OverlayPlacement=n.Placement,n.OverlayRotationMode=n.freezeObject({NO_ROTATION:1,EXACT:2,BOUNDING_BOX:3}),n.Overlay=function(t,s,a){a=n.isPlainObject(t)?t:{element:t,location:s,placement:a},this.element=a.element,this.style=a.element.style,this._init(a)},n.Overlay.prototype={_init:function(t){this.location=t.location,this.placement=void 0===t.placement?n.Placement.TOP_LEFT:t.placement,this.onDraw=t.onDraw,this.checkResize=void 0===t.checkResize||t.checkResize,this.width=void 0===t.width?null:t.width,this.height=void 0===t.height?null:t.height,this.rotationMode=t.rotationMode||n.OverlayRotationMode.EXACT,this.location instanceof n.Rect&&(this.width=this.location.width,this.height=this.location.height,this.location=this.location.getTopLeft(),this.placement=n.Placement.TOP_LEFT),this.scales=null!==this.width&&null!==this.height,this.bounds=new n.Rect(this.location.x,this.location.y,this.width,this.height),this.position=this.location},adjust:function(t,s){var a=n.Placement.properties[this.placement];a&&(a.isHorizontallyCentered?t.x-=s.x/2:a.isRight&&(t.x-=s.x),a.isVerticallyCentered?t.y-=s.y/2:a.isBottom&&(t.y-=s.y))},destroy:function(){var t=this.element,s=this.style;t.parentNode&&(t.parentNode.removeChild(t),t.prevElementParent&&(s.display="none",document.body.appendChild(t))),this.onDraw=null,s.top="",s.left="",s.position="",null!==this.width&&(s.width=""),null!==this.height&&(s.height="");var a=n.getCssPropertyWithVendorPrefix("transformOrigin");t=n.getCssPropertyWithVendorPrefix("transform"),a&&t&&(s[a]="",s[t]="")},drawHTML:function(t,s){var a=this.element;a.parentNode!==t&&(a.prevElementParent=a.parentNode,a.prevNextSibling=a.nextSibling,t.appendChild(a),this.style.position="absolute",this.size=n.getElementSize(a));var e=this._getOverlayPositionAndSize(s);t=e.position,a=this.size=e.size,s=e.rotate,this.onDraw?this.onDraw(t,a,this.element):((e=this.style).left=t.x+"px",e.top=t.y+"px",null!==this.width&&(e.width=a.x+"px"),null!==this.height&&(e.height=a.y+"px"),t=n.getCssPropertyWithVendorPrefix("transformOrigin"),a=n.getCssPropertyWithVendorPrefix("transform"),t&&a&&(s?(e[t]=this._getTransformOrigin(),e[a]="rotate("+s+"deg)"):(e[t]="",e[a]="")),e.display="block")},_getOverlayPositionAndSize:function(t){var s=t.pixelFromPoint(this.location,!0),a=this._getSizeInPixels(t);this.adjust(s,a);var e=0;if(t.getRotation(!0)&&this.rotationMode!==n.OverlayRotationMode.NO_ROTATION)if(this.rotationMode===n.OverlayRotationMode.BOUNDING_BOX&&null!==this.width&&null!==this.height){var r=new n.Rect(s.x,s.y,a.x,a.y);s=(r=this._getBoundingBox(r,t.getRotation(!0))).getTopLeft(),a=r.getSize()}else e=t.getRotation(!0);return{position:s,size:a,rotate:e}},_getSizeInPixels:function(t){var s=this.size.x,a=this.size.y;if(null!==this.width||null!==this.height){var e=t.deltaPixelsFromPointsNoRotate(new n.Point(this.width||0,this.height||0),!0);null!==this.width&&(s=e.x),null!==this.height&&(a=e.y)}return this.checkResize&&(null===this.width||null===this.height)&&(e=this.size=n.getElementSize(this.element),null===this.width&&(s=e.x),null===this.height&&(a=e.y)),new n.Point(s,a)},_getBoundingBox:function(t,s){var a=this._getPlacementPoint(t);return t.rotate(s,a).getBoundingBox()},_getPlacementPoint:function(t){var s=new n.Point(t.x,t.y),a=n.Placement.properties[this.placement];return a&&(a.isHorizontallyCentered?s.x+=t.width/2:a.isRight&&(s.x+=t.width),a.isVerticallyCentered?s.y+=t.height/2:a.isBottom&&(s.y+=t.height)),s},_getTransformOrigin:function(){var t="",s=n.Placement.properties[this.placement];return s&&(s.isLeft?t="left":s.isRight&&(t="right"),s.isTop?t+=" top":s.isBottom&&(t+=" bottom")),t},update:function(t,s){s=n.isPlainObject(t)?t:{location:t,placement:s},this._init({location:s.location||this.location,placement:(void 0!==s.placement?s:this).placement,onDraw:s.onDraw||this.onDraw,checkResize:s.checkResize||this.checkResize,width:(void 0!==s.width?s:this).width,height:(void 0!==s.height?s:this).height,rotationMode:s.rotationMode||this.rotationMode})},getBounds:function(t){n.console.assert(t,"A viewport must now be passed to Overlay.getBounds.");var s=this.width,a=this.height;if(null===s||null===a){var e=t.deltaPointsFromPixelsNoRotate(this.size,!0);null===s&&(s=e.x),null===a&&(a=e.y)}return e=this.location.clone(),this.adjust(e,new n.Point(s,a)),this._adjustBoundsForRotation(t,new n.Rect(e.x,e.y,s,a))},_adjustBoundsForRotation:function(t,s){return t&&0!==t.getRotation(!0)&&this.rotationMode!==n.OverlayRotationMode.EXACT?this.rotationMode!==n.OverlayRotationMode.BOUNDING_BOX?s.rotate(-t.getRotation(!0),this._getPlacementPoint(s)):null===this.width||null===this.height?s:(s=this._getOverlayPositionAndSize(t),t.viewerElementToViewportRectangle(new n.Rect(s.position.x,s.position.y,s.size.x,s.size.y))):s}}}(OpenSeadragon),function(n){n.Drawer=function(t){n.console.assert(t.viewer,"[Drawer] options.viewer is required");var s=arguments;n.isPlainObject(t)||(t={source:s[0],viewport:s[1],element:s[2]}),n.console.assert(t.viewport,"[Drawer] options.viewport is required"),n.console.assert(t.element,"[Drawer] options.element is required"),t.source&&n.console.error("[Drawer] options.source is no longer accepted; use TiledImage instead"),this.viewer=t.viewer,this.viewport=t.viewport,this.debugGridColor="string"==typeof t.debugGridColor?[t.debugGridColor]:t.debugGridColor||n.DEFAULT_SETTINGS.debugGridColor,t.opacity&&n.console.error("[Drawer] options.opacity is no longer accepted; set the opacity on the TiledImage instead"),this.useCanvas=n.supportsCanvas&&(!this.viewer||this.viewer.useCanvas),this.container=n.getElement(t.element),this.canvas=n.makeNeutralElement(this.useCanvas?"canvas":"div"),this.context=this.useCanvas?this.canvas.getContext("2d"):null,this.sketchCanvas=null,this.sketchContext=null,this.element=this.container,this.container.dir="ltr",this.useCanvas&&(s=this._calculateCanvasSize(),this.canvas.width=s.x,this.canvas.height=s.y),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",n.setElementOpacity(this.canvas,this.opacity,!0),n.setElementPointerEventsNone(this.canvas),n.setElementTouchActionNone(this.canvas),this.container.style.textAlign="left",this.container.appendChild(this.canvas),this._imageSmoothingEnabled=!0},n.Drawer.prototype={addOverlay:function(t,s,a,e){return n.console.error("drawer.addOverlay is deprecated. Use viewer.addOverlay instead."),this.viewer.addOverlay(t,s,a,e),this},updateOverlay:function(t,s,a){return n.console.error("drawer.updateOverlay is deprecated. Use viewer.updateOverlay instead."),this.viewer.updateOverlay(t,s,a),this},removeOverlay:function(t){return n.console.error("drawer.removeOverlay is deprecated. Use viewer.removeOverlay instead."),this.viewer.removeOverlay(t),this},clearOverlays:function(){return n.console.error("drawer.clearOverlays is deprecated. Use viewer.clearOverlays instead."),this.viewer.clearOverlays(),this},viewportCoordToDrawerCoord:function(t){return t=this.viewport.pixelFromPointNoRotate(t,!0),new n.Point(t.x*n.pixelDensityRatio,t.y*n.pixelDensityRatio)},clipWithPolygons:function(t,s){if(this.useCanvas){var a=this._getContext(s);a.beginPath(),t.forEach(function(e){e.forEach(function(r,i){a[0===i?"moveTo":"lineTo"](r.x,r.y)})}),a.clip()}},setOpacity:function(t){n.console.error("drawer.setOpacity is deprecated. Use tiledImage.setOpacity instead.");for(var s=this.viewer.world,a=0;a<s.getItemCount();a++)s.getItemAt(a).setOpacity(t);return this},getOpacity:function(){n.console.error("drawer.getOpacity is deprecated. Use tiledImage.getOpacity instead.");for(var t=this.viewer.world,s=0,a=0;a<t.getItemCount();a++){var e=t.getItemAt(a).getOpacity();s<e&&(s=e)}return s},needsUpdate:function(){return n.console.error("[Drawer.needsUpdate] this function is deprecated. Use World.needsDraw instead."),this.viewer.world.needsDraw()},numTilesLoaded:function(){return n.console.error("[Drawer.numTilesLoaded] this function is deprecated. Use TileCache.numTilesLoaded instead."),this.viewer.tileCache.numTilesLoaded()},reset:function(){return n.console.error("[Drawer.reset] this function is deprecated. Use World.resetItems instead."),this.viewer.world.resetItems(),this},update:function(){return n.console.error("[Drawer.update] this function is deprecated. Use Drawer.clear and World.draw instead."),this.clear(),this.viewer.world.draw(),this},canRotate:function(){return this.useCanvas},destroy:function(){this.canvas.width=1,this.canvas.height=1,this.sketchCanvas=null,this.sketchContext=null},clear:function(){if(this.canvas.innerHTML="",this.useCanvas){var t=this._calculateCanvasSize();(this.canvas.width!==t.x||this.canvas.height!==t.y)&&(this.canvas.width=t.x,this.canvas.height=t.y,this._updateImageSmoothingEnabled(this.context),null!==this.sketchCanvas&&(t=this._calculateSketchCanvasSize(),this.sketchCanvas.width=t.x,this.sketchCanvas.height=t.y,this._updateImageSmoothingEnabled(this.sketchContext))),this._clear()}},_clear:function(t,s){this.useCanvas&&(t=this._getContext(t),s?t.clearRect(s.x,s.y,s.width,s.height):t.clearRect(0,0,(s=t.canvas).width,s.height))},viewportToDrawerRectangle:function(t){var s=this.viewport.pixelFromPointNoRotate(t.getTopLeft(),!0);return t=this.viewport.deltaPixelsFromPointsNoRotate(t.getSize(),!0),new n.Rect(s.x*n.pixelDensityRatio,s.y*n.pixelDensityRatio,t.x*n.pixelDensityRatio,t.y*n.pixelDensityRatio)},drawTile:function(t,s,a,e,r,i,o){n.console.assert(t,"[Drawer.drawTile] tile is required"),n.console.assert(s,"[Drawer.drawTile] drawingHandler is required"),this.useCanvas?(a=this._getContext(a),t.drawCanvas(a,s,e=e||1,r,i,o)):t.drawHTML(this.canvas)},_getContext:function(t){var s=this.context;if(t){if(null===this.sketchCanvas){if(this.sketchCanvas=document.createElement("canvas"),t=this._calculateSketchCanvasSize(),this.sketchCanvas.width=t.x,this.sketchCanvas.height=t.y,this.sketchContext=this.sketchCanvas.getContext("2d"),0===this.viewport.getRotation()){var a=this;this.viewer.addHandler("rotate",function e(){if(0!==a.viewport.getRotation()){a.viewer.removeHandler("rotate",e);var r=a._calculateSketchCanvasSize();a.sketchCanvas.width=r.x,a.sketchCanvas.height=r.y}})}this._updateImageSmoothingEnabled(this.sketchContext)}s=this.sketchContext}return s},saveContext:function(t){this.useCanvas&&this._getContext(t).save()},restoreContext:function(t){this.useCanvas&&this._getContext(t).restore()},setClip:function(t,s){this.useCanvas&&((s=this._getContext(s)).beginPath(),s.rect(t.x,t.y,t.width,t.height),s.clip())},drawRectangle:function(t,s,a){this.useCanvas&&((a=this._getContext(a)).save(),a.fillStyle=s,a.fillRect(t.x,t.y,t.width,t.height),a.restore())},blendSketch:function(t,s,a,e){var r=t;if(n.isPlainObject(r)||(r={opacity:t,scale:s,translate:a,compositeOperation:e}),this.useCanvas&&this.sketchCanvas){t=r.opacity,e=r.compositeOperation;var i=r.bounds;this.context.save(),this.context.globalAlpha=t,e&&(this.context.globalCompositeOperation=e),i?(i.x<0&&(i.width+=i.x,i.x=0),i.x+i.width>this.canvas.width&&(i.width=this.canvas.width-i.x),i.y<0&&(i.height+=i.y,i.y=0),i.y+i.height>this.canvas.height&&(i.height=this.canvas.height-i.y),this.context.drawImage(this.sketchCanvas,i.x,i.y,i.width,i.height,i.x,i.y,i.width,i.height)):(s=r.scale||1,t=(a=r.translate)instanceof n.Point?a:new n.Point(0,0),e=0,i=0,a&&(r=this.sketchCanvas.width-this.canvas.width,a=this.sketchCanvas.height-this.canvas.height,e=Math.round(r/2),i=Math.round(a/2)),this.context.drawImage(this.sketchCanvas,t.x-e*s,t.y-i*s,(this.canvas.width+2*e)*s,(this.canvas.height+2*i)*s,-e,-i,this.canvas.width+2*e,this.canvas.height+2*i)),this.context.restore()}},drawDebugInfo:function(t,s,a,e){if(this.useCanvas){var r=this.viewer.world.getIndexOfItem(e)%this.debugGridColor.length,i=this.context;i.save(),i.lineWidth=2*n.pixelDensityRatio,i.font="small-caps bold "+13*n.pixelDensityRatio+"px arial",i.strokeStyle=this.debugGridColor[r],i.fillStyle=this.debugGridColor[r],this.viewport.getRotation(!0)%360!=0&&this._offsetForRotation({degrees:this.viewport.getRotation(!0)}),e.getRotation(!0)%360!=0&&this._offsetForRotation({degrees:e.getRotation(!0),point:e.viewport.pixelFromPointNoRotate(e._getRotationPoint(!0),!0)}),e.viewport.getRotation(!0)%360==0&&e.getRotation(!0)%360==0&&e._drawer.viewer.viewport.getFlip()&&e._drawer._flip(),i.strokeRect(t.position.x*n.pixelDensityRatio,t.position.y*n.pixelDensityRatio,t.size.x*n.pixelDensityRatio,t.size.y*n.pixelDensityRatio);var o=(t.position.x+t.size.x/2)*n.pixelDensityRatio;i.translate(o,r=(t.position.y+t.size.y/2)*n.pixelDensityRatio),i.rotate(Math.PI/180*-this.viewport.getRotation(!0)),i.translate(-o,-r),0===t.x&&0===t.y&&(i.fillText("Zoom: "+this.viewport.getZoom(),t.position.x*n.pixelDensityRatio,(t.position.y-30)*n.pixelDensityRatio),i.fillText("Pan: "+this.viewport.getBounds().toString(),t.position.x*n.pixelDensityRatio,(t.position.y-20)*n.pixelDensityRatio)),i.fillText("Level: "+t.level,(t.position.x+10)*n.pixelDensityRatio,(t.position.y+20)*n.pixelDensityRatio),i.fillText("Column: "+t.x,(t.position.x+10)*n.pixelDensityRatio,(t.position.y+30)*n.pixelDensityRatio),i.fillText("Row: "+t.y,(t.position.x+10)*n.pixelDensityRatio,(t.position.y+40)*n.pixelDensityRatio),i.fillText("Order: "+a+" of "+s,(t.position.x+10)*n.pixelDensityRatio,(t.position.y+50)*n.pixelDensityRatio),i.fillText("Size: "+t.size.toString(),(t.position.x+10)*n.pixelDensityRatio,(t.position.y+60)*n.pixelDensityRatio),i.fillText("Position: "+t.position.toString(),(t.position.x+10)*n.pixelDensityRatio,(t.position.y+70)*n.pixelDensityRatio),this.viewport.getRotation(!0)%360!=0&&this._restoreRotationChanges(),e.getRotation(!0)%360!=0&&this._restoreRotationChanges(),e.viewport.getRotation(!0)%360==0&&e.getRotation(!0)%360==0&&e._drawer.viewer.viewport.getFlip()&&e._drawer._flip(),i.restore()}},debugRect:function(t){if(this.useCanvas){var s=this.context;s.save(),s.lineWidth=2*n.pixelDensityRatio,s.strokeStyle=this.debugGridColor[0],s.fillStyle=this.debugGridColor[0],s.strokeRect(t.x*n.pixelDensityRatio,t.y*n.pixelDensityRatio,t.width*n.pixelDensityRatio,t.height*n.pixelDensityRatio),s.restore()}},setImageSmoothingEnabled:function(t){this.useCanvas&&(this._imageSmoothingEnabled=t,this._updateImageSmoothingEnabled(this.context),this.viewer.forceRedraw())},_updateImageSmoothingEnabled:function(t){t.msImageSmoothingEnabled=this._imageSmoothingEnabled,t.imageSmoothingEnabled=this._imageSmoothingEnabled},getCanvasSize:function(t){return t=this._getContext(t).canvas,new n.Point(t.width,t.height)},getCanvasCenter:function(){return new n.Point(this.canvas.width/2,this.canvas.height/2)},_offsetForRotation:function(t){var s=t.point?t.point.times(n.pixelDensityRatio):this.getCanvasCenter(),a=this._getContext(t.useSketch);a.save(),a.translate(s.x,s.y),this.viewer.viewport.flipped?(a.rotate(Math.PI/180*-t.degrees),a.scale(-1,1)):a.rotate(Math.PI/180*t.degrees),a.translate(-s.x,-s.y)},_flip:function(t){var s=(t=t||{}).point?t.point.times(n.pixelDensityRatio):this.getCanvasCenter();(t=this._getContext(t.useSketch)).translate(s.x,0),t.scale(-1,1),t.translate(-s.x,0)},_restoreRotationChanges:function(t){this._getContext(t).restore()},_calculateCanvasSize:function(){var t=n.pixelDensityRatio,s=this.viewport.getContainerSize();return{x:Math.round(s.x*t),y:Math.round(s.y*t)}},_calculateSketchCanvasSize:function(){var t=this._calculateCanvasSize();return 0===this.viewport.getRotation()?t:{x:t=Math.ceil(Math.sqrt(t.x*t.x+t.y*t.y)),y:t}}}}(OpenSeadragon),function(n){n.Viewport=function(t){var s=arguments;(t=s.length&&s[0]instanceof n.Point?{containerSize:s[0],contentSize:s[1],config:s[2]}:t).config&&(n.extend(!0,t,t.config),delete t.config),this._margins=n.extend({left:0,top:0,right:0,bottom:0},t.margins||{}),delete t.margins,t.initialDegrees=t.degrees,delete t.degrees,n.extend(!0,this,{containerSize:null,contentSize:null,zoomPoint:null,rotationPivot:null,viewer:null,springStiffness:n.DEFAULT_SETTINGS.springStiffness,animationTime:n.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:n.DEFAULT_SETTINGS.minZoomImageRatio,maxZoomPixelRatio:n.DEFAULT_SETTINGS.maxZoomPixelRatio,visibilityRatio:n.DEFAULT_SETTINGS.visibilityRatio,wrapHorizontal:n.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:n.DEFAULT_SETTINGS.wrapVertical,defaultZoomLevel:n.DEFAULT_SETTINGS.defaultZoomLevel,minZoomLevel:n.DEFAULT_SETTINGS.minZoomLevel,maxZoomLevel:n.DEFAULT_SETTINGS.maxZoomLevel,initialDegrees:n.DEFAULT_SETTINGS.degrees,flipped:n.DEFAULT_SETTINGS.flipped,homeFillsViewer:n.DEFAULT_SETTINGS.homeFillsViewer,silenceMultiImageWarnings:n.DEFAULT_SETTINGS.silenceMultiImageWarnings},t),this._updateContainerInnerSize(),this.centerSpringX=new n.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.centerSpringY=new n.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.zoomSpring=new n.Spring({exponential:!0,initial:1,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.degreesSpring=new n.Spring({initial:t.initialDegrees,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value,this._setContentBounds(new n.Rect(0,0,1,1),1),this.goHome(!0),this.update()},n.Viewport.prototype={get degrees(){return n.console.warn("Accessing [Viewport.degrees] is deprecated. Use viewport.getRotation instead."),this.getRotation()},set degrees(t){n.console.warn("Setting [Viewport.degrees] is deprecated. Use viewport.rotateTo, viewport.rotateBy, or viewport.setRotation instead."),this.rotateTo(t)},resetContentSize:function(t){return n.console.assert(t,"[Viewport.resetContentSize] contentSize is required"),n.console.assert(t instanceof n.Point,"[Viewport.resetContentSize] contentSize must be an OpenSeadragon.Point"),n.console.assert(0<t.x,"[Viewport.resetContentSize] contentSize.x must be greater than 0"),n.console.assert(0<t.y,"[Viewport.resetContentSize] contentSize.y must be greater than 0"),this._setContentBounds(new n.Rect(0,0,1,t.y/t.x),t.x),this},setHomeBounds:function(t,s){n.console.error("[Viewport.setHomeBounds] this function is deprecated; The content bounds should not be set manually."),this._setContentBounds(t,s)},_setContentBounds:function(t,s){n.console.assert(t,"[Viewport._setContentBounds] bounds is required"),n.console.assert(t instanceof n.Rect,"[Viewport._setContentBounds] bounds must be an OpenSeadragon.Rect"),n.console.assert(0<t.width,"[Viewport._setContentBounds] bounds.width must be greater than 0"),n.console.assert(0<t.height,"[Viewport._setContentBounds] bounds.height must be greater than 0"),this._contentBoundsNoRotate=t.clone(),this._contentSizeNoRotate=this._contentBoundsNoRotate.getSize().times(s),this._contentBounds=t.rotate(this.getRotation()).getBoundingBox(),this._contentSize=this._contentBounds.getSize().times(s),this._contentAspectRatio=this._contentSize.x/this._contentSize.y,this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:this._contentSizeNoRotate.clone(),contentFactor:s,homeBounds:this._contentBoundsNoRotate.clone(),contentBounds:this._contentBounds.clone()})},getHomeZoom:function(){if(this.defaultZoomLevel)return this.defaultZoomLevel;var t=this._contentAspectRatio/this.getAspectRatio();return(this.homeFillsViewer?1<=t?t:1:1<=t?1:t)/this._contentBounds.width},getHomeBounds:function(){return this.getHomeBoundsNoRotate().rotate(-this.getRotation())},getHomeBoundsNoRotate:function(){var t=this._contentBounds.getCenter(),s=1/this.getHomeZoom(),a=s/this.getAspectRatio();return new n.Rect(t.x-s/2,t.y-a/2,s,a)},goHome:function(t){return this.viewer&&this.viewer.raiseEvent("home",{immediately:t}),this.fitBounds(this.getHomeBounds(),t)},getMinZoom:function(){var t=this.getHomeZoom();return this.minZoomLevel||this.minZoomImageRatio*t},getMaxZoom:function(){var t=this.maxZoomLevel;return t||(t=this._contentSize.x*this.maxZoomPixelRatio/this._containerInnerSize.x,t/=this._contentBounds.width),Math.max(t,this.getHomeZoom())},getAspectRatio:function(){return this._containerInnerSize.x/this._containerInnerSize.y},getContainerSize:function(){return new n.Point(this.containerSize.x,this.containerSize.y)},getMargins:function(){return n.extend({},this._margins)},setMargins:function(t){n.console.assert("object"===n.type(t),"[Viewport.setMargins] margins must be an object"),this._margins=n.extend({left:0,top:0,right:0,bottom:0},t),this._updateContainerInnerSize(),this.viewer&&this.viewer.forceRedraw()},getBounds:function(t){return this.getBoundsNoRotate(t).rotate(-this.getRotation(t))},getBoundsNoRotate:function(t){var s=this.getCenter(t),a=1/this.getZoom(t);return t=a/this.getAspectRatio(),new n.Rect(s.x-a/2,s.y-t/2,a,t)},getBoundsWithMargins:function(t){return this.getBoundsNoRotateWithMargins(t).rotate(-this.getRotation(t),this.getCenter(t))},getBoundsNoRotateWithMargins:function(t){var s=this.getBoundsNoRotate(t);return t=this._containerInnerSize.x*this.getZoom(t),s.x-=this._margins.left/t,s.y-=this._margins.top/t,s.width+=(this._margins.left+this._margins.right)/t,s.height+=(this._margins.top+this._margins.bottom)/t,s},getCenter:function(t){var s,a,e,r=new n.Point(this.centerSpringX.current.value,this.centerSpringY.current.value),i=new n.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return t?r:this.zoomPoint?(s=this.pixelFromPoint(this.zoomPoint,!0),t=(a=1/(e=this.getZoom()))/this.getAspectRatio(),t=new n.Rect(r.x-a/2,r.y-t/2,a,t),e=this._pixelFromPoint(this.zoomPoint,t).minus(s).rotate(-this.getRotation(!0)).divide(this._containerInnerSize.x*e),i.plus(e)):i},getZoom:function(t){return(t?this.zoomSpring.current:this.zoomSpring.target).value},_applyZoomConstraints:function(t){return Math.max(Math.min(t,this.getMaxZoom()),this.getMinZoom())},_applyBoundaryConstraints:function(t){var s=this.viewportToViewerElementRectangle(t).getBoundingBox(),a=this.viewportToViewerElementRectangle(this._contentBoundsNoRotate).getBoundingBox(),e=!1,r=!1;if(!this.wrapHorizontal){var h,i=s.x+s.width,o=a.x+a.width;i=a.x-i+(h=s.width>a.width?this.visibilityRatio*a.width:this.visibilityRatio*s.width),o=o-s.x-h,h>a.width?(s.x+=(i+o)/2,e=!0):o<0?(s.x+=o,e=!0):0<i&&(s.x+=i,e=!0)}if(!this.wrapVertical){var l=s.y+s.height;l=a.y-l+(i=s.height>a.height?this.visibilityRatio*a.height:this.visibilityRatio*s.height),o=(o=a.y+a.height)-s.y-i,i>a.height?(s.y+=(l+o)/2,r=!0):o<0?(s.y+=o,r=!0):0<l&&(s.y+=l,r=!0)}return(t=(l=e||r)?this.viewerElementToViewportRectangle(s):t.clone()).xConstrained=e,t.yConstrained=r,t.constraintApplied=l,t},_raiseConstraintsEvent:function(t){this.viewer&&this.viewer.raiseEvent("constrain",{immediately:t})},applyConstraints:function(t){var s=this.getZoom(),a=this._applyZoomConstraints(s);return s!==a&&this.zoomTo(a,this.zoomPoint,t),(a=this.getConstrainedBounds(!1)).constraintApplied&&(this.fitBounds(a,t),this._raiseConstraintsEvent(t)),this},ensureVisible:function(t){return this.applyConstraints(t)},_fitBounds:function(t,s){var a=(s=s||{}).immediately||!1,e=s.constraints||!1,r=this.getAspectRatio(),i=t.getCenter(),o=new n.Rect(t.x,t.y,t.width,t.height,t.degrees+this.getRotation()).getBoundingBox();o.getAspectRatio()>=r?o.height=o.width/r:o.width=o.height*r,o.x=i.x-o.width/2,o.y=i.y-o.height/2;var h=1/o.width;if(a)return this.panTo(i,!0),this.zoomTo(h,null,!0),e&&this.applyConstraints(!0),this;var l=this.getCenter(!0);return s=this.getZoom(!0),this.panTo(l,!0),this.zoomTo(s,null,!0),t=this.getBounds(),0===(r=this.getZoom())||Math.abs(h/r-1)<1e-8?(this.zoomTo(h,null,!0),this.panTo(i,a),e&&this.applyConstraints(!1),this):(e?(this.panTo(i,!1),this.zoomTo(h,null,!1),i=this.getConstrainedBounds(),this.panTo(l,!0),this.zoomTo(s,null,!0),this.fitBounds(i)):(r=o.rotate(-this.getRotation()).getTopLeft().times(h).minus(t.getTopLeft().times(r)).divide(h-r),this.zoomTo(h,r,a)),this)},fitBounds:function(t,s){return this._fitBounds(t,{immediately:s,constraints:!1})},fitBoundsWithConstraints:function(t,s){return this._fitBounds(t,{immediately:s,constraints:!0})},fitVertically:function(t){var s=new n.Rect(this._contentBounds.x+this._contentBounds.width/2,this._contentBounds.y,0,this._contentBounds.height);return this.fitBounds(s,t)},fitHorizontally:function(t){var s=new n.Rect(this._contentBounds.x,this._contentBounds.y+this._contentBounds.height/2,this._contentBounds.width,0);return this.fitBounds(s,t)},getConstrainedBounds:function(t){return t=this.getBounds(t),this._applyBoundaryConstraints(t)},panBy:function(t,s){var a=new n.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return this.panTo(a.plus(t),s)},panTo:function(t,s){return s?(this.centerSpringX.resetTo(t.x),this.centerSpringY.resetTo(t.y)):(this.centerSpringX.springTo(t.x),this.centerSpringY.springTo(t.y)),this.viewer&&this.viewer.raiseEvent("pan",{center:t,immediately:s}),this},zoomBy:function(t,s,a){return this.zoomTo(this.zoomSpring.target.value*t,s,a)},zoomTo:function(t,s,a){var e=this;return this.zoomPoint=s instanceof n.Point&&!isNaN(s.x)&&!isNaN(s.y)?s:null,a?this._adjustCenterSpringsForZoomPoint(function(){e.zoomSpring.resetTo(t)}):this.zoomSpring.springTo(t),this.viewer&&this.viewer.raiseEvent("zoom",{zoom:t,refPoint:s,immediately:a}),this},setRotation:function(t,s){return this.rotateTo(t,null,s)},getRotation:function(t){return(t?this.degreesSpring.current:this.degreesSpring.target).value},setRotationWithPivot:function(t,s,a){return this.rotateTo(t,s,a)},rotateTo:function(t,s,a){if(!this.viewer||!this.viewer.drawer.canRotate())return this;if(this.degreesSpring.target.value===t&&this.degreesSpring.isAtTargetValue())return this;if(this.rotationPivot=s instanceof n.Point&&!isNaN(s.x)&&!isNaN(s.y)?s:null,a)if(this.rotationPivot){if(!(t-this._oldDegrees))return this.rotationPivot=null,this;this._rotateAboutPivot(t)}else this.degreesSpring.resetTo(t);else{var e=n.positiveModulo(this.degreesSpring.current.value,360),r=n.positiveModulo(t,360);180<(s=r-e)?r-=360:s<-180&&(r+=360),this.degreesSpring.resetTo(t+(e-r)),this.degreesSpring.springTo(t)}return this._setContentBounds(this.viewer.world.getHomeBounds(),this.viewer.world.getContentFactor()),this.viewer.forceRedraw(),this.viewer.raiseEvent("rotate",{degrees:t,immediately:!!a,pivot:this.rotationPivot||this.getCenter()}),this},rotateBy:function(t,s,a){return this.rotateTo(this.degreesSpring.target.value+t,s,a)},resize:function(t,s){var e=this.getBoundsNoRotate(),r=e;return this.containerSize.x=t.x,this.containerSize.y=t.y,this._updateContainerInnerSize(),s&&(r.width=e.width*(t.x/this.containerSize.x),r.height=r.width/this.getAspectRatio()),this.viewer&&this.viewer.raiseEvent("resize",{newContainerSize:t,maintain:s}),this.fitBounds(r,!0)},_updateContainerInnerSize:function(){this._containerInnerSize=new n.Point(Math.max(1,this.containerSize.x-(this._margins.left+this._margins.right)),Math.max(1,this.containerSize.y-(this._margins.top+this._margins.bottom)))},update:function(){var t=this;this._adjustCenterSpringsForZoomPoint(function(){t.zoomSpring.update()}),this.degreesSpring.isAtTargetValue()&&(this.rotationPivot=null),this.centerSpringX.update(),this.centerSpringY.update(),this.rotationPivot?this._rotateAboutPivot(!0):this.degreesSpring.update();var s=this.centerSpringX.current.value!==this._oldCenterX||this.centerSpringY.current.value!==this._oldCenterY||this.zoomSpring.current.value!==this._oldZoom||this.degreesSpring.current.value!==this._oldDegrees;return this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value,s},_rotateAboutPivot:function(t){var s=!0===t,a=this.rotationPivot.minus(this.getCenter());this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y),s?this.degreesSpring.update():this.degreesSpring.resetTo(t),t=a.rotate(-1*(t=this.degreesSpring.current.value-this._oldDegrees)).times(-1),this.centerSpringX.shiftBy(t.x),this.centerSpringY.shiftBy(t.y)},_adjustCenterSpringsForZoomPoint:function(t){if(this.zoomPoint){var s=this.pixelFromPoint(this.zoomPoint,!0);t(),s=this.pixelFromPoint(this.zoomPoint,!0).minus(s),s=this.deltaPointsFromPixels(s,!0),this.centerSpringX.shiftBy(s.x),this.centerSpringY.shiftBy(s.y),this.zoomSpring.isAtTargetValue()&&(this.zoomPoint=null)}else t()},deltaPixelsFromPointsNoRotate:function(t,s){return t.times(this._containerInnerSize.x*this.getZoom(s))},deltaPixelsFromPoints:function(t,s){return this.deltaPixelsFromPointsNoRotate(t.rotate(this.getRotation(s)),s)},deltaPointsFromPixelsNoRotate:function(t,s){return t.divide(this._containerInnerSize.x*this.getZoom(s))},deltaPointsFromPixels:function(t,s){return this.deltaPointsFromPixelsNoRotate(t,s).rotate(-this.getRotation(s))},pixelFromPointNoRotate:function(t,s){return this._pixelFromPointNoRotate(t,this.getBoundsNoRotate(s))},pixelFromPoint:function(t,s){return this._pixelFromPoint(t,this.getBoundsNoRotate(s))},_pixelFromPointNoRotate:function(t,s){return t.minus(s.getTopLeft()).times(this._containerInnerSize.x/s.width).plus(new n.Point(this._margins.left,this._margins.top))},_pixelFromPoint:function(t,s){return this._pixelFromPointNoRotate(t.rotate(this.getRotation(!0),this.getCenter(!0)),s)},pointFromPixelNoRotate:function(t,s){return s=this.getBoundsNoRotate(s),t.minus(new n.Point(this._margins.left,this._margins.top)).divide(this._containerInnerSize.x/s.width).plus(s.getTopLeft())},pointFromPixel:function(t,s){return this.pointFromPixelNoRotate(t,s).rotate(-this.getRotation(s),this.getCenter(s))},_viewportToImageDelta:function(t,s){var a=this._contentBoundsNoRotate.width;return new n.Point(t*this._contentSizeNoRotate.x/a,s*this._contentSizeNoRotate.x/a)},viewportToImageCoordinates:function(t,s){if(t instanceof n.Point)return this.viewportToImageCoordinates(t.x,t.y);if(this.viewer){var a=this.viewer.world.getItemCount();if(1<a)this.silenceMultiImageWarnings||n.console.error("[Viewport.viewportToImageCoordinates] is not accurate with multi-image; use TiledImage.viewportToImageCoordinates instead.");else if(1===a)return this.viewer.world.getItemAt(0).viewportToImageCoordinates(t,s,!0)}return this._viewportToImageDelta(t-this._contentBoundsNoRotate.x,s-this._contentBoundsNoRotate.y)},_imageToViewportDelta:function(t,s){var a=this._contentBoundsNoRotate.width;return new n.Point(t/this._contentSizeNoRotate.x*a,s/this._contentSizeNoRotate.x*a)},imageToViewportCoordinates:function(t,s){if(t instanceof n.Point)return this.imageToViewportCoordinates(t.x,t.y);if(this.viewer){var a=this.viewer.world.getItemCount();if(1<a)this.silenceMultiImageWarnings||n.console.error("[Viewport.imageToViewportCoordinates] is not accurate with multi-image; use TiledImage.imageToViewportCoordinates instead.");else if(1===a)return this.viewer.world.getItemAt(0).imageToViewportCoordinates(t,s,!0)}return(s=this._imageToViewportDelta(t,s)).x+=this._contentBoundsNoRotate.x,s.y+=this._contentBoundsNoRotate.y,s},imageToViewportRectangle:function(t,s,a,e){var r=t;if(r instanceof n.Rect||(r=new n.Rect(t,s,a,e)),this.viewer){var i=this.viewer.world.getItemCount();if(1<i)this.silenceMultiImageWarnings||n.console.error("[Viewport.imageToViewportRectangle] is not accurate with multi-image; use TiledImage.imageToViewportRectangle instead.");else if(1===i)return this.viewer.world.getItemAt(0).imageToViewportRectangle(t,s,a,e,!0)}return a=this.imageToViewportCoordinates(r.x,r.y),e=this._imageToViewportDelta(r.width,r.height),new n.Rect(a.x,a.y,e.x,e.y,r.degrees)},viewportToImageRectangle:function(t,s,a,e){var r=t;if(r instanceof n.Rect||(r=new n.Rect(t,s,a,e)),this.viewer){var i=this.viewer.world.getItemCount();if(1<i)this.silenceMultiImageWarnings||n.console.error("[Viewport.viewportToImageRectangle] is not accurate with multi-image; use TiledImage.viewportToImageRectangle instead.");else if(1===i)return this.viewer.world.getItemAt(0).viewportToImageRectangle(t,s,a,e,!0)}return a=this.viewportToImageCoordinates(r.x,r.y),e=this._viewportToImageDelta(r.width,r.height),new n.Rect(a.x,a.y,e.x,e.y,r.degrees)},viewerElementToImageCoordinates:function(t){return t=this.pointFromPixel(t,!0),this.viewportToImageCoordinates(t)},imageToViewerElementCoordinates:function(t){return t=this.imageToViewportCoordinates(t),this.pixelFromPoint(t,!0)},windowToImageCoordinates:function(t){return n.console.assert(this.viewer,"[Viewport.windowToImageCoordinates] the viewport must have a viewer."),t=t.minus(n.getElementPosition(this.viewer.element)),this.viewerElementToImageCoordinates(t)},imageToWindowCoordinates:function(t){return n.console.assert(this.viewer,"[Viewport.imageToWindowCoordinates] the viewport must have a viewer."),this.imageToViewerElementCoordinates(t).plus(n.getElementPosition(this.viewer.element))},viewerElementToViewportCoordinates:function(t){return this.pointFromPixel(t,!0)},viewportToViewerElementCoordinates:function(t){return this.pixelFromPoint(t,!0)},viewerElementToViewportRectangle:function(t){return n.Rect.fromSummits(this.pointFromPixel(t.getTopLeft(),!0),this.pointFromPixel(t.getTopRight(),!0),this.pointFromPixel(t.getBottomLeft(),!0))},viewportToViewerElementRectangle:function(t){return n.Rect.fromSummits(this.pixelFromPoint(t.getTopLeft(),!0),this.pixelFromPoint(t.getTopRight(),!0),this.pixelFromPoint(t.getBottomLeft(),!0))},windowToViewportCoordinates:function(t){return n.console.assert(this.viewer,"[Viewport.windowToViewportCoordinates] the viewport must have a viewer."),t=t.minus(n.getElementPosition(this.viewer.element)),this.viewerElementToViewportCoordinates(t)},viewportToWindowCoordinates:function(t){return n.console.assert(this.viewer,"[Viewport.viewportToWindowCoordinates] the viewport must have a viewer."),this.viewportToViewerElementCoordinates(t).plus(n.getElementPosition(this.viewer.element))},viewportToImageZoom:function(t){if(this.viewer){var s=this.viewer.world.getItemCount();if(1<s)this.silenceMultiImageWarnings||n.console.error("[Viewport.viewportToImageZoom] is not accurate with multi-image.");else if(1===s)return this.viewer.world.getItemAt(0).viewportToImageZoom(t)}return t*(this._containerInnerSize.x/(s=this._contentSizeNoRotate.x)*this._contentBoundsNoRotate.width)},imageToViewportZoom:function(t){if(this.viewer){var s=this.viewer.world.getItemCount();if(1<s)this.silenceMultiImageWarnings||n.console.error("[Viewport.imageToViewportZoom] is not accurate with multi-image.");else if(1===s)return this.viewer.world.getItemAt(0).imageToViewportZoom(t)}return t*(this._contentSizeNoRotate.x/this._containerInnerSize.x/this._contentBoundsNoRotate.width)},toggleFlip:function(){return this.setFlip(!this.getFlip()),this},getFlip:function(){return this.flipped},setFlip:function(t){return this.flipped===t||(this.flipped=t,this.viewer.navigator&&this.viewer.navigator.setFlip(this.getFlip()),this.viewer.forceRedraw(),this.viewer.raiseEvent("flip",{flipped:t})),this}}}(OpenSeadragon),function(n){n.TiledImage=function(e){var r=this;n.console.assert(e.tileCache,"[TiledImage] options.tileCache is required"),n.console.assert(e.drawer,"[TiledImage] options.drawer is required"),n.console.assert(e.viewer,"[TiledImage] options.viewer is required"),n.console.assert(e.imageLoader,"[TiledImage] options.imageLoader is required"),n.console.assert(e.source,"[TiledImage] options.source is required"),n.console.assert(!e.clip||e.clip instanceof n.Rect,"[TiledImage] options.clip must be an OpenSeadragon.Rect if present"),n.EventSource.call(this),this._tileCache=e.tileCache,delete e.tileCache,this._drawer=e.drawer,delete e.drawer,this._imageLoader=e.imageLoader,delete e.imageLoader,e.clip instanceof n.Rect&&(this._clip=e.clip.clone()),delete e.clip;var i=e.x||0;delete e.x;var o=e.y||0;delete e.y,this.normHeight=e.source.dimensions.y/e.source.dimensions.x,this.contentAspectX=e.source.dimensions.x/e.source.dimensions.y;var h=1;e.width?(h=e.width,delete e.width,e.height&&(n.console.error("specifying both width and height to a tiledImage is not supported"),delete e.height)):e.height&&(h=e.height/this.normHeight,delete e.height);var l=e.fitBounds;delete e.fitBounds;var c=e.fitBoundsPlacement||OpenSeadragon.Placement.CENTER;delete e.fitBoundsPlacement;var u=e.degrees||0;delete e.degrees,n.extend(!0,this,{viewer:null,tilesMatrix:{},coverage:{},loadingCoverage:{},lastDrawn:[],lastResetTime:0,_midDraw:!1,_needsDraw:!0,_hasOpaqueTile:!1,_tilesLoading:0,springStiffness:n.DEFAULT_SETTINGS.springStiffness,animationTime:n.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:n.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:n.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:n.DEFAULT_SETTINGS.wrapVertical,immediateRender:n.DEFAULT_SETTINGS.immediateRender,blendTime:n.DEFAULT_SETTINGS.blendTime,alwaysBlend:n.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:n.DEFAULT_SETTINGS.minPixelRatio,smoothTileEdgesMinZoom:n.DEFAULT_SETTINGS.smoothTileEdgesMinZoom,iOSDevice:n.DEFAULT_SETTINGS.iOSDevice,debugMode:n.DEFAULT_SETTINGS.debugMode,crossOriginPolicy:n.DEFAULT_SETTINGS.crossOriginPolicy,ajaxWithCredentials:n.DEFAULT_SETTINGS.ajaxWithCredentials,placeholderFillStyle:n.DEFAULT_SETTINGS.placeholderFillStyle,opacity:n.DEFAULT_SETTINGS.opacity,preload:n.DEFAULT_SETTINGS.preload,compositeOperation:n.DEFAULT_SETTINGS.compositeOperation,subPixelRoundingForTransparency:n.DEFAULT_SETTINGS.subPixelRoundingForTransparency},e),this._preload=this.preload,delete this.preload,this._fullyLoaded=!1,this._xSpring=new n.Spring({initial:i,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._ySpring=new n.Spring({initial:o,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._scaleSpring=new n.Spring({initial:h,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._degreesSpring=new n.Spring({initial:u,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._updateForScale(),l&&this.fitBounds(l,c,!0),this._drawingHandler=function(d){r.viewer.raiseEvent("tile-drawing",n.extend({tiledImage:r},d))}},n.extend(n.TiledImage.prototype,n.EventSource.prototype,{needsDraw:function(){return this._needsDraw},getFullyLoaded:function(){return this._fullyLoaded},_setFullyLoaded:function(e){e!==this._fullyLoaded&&(this._fullyLoaded=e,this.raiseEvent("fully-loaded-change",{fullyLoaded:this._fullyLoaded}))},reset:function(){this._tileCache.clearTilesFor(this),this.lastResetTime=n.now(),this._needsDraw=!0},update:function(){var e=this._xSpring.update(),r=this._ySpring.update(),i=this._scaleSpring.update(),o=this._degreesSpring.update();return!!(e||r||i||o)&&(this._updateForScale(),this._needsDraw=!0)},draw:function(){0!==this.opacity||this._preload?(this._midDraw=!0,this._updateViewport(),this._midDraw=!1):this._needsDraw=!1},destroy:function(){this.reset(),this.source.destroy&&this.source.destroy()},getBounds:function(e){return this.getBoundsNoRotate(e).rotate(this.getRotation(e),this._getRotationPoint(e))},getBoundsNoRotate:function(e){return e?new n.Rect(this._xSpring.current.value,this._ySpring.current.value,this._worldWidthCurrent,this._worldHeightCurrent):new n.Rect(this._xSpring.target.value,this._ySpring.target.value,this._worldWidthTarget,this._worldHeightTarget)},getWorldBounds:function(){return n.console.error("[TiledImage.getWorldBounds] is deprecated; use TiledImage.getBounds instead"),this.getBounds()},getClippedBounds:function(e){var r=this.getBoundsNoRotate(e);if(this._clip){var i=(e?this._worldWidthCurrent:this._worldWidthTarget)/this.source.dimensions.x;i=this._clip.times(i),r=new n.Rect(r.x+i.x,r.y+i.y,i.width,i.height)}return r.rotate(this.getRotation(e),this._getRotationPoint(e))},getTileBounds:function(e,r,i){var o=this.source.getNumTiles(e),h=(o.x+r%o.x)%o.x,l=(o.y+i%o.y)%o.y;return e=this.source.getTileBounds(e,h,l),this.getFlip()&&(e.x=1-e.x-e.width),e.x+=(r-h)/o.x,e.y+=this._worldHeightCurrent/this._worldWidthCurrent*((i-l)/o.y),e},getContentSize:function(){return new n.Point(this.source.dimensions.x,this.source.dimensions.y)},getSizeInWindowCoordinates:function(){var e=this.imageToWindowCoordinates(new n.Point(0,0)),r=this.imageToWindowCoordinates(this.getContentSize());return new n.Point(r.x-e.x,r.y-e.y)},_viewportToImageDelta:function(e,r,i){return new n.Point(e*(this.source.dimensions.x/(i=(i?this._scaleSpring.current:this._scaleSpring.target).value)),r*(this.source.dimensions.y*this.contentAspectX/i))},viewportToImageCoordinates:function(e,r,i){var o;return e instanceof n.Point?(i=r,o=e):o=new n.Point(e,r),o=o.rotate(-this.getRotation(i),this._getRotationPoint(i)),i?this._viewportToImageDelta(o.x-this._xSpring.current.value,o.y-this._ySpring.current.value):this._viewportToImageDelta(o.x-this._xSpring.target.value,o.y-this._ySpring.target.value)},_imageToViewportDelta:function(e,r,i){return new n.Point(e/this.source.dimensions.x*(i=(i?this._scaleSpring.current:this._scaleSpring.target).value),r/this.source.dimensions.y/this.contentAspectX*i)},imageToViewportCoordinates:function(e,r,i){return e instanceof n.Point&&(i=r,r=e.y,e=e.x),r=this._imageToViewportDelta(e,r),i?(r.x+=this._xSpring.current.value,r.y+=this._ySpring.current.value):(r.x+=this._xSpring.target.value,r.y+=this._ySpring.target.value),r.rotate(this.getRotation(i),this._getRotationPoint(i))},imageToViewportRectangle:function(e,r,i,o,h){var l=e;return l instanceof n.Rect?h=r:l=new n.Rect(e,r,i,o),i=this.imageToViewportCoordinates(l.getTopLeft(),h),o=this._imageToViewportDelta(l.width,l.height,h),new n.Rect(i.x,i.y,o.x,o.y,l.degrees+this.getRotation(h))},viewportToImageRectangle:function(e,r,i,o,h){var l=e;return e instanceof n.Rect?h=r:l=new n.Rect(e,r,i,o),i=this.viewportToImageCoordinates(l.getTopLeft(),h),o=this._viewportToImageDelta(l.width,l.height,h),new n.Rect(i.x,i.y,o.x,o.y,l.degrees-this.getRotation(h))},viewerElementToImageCoordinates:function(e){return e=this.viewport.pointFromPixel(e,!0),this.viewportToImageCoordinates(e)},imageToViewerElementCoordinates:function(e){return e=this.imageToViewportCoordinates(e),this.viewport.pixelFromPoint(e,!0)},windowToImageCoordinates:function(e){return e=e.minus(OpenSeadragon.getElementPosition(this.viewer.element)),this.viewerElementToImageCoordinates(e)},imageToWindowCoordinates:function(e){return this.imageToViewerElementCoordinates(e).plus(OpenSeadragon.getElementPosition(this.viewer.element))},_viewportToTiledImageRectangle:function(e){var r=this._scaleSpring.current.value;return e=e.rotate(-this.getRotation(!0),this._getRotationPoint(!0)),new n.Rect((e.x-this._xSpring.current.value)/r,(e.y-this._ySpring.current.value)/r,e.width/r,e.height/r,e.degrees)},viewportToImageZoom:function(e){return this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x*e},imageToViewportZoom:function(e){return e/(this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x)},setPosition:function(e,r){var i=this._xSpring.target.value===e.x&&this._ySpring.target.value===e.y;if(r){if(i&&this._xSpring.current.value===e.x&&this._ySpring.current.value===e.y)return;this._xSpring.resetTo(e.x),this._ySpring.resetTo(e.y),this._needsDraw=!0}else{if(i)return;this._xSpring.springTo(e.x),this._ySpring.springTo(e.y),this._needsDraw=!0}i||this._raiseBoundsChange()},setWidth:function(e,r){this._setScale(e,r)},setHeight:function(e,r){this._setScale(e/this.normHeight,r)},setCroppingPolygons:function(e){try{if(!n.isArray(e))throw new Error("Provided cropping polygon is not an array");this._croppingPolygons=e.map(function(i){return i.map(function(o){try{if(function(i){return i instanceof n.Point||"number"==typeof i.x&&"number"==typeof i.y}(o))return{x:o.x,y:o.y};throw new Error}catch(h){throw new Error("A Provided cropping polygon point is not supported")}})})}catch(i){n.console.error("[TiledImage.setCroppingPolygons] Cropping polygon format not supported"),n.console.error(i),this._croppingPolygons=null}},resetCroppingPolygons:function(){this._croppingPolygons=null},fitBounds:function(e,r,i){var o=n.Placement.properties[r=r||n.Placement.CENTER],h=this.contentAspectX,l=0,c=0,u=1;if(r=1,this._clip&&(h=this._clip.getAspectRatio(),u=this._clip.width/this.source.dimensions.x,r=this._clip.height/this.source.dimensions.y,e.getAspectRatio()>h?(l=this._clip.x/this._clip.height*e.height,c=this._clip.y/this._clip.height*e.height):(l=this._clip.x/this._clip.width*e.width,c=this._clip.y/this._clip.width*e.width)),e.getAspectRatio()>h){var d=e.height/r;r=0,o.isHorizontallyCentered?r=(e.width-e.height*h)/2:o.isRight&&(r=e.width-e.height*h),this.setPosition(new n.Point(e.x-l+r,e.y-c),i),this.setHeight(d,i)}else d=e.width/u,u=0,o.isVerticallyCentered?u=(e.height-e.width/h)/2:o.isBottom&&(u=e.height-e.width/h),this.setPosition(new n.Point(e.x-l,e.y-c+u),i),this.setWidth(d,i)},getClip:function(){return this._clip?this._clip.clone():null},setClip:function(e){n.console.assert(!e||e instanceof n.Rect,"[TiledImage.setClip] newClip must be an OpenSeadragon.Rect or null"),this._clip=e instanceof n.Rect?e.clone():null,this._needsDraw=!0,this.raiseEvent("clip-change")},getFlip:function(){return!!this.flipped},setFlip:function(e){this.flipped=!!e,this._needsDraw=!0,this._raiseBoundsChange()},getOpacity:function(){return this.opacity},setOpacity:function(e){e!==this.opacity&&(this.opacity=e,this._needsDraw=!0,this.raiseEvent("opacity-change",{opacity:this.opacity}))},getPreload:function(){return this._preload},setPreload:function(e){this._preload=!!e,this._needsDraw=!0},getRotation:function(e){return(e?this._degreesSpring.current:this._degreesSpring.target).value},setRotation:function(e,r){(this._degreesSpring.target.value!==e||!this._degreesSpring.isAtTargetValue())&&(r?this._degreesSpring.resetTo(e):this._degreesSpring.springTo(e),this._needsDraw=!0,this._raiseBoundsChange())},_getRotationPoint:function(e){return this.getBoundsNoRotate(e).getCenter()},getCompositeOperation:function(){return this.compositeOperation},setCompositeOperation:function(e){e!==this.compositeOperation&&(this.compositeOperation=e,this._needsDraw=!0,this.raiseEvent("composite-operation-change",{compositeOperation:this.compositeOperation}))},_setScale:function(e,r){var i=this._scaleSpring.target.value===e;if(r){if(i&&this._scaleSpring.current.value===e)return;this._scaleSpring.resetTo(e),this._updateForScale(),this._needsDraw=!0}else{if(i)return;this._scaleSpring.springTo(e),this._updateForScale(),this._needsDraw=!0}i||this._raiseBoundsChange()},_updateForScale:function(){this._worldWidthTarget=this._scaleSpring.target.value,this._worldHeightTarget=this.normHeight*this._scaleSpring.target.value,this._worldWidthCurrent=this._scaleSpring.current.value,this._worldHeightCurrent=this.normHeight*this._scaleSpring.current.value},_raiseBoundsChange:function(){this.raiseEvent("bounds-change")},_isBottomItem:function(){return this.viewer.world.getItemAt(0)===this},_getLevelsInterval:function(){var e=Math.max(this.source.minLevel,Math.floor(Math.log(this.minZoomImageRatio)/Math.log(2))),r=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(0),!0).x*this._scaleSpring.current.value;return r=Math.min(Math.abs(this.source.maxLevel),Math.abs(Math.floor(Math.log(r/this.minPixelRatio)/Math.log(2)))),r=Math.max(r,this.source.minLevel||0),{lowestLevel:Math.min(e,r),highestLevel:r}},_updateViewport:function(){for(this._needsDraw=!1,this._tilesLoading=0,this.loadingCoverage={};0<this.lastDrawn.length;)this.lastDrawn.pop().beingDrawn=!1;var e=this.viewport,r=this._viewportToTiledImageRectangle(e.getBoundsWithMargins(!0));if(!this.wrapHorizontal&&!this.wrapVertical){var i=this._viewportToTiledImageRectangle(this.getClippedBounds(!0));if(null===(r=r.intersection(i)))return}var o=(i=this._getLevelsInterval()).lowestLevel;i=i.highestLevel;for(var h=null,l=!1,c=n.now(),u=i;o<=u;u--){var d=!1,g=e.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(u),!0).x*this._scaleSpring.current.value;if(u===o||!l&&g>=this.minPixelRatio)l=d=!0;else if(!l)continue;var v=e.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(u),!1).x*this._scaleSpring.current.value,w=e.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(Math.max(this.source.getClosestLevel(),0)),!1).x*this._scaleSpring.current.value;if(w=this.immediateRender?1:w,g=Math.min(1,(g-.5)/.5),v=w/Math.abs(w-v),h=this._updateLevel(l,d,u,g,v,r,c,h),this._providesCoverage(this.coverage,u))break}this._drawTiles(this.lastDrawn),h&&!h.context2D?(this._loadTile(h,c),this._needsDraw=!0,this._setFullyLoaded(!1)):this._setFullyLoaded(0===this._tilesLoading)},_getCornerTiles:function(e,r,i){var o,h;this.wrapHorizontal?(o=n.positiveModulo(r.x,1),h=n.positiveModulo(i.x,1)):(o=Math.max(0,r.x),h=Math.min(1,i.x));var l=1/this.source.aspectRatio;this.wrapVertical?(c=n.positiveModulo(r.y,l),u=n.positiveModulo(i.y,l)):(c=Math.max(0,r.y),u=Math.min(l,i.y));var c=this.source.getTileAtPoint(e,new n.Point(o,c)),u=this.source.getTileAtPoint(e,new n.Point(h,u));return e=this.source.getNumTiles(e),this.wrapHorizontal&&(c.x+=e.x*Math.floor(r.x),u.x+=e.x*Math.floor(i.x)),this.wrapVertical&&(c.y+=e.y*Math.floor(r.y/l),u.y+=e.y*Math.floor(i.y/l)),{topLeft:c,bottomRight:u}},_updateLevel:function(e,r,i,o,h,l,c,u){var d=l.getBoundingBox().getTopLeft(),g=l.getBoundingBox().getBottomRight();this.viewer&&this.viewer.raiseEvent("update-level",{tiledImage:this,havedrawn:e,level:i,opacity:o,visibility:h,drawArea:l,topleft:d,bottomright:g,currenttime:c,best:u}),this._resetCoverage(this.coverage,i),this._resetCoverage(this.loadingCoverage,i);var v=(g=this._getCornerTiles(i,d,g)).topLeft,w=g.bottomRight,T=this.source.getNumTiles(i),E=this.viewport.pixelFromPoint(this.viewport.getCenter());this.getFlip()&&(w.x+=1,this.wrapHorizontal||(w.x=Math.min(w.x,T.x-1)));for(var I=v.x;I<=w.x;I++)for(var H=v.y;H<=w.y;H++){if(this.getFlip()){var j=(T.x+I%T.x)%T.x;j=I+T.x-j-j-1}else j=I;null!==l.intersection(this.getTileBounds(i,j,H))&&(u=this._updateTile(r,e,j,H,i,o,h,E,T,c,u))}return u},_updateTile:function(e,r,i,o,h,l,c,u,T,g,v){var w=this._getTile(i,o,h,g,T,this._worldWidthCurrent,this._worldHeightCurrent);return T=r,this.viewer&&this.viewer.raiseEvent("update-tile",{tiledImage:this,tile:w}),this._setCoverage(this.coverage,h,i,o,!1),r=w.loaded||w.loading||this._isCovered(this.loadingCoverage,h,i,o),this._setCoverage(this.loadingCoverage,h,i,o,r),!w.exists||(e&&!T&&(this._isCovered(this.coverage,h,i,o)?this._setCoverage(this.coverage,h,i,o,!0):T=!0),!T)||(this._positionTile(w,this.source.tileOverlap,this.viewport,u,c),w.loaded||(w.context2D?this._setTileLoaded(w):(c=this._tileCache.getImageRecord(w.cacheKey))&&this._setTileLoaded(w,c.getData())),w.loaded?this._blendTile(w,i,o,h,l,g)&&(this._needsDraw=!0):w.loading?this._tilesLoading++:r||(v=this._compareTiles(v,w))),v},_getTile:function(e,r,i,o,h,l,c){var u,d,g,v,w,T,E,I,H,j=this.tilesMatrix,V=this.source;return j[i]||(j[i]={}),j[i][e]||(j[i][e]={}),(!j[i][e][r]||!j[i][e][r].flipped!=!this.flipped)&&(u=(h.x+e%h.x)%h.x,d=(h.y+r%h.y)%h.y,g=this.getTileBounds(i,e,r),v=V.getTileBounds(i,u,d,!0),w=V.tileExists(i,u,d),T=V.getTileUrl(i,u,d),H=V.getTilePostData(i,u,d),this.loadTilesWithAjax?(E=V.getTileAjaxHeaders(i,u,d),n.isPlainObject(this.ajaxHeaders)&&(E=n.extend({},this.ajaxHeaders,E))):E=null,I=V.getContext2D?V.getContext2D(i,u,d):void 0,H=new n.Tile(i,e,r,g,w,T,I,this.loadTilesWithAjax,E,v,H,V.getTileHashKey(i,u,d,T,E,H)),this.getFlip()?0==u&&(H.isRightMost=!0):u==h.x-1&&(H.isRightMost=!0),d==h.y-1&&(H.isBottomMost=!0),H.flipped=this.flipped,j[i][e][r]=H),(H=j[i][e][r]).lastTouchTime=o,H},_loadTile:function(e,r){var i=this;e.loading=!0,this._imageLoader.addJob({src:e.getUrl(),tile:e,source:this.source,postData:e.postData,loadWithAjax:e.loadWithAjax,ajaxHeaders:e.ajaxHeaders,crossOriginPolicy:this.crossOriginPolicy,ajaxWithCredentials:this.ajaxWithCredentials,callback:function(o,h,l){i._onTileLoad(e,r,o,h,l)},abort:function(){e.loading=!1}})},_onTileLoad:function(e,r,i,o,h){if(i)if(r<this.lastResetTime)n.console.warn("Ignoring tile %s loaded before reset: %s",e,e.getUrl()),e.loading=!1;else{let u=function(){var d=l.source.getClosestLevel();l._setTileLoaded(e,i,d,h)};var l=this;this._midDraw?window.setTimeout(u,1):u()}else n.console.error("Tile %s failed to load: %s - error: %s",e,e.getUrl(),o),this.viewer.raiseEvent("tile-load-failed",{tile:e,tiledImage:this,time:r,message:o,tileRequest:h}),e.loading=!1,e.exists=!1},_setTileLoaded:function(e,r,i,o){var h=0,l=this;function c(){return h++,u}function u(){0==--h&&(e.loading=!1,e.loaded=!0,e.hasTransparency=l.source.hasTransparency(e.context2D,e.getUrl(),e.ajaxHeaders,e.postData),e.context2D||l._tileCache.cacheTile({data:r,tile:e,cutoff:i,tiledImage:l}),l._needsDraw=!0)}this.viewer.raiseEvent("tile-loaded",{tile:e,tiledImage:this,tileRequest:o,get image(){return n.console.error("[tile-loaded] event 'image' has been deprecated. Use 'data' property instead."),r},data:r,getCompletionCallback:c}),c()()},_positionTile:function(e,r,i,o,h){(u=e.bounds.getTopLeft()).x*=this._scaleSpring.current.value,u.y*=this._scaleSpring.current.value,u.x+=this._xSpring.current.value,u.y+=this._ySpring.current.value,(d=e.bounds.getSize()).x*=this._scaleSpring.current.value,d.y*=this._scaleSpring.current.value;var l=i.pixelFromPointNoRotate(u,!0),c=i.pixelFromPointNoRotate(u,!1),u=i.deltaPixelsFromPointsNoRotate(d,!0),d=i.deltaPixelsFromPointsNoRotate(d,!1);d=c.plus(d.divide(2)),d=o.squaredDistanceTo(d),r||(u=u.plus(new n.Point(1,1))),e.isRightMost&&this.wrapHorizontal&&(u.x+=.75),e.isBottomMost&&this.wrapVertical&&(u.y+=.75),e.position=l,e.size=u,e.squaredDistance=d,e.visibility=h},_blendTile:function(e,r,i,o,h,l){var c,u=1e3*this.blendTime;if(e.blendStart||(e.blendStart=l),c=l-e.blendStart,l=u?Math.min(1,c/u):1,this.alwaysBlend&&(l*=h),e.opacity=l,this.lastDrawn.push(e),1===l)this._setCoverage(this.coverage,o,r,i,!0),this._hasOpaqueTile=!0;else if(c<u)return!0;return!1},_compareTiles:function(e,r){return!e||r.visibility>e.visibility||r.visibility===e.visibility&&r.squaredDistance<e.squaredDistance?r:e},_drawTiles:function(e){if(0!==this.opacity&&(0!==e.length||this.placeholderFillStyle)){var i,r=e[0];r&&(i=this.opacity<1||this.compositeOperation&&"source-over"!==this.compositeOperation||!this._isBottomItem()&&this.source.hasTransparency(r.context2D,r.getUrl(),r.ajaxHeaders,r.postData));var o,h,u,l=this.viewport.getZoom(!0),c=this.viewportToImageZoom(l);if(1<e.length&&c>this.smoothTileEdgesMinZoom&&!this.iOSDevice&&this.getRotation(!0)%360==0&&n.supportsCanvas&&this.viewer.useCanvas&&(i=!0,o=r.getScaleForEdgeSmoothing(),h=r.getTranslationForEdgeSmoothing(o,this._drawer.getCanvasSize(!1),this._drawer.getCanvasSize(!0))),i&&(o||(u=this.viewport.viewportToViewerElementRectangle(this.getClippedBounds(!0)).getIntegerBoundingBox(),this._drawer.viewer.viewport.getFlip()&&(this.viewport.getRotation(!0)%360==0&&this.getRotation(!0)%360==0||(u.x=this._drawer.viewer.container.clientWidth-(u.x+u.width))),u=u.times(n.pixelDensityRatio)),this._drawer._clear(!0,u)),o||(this.viewport.getRotation(!0)%360!=0&&this._drawer._offsetForRotation({degrees:this.viewport.getRotation(!0),useSketch:i}),this.getRotation(!0)%360!=0&&this._drawer._offsetForRotation({degrees:this.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(this._getRotationPoint(!0),!0),useSketch:i}),this.viewport.getRotation(!0)%360==0&&this.getRotation(!0)%360==0&&this._drawer.viewer.viewport.getFlip()&&this._drawer._flip()),l=!1,this._clip&&(this._drawer.saveContext(i),c=(c=this.imageToViewportRectangle(this._clip,!0)).rotate(-this.getRotation(!0),this._getRotationPoint(!0)),c=this._drawer.viewportToDrawerRectangle(c),o&&(c=c.times(o)),h&&(c=c.translate(h)),this._drawer.setClip(c,i),l=!0),this._croppingPolygons){var d=this;this._drawer.saveContext(i);try{var g=this._croppingPolygons.map(function(E){return E.map(function(I){return I=d.imageToViewportCoordinates(I.x,I.y,!0).rotate(-d.getRotation(!0),d._getRotationPoint(!0)),I=d._drawer.viewportCoordToDrawerCoord(I),o?I.times(o):I})});this._drawer.clipWithPolygons(g,i)}catch(E){n.console.error(E)}l=!0}if(this.placeholderFillStyle&&!1===this._hasOpaqueTile){g=this._drawer.viewportToDrawerRectangle(this.getBounds(!0)),o&&(g=g.times(o)),h&&(g=g.translate(h));var v=null;v="function"==typeof this.placeholderFillStyle?this.placeholderFillStyle(this,this._drawer.context):this.placeholderFillStyle,this._drawer.drawRectangle(g,v,i)}var w=!1;(v=function(E){if("number"==typeof E)return a(E);if(!E||!n.Browser)return t;var I=E[n.Browser.vendor];return s(I)&&(I=E["*"]),a(I)}(this.subPixelRoundingForTransparency))===n.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS?w=!0:v===n.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&(w=!(this.viewer&&this.viewer.isAnimating()));for(var T=e.length-1;0<=T;T--)this._drawer.drawTile(r=e[T],this._drawingHandler,i,o,h,w,this.source),r.beingDrawn=!0,this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:this,tile:r});l&&this._drawer.restoreContext(i),o||(this.getRotation(!0)%360!=0&&this._drawer._restoreRotationChanges(i),this.viewport.getRotation(!0)%360!=0&&this._drawer._restoreRotationChanges(i)),i&&(o&&(this.viewport.getRotation(!0)%360!=0&&this._drawer._offsetForRotation({degrees:this.viewport.getRotation(!0),useSketch:!1}),this.getRotation(!0)%360!=0&&this._drawer._offsetForRotation({degrees:this.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(this._getRotationPoint(!0),!0),useSketch:!1})),this._drawer.blendSketch({opacity:this.opacity,scale:o,translate:h,compositeOperation:this.compositeOperation,bounds:u}),o&&(this.getRotation(!0)%360!=0&&this._drawer._restoreRotationChanges(!1),this.viewport.getRotation(!0)%360!=0&&this._drawer._restoreRotationChanges(!1))),o||this.viewport.getRotation(!0)%360==0&&this.getRotation(!0)%360==0&&this._drawer.viewer.viewport.getFlip()&&this._drawer._flip(),this._drawDebugInfo(e)}},_drawDebugInfo:function(e){if(this.debugMode)for(var r=e.length-1;0<=r;r--){var i=e[r];try{this._drawer.drawDebugInfo(i,e.length,r,this)}catch(o){n.console.error(o)}}},_providesCoverage:function(e,r,i,o){var h,l,c,u;if(!e[r])return!1;if(void 0!==i&&void 0!==o)return void 0===e[r][i]||void 0===e[r][i][o]||!0===e[r][i][o];for(c in h=e[r])if(Object.prototype.hasOwnProperty.call(h,c))for(u in l=h[c])if(Object.prototype.hasOwnProperty.call(l,u)&&!l[u])return!1;return!0},_isCovered:function(e,r,i,o){return void 0===i||void 0===o?this._providesCoverage(e,r+1):this._providesCoverage(e,r+1,2*i,2*o)&&this._providesCoverage(e,r+1,2*i,2*o+1)&&this._providesCoverage(e,r+1,2*i+1,2*o)&&this._providesCoverage(e,r+1,2*i+1,2*o+1)},_setCoverage:function(e,r,i,o,h){e[r]?(e[r][i]||(e[r][i]={}),e[r][i][o]=h):n.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",r)},_resetCoverage:function(e,r){e[r]={}}});var t=n.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER;function s(e){return e!==n.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS&&e!==n.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&e!==n.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER}function a(e){return s(e)?t:e}}(OpenSeadragon),function(n){function t(a){n.console.assert(a,"[TileCache.cacheTile] options is required"),n.console.assert(a.tile,"[TileCache.cacheTile] options.tile is required"),n.console.assert(a.tiledImage,"[TileCache.cacheTile] options.tiledImage is required"),this.tile=a.tile,this.tiledImage=a.tiledImage}function s(a){n.console.assert(a,"[ImageRecord] options is required"),n.console.assert(a.data,"[ImageRecord] options.data is required"),this._tiles=[],a.create.apply(null,[this,a.data,a.ownerTile]),this._destroyImplementation=a.destroy.bind(null,this),this.getImage=a.getImage.bind(null,this),this.getData=a.getData.bind(null,this),this.getRenderedContext=a.getRenderedContext.bind(null,this)}s.prototype={destroy:function(){this._destroyImplementation(),this._tiles=null},addTile:function(a){n.console.assert(a,"[ImageRecord.addTile] tile is required"),this._tiles.push(a)},removeTile:function(a){for(var e=0;e<this._tiles.length;e++)if(this._tiles[e]===a)return void this._tiles.splice(e,1);n.console.warn("[ImageRecord.removeTile] trying to remove unknown tile",a)},getTileCount:function(){return this._tiles.length}},n.TileCache=function(a){this._maxImageCacheCount=(a=a||{}).maxImageCacheCount||n.DEFAULT_SETTINGS.maxImageCacheCount,this._tilesLoaded=[],this._imagesLoaded=[],this._imagesLoadedCount=0},n.TileCache.prototype={numTilesLoaded:function(){return this._tilesLoaded.length},cacheTile:function(a){n.console.assert(a,"[TileCache.cacheTile] options is required"),n.console.assert(a.tile,"[TileCache.cacheTile] options.tile is required"),n.console.assert(a.tile.cacheKey,"[TileCache.cacheTile] options.tile.cacheKey is required"),n.console.assert(a.tiledImage,"[TileCache.cacheTile] options.tiledImage is required");var e=a.cutoff||0,r=this._tilesLoaded.length,i=this._imagesLoaded[a.tile.cacheKey];if(i||(a.data||(n.console.error("[TileCache.cacheTile] options.image was renamed to options.data. '.image' attribute has been deprecated and will be removed in the future."),a.data=a.image),n.console.assert(a.data,"[TileCache.cacheTile] options.data is required to create an ImageRecord"),i=this._imagesLoaded[a.tile.cacheKey]=new s({data:a.data,ownerTile:a.tile,create:a.tiledImage.source.createTileCache,destroy:a.tiledImage.source.destroyTileCache,getImage:a.tiledImage.source.getTileCacheDataAsImage,getData:a.tiledImage.source.getTileCacheData,getRenderedContext:a.tiledImage.source.getTileCacheDataAsContext2D}),this._imagesLoadedCount++),i.addTile(a.tile),a.tile.cacheImageRecord=i,this._imagesLoadedCount>this._maxImageCacheCount){for(var c,u,g,w,o=null,h=-1,l=null,T=this._tilesLoaded.length-1;0<=T;T--)(c=(w=this._tilesLoaded[T]).tile).level<=e||c.beingDrawn||(o?((g=c.lastTouchTime)<(u=o.lastTouchTime)||g===u&&o.level<c.level)&&(o=c,h=T,l=w):(o=c,h=T,l=w));o&&0<=h&&(this._unloadTile(l),r=h)}this._tilesLoaded[r]=new t({tile:a.tile,tiledImage:a.tiledImage})},clearTilesFor:function(a){n.console.assert(a,"[TileCache.clearTilesFor] tiledImage is required");for(var e,r=0;r<this._tilesLoaded.length;++r)(e=this._tilesLoaded[r]).tiledImage===a&&(this._unloadTile(e),this._tilesLoaded.splice(r,1),r--)},getImageRecord:function(a){return n.console.assert(a,"[TileCache.getImageRecord] cacheKey is required"),this._imagesLoaded[a]},_unloadTile:function(a){n.console.assert(a,"[TileCache._unloadTile] tileRecord is required");var e=a.tile,r=a.tiledImage;e.unload(),e.cacheImageRecord=null,(a=this._imagesLoaded[e.cacheKey]).removeTile(e),a.getTileCount()||(a.destroy(),delete this._imagesLoaded[e.cacheKey],this._imagesLoadedCount--),r.viewer.raiseEvent("tile-unloaded",{tile:e,tiledImage:r})}}}(OpenSeadragon),function(n){n.World=function(t){var s=this;n.console.assert(t.viewer,"[World] options.viewer is required"),n.EventSource.call(this),this.viewer=t.viewer,this._items=[],this._needsDraw=!1,this._autoRefigureSizes=!0,this._needsSizesFigured=!1,this._delegatedFigureSizes=function(a){s._autoRefigureSizes?s._figureSizes():s._needsSizesFigured=!0},this._figureSizes()},n.extend(n.World.prototype,n.EventSource.prototype,{addItem:function(t,s){n.console.assert(t,"[World.addItem] item is required"),n.console.assert(t instanceof n.TiledImage,"[World.addItem] only TiledImages supported at this time"),void 0!==(s=s||{}).index?(s=Math.max(0,Math.min(this._items.length,s.index)),this._items.splice(s,0,t)):this._items.push(t),this._autoRefigureSizes?this._figureSizes():this._needsSizesFigured=!0,this._needsDraw=!0,t.addHandler("bounds-change",this._delegatedFigureSizes),t.addHandler("clip-change",this._delegatedFigureSizes),this.raiseEvent("add-item",{item:t})},getItemAt:function(t){return n.console.assert(void 0!==t,"[World.getItemAt] index is required"),this._items[t]},getIndexOfItem:function(t){return n.console.assert(t,"[World.getIndexOfItem] item is required"),n.indexOf(this._items,t)},getItemCount:function(){return this._items.length},setItemIndex:function(t,s){n.console.assert(t,"[World.setItemIndex] item is required"),n.console.assert(void 0!==s,"[World.setItemIndex] index is required");var a=this.getIndexOfItem(t);if(s>=this._items.length)throw new Error("Index bigger than number of layers.");s!==a&&-1!==a&&(this._items.splice(a,1),this._items.splice(s,0,t),this._needsDraw=!0,this.raiseEvent("item-index-change",{item:t,previousIndex:a,newIndex:s}))},removeItem:function(t){n.console.assert(t,"[World.removeItem] item is required");var s=n.indexOf(this._items,t);-1!==s&&(t.removeHandler("bounds-change",this._delegatedFigureSizes),t.removeHandler("clip-change",this._delegatedFigureSizes),t.destroy(),this._items.splice(s,1),this._figureSizes(),this._needsDraw=!0,this._raiseRemoveItem(t))},removeAll:function(){var t,s;for(this.viewer._cancelPendingImages(),s=0;s<this._items.length;s++)(t=this._items[s]).removeHandler("bounds-change",this._delegatedFigureSizes),t.removeHandler("clip-change",this._delegatedFigureSizes),t.destroy();var a=this._items;for(this._items=[],this._figureSizes(),this._needsDraw=!0,s=0;s<a.length;s++)this._raiseRemoveItem(t=a[s])},resetItems:function(){for(var t=0;t<this._items.length;t++)this._items[t].reset()},update:function(){for(var t=!1,s=0;s<this._items.length;s++)t=this._items[s].update()||t;return t},draw:function(){for(var t=0;t<this._items.length;t++)this._items[t].draw();this._needsDraw=!1},needsDraw:function(){for(var t=0;t<this._items.length;t++)if(this._items[t].needsDraw())return!0;return this._needsDraw},getHomeBounds:function(){return this._homeBounds.clone()},getContentFactor:function(){return this._contentFactor},setAutoRefigureSizes:function(t){(this._autoRefigureSizes=t)&this._needsSizesFigured&&(this._figureSizes(),this._needsSizesFigured=!1)},arrange:function(t){var h,s=(t=t||{}).immediately||!1,a=t.layout||n.DEFAULT_SETTINGS.collectionLayout,r=t.columns||n.DEFAULT_SETTINGS.collectionColumns,i=t.tileSize||n.DEFAULT_SETTINGS.collectionTileSize,o=i+(t.tileMargin||n.DEFAULT_SETTINGS.collectionTileMargin);h=!t.rows&&r?r:Math.ceil(this._items.length/(t.rows||n.DEFAULT_SETTINGS.collectionRows));var u,d,g,l=0,c=0;this.setAutoRefigureSizes(!1);for(var v=0;v<this._items.length;v++)v&&v%h==0&&("horizontal"===a?(c+=o,l=0):(l+=o,c=0)),g=(d=(g=(u=this._items[v]).getBounds()).width>g.height?i:i*(g.width/g.height))*(g.height/g.width),g=new n.Point(l+(i-d)/2,c+(i-g)/2),u.setPosition(g,s),u.setWidth(d,s),"horizontal"===a?l+=o:c+=o;this.setAutoRefigureSizes(!0)},_figureSizes:function(){var t=this._homeBounds?this._homeBounds.clone():null,s=this._contentSize?this._contentSize.clone():null,a=this._contentFactor||0;if(this._items.length){var e=this._items[0],r=e.getBounds();this._contentFactor=e.getContentSize().x/r.width;for(var i=e.getClippedBounds().getBoundingBox(),o=i.x,h=i.y,l=i.x+i.width,c=i.y+i.height,u=1;u<this._items.length;u++)r=(e=this._items[u]).getBounds(),this._contentFactor=Math.max(this._contentFactor,e.getContentSize().x/r.width),i=e.getClippedBounds().getBoundingBox(),o=Math.min(o,i.x),h=Math.min(h,i.y),l=Math.max(l,i.x+i.width),c=Math.max(c,i.y+i.height);this._homeBounds=new n.Rect(o,h,l-o,c-h),this._contentSize=new n.Point(this._homeBounds.width*this._contentFactor,this._homeBounds.height*this._contentFactor)}else this._homeBounds=new n.Rect(0,0,1,1),this._contentSize=new n.Point(1,1),this._contentFactor=1;this._contentFactor===a&&this._homeBounds.equals(t)&&this._contentSize.equals(s)||this.raiseEvent("metrics-change",{})},_raiseRemoveItem:function(t){this.raiseEvent("remove-item",{item:t})}})}(OpenSeadragon);var fabric=fabric||{version:"5.1.0"};if("undefined"!=typeof exports?exports.fabric=fabric:"function"==typeof define&&define.amd&&define([],function(){return fabric}),"undefined"!=typeof document&&"undefined"!=typeof window)fabric.document=document instanceof("undefined"!=typeof HTMLDocument?HTMLDocument:Document)?document:document.implementation.createHTMLDocument(""),fabric.window=window;else{var jsdom=require("jsdom"),virtualWindow=new jsdom.JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;fabric.document=virtualWindow.document,fabric.jsdomImplForWrapper=require("jsdom/lib/jsdom/living/generated/utils").implForWrapper,fabric.nodeCanvas=require("jsdom/lib/jsdom/utils").Canvas,fabric.window=virtualWindow,DOMParser=fabric.window.DOMParser}function resizeCanvasIfNeeded(n){var t=n.targetCanvas,e=n.destinationWidth,r=n.destinationHeight;(t.width!==e||t.height!==r)&&(t.width=e,t.height=r)}function copyGLTo2DDrawImage(n,t){var s=n.canvas,a=t.targetCanvas,e=a.getContext("2d");e.translate(0,a.height),e.scale(1,-1),e.drawImage(s,0,s.height-a.height,a.width,a.height,0,0,a.width,a.height)}function copyGLTo2DPutImageData(n,t){var a=t.targetCanvas.getContext("2d"),e=t.destinationWidth,r=t.destinationHeight,i=e*r*4,o=new Uint8Array(this.imageBuffer,0,i),h=new Uint8ClampedArray(this.imageBuffer,0,i);n.readPixels(0,0,e,r,n.RGBA,n.UNSIGNED_BYTE,o);var l=new ImageData(h,e,r);a.putImageData(l,0,0)}fabric.isTouchSupported="ontouchstart"in fabric.window||"ontouchstart"in fabric.document||fabric.window&&fabric.window.navigator&&fabric.window.navigator.maxTouchPoints>0,fabric.isLikelyNode="undefined"!=typeof Buffer&&"undefined"==typeof window,fabric.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],fabric.DPI=96,fabric.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",fabric.commaWsp="(?:\\s+,?\\s*|,\\s*)",fabric.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/gi,fabric.reNonWord=/[ \n\.,;!\?\-]/,fabric.fontPaths={},fabric.iMatrix=[1,0,0,1,0,0],fabric.svgNS="http://www.w3.org/2000/svg",fabric.perfLimitSizeTotal=2097152,fabric.maxCacheSideLimit=4096,fabric.minCacheSideLimit=256,fabric.charWidthsCache={},fabric.textureSize=2048,fabric.disableStyleCopyPaste=!1,fabric.enableGLFiltering=!0,fabric.devicePixelRatio=fabric.window.devicePixelRatio||fabric.window.webkitDevicePixelRatio||fabric.window.mozDevicePixelRatio||1,fabric.browserShadowBlurConstant=1,fabric.arcToSegmentsCache={},fabric.boundsOfCurveCache={},fabric.cachesBoundsOfCurve=!0,fabric.forceGLPutImageData=!1,fabric.initFilterBackend=function(){return fabric.enableGLFiltering&&fabric.isWebglSupported&&fabric.isWebglSupported(fabric.textureSize)?(console.log("max texture size: "+fabric.maxTextureSize),new fabric.WebglFilterBackend({tileSize:fabric.textureSize})):fabric.Canvas2dFilterBackend?new fabric.Canvas2dFilterBackend:void 0},"undefined"!=typeof document&&"undefined"!=typeof window&&(window.fabric=fabric),function(){function n(i,o){if(this.__eventListeners[i]){var h=this.__eventListeners[i];o?h[h.indexOf(o)]=!1:fabric.util.array.fill(h,!1)}}function s(i,o){var h=function(){o.apply(this,arguments),this.off(i,h)}.bind(this);this.on(i,h)}fabric.Observable={fire:function r(i,o){if(!this.__eventListeners)return this;var h=this.__eventListeners[i];if(!h)return this;for(var l=0,c=h.length;l<c;l++)h[l]&&h[l].call(this,o||{});return this.__eventListeners[i]=h.filter(function(u){return!1!==u}),this},on:function t(i,o){if(this.__eventListeners||(this.__eventListeners={}),1===arguments.length)for(var h in i)this.on(h,i[h]);else this.__eventListeners[i]||(this.__eventListeners[i]=[]),this.__eventListeners[i].push(o);return this},once:function a(i,o){if(1===arguments.length)for(var h in i)s.call(this,h,i[h]);else s.call(this,i,o);return this},off:function e(i,o){if(!this.__eventListeners)return this;if(0===arguments.length)for(i in this.__eventListeners)n.call(this,i);else if(1===arguments.length&&"object"==typeof arguments[0])for(var h in i)n.call(this,h,i[h]);else n.call(this,i,o);return this}}}(),fabric.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var n=0,t=arguments.length;n<t;n++)this._onObjectAdded(arguments[n]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(n,t,s){var a=this._objects;return s?a[t]=n:a.splice(t,0,n),this._onObjectAdded&&this._onObjectAdded(n),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var t,n=this._objects,s=!1,a=0,e=arguments.length;a<e;a++)-1!==(t=n.indexOf(arguments[a]))&&(s=!0,n.splice(t,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[a]));return this.renderOnAddRemove&&s&&this.requestRenderAll(),this},forEachObject:function(n,t){for(var s=this.getObjects(),a=0,e=s.length;a<e;a++)n.call(t,s[a],a,s);return this},getObjects:function(n){return void 0===n?this._objects.concat():this._objects.filter(function(t){return t.type===n})},item:function(n){return this._objects[n]},isEmpty:function(){return 0===this._objects.length},size:function(){return this._objects.length},contains:function(n,t){return this._objects.indexOf(n)>-1||!!t&&this._objects.some(function(s){return"function"==typeof s.contains&&s.contains(n,!0)})},complexity:function(){return this._objects.reduce(function(n,t){return n+(t.complexity?t.complexity():0)},0)}},fabric.CommonMethods={_setOptions:function(n){for(var t in n)this.set(t,n[t])},_initGradient:function(n,t){n&&n.colorStops&&!(n instanceof fabric.Gradient)&&this.set(t,new fabric.Gradient(n))},_initPattern:function(n,t,s){!n||!n.source||n instanceof fabric.Pattern?s&&s():this.set(t,new fabric.Pattern(n,s))},_setObject:function(n){for(var t in n)this._set(t,n[t])},set:function(n,t){return"object"==typeof n?this._setObject(n):this._set(n,t),this},_set:function(n,t){this[n]=t},toggle:function(n){var t=this.get(n);return"boolean"==typeof t&&this.set(n,!t),this},get:function(n){return this[n]}},function(n){var t=Math.sqrt,s=Math.atan2,a=Math.pow,e=Math.PI/180,r=Math.PI/2;fabric.util={cos:function(i){if(0===i)return 1;switch(i<0&&(i=-i),i/r){case 1:case 3:return 0;case 2:return-1}return Math.cos(i)},sin:function(i){if(0===i)return 0;var h=1;switch(i<0&&(h=-1),i/r){case 1:return h;case 2:return 0;case 3:return-h}return Math.sin(i)},removeFromArray:function(i,o){var h=i.indexOf(o);return-1!==h&&i.splice(h,1),i},getRandomInt:function(i,o){return Math.floor(Math.random()*(o-i+1))+i},degreesToRadians:function(i){return i*e},radiansToDegrees:function(i){return i/e},rotatePoint:function(i,o,h){var l=new fabric.Point(i.x-o.x,i.y-o.y),c=fabric.util.rotateVector(l,h);return new fabric.Point(c.x,c.y).addEquals(o)},rotateVector:function(i,o){var h=fabric.util.sin(o),l=fabric.util.cos(o);return{x:i.x*l-i.y*h,y:i.x*h+i.y*l}},createVector:function(i,o){return new fabric.Point(o.x-i.x,o.y-i.y)},calcAngleBetweenVectors:function(i,o){return Math.acos((i.x*o.x+i.y*o.y)/(Math.hypot(i.x,i.y)*Math.hypot(o.x,o.y)))},getHatVector:function(i){return new fabric.Point(i.x,i.y).multiply(1/Math.hypot(i.x,i.y))},getBisector:function(i,o,h){var l=fabric.util.createVector(i,o),c=fabric.util.createVector(i,h),u=fabric.util.calcAngleBetweenVectors(l,c),d=fabric.util.calcAngleBetweenVectors(fabric.util.rotateVector(l,u),c);return{vector:fabric.util.getHatVector(fabric.util.rotateVector(l,u*(0===d?1:-1)/2)),angle:u}},projectStrokeOnPoints:function(i,o,h){var l=[],c=o.strokeWidth/2,u=o.strokeUniform?new fabric.Point(1/o.scaleX,1/o.scaleY):new fabric.Point(1,1),d=function(g){var v=c/Math.hypot(g.x,g.y);return new fabric.Point(g.x*v*u.x,g.y*v*u.y)};return i.length<=1||i.forEach(function(g,v){var T,E,w=new fabric.Point(g.x,g.y);0===v?(E=i[v+1],T=h?d(fabric.util.createVector(E,w)).addEquals(w):i[i.length-1]):v===i.length-1?(T=i[v-1],E=h?d(fabric.util.createVector(T,w)).addEquals(w):i[0]):(T=i[v-1],E=i[v+1]);var V,K,I=fabric.util.getBisector(w,T,E),H=I.vector;if("miter"===o.strokeLineJoin&&(V=-c/Math.sin(I.angle/2),K=new fabric.Point(H.x*V*u.x,H.y*V*u.y),Math.hypot(K.x,K.y)/c<=o.strokeMiterLimit))return l.push(w.add(K)),void l.push(w.subtract(K));V=-c*Math.SQRT2,K=new fabric.Point(H.x*V*u.x,H.y*V*u.y),l.push(w.add(K)),l.push(w.subtract(K))}),l},transformPoint:function(i,o,h){return h?new fabric.Point(o[0]*i.x+o[2]*i.y,o[1]*i.x+o[3]*i.y):new fabric.Point(o[0]*i.x+o[2]*i.y+o[4],o[1]*i.x+o[3]*i.y+o[5])},makeBoundingBoxFromPoints:function(i,o){if(o)for(var h=0;h<i.length;h++)i[h]=fabric.util.transformPoint(i[h],o);var l=[i[0].x,i[1].x,i[2].x,i[3].x],c=fabric.util.array.min(l),d=fabric.util.array.max(l)-c,g=[i[0].y,i[1].y,i[2].y,i[3].y],v=fabric.util.array.min(g);return{left:c,top:v,width:d,height:fabric.util.array.max(g)-v}},invertTransform:function(i){var o=1/(i[0]*i[3]-i[1]*i[2]),h=[o*i[3],-o*i[1],-o*i[2],o*i[0]],l=fabric.util.transformPoint({x:i[4],y:i[5]},h,!0);return h[4]=-l.x,h[5]=-l.y,h},toFixed:function(i,o){return parseFloat(Number(i).toFixed(o))},parseUnit:function(i,o){var h=/\D{0,2}$/.exec(i),l=parseFloat(i);switch(o||(o=fabric.Text.DEFAULT_SVG_FONT_SIZE),h[0]){case"mm":return l*fabric.DPI/25.4;case"cm":return l*fabric.DPI/2.54;case"in":return l*fabric.DPI;case"pt":return l*fabric.DPI/72;case"pc":return l*fabric.DPI/72*12;case"em":return l*o;default:return l}},falseFunction:function(){return!1},getKlass:function(i,o){return i=fabric.util.string.camelize(i.charAt(0).toUpperCase()+i.slice(1)),fabric.util.resolveNamespace(o)[i]},getSvgAttributes:function(i){var o=["instantiated_by_use","style","id","class"];switch(i){case"linearGradient":o=o.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":o=o.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":o=o.concat(["offset","stop-color","stop-opacity"])}return o},resolveNamespace:function(i){if(!i)return fabric;var l,o=i.split("."),h=o.length,c=n||fabric.window;for(l=0;l<h;++l)c=c[o[l]];return c},loadImage:function(i,o,h,l){if(i){var c=fabric.util.createImage(),u=function(){o&&o.call(h,c,!1),c=c.onload=c.onerror=null};c.onload=u,c.onerror=function(){fabric.log("Error loading "+c.src),o&&o.call(h,null,!0),c=c.onload=c.onerror=null},0!==i.indexOf("data")&&null!=l&&(c.crossOrigin=l),"data:image/svg"===i.substring(0,14)&&(c.onload=null,fabric.util.loadImageInDom(c,u)),c.src=i}else o&&o.call(h,i)},loadImageInDom:function(i,o){var h=fabric.document.createElement("div");h.style.width=h.style.height="1px",h.style.left=h.style.top="-100%",h.style.position="absolute",h.appendChild(i),fabric.document.querySelector("body").appendChild(h),i.onload=function(){o(),h.parentNode.removeChild(h),h=null}},enlivenObjects:function(i,o,h,l){var c=[],u=0,d=(i=i||[]).length;function g(){++u===d&&o&&o(c.filter(function(v){return v}))}d?i.forEach(function(v,w){v&&v.type?fabric.util.getKlass(v.type,h).fromObject(v,function(E,I){I||(c[w]=E),l&&l(v,E,I),g()}):g()}):o&&o(c)},enlivenObjectEnlivables:function(i,o,h){var l=fabric.Object.ENLIVEN_PROPS.filter(function(c){return!!i[c]});fabric.util.enlivenObjects(l.map(function(c){return i[c]}),function(c){var u={};l.forEach(function(d,g){u[d]=c[g],o&&(o[d]=c[g])}),h&&h(u)})},enlivenPatterns:function(i,o){function h(){++c===u&&o&&o(l)}var l=[],c=0,u=(i=i||[]).length;u?i.forEach(function(d,g){d&&d.source?new fabric.Pattern(d,function(v){l[g]=v,h()}):(l[g]=d,h())}):o&&o(l)},groupSVGElements:function(i,o,h){var l;return i&&1===i.length?i[0]:(o&&(o.width&&o.height?o.centerPoint={x:o.width/2,y:o.height/2}:(delete o.width,delete o.height)),l=new fabric.Group(i,o),void 0!==h&&(l.sourcePath=h),l)},populateWithProperties:function(i,o,h){if(h&&"[object Array]"===Object.prototype.toString.call(h))for(var l=0,c=h.length;l<c;l++)h[l]in i&&(o[h[l]]=i[h[l]])},createCanvasElement:function(){return fabric.document.createElement("canvas")},copyCanvasElement:function(i){var o=fabric.util.createCanvasElement();return o.width=i.width,o.height=i.height,o.getContext("2d").drawImage(i,0,0),o},toDataURL:function(i,o,h){return i.toDataURL("image/"+o,h)},createImage:function(){return fabric.document.createElement("img")},multiplyTransformMatrices:function(i,o,h){return[i[0]*o[0]+i[2]*o[1],i[1]*o[0]+i[3]*o[1],i[0]*o[2]+i[2]*o[3],i[1]*o[2]+i[3]*o[3],h?0:i[0]*o[4]+i[2]*o[5]+i[4],h?0:i[1]*o[4]+i[3]*o[5]+i[5]]},qrDecompose:function(i){var o=s(i[1],i[0]),h=a(i[0],2)+a(i[1],2),l=t(h),c=(i[0]*i[3]-i[2]*i[1])/l,u=s(i[0]*i[2]+i[1]*i[3],h);return{angle:o/e,scaleX:l,scaleY:c,skewX:u/e,skewY:0,translateX:i[4],translateY:i[5]}},calcRotateMatrix:function(i){if(!i.angle)return fabric.iMatrix.concat();var o=fabric.util.degreesToRadians(i.angle),h=fabric.util.cos(o),l=fabric.util.sin(o);return[h,l,-l,h,0,0]},calcDimensionsMatrix:function(i){var o=void 0===i.scaleX?1:i.scaleX,h=void 0===i.scaleY?1:i.scaleY,l=[i.flipX?-o:o,0,0,i.flipY?-h:h,0,0],c=fabric.util.multiplyTransformMatrices,u=fabric.util.degreesToRadians;return i.skewX&&(l=c(l,[1,0,Math.tan(u(i.skewX)),1],!0)),i.skewY&&(l=c(l,[1,Math.tan(u(i.skewY)),0,1],!0)),l},composeMatrix:function(i){var o=[1,0,0,1,i.translateX||0,i.translateY||0],h=fabric.util.multiplyTransformMatrices;return i.angle&&(o=h(o,fabric.util.calcRotateMatrix(i))),(1!==i.scaleX||1!==i.scaleY||i.skewX||i.skewY||i.flipX||i.flipY)&&(o=h(o,fabric.util.calcDimensionsMatrix(i))),o},resetObjectTransform:function(i){i.scaleX=1,i.scaleY=1,i.skewX=0,i.skewY=0,i.flipX=!1,i.flipY=!1,i.rotate(0)},saveObjectTransform:function(i){return{scaleX:i.scaleX,scaleY:i.scaleY,skewX:i.skewX,skewY:i.skewY,angle:i.angle,left:i.left,flipX:i.flipX,flipY:i.flipY,top:i.top}},isTransparent:function(i,o,h,l){l>0&&(o>l?o-=l:o=0,h>l?h-=l:h=0);var u,c=!0,g=i.getImageData(o,h,2*l||1,2*l||1),v=g.data.length;for(u=3;u<v&&!1!=(c=g.data[u]<=0);u+=4);return g=null,c},parsePreserveAspectRatioAttribute:function(i){var u,o="meet",c=i.split(" ");return c&&c.length&&("meet"!==(o=c.pop())&&"slice"!==o?(u=o,o="meet"):c.length&&(u=c.pop())),{meetOrSlice:o,alignX:"none"!==u?u.slice(1,4):"none",alignY:"none"!==u?u.slice(5,8):"none"}},clearFabricFontCache:function(i){(i=(i||"").toLowerCase())?fabric.charWidthsCache[i]&&delete fabric.charWidthsCache[i]:fabric.charWidthsCache={}},limitDimsByArea:function(i,o){var h=Math.sqrt(o*i),l=Math.floor(o/h);return{x:Math.floor(h),y:l}},capValue:function(i,o,h){return Math.max(i,Math.min(o,h))},findScaleToFit:function(i,o){return Math.min(o.width/i.width,o.height/i.height)},findScaleToCover:function(i,o){return Math.max(o.width/i.width,o.height/i.height)},matrixToSVG:function(i){return"matrix("+i.map(function(o){return fabric.util.toFixed(o,fabric.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(i,o){var h=fabric.util.invertTransform(o),l=fabric.util.multiplyTransformMatrices(h,i.calcOwnMatrix());fabric.util.applyTransformToObject(i,l)},addTransformToObject:function(i,o){fabric.util.applyTransformToObject(i,fabric.util.multiplyTransformMatrices(o,i.calcOwnMatrix()))},applyTransformToObject:function(i,o){var h=fabric.util.qrDecompose(o),l=new fabric.Point(h.translateX,h.translateY);i.flipX=!1,i.flipY=!1,i.set("scaleX",h.scaleX),i.set("scaleY",h.scaleY),i.skewX=h.skewX,i.skewY=h.skewY,i.angle=h.angle,i.setPositionByOrigin(l,"center","center")},sizeAfterTransform:function(i,o,h){var l=i/2,c=o/2,u=[{x:-l,y:-c},{x:l,y:-c},{x:-l,y:c},{x:l,y:c}],d=fabric.util.calcDimensionsMatrix(h),g=fabric.util.makeBoundingBoxFromPoints(u,d);return{x:g.width,y:g.height}},mergeClipPaths:function(i,o){var h=i,l=o;h.inverted&&!l.inverted&&(h=o,l=i),fabric.util.applyTransformToObject(l,fabric.util.multiplyTransformMatrices(fabric.util.invertTransform(h.calcTransformMatrix()),l.calcTransformMatrix()));var c=h.inverted&&l.inverted;return c&&(h.inverted=l.inverted=!1),new fabric.Group([h],{clipPath:l,inverted:c})}}}("undefined"!=typeof exports?exports:this),function(){var n=Array.prototype.join,t={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},s={m:"l",M:"L"};function a(S,R,b,D,L,P,C,M,A,N,B){var W=fabric.util.cos(S),U=fabric.util.sin(S),Z=fabric.util.cos(R),z=fabric.util.sin(R),y=b*L*Z-D*P*z+C,f=D*L*Z+b*P*z+M;return["C",N+A*(-b*L*U-D*P*W),B+A*(-D*L*U+b*P*W),y+A*(b*L*z+D*P*Z),f+A*(D*L*z-b*P*Z),y,f]}function r(S,R,b,D){var L=Math.atan2(R,S),P=Math.atan2(D,b);return P>=L?P-L:2*Math.PI-(L-P)}function o(S,R,b){for(var B=function e(S,R,b,D,L,P,C){var M=Math.PI,A=C*M/180,N=fabric.util.sin(A),B=fabric.util.cos(A),W=0,U=0,Z=-B*S*.5-N*R*.5,z=-B*R*.5+N*S*.5,y=(b=Math.abs(b))*b,f=(D=Math.abs(D))*D,p=z*z,m=Z*Z,_=y*f-y*p-f*m,x=0;if(_<0){var F=Math.sqrt(1-_/(y*f));b*=F,D*=F}else x=(L===P?-1:1)*Math.sqrt(_/(y*p+f*m));var O=x*b*z/D,k=-x*D*Z/b,G=B*O-N*k+.5*S,X=N*O+B*k+.5*R,J=r(1,0,(Z-O)/b,(z-k)/D),it=r((Z-O)/b,(z-k)/D,(-Z-O)/b,(-z-k)/D);0===P&&it>0?it-=2*M:1===P&&it<0&&(it+=2*M);for(var tt=Math.ceil(Math.abs(it/M*2)),rt=[],nt=it/tt,st=8/3*Math.sin(nt/4)*Math.sin(nt/4)/Math.sin(nt/2),ot=J+nt,at=0;at<tt;at++)rt[at]=a(J,ot,B,N,b,D,G,X,st,W,U),W=rt[at][5],U=rt[at][6],J=ot,ot+=nt;return rt}(b[6]-S,b[7]-R,b[1],b[2],b[4],b[5],b[3]),W=0,U=B.length;W<U;W++)B[W][1]+=S,B[W][2]+=R,B[W][3]+=S,B[W][4]+=R,B[W][5]+=S,B[W][6]+=R;return B}function l(S,R,b,D){return Math.sqrt((b-S)*(b-S)+(D-R)*(D-R))}function v(S,R,b,D,L,P,C,M){return function(A){var N=function c(S){return S*S*S}(A),B=function u(S){return 3*S*S*(1-S)}(A),W=function d(S){return 3*S*(1-S)*(1-S)}(A),U=function g(S){return(1-S)*(1-S)*(1-S)}(A);return{x:C*N+L*B+b*W+S*U,y:M*N+P*B+D*W+R*U}}}function w(S,R,b,D,L,P,C,M){return function(A){var N=1-A;return Math.atan2(3*N*N*(D-R)+6*N*A*(P-D)+3*A*A*(M-P),3*N*N*(b-S)+6*N*A*(L-b)+3*A*A*(C-L))}}function H(S,R,b,D,L,P){return function(C){var M=function T(S){return S*S}(C),A=function E(S){return 2*S*(1-S)}(C),N=function I(S){return(1-S)*(1-S)}(C);return{x:L*M+b*A+S*N,y:P*M+D*A+R*N}}}function j(S,R,b,D,L,P){return function(C){var M=1-C;return Math.atan2(2*M*(D-R)+2*C*(P-D),2*M*(b-S)+2*C*(L-b))}}function V(S,R,b){var L,C,D={x:R,y:b},P=0;for(C=1;C<=100;C+=1)L=S(C/100),P+=l(D.x,D.y,L.x,L.y),D=L;return P}function q(S){for(var D,N,B,W,R=0,b=S.length,L=0,P=0,C=0,M=0,A=[],U=0;U<b;U++){switch(B={x:L,y:P,command:(D=S[U])[0]},D[0]){case"M":B.length=0,C=L=D[1],M=P=D[2];break;case"L":B.length=l(L,P,D[1],D[2]),L=D[1],P=D[2];break;case"C":N=v(L,P,D[1],D[2],D[3],D[4],D[5],D[6]),W=w(L,P,D[1],D[2],D[3],D[4],D[5],D[6]),B.iterator=N,B.angleFinder=W,B.length=V(N,L,P),L=D[5],P=D[6];break;case"Q":N=H(L,P,D[1],D[2],D[3],D[4]),W=j(L,P,D[1],D[2],D[3],D[4]),B.iterator=N,B.angleFinder=W,B.length=V(N,L,P),L=D[3],P=D[4];break;case"Z":case"z":B.destX=C,B.destY=M,B.length=l(L,P,C,M),L=C,P=M}R+=B.length,A.push(B)}return A.push({length:R,x:L,y:P}),A}fabric.util.joinPath=function(S){return S.map(function(R){return R.join(" ")}).join(" ")},fabric.util.parsePath=function Q(S){var D,L,W,U,Z,R=[],b=[],P=fabric.rePathCommand,C="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",M="("+C+")"+fabric.commaWsp,A="([01])"+fabric.commaWsp+"?",B=new RegExp(M+"?"+M+"?"+M+A+A+M+"?("+C+")","g");if(!S||!S.match)return R;for(var y,z=0,f=(Z=S.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi)).length;z<f;z++){U=(D=Z[z]).slice(1).trim(),b.length=0;var p=D.charAt(0);if(y=[p],"a"===p.toLowerCase())for(var m;m=B.exec(U);)for(var _=1;_<m.length;_++)b.push(m[_]);else for(;W=P.exec(U);)b.push(W[0]);_=0;for(var x=b.length;_<x;_++)L=parseFloat(b[_]),isNaN(L)||y.push(L);var F=t[p.toLowerCase()],O=s[p]||p;if(y.length-1>F)for(var k=1,G=y.length;k<G;k+=F)R.push([p].concat(y.slice(k,k+F))),p=O;else R.push(y)}return R},fabric.util.makePathSimpler=function h(S){var C,M,A,B,W,U,R=0,b=0,D=S.length,L=0,P=0,N=[];for(M=0;M<D;++M){switch(A=!1,(C=S[M].slice(0))[0]){case"l":C[0]="L",C[1]+=R,C[2]+=b;case"L":R=C[1],b=C[2];break;case"h":C[1]+=R;case"H":C[0]="L",C[2]=b,R=C[1];break;case"v":C[1]+=b;case"V":C[0]="L",b=C[1],C[1]=R,C[2]=b;break;case"m":C[0]="M",C[1]+=R,C[2]+=b;case"M":R=C[1],b=C[2],L=C[1],P=C[2];break;case"c":C[0]="C",C[1]+=R,C[2]+=b,C[3]+=R,C[4]+=b,C[5]+=R,C[6]+=b;case"C":W=C[3],U=C[4],R=C[5],b=C[6];break;case"s":C[0]="S",C[1]+=R,C[2]+=b,C[3]+=R,C[4]+=b;case"S":"C"===B?(W=2*R-W,U=2*b-U):(W=R,U=b),R=C[3],b=C[4],C[0]="C",C[5]=C[3],C[6]=C[4],C[3]=C[1],C[4]=C[2],C[1]=W,C[2]=U,W=C[3],U=C[4];break;case"q":C[0]="Q",C[1]+=R,C[2]+=b,C[3]+=R,C[4]+=b;case"Q":W=C[1],U=C[2],R=C[3],b=C[4];break;case"t":C[0]="T",C[1]+=R,C[2]+=b;case"T":"Q"===B?(W=2*R-W,U=2*b-U):(W=R,U=b),C[0]="Q",R=C[1],b=C[2],C[1]=W,C[2]=U,C[3]=R,C[4]=b;break;case"a":C[0]="A",C[6]+=R,C[7]+=b;case"A":A=!0,N=N.concat(o(R,b,C)),R=C[6],b=C[7];break;case"z":case"Z":R=L,b=P}A||N.push(C),B=C[0]}return N},fabric.util.getSmoothPathFromPoints=function et(S,R){var D,b=[],L=new fabric.Point(S[0].x,S[0].y),P=new fabric.Point(S[1].x,S[1].y),C=S.length,M=1,A=0,N=C>2;for(N&&(M=S[2].x<P.x?-1:S[2].x===P.x?0:1,A=S[2].y<P.y?-1:S[2].y===P.y?0:1),b.push(["M",L.x-M*(R=R||0),L.y-A*R]),D=1;D<C;D++){if(!L.eq(P)){var B=L.midPointFrom(P);b.push(["Q",L.x,L.y,B.x,B.y])}L=S[D],D+1<S.length&&(P=S[D+1])}return N&&(M=L.x>S[D-2].x?1:L.x===S[D-2].x?0:-1,A=L.y>S[D-2].y?1:L.y===S[D-2].y?0:-1),b.push(["L",L.x+M*R,L.y+A*R]),b},fabric.util.getPathSegmentsInfo=q,fabric.util.getBoundsOfCurve=function i(S,R,b,D,L,P,C,M){var A;if(fabric.cachesBoundsOfCurve&&(A=n.call(arguments),fabric.boundsOfCurveCache[A]))return fabric.boundsOfCurveCache[A];var y,f,p,m,_,x,F,O,N=Math.sqrt,B=Math.min,W=Math.max,U=Math.abs,Z=[],z=[[],[]];f=6*S-12*b+6*L,y=-3*S+9*b-9*L+3*C,p=3*b-3*S;for(var k=0;k<2;++k)if(k>0&&(f=6*R-12*D+6*P,y=-3*R+9*D-9*P+3*M,p=3*D-3*R),U(y)<1e-12){if(U(f)<1e-12)continue;0<(m=-p/f)&&m<1&&Z.push(m)}else!((F=f*f-4*p*y)<0)&&(0<(_=(-f+(O=N(F)))/(2*y))&&_<1&&Z.push(_),0<(x=(-f-O)/(2*y))&&x<1&&Z.push(x));for(var tt,J=Z.length,it=J;J--;)z[0][J]=(tt=1-(m=Z[J]))*tt*tt*S+3*tt*tt*m*b+3*tt*m*m*L+m*m*m*C,z[1][J]=tt*tt*tt*R+3*tt*tt*m*D+3*tt*m*m*P+m*m*m*M;z[0][it]=S,z[1][it]=R,z[0][it+1]=C,z[1][it+1]=M;var rt=[{x:B.apply(null,z[0]),y:B.apply(null,z[1])},{x:W.apply(null,z[0]),y:W.apply(null,z[1])}];return fabric.cachesBoundsOfCurve&&(fabric.boundsOfCurveCache[A]=rt),rt},fabric.util.getPointOnPath=function Y(S,R,b){b||(b=q(S));for(var D=0;R-b[D].length>0&&D<b.length-2;)R-=b[D].length,D++;var A,L=b[D],P=R/L.length,M=S[D];switch(L.command){case"M":return{x:L.x,y:L.y,angle:0};case"Z":case"z":return(A=new fabric.Point(L.x,L.y).lerp(new fabric.Point(L.destX,L.destY),P)).angle=Math.atan2(L.destY-L.y,L.destX-L.x),A;case"L":return(A=new fabric.Point(L.x,L.y).lerp(new fabric.Point(M[1],M[2]),P)).angle=Math.atan2(M[2]-L.y,M[1]-L.x),A;case"C":case"Q":return function K(S,R){for(var C,M,B,b=0,D=0,L=S.iterator,P={x:S.x,y:S.y},A=.01,N=S.angleFinder;D<R&&A>1e-4;)C=L(b),B=b,(M=l(P.x,P.y,C.x,C.y))+D>R?(b-=A,A/=2):(P=C,b+=A,D+=M);return C.angle=N(B),C}(L,R)}},fabric.util.transformPath=function $(S,R,b){return b&&(R=fabric.util.multiplyTransformMatrices(R,[1,0,0,1,-b.x,-b.y])),S.map(function(D){for(var L=D.slice(0),P={},C=1;C<D.length-1;C+=2)P.x=D[C],P.y=D[C+1],P=fabric.util.transformPoint(P,R),L[C]=P.x,L[C+1]=P.y;return L})}}(),function(){var n=Array.prototype.slice;function r(i,o,h){if(i&&0!==i.length){var l=i.length-1,c=o?i[l][o]:i[l];if(o)for(;l--;)h(i[l][o],c)&&(c=i[l][o]);else for(;l--;)h(i[l],c)&&(c=i[l]);return c}}fabric.util.array={fill:function e(i,o){for(var h=i.length;h--;)i[h]=o;return i},invoke:function t(i,o){for(var h=n.call(arguments,2),l=[],c=0,u=i.length;c<u;c++)l[c]=h.length?i[c][o].apply(i[c],h):i[c][o].call(i[c]);return l},min:function a(i,o){return r(i,o,function(h,l){return h<l})},max:function s(i,o){return r(i,o,function(h,l){return h>=l})}}}(),function(){function n(s,a,e){if(e)if(!fabric.isLikelyNode&&a instanceof Element)s=a;else if(a instanceof Array){s=[];for(var r=0,i=a.length;r<i;r++)s[r]=n({},a[r],e)}else if(a&&"object"==typeof a)for(var o in a)"canvas"===o||"group"===o?s[o]=null:a.hasOwnProperty(o)&&(s[o]=n({},a[o],e));else s=a;else for(var o in a)s[o]=a[o];return s}fabric.util.object={extend:n,clone:function t(s,a){return n({},s,a)}},fabric.util.object.extend(fabric.util,fabric.Observable)}(),function(){function e(r,i){var o=r.charCodeAt(i);if(isNaN(o))return"";if(o<55296||o>57343)return r.charAt(i);if(55296<=o&&o<=56319){if(r.length<=i+1)throw"High surrogate without following low surrogate";var h=r.charCodeAt(i+1);if(56320>h||h>57343)throw"High surrogate without following low surrogate";return r.charAt(i)+r.charAt(i+1)}if(0===i)throw"Low surrogate without preceding high surrogate";var l=r.charCodeAt(i-1);if(55296>l||l>56319)throw"Low surrogate without preceding high surrogate";return!1}fabric.util.string={camelize:function n(r){return r.replace(/-+(.)?/g,function(i,o){return o?o.toUpperCase():""})},capitalize:function t(r,i){return r.charAt(0).toUpperCase()+(i?r.slice(1):r.slice(1).toLowerCase())},escapeXml:function s(r){return r.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},graphemeSplit:function a(r){var o,i=0,h=[];for(i=0;i<r.length;i++)!1!==(o=e(r,i))&&h.push(o);return h}}}(),function(){var n=Array.prototype.slice,t=function(){},s=function(){for(var o in{toString:1})if("toString"===o)return!1;return!0}(),a=function(o,h,l){for(var c in h)o.prototype[c]=c in o.prototype&&"function"==typeof o.prototype[c]&&(h[c]+"").indexOf("callSuper")>-1?function(u){return function(){var d=this.constructor.superclass;this.constructor.superclass=l;var g=h[u].apply(this,arguments);if(this.constructor.superclass=d,"initialize"!==u)return g}}(c):h[c],s&&(h.toString!==Object.prototype.toString&&(o.prototype.toString=h.toString),h.valueOf!==Object.prototype.valueOf&&(o.prototype.valueOf=h.valueOf))};function e(){}function r(o){for(var h=null,l=this;l.constructor.superclass;){var c=l.constructor.superclass.prototype[o];if(l[o]!==c){h=c;break}l=l.constructor.superclass.prototype}return h?arguments.length>1?h.apply(this,n.call(arguments,1)):h.call(this):console.log("tried to callSuper "+o+", method not found in prototype chain",this)}fabric.util.createClass=function i(){var o=null,h=n.call(arguments,0);function l(){this.initialize.apply(this,arguments)}"function"==typeof h[0]&&(o=h.shift()),l.superclass=o,l.subclasses=[],o&&(e.prototype=o.prototype,l.prototype=new e,o.subclasses.push(l));for(var c=0,u=h.length;c<u;c++)a(l,h[c],o);return l.prototype.initialize||(l.prototype.initialize=t),l.prototype.constructor=l,l.prototype.callSuper=r,l}}(),function(){var n=!!fabric.document.createElement("div").attachEvent,t=["touchstart","touchmove","touchend"];fabric.util.addListener=function(a,e,r,i){a&&a.addEventListener(e,r,!n&&i)},fabric.util.removeListener=function(a,e,r,i){a&&a.removeEventListener(e,r,!n&&i)},fabric.util.getPointer=function(a){var r=fabric.util.getScrollLeftTop(a.target),i=function s(a){var e=a.changedTouches;return e&&e[0]?e[0]:a}(a);return{x:i.clientX+r.left,y:i.clientY+r.top}},fabric.util.isTouchEvent=function(a){return t.indexOf(a.type)>-1||"touch"===a.pointerType}}(),function(){var t=fabric.document.createElement("div"),e=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,r=function(i){return i};"string"==typeof t.style.opacity?r=function(i,o){return i.style.opacity=o,i}:"string"==typeof t.style.filter&&(r=function(i,o){var h=i.style;return i.currentStyle&&!i.currentStyle.hasLayout&&(h.zoom=1),e.test(h.filter)?h.filter=h.filter.replace(e,o=o>=.9999?"":"alpha(opacity="+100*o+")"):h.filter+=" alpha(opacity="+100*o+")",i}),fabric.util.setStyle=function n(i,o){var h=i.style;if(!h)return i;if("string"==typeof o)return i.style.cssText+=";"+o,o.indexOf("opacity")>-1?r(i,o.match(/opacity:\s*(\d?\.?\d*)/)[1]):i;for(var l in o)"opacity"===l?r(i,o[l]):h["float"===l||"cssFloat"===l?void 0===h.styleFloat?"cssFloat":"styleFloat":l]=o[l];return i}}(),function(){var s,l,g,v,n=Array.prototype.slice,a=function(g){return n.call(g,0)};try{s=a(fabric.document.childNodes)instanceof Array}catch(g){}function e(g,v){var w=fabric.document.createElement(g);for(var T in v)"class"===T?w.className=v[T]:"for"===T?w.htmlFor=v[T]:w.setAttribute(T,v[T]);return w}function o(g){for(var v=0,w=0,T=fabric.document.documentElement,E=fabric.document.body||{scrollLeft:0,scrollTop:0};g&&(g.parentNode||g.host)&&((g=g.parentNode||g.host)===fabric.document?(v=E.scrollLeft||T.scrollLeft||0,w=E.scrollTop||T.scrollTop||0):(v+=g.scrollLeft||0,w+=g.scrollTop||0),1!==g.nodeType||"fixed"!==g.style.position););return{left:v,top:w}}s||(a=function(g){for(var v=new Array(g.length),w=g.length;w--;)v[w]=g[w];return v}),l=fabric.document.defaultView&&fabric.document.defaultView.getComputedStyle?function(g,v){var w=fabric.document.defaultView.getComputedStyle(g,null);return w?w[v]:void 0}:function(g,v){var w=g.style[v];return!w&&g.currentStyle&&(w=g.currentStyle[v]),w},v="userSelect"in(g=fabric.document.documentElement.style)?"userSelect":"MozUserSelect"in g?"MozUserSelect":"WebkitUserSelect"in g?"WebkitUserSelect":"KhtmlUserSelect"in g?"KhtmlUserSelect":"",fabric.util.makeElementUnselectable=function w(E){return void 0!==E.onselectstart&&(E.onselectstart=fabric.util.falseFunction),v?E.style[v]="none":"string"==typeof E.unselectable&&(E.unselectable="on"),E},fabric.util.makeElementSelectable=function T(E){return void 0!==E.onselectstart&&(E.onselectstart=null),v?E.style[v]="":"string"==typeof E.unselectable&&(E.unselectable=""),E},fabric.util.setImageSmoothing=function d(g,v){g.imageSmoothingEnabled=g.imageSmoothingEnabled||g.webkitImageSmoothingEnabled||g.mozImageSmoothingEnabled||g.msImageSmoothingEnabled||g.oImageSmoothingEnabled,g.imageSmoothingEnabled=v},fabric.util.getById=function t(g){return"string"==typeof g?fabric.document.getElementById(g):g},fabric.util.toArray=a,fabric.util.addClass=function r(g,v){g&&-1===(" "+g.className+" ").indexOf(" "+v+" ")&&(g.className+=(g.className?" ":"")+v)},fabric.util.makeElement=e,fabric.util.wrapElement=function i(g,v,w){return"string"==typeof v&&(v=e(v,w)),g.parentNode&&g.parentNode.replaceChild(v,g),v.appendChild(g),v},fabric.util.getScrollLeftTop=o,fabric.util.getElementOffset=function h(g){var v,I,w=g&&g.ownerDocument,T={left:0,top:0},E={left:0,top:0},H={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!w)return E;for(var j in H)E[H[j]]+=parseInt(l(g,j),10)||0;return v=w.documentElement,void 0!==g.getBoundingClientRect&&(T=g.getBoundingClientRect()),I=o(g),{left:T.left+I.left-(v.clientLeft||0)+E.left,top:T.top+I.top-(v.clientTop||0)+E.top}},fabric.util.getNodeCanvas=function c(g){var v=fabric.jsdomImplForWrapper(g);return v._canvas||v._image},fabric.util.cleanUpJsdomNode=function u(g){if(fabric.isLikelyNode){var v=fabric.jsdomImplForWrapper(g);v&&(v._image=null,v._canvas=null,v._currentSrc=null,v._attributes=null,v._classList=null)}}}(),function(){function t(){}fabric.util.request=function s(a,e){e||(e={});var r=e.method?e.method.toUpperCase():"GET",i=e.onComplete||function(){},o=new fabric.window.XMLHttpRequest,h=e.body||e.parameters;return o.onreadystatechange=function(){4===o.readyState&&(i(o),o.onreadystatechange=t)},"GET"===r&&(h=null,"string"==typeof e.parameters&&(a=function n(a,e){return a+(/\?/.test(a)?"&":"?")+e}(a,e.parameters))),o.open(r,a,!0),("POST"===r||"PUT"===r)&&o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send(h),o}}(),fabric.log=console.log,fabric.warn=console.warn,function(){var n=fabric.util.object.extend,t=fabric.util.object.clone,s=[];function a(){return!1}function e(c,u,d,g){return-d*Math.cos(c/g*(Math.PI/2))+d+u}fabric.util.object.extend(s,{cancelAll:function(){var c=this.splice(0);return c.forEach(function(u){u.cancel()}),c},cancelByCanvas:function(c){if(!c)return[];var u=this.filter(function(d){return"object"==typeof d.target&&d.target.canvas===c});return u.forEach(function(d){d.cancel()}),u},cancelByTarget:function(c){var u=this.findAnimationsByTarget(c);return u.forEach(function(d){d.cancel()}),u},findAnimationIndex:function(c){return this.indexOf(this.findAnimation(c))},findAnimation:function(c){return this.find(function(u){return u.cancel===c})},findAnimationsByTarget:function(c){return c?this.filter(function(u){return u.target===c}):[]}});var i=fabric.window.requestAnimationFrame||fabric.window.webkitRequestAnimationFrame||fabric.window.mozRequestAnimationFrame||fabric.window.oRequestAnimationFrame||fabric.window.msRequestAnimationFrame||function(c){return fabric.window.setTimeout(c,1e3/60)},o=fabric.window.cancelAnimationFrame||fabric.window.clearTimeout;function h(){return i.apply(fabric.window,arguments)}fabric.util.animate=function r(c){c||(c={});var d,u=!1,g=function(){var v=fabric.runningAnimations.indexOf(d);return v>-1&&fabric.runningAnimations.splice(v,1)[0]};return d=n(t(c),{cancel:function(){return u=!0,g()},currentValue:"startValue"in c?c.startValue:0,completionRate:0,durationRate:0}),fabric.runningAnimations.push(d),h(function(v){var I,w=v||+new Date,T=c.duration||500,E=w+T,H=c.onChange||a,j=c.abort||a,V=c.onComplete||a,K=c.easing||e,q="startValue"in c&&c.startValue.length>0,Y="startValue"in c?c.startValue:0,Q="endValue"in c?c.endValue:100,et=c.byValue||(q?Y.map(function($,S){return Q[S]-Y[S]}):Q-Y);c.onStart&&c.onStart(),function $(S){var R=(I=S||+new Date)>E?T:I-w,b=R/T,D=q?Y.map(function(P,C){return K(R,Y[C],et[C],T)}):K(R,Y,et,T),L=Math.abs(q?(D[0]-Y[0])/et[0]:(D-Y)/et);if(d.currentValue=q?D.slice():D,d.completionRate=L,d.durationRate=b,!u){if(j(D,L,b))return void g();if(I>E)return d.currentValue=q?Q.slice():Q,d.completionRate=1,d.durationRate=1,H(q?Q.slice():Q,1,1),V(Q,1,1),void g();H(D,L,b),h($)}}(w)}),d.cancel},fabric.util.requestAnimFrame=h,fabric.util.cancelAnimFrame=function l(){return o.apply(fabric.window,arguments)},fabric.runningAnimations=s}(),function(){function n(s,a,e){var r="rgba("+parseInt(s[0]+e*(a[0]-s[0]),10)+","+parseInt(s[1]+e*(a[1]-s[1]),10)+","+parseInt(s[2]+e*(a[2]-s[2]),10);return(r+=","+(s&&a?parseFloat(s[3]+e*(a[3]-s[3])):1))+")"}fabric.util.animateColor=function t(s,a,e,r){var i=new fabric.Color(s).getSource(),o=new fabric.Color(a).getSource(),h=r.onComplete,l=r.onChange;return fabric.util.animate(fabric.util.object.extend(r=r||{},{duration:e||500,startValue:i,endValue:o,byValue:o,easing:function(c,u,d,g){return n(u,d,r.colorEasing?r.colorEasing(c,g):1-Math.cos(c/g*(Math.PI/2)))},onComplete:function(c,u,d){if(h)return h(n(o,o,0),u,d)},onChange:function(c,u,d){if(l){if(Array.isArray(c))return l(n(c,c,0),u,d);l(c,u,d)}}}))}}(),function(){function n(S,R,b,D){return S<Math.abs(R)?(S=R,D=b/4):D=0===R&&0===S?b/(2*Math.PI)*Math.asin(1):b/(2*Math.PI)*Math.asin(R/S),{a:S,c:R,p:b,s:D}}function t(S,R,b){return S.a*Math.pow(2,10*(R-=1))*Math.sin((R*b-S.s)*(2*Math.PI)/S.p)}function Q(S,R,b,D){return b-et(D-S,0,b,D)+R}function et(S,R,b,D){return(S/=D)<1/2.75?b*(7.5625*S*S)+R:S<2/2.75?b*(7.5625*(S-=1.5/2.75)*S+.75)+R:S<2.5/2.75?b*(7.5625*(S-=2.25/2.75)*S+.9375)+R:b*(7.5625*(S-=2.625/2.75)*S+.984375)+R}fabric.util.ease={easeInQuad:function(S,R,b,D){return b*(S/=D)*S+R},easeOutQuad:function(S,R,b,D){return-b*(S/=D)*(S-2)+R},easeInOutQuad:function(S,R,b,D){return(S/=D/2)<1?b/2*S*S+R:-b/2*(--S*(S-2)-1)+R},easeInCubic:function(S,R,b,D){return b*(S/=D)*S*S+R},easeOutCubic:function s(S,R,b,D){return b*((S=S/D-1)*S*S+1)+R},easeInOutCubic:function a(S,R,b,D){return(S/=D/2)<1?b/2*S*S*S+R:b/2*((S-=2)*S*S+2)+R},easeInQuart:function e(S,R,b,D){return b*(S/=D)*S*S*S+R},easeOutQuart:function r(S,R,b,D){return-b*((S=S/D-1)*S*S*S-1)+R},easeInOutQuart:function i(S,R,b,D){return(S/=D/2)<1?b/2*S*S*S*S+R:-b/2*((S-=2)*S*S*S-2)+R},easeInQuint:function o(S,R,b,D){return b*(S/=D)*S*S*S*S+R},easeOutQuint:function h(S,R,b,D){return b*((S=S/D-1)*S*S*S*S+1)+R},easeInOutQuint:function l(S,R,b,D){return(S/=D/2)<1?b/2*S*S*S*S*S+R:b/2*((S-=2)*S*S*S*S+2)+R},easeInSine:function c(S,R,b,D){return-b*Math.cos(S/D*(Math.PI/2))+b+R},easeOutSine:function u(S,R,b,D){return b*Math.sin(S/D*(Math.PI/2))+R},easeInOutSine:function d(S,R,b,D){return-b/2*(Math.cos(Math.PI*S/D)-1)+R},easeInExpo:function g(S,R,b,D){return 0===S?R:b*Math.pow(2,10*(S/D-1))+R},easeOutExpo:function v(S,R,b,D){return S===D?R+b:b*(1-Math.pow(2,-10*S/D))+R},easeInOutExpo:function w(S,R,b,D){return 0===S?R:S===D?R+b:(S/=D/2)<1?b/2*Math.pow(2,10*(S-1))+R:b/2*(2-Math.pow(2,-10*--S))+R},easeInCirc:function T(S,R,b,D){return-b*(Math.sqrt(1-(S/=D)*S)-1)+R},easeOutCirc:function E(S,R,b,D){return b*Math.sqrt(1-(S=S/D-1)*S)+R},easeInOutCirc:function I(S,R,b,D){return(S/=D/2)<1?-b/2*(Math.sqrt(1-S*S)-1)+R:b/2*(Math.sqrt(1-(S-=2)*S)+1)+R},easeInElastic:function H(S,R,b,D){var P=0;return 0===S?R:1==(S/=D)?R+b:(P||(P=.3*D),-t(n(b,b,P,1.70158),S,D)+R)},easeOutElastic:function j(S,R,b,D){var P=0;if(0===S)return R;if(1==(S/=D))return R+b;P||(P=.3*D);var M=n(b,b,P,1.70158);return M.a*Math.pow(2,-10*S)*Math.sin((S*D-M.s)*(2*Math.PI)/M.p)+M.c+R},easeInOutElastic:function V(S,R,b,D){var P=0;if(0===S)return R;if(2==(S/=D/2))return R+b;P||(P=D*(.3*1.5));var M=n(b,b,P,1.70158);return S<1?-.5*t(M,S,D)+R:M.a*Math.pow(2,-10*(S-=1))*Math.sin((S*D-M.s)*(2*Math.PI)/M.p)*.5+M.c+R},easeInBack:function K(S,R,b,D,L){return void 0===L&&(L=1.70158),b*(S/=D)*S*((L+1)*S-L)+R},easeOutBack:function q(S,R,b,D,L){return void 0===L&&(L=1.70158),b*((S=S/D-1)*S*((L+1)*S+L)+1)+R},easeInOutBack:function Y(S,R,b,D,L){return void 0===L&&(L=1.70158),(S/=D/2)<1?b/2*(S*S*((1+(L*=1.525))*S-L))+R:b/2*((S-=2)*S*((1+(L*=1.525))*S+L)+2)+R},easeInBounce:Q,easeOutBounce:et,easeInOutBounce:function $(S,R,b,D){return S<D/2?.5*Q(2*S,0,b,D)+R:.5*et(2*S-D,0,b,D)+.5*b+R}}}(),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.object.extend,a=t.util.object.clone,e=t.util.toFixed,r=t.util.parseUnit,i=t.util.multiplyTransformMatrices,u={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},d={stroke:"strokeOpacity",fill:"fillOpacity"},g="font-size",v="clip-path";function w(P){return P in u?u[P]:P}function T(P,C,M,A){var B,N="[object Array]"===Object.prototype.toString.call(C);if("fill"!==P&&"stroke"!==P||"none"!==C){if("strokeUniform"===P)return"non-scaling-stroke"===C;if("strokeDashArray"===P)C="none"===C?null:C.replace(/,/g," ").split(/\s+/).map(parseFloat);else if("transformMatrix"===P)C=M&&M.transformMatrix?i(M.transformMatrix,t.parseTransformAttribute(C)):t.parseTransformAttribute(C);else if("visible"===P)C="none"!==C&&"hidden"!==C,M&&!1===M.visible&&(C=!1);else if("opacity"===P)C=parseFloat(C),M&&void 0!==M.opacity&&(C*=M.opacity);else if("textAnchor"===P)C="start"===C?"left":"end"===C?"right":"center";else if("charSpacing"===P)B=r(C,A)/A*1e3;else if("paintFirst"===P){var W=C.indexOf("fill"),U=C.indexOf("stroke");C="fill",(W>-1&&U>-1&&U<W||-1===W&&U>-1)&&(C="stroke")}else{if("href"===P||"xlink:href"===P||"font"===P)return C;if("imageSmoothing"===P)return"optimizeQuality"===C;B=N?C.map(r):r(C,A)}}else C="";return!N&&isNaN(B)?C:B}function E(P){return new RegExp("^("+P.join("|")+")\\b","i")}function H(P,C){var N,B,W,A=[];for(B=0,W=C.length;B<W;B++)N=P.getElementsByTagName(C[B]),A=A.concat(Array.prototype.slice.call(N));return A}function q(P,C){var M,A=!0;return(M=Q(P,C.pop()))&&C.length&&(A=function Y(P,C){for(var M,A=!0;P.parentNode&&1===P.parentNode.nodeType&&C.length;)A&&(M=C.pop()),A=Q(P=P.parentNode,M);return 0===C.length}(P,C)),M&&A&&0===C.length}function Q(P,C){var B,W,M=P.nodeName,A=P.getAttribute("class"),N=P.getAttribute("id");if(B=new RegExp("^"+M,"i"),C=C.replace(B,""),N&&C.length&&(B=new RegExp("#"+N+"(?![a-zA-Z\\-]+)","i"),C=C.replace(B,"")),A&&C.length)for(W=(A=A.split(" ")).length;W--;)B=new RegExp("\\."+A[W]+"(?![a-zA-Z\\-]+)","i"),C=C.replace(B,"");return 0===C.length}function et(P,C){var M;if(P.getElementById&&(M=P.getElementById(C)),M)return M;var A,N,B,W=P.getElementsByTagName("*");for(N=0,B=W.length;N<B;N++)if(C===(A=W[N]).getAttribute("id"))return A}t.svgValidTagNamesRegEx=E(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]),t.svgViewBoxElementsRegEx=E(["symbol","image","marker","pattern","view","svg"]),t.svgInvalidAncestorsRegEx=E(["pattern","defs","symbol","metadata","clipPath","mask","desc"]),t.svgValidParentsRegEx=E(["symbol","g","a","svg","clipPath","defs"]),t.cssRules={},t.gradientDefs={},t.clipPaths={},t.parseTransformAttribute=function(){function M(k,G,X){k[X]=Math.tan(t.util.degreesToRadians(G[0]))}var N=t.iMatrix,B=t.reNum,W=t.commaWsp,m="(?:(?:(matrix)\\s*\\(\\s*("+B+")"+W+"("+B+")"+W+"("+B+")"+W+"("+B+")"+W+"("+B+")"+W+"("+B+")\\s*\\))|(?:(translate)\\s*\\(\\s*("+B+")(?:"+W+"("+B+"))?\\s*\\))|(?:(scale)\\s*\\(\\s*("+B+")(?:"+W+"("+B+"))?\\s*\\))|(?:(rotate)\\s*\\(\\s*("+B+")(?:"+W+"("+B+")"+W+"("+B+"))?\\s*\\))|(?:(skewX)\\s*\\(\\s*("+B+")\\s*\\))|(?:(skewY)\\s*\\(\\s*("+B+")\\s*\\)))",F=new RegExp("^\\s*(?:(?:"+m+"(?:"+W+"*"+m+")*)?)\\s*$"),O=new RegExp(m,"g");return function(k){var G=N.concat(),X=[];if(!k||k&&!F.test(k))return G;k.replace(O,function(it){var tt=new RegExp(m).exec(it).filter(function(st){return!!st}),rt=tt[1],nt=tt.slice(2).map(parseFloat);switch(rt){case"translate":!function A(k,G){k[4]=G[0],2===G.length&&(k[5]=G[1])}(G,nt);break;case"rotate":nt[0]=t.util.degreesToRadians(nt[0]),function P(k,G){var X=t.util.cos(G[0]),J=t.util.sin(G[0]),it=0,tt=0;3===G.length&&(it=G[1],tt=G[2]),k[0]=X,k[1]=J,k[2]=-J,k[3]=X,k[4]=it-(X*it-J*tt),k[5]=tt-(J*it+X*tt)}(G,nt);break;case"scale":!function C(k,G){var J=2===G.length?G[1]:G[0];k[0]=G[0],k[3]=J}(G,nt);break;case"skewX":M(G,nt,2);break;case"skewY":M(G,nt,1);break;case"matrix":G=nt}X.push(G.concat()),G=N.concat()});for(var J=X[0];X.length>1;)X.shift(),J=t.util.multiplyTransformMatrices(J,X[0]);return J}}();var S=new RegExp("^\\s*("+t.reNum+"+)\\s*,?\\s*("+t.reNum+"+)\\s*,?\\s*("+t.reNum+"+)\\s*,?\\s*("+t.reNum+"+)\\s*$");function R(P){if(!t.svgViewBoxElementsRegEx.test(P.nodeName))return{};var N,B,W,U,Z,z,C=P.getAttribute("viewBox"),M=1,A=1,y=P.getAttribute("width"),f=P.getAttribute("height"),p=P.getAttribute("x")||0,m=P.getAttribute("y")||0,_=P.getAttribute("preserveAspectRatio")||"",x=!C||!(C=C.match(S)),F=!y||!f||"100%"===y||"100%"===f,O=x&&F,k={},G="",X=0,J=0;if(k.width=0,k.height=0,k.toBeParsed=O,x&&(p||m)&&P.parentNode&&"#document"!==P.parentNode.nodeName&&(G=" translate("+r(p)+" "+r(m)+") ",Z=(P.getAttribute("transform")||"")+G,P.setAttribute("transform",Z),P.removeAttribute("x"),P.removeAttribute("y")),O)return k;if(x)return k.width=r(y),k.height=r(f),k;if(N=-parseFloat(C[1]),B=-parseFloat(C[2]),W=parseFloat(C[3]),U=parseFloat(C[4]),k.minX=N,k.minY=B,k.viewBoxWidth=W,k.viewBoxHeight=U,F?(k.width=W,k.height=U):(k.width=r(y),k.height=r(f),M=k.width/W,A=k.height/U),"none"!==(_=t.util.parsePreserveAspectRatioAttribute(_)).alignX&&("meet"===_.meetOrSlice&&(A=M=M>A?A:M),"slice"===_.meetOrSlice&&(A=M=M>A?M:A),X=k.width-W*M,J=k.height-U*M,"Mid"===_.alignX&&(X/=2),"Mid"===_.alignY&&(J/=2),"Min"===_.alignX&&(X=0),"Min"===_.alignY&&(J=0)),1===M&&1===A&&0===N&&0===B&&0===p&&0===m)return k;if((p||m)&&"#document"!==P.parentNode.nodeName&&(G=" translate("+r(p)+" "+r(m)+") "),Z=G+" matrix("+M+" 0 0 "+A+" "+(N*M+X)+" "+(B*A+J)+") ","svg"===P.nodeName){for(z=P.ownerDocument.createElementNS(t.svgNS,"g");P.firstChild;)z.appendChild(P.firstChild);P.appendChild(z)}else(z=P).removeAttribute("x"),z.removeAttribute("y"),Z=z.getAttribute("transform")+Z;return z.setAttribute("transform",Z),k}function D(P,C){var A="xlink:href",B=et(P,C.getAttribute(A).substr(1));if(B&&B.getAttribute(A)&&D(P,B),["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"].forEach(function(U){B&&!C.hasAttribute(U)&&B.hasAttribute(U)&&C.setAttribute(U,B.getAttribute(U))}),!C.children.length)for(var W=B.cloneNode(!0);W.firstChild;)C.appendChild(W.firstChild);C.removeAttribute(A)}t.parseSVGDocument=function(P,C,M,A){if(P){!function $(P){for(var C=H(P,["use","svg:use"]),M=0;C.length&&M<C.length;){var A=C[M],N=A.getAttribute("xlink:href")||A.getAttribute("href");if(null===N)return;var p,m,_,x,B=N.substr(1),W=A.getAttribute("x")||0,U=A.getAttribute("y")||0,Z=et(P,B).cloneNode(!0),z=(Z.getAttribute("transform")||"")+" translate("+W+", "+U+")",f=C.length,F=t.svgNS;if(R(Z),/^svg$/i.test(Z.nodeName)){var O=Z.ownerDocument.createElementNS(F,"g");for(m=0,x=(_=Z.attributes).length;m<x;m++)p=_.item(m),O.setAttributeNS(F,p.nodeName,p.nodeValue);for(;Z.firstChild;)O.appendChild(Z.firstChild);Z=O}for(m=0,x=(_=A.attributes).length;m<x;m++)"x"!==(p=_.item(m)).nodeName&&"y"!==p.nodeName&&"xlink:href"!==p.nodeName&&"href"!==p.nodeName&&("transform"===p.nodeName?z=p.nodeValue+" "+z:Z.setAttribute(p.nodeName,p.nodeValue));Z.setAttribute("transform",z),Z.setAttribute("instantiated_by_use","1"),Z.removeAttribute("id"),A.parentNode.replaceChild(Z,A),C.length===f&&M++}}(P);var B,W,N=t.Object.__uid++,U=R(P),Z=t.util.toArray(P.getElementsByTagName("*"));if(U.crossOrigin=A&&A.crossOrigin,U.svgUid=N,0===Z.length&&t.isLikelyNode){var z=[];for(B=0,W=(Z=P.selectNodes('//*[name(.)!="svg"]')).length;B<W;B++)z[B]=Z[B];Z=z}var y=Z.filter(function(p){return R(p),t.svgValidTagNamesRegEx.test(p.nodeName.replace("svg:",""))&&!function b(P,C){for(;P&&(P=P.parentNode);)if(P.nodeName&&C.test(P.nodeName.replace("svg:",""))&&!P.getAttribute("instantiated_by_use"))return!0;return!1}(p,t.svgInvalidAncestorsRegEx)});if(!y||y&&!y.length)return void(C&&C([],{}));var f={};Z.filter(function(p){return"clipPath"===p.nodeName.replace("svg:","")}).forEach(function(p){var m=p.getAttribute("id");f[m]=t.util.toArray(p.getElementsByTagName("*")).filter(function(_){return t.svgValidTagNamesRegEx.test(_.nodeName.replace("svg:",""))})}),t.gradientDefs[N]=t.getGradientDefs(P),t.cssRules[N]=t.getCSSRules(P),t.clipPaths[N]=f,t.parseElements(y,function(p,m){C&&(C(p,U,m,Z),delete t.gradientDefs[N],delete t.cssRules[N],delete t.clipPaths[N])},a(U),M,A)}};var L=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+t.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+t.reNum+"))?\\s+(.*)");s(t,{parseFontDeclaration:function(P,C){var M=P.match(L);if(M){var A=M[1],N=M[3],B=M[4],W=M[5],U=M[6];A&&(C.fontStyle=A),N&&(C.fontWeight=isNaN(parseFloat(N))?N:parseFloat(N)),B&&(C.fontSize=r(B)),U&&(C.fontFamily=U),W&&(C.lineHeight="normal"===W?1:W)}},getGradientDefs:function(P){var A,M=H(P,["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"]),N=0,B={};for(N=M.length;N--;)(A=M[N]).getAttribute("xlink:href")&&D(P,A),B[A.getAttribute("id")]=A;return B},parseAttributes:function(P,C,M){if(P){var A,B,W,N={};void 0===M&&(M=P.getAttribute("svgUid")),P.parentNode&&t.svgValidParentsRegEx.test(P.parentNode.nodeName)&&(N=t.parseAttributes(P.parentNode,C,M));var U=C.reduce(function(_,x){return(A=P.getAttribute(x))&&(_[x]=A),_},{}),Z=s(function K(P,C){var M={};for(var A in t.cssRules[C])if(q(P,A.split(" ")))for(var N in t.cssRules[C][A])M[N]=t.cssRules[C][A][N];return M}(P,M),t.parseStyleAttribute(P));U=s(U,Z),Z[v]&&P.setAttribute(v,Z[v]),B=W=N.fontSize||t.Text.DEFAULT_SVG_FONT_SIZE,U[g]&&(U[g]=B=r(U[g],W));var z,y,f={};for(var p in U)y=T(z=w(p),U[p],N,B),f[z]=y;f&&f.font&&t.parseFontDeclaration(f.font,f);var m=s(N,f);return t.svgValidParentsRegEx.test(P.nodeName)?m:function I(P){for(var C in d)if(void 0!==P[d[C]]&&""!==P[C]){if(void 0===P[C]){if(!t.Object.prototype[C])continue;P[C]=t.Object.prototype[C]}if(0!==P[C].indexOf("url(")){var M=new t.Color(P[C]);P[C]=M.setAlpha(e(M.getAlpha()*P[d[C]],2)).toRgba()}}return P}(m)}},parseElements:function(P,C,M,A,N){new t.ElementsParser(P,C,M,A,N).parse()},parseStyleAttribute:function(P){var C={},M=P.getAttribute("style");return M&&("string"==typeof M?function j(P,C){var M,A;P.replace(/;\s*$/,"").split(";").forEach(function(N){var B=N.split(":");M=B[0].trim().toLowerCase(),A=B[1].trim(),C[M]=A})}(M,C):function V(P,C){for(var N in P)void 0!==P[N]&&(C[N.toLowerCase()]=P[N])}(M,C)),C},parsePointsAttribute:function(P){if(!P)return null;var M,A,C=[];for(M=0,A=(P=(P=P.replace(/,/g," ").trim()).split(/\s+/)).length;M<A;M+=2)C.push({x:parseFloat(P[M]),y:parseFloat(P[M+1])});return C},getCSSRules:function(P){var M,A,C=P.getElementsByTagName("style"),N={};for(M=0,A=C.length;M<A;M++){var W=C[M].textContent;""!==(W=W.replace(/\/\*[\s\S]*?\*\//g,"")).trim()&&W.split("}").filter(function(U){return U.trim()}).forEach(function(U){var Z=U.split("{"),z={},f=Z[1].trim().split(";").filter(function(x){return x.trim()});for(M=0,A=f.length;M<A;M++){var p=f[M].split(":"),m=p[0].trim(),_=p[1].trim();z[m]=_}(U=Z[0].trim()).split(",").forEach(function(x){""!==(x=x.replace(/^svg/i,"").trim())&&(N[x]?t.util.object.extend(N[x],z):N[x]=t.util.object.clone(z))})})}return N},loadSVGFromURL:function(P,C,M,A){P=P.replace(/^\n\s*/,"").trim(),new t.util.request(P,{method:"get",onComplete:function N(B){var W=B.responseXML;if(!W||!W.documentElement)return C&&C(null),!1;t.parseSVGDocument(W.documentElement,function(U,Z,z,y){C&&C(U,Z,z,y)},M,A)}})},loadSVGFromString:function(P,C,M,A){var B=(new t.window.DOMParser).parseFromString(P.trim(),"text/xml");t.parseSVGDocument(B.documentElement,function(W,U,Z,z){C(W,U,Z,z)},M,A)}})}("undefined"!=typeof exports?exports:this),fabric.ElementsParser=function(n,t,s,a,e,r){this.elements=n,this.callback=t,this.options=s,this.reviver=a,this.svgUid=s&&s.svgUid||0,this.parsingOptions=e,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=r},function(n){n.parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},n.createObjects=function(){var t=this;this.elements.forEach(function(s,a){s.setAttribute("svgUid",t.svgUid),t.createObject(s,a)})},n.findTag=function(t){return fabric[fabric.util.string.capitalize(t.tagName.replace("svg:",""))]},n.createObject=function(t,s){var a=this.findTag(t);if(a&&a.fromElement)try{a.fromElement(t,this.createCallback(s,t),this.options)}catch(e){fabric.log(e)}else this.checkIfDone()},n.createCallback=function(t,s){var a=this;return function(e){var r;a.resolveGradient(e,s,"fill"),a.resolveGradient(e,s,"stroke"),e instanceof fabric.Image&&e._originalElement&&(r=e.parsePreserveAspectRatioAttribute(s)),e._removeTransformMatrix(r),a.resolveClipPath(e,s),a.reviver&&a.reviver(s,e),a.instances[t]=e,a.checkIfDone()}},n.extractPropertyDefinition=function(t,s,a){var e=t[s],r=this.regexUrl;if(r.test(e)){r.lastIndex=0;var i=r.exec(e)[1];return r.lastIndex=0,fabric[a][this.svgUid][i]}},n.resolveGradient=function(t,s,a){var e=this.extractPropertyDefinition(t,a,"gradientDefs");if(e){var r=s.getAttribute(a+"-opacity"),i=fabric.Gradient.fromElement(e,t,r,this.options);t.set(a,i)}},n.createClipPathCallback=function(t,s){return function(a){a._removeTransformMatrix(),a.fillRule=a.clipRule,s.push(a)}},n.resolveClipPath=function(t,s){var e,i,o,h,a=this.extractPropertyDefinition(t,"clipPath","clipPaths");if(a){o=[],i=fabric.util.invertTransform(t.calcTransformMatrix());for(var c=a[0].parentNode,u=s;u.parentNode&&u.getAttribute("clip-path")!==t.clipPath;)u=u.parentNode;u.parentNode.appendChild(c);for(var d=0;d<a.length;d++)this.findTag(e=a[d]).fromElement(e,this.createClipPathCallback(t,o),this.options);a=1===o.length?o[0]:new fabric.Group(o),h=fabric.util.multiplyTransformMatrices(i,a.calcTransformMatrix()),a.clipPath&&this.resolveClipPath(a,u);var l=fabric.util.qrDecompose(h);a.flipX=!1,a.flipY=!1,a.set("scaleX",l.scaleX),a.set("scaleY",l.scaleY),a.angle=l.angle,a.skewX=l.skewX,a.skewY=0,a.setPositionByOrigin({x:l.translateX,y:l.translateY},"center","center"),t.clipPath=a}else delete t.clipPath},n.checkIfDone=function(){0==--this.numElements&&(this.instances=this.instances.filter(function(t){return null!=t}),this.callback(this.instances,this.elements))}}(fabric.ElementsParser.prototype),function(n){"use strict";var t=n.fabric||(n.fabric={});function s(a,e){this.x=a,this.y=e}t.Point?t.warn("fabric.Point is already defined"):(t.Point=s,s.prototype={type:"point",constructor:s,add:function(a){return new s(this.x+a.x,this.y+a.y)},addEquals:function(a){return this.x+=a.x,this.y+=a.y,this},scalarAdd:function(a){return new s(this.x+a,this.y+a)},scalarAddEquals:function(a){return this.x+=a,this.y+=a,this},subtract:function(a){return new s(this.x-a.x,this.y-a.y)},subtractEquals:function(a){return this.x-=a.x,this.y-=a.y,this},scalarSubtract:function(a){return new s(this.x-a,this.y-a)},scalarSubtractEquals:function(a){return this.x-=a,this.y-=a,this},multiply:function(a){return new s(this.x*a,this.y*a)},multiplyEquals:function(a){return this.x*=a,this.y*=a,this},divide:function(a){return new s(this.x/a,this.y/a)},divideEquals:function(a){return this.x/=a,this.y/=a,this},eq:function(a){return this.x===a.x&&this.y===a.y},lt:function(a){return this.x<a.x&&this.y<a.y},lte:function(a){return this.x<=a.x&&this.y<=a.y},gt:function(a){return this.x>a.x&&this.y>a.y},gte:function(a){return this.x>=a.x&&this.y>=a.y},lerp:function(a,e){return void 0===e&&(e=.5),e=Math.max(Math.min(1,e),0),new s(this.x+(a.x-this.x)*e,this.y+(a.y-this.y)*e)},distanceFrom:function(a){var e=this.x-a.x,r=this.y-a.y;return Math.sqrt(e*e+r*r)},midPointFrom:function(a){return this.lerp(a)},min:function(a){return new s(Math.min(this.x,a.x),Math.min(this.y,a.y))},max:function(a){return new s(Math.max(this.x,a.x),Math.max(this.y,a.y))},toString:function(){return this.x+","+this.y},setXY:function(a,e){return this.x=a,this.y=e,this},setX:function(a){return this.x=a,this},setY:function(a){return this.y=a,this},setFromPoint:function(a){return this.x=a.x,this.y=a.y,this},swap:function(a){var e=this.x,r=this.y;this.x=a.x,this.y=a.y,a.x=e,a.y=r},clone:function(){return new s(this.x,this.y)}})}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={});function s(a){this.status=a,this.points=[]}t.Intersection?t.warn("fabric.Intersection is already defined"):(t.Intersection=s,t.Intersection.prototype={constructor:s,appendPoint:function(a){return this.points.push(a),this},appendPoints:function(a){return this.points=this.points.concat(a),this}},t.Intersection.intersectLineLine=function(a,e,r,i){var o,h=(i.x-r.x)*(a.y-r.y)-(i.y-r.y)*(a.x-r.x),l=(e.x-a.x)*(a.y-r.y)-(e.y-a.y)*(a.x-r.x),c=(i.y-r.y)*(e.x-a.x)-(i.x-r.x)*(e.y-a.y);if(0!==c){var u=h/c,d=l/c;0<=u&&u<=1&&0<=d&&d<=1?(o=new s("Intersection")).appendPoint(new t.Point(a.x+u*(e.x-a.x),a.y+u*(e.y-a.y))):o=new s}else o=new s(0===h||0===l?"Coincident":"Parallel");return o},t.Intersection.intersectLinePolygon=function(a,e,r){var c,u,i=new s,o=r.length;for(u=0;u<o;u++)c=s.intersectLineLine(a,e,r[u],r[(u+1)%o]),i.appendPoints(c.points);return i.points.length>0&&(i.status="Intersection"),i},t.Intersection.intersectPolygonPolygon=function(a,e){var o,r=new s,i=a.length;for(o=0;o<i;o++){var c=s.intersectLinePolygon(a[o],a[(o+1)%i],e);r.appendPoints(c.points)}return r.points.length>0&&(r.status="Intersection"),r},t.Intersection.intersectPolygonRectangle=function(a,e,r){var i=e.min(r),o=e.max(r),h=new t.Point(o.x,i.y),l=new t.Point(i.x,o.y),c=s.intersectLinePolygon(i,h,a),u=s.intersectLinePolygon(h,o,a),d=s.intersectLinePolygon(o,l,a),g=s.intersectLinePolygon(l,i,a),v=new s;return v.appendPoints(c.points),v.appendPoints(u.points),v.appendPoints(d.points),v.appendPoints(g.points),v.points.length>0&&(v.status="Intersection"),v})}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={});function s(e){e?this._tryParsingColor(e):this.setSource([0,0,0,1])}function a(e,r,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(r-e)*i:i<.5?r:i<2/3?e+(r-e)*(2/3-i)*6:e}t.Color?t.warn("fabric.Color is already defined."):(t.Color=s,t.Color.prototype={_tryParsingColor:function(e){var r;e in s.colorNameMap&&(e=s.colorNameMap[e]),"transparent"===e&&(r=[255,255,255,0]),r||(r=s.sourceFromHex(e)),r||(r=s.sourceFromRgb(e)),r||(r=s.sourceFromHsl(e)),r||(r=[0,0,0,1]),r&&this.setSource(r)},_rgbToHsl:function(e,r,i){var o,h,l,c=t.util.array.max([e/=255,r/=255,i/=255]),u=t.util.array.min([e,r,i]);if(l=(c+u)/2,c===u)o=h=0;else{var d=c-u;switch(h=l>.5?d/(2-c-u):d/(c+u),c){case e:o=(r-i)/d+(r<i?6:0);break;case r:o=(i-e)/d+2;break;case i:o=(e-r)/d+4}o/=6}return[Math.round(360*o),Math.round(100*h),Math.round(100*l)]},getSource:function(){return this._source},setSource:function(e){this._source=e},toRgb:function(){var e=this.getSource();return"rgb("+e[0]+","+e[1]+","+e[2]+")"},toRgba:function(){var e=this.getSource();return"rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"},toHsl:function(){var e=this.getSource(),r=this._rgbToHsl(e[0],e[1],e[2]);return"hsl("+r[0]+","+r[1]+"%,"+r[2]+"%)"},toHsla:function(){var e=this.getSource(),r=this._rgbToHsl(e[0],e[1],e[2]);return"hsla("+r[0]+","+r[1]+"%,"+r[2]+"%,"+e[3]+")"},toHex:function(){var r,i,o,e=this.getSource();return r=1===(r=e[0].toString(16)).length?"0"+r:r,i=1===(i=e[1].toString(16)).length?"0"+i:i,o=1===(o=e[2].toString(16)).length?"0"+o:o,r.toUpperCase()+i.toUpperCase()+o.toUpperCase()},toHexa:function(){var r,e=this.getSource();return r=1===(r=(r=Math.round(255*e[3])).toString(16)).length?"0"+r:r,this.toHex()+r.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(e){var r=this.getSource();return r[3]=e,this.setSource(r),this},toGrayscale:function(){var e=this.getSource(),r=parseInt((.3*e[0]+.59*e[1]+.11*e[2]).toFixed(0),10);return this.setSource([r,r,r,e[3]]),this},toBlackWhite:function(e){var r=this.getSource(),i=(.3*r[0]+.59*r[1]+.11*r[2]).toFixed(0),o=r[3];return e=e||127,i=Number(i)<Number(e)?0:255,this.setSource([i,i,i,o]),this},overlayWith:function(e){e instanceof s||(e=new s(e));var c,r=[],i=this.getAlpha(),h=this.getSource(),l=e.getSource();for(c=0;c<3;c++)r.push(Math.round(.5*h[c]+.5*l[c]));return r[3]=i,this.setSource(r),this}},t.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,t.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,t.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,t.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},t.Color.fromRgb=function(e){return s.fromSource(s.sourceFromRgb(e))},t.Color.sourceFromRgb=function(e){var r=e.match(s.reRGBa);if(r){var i=parseInt(r[1],10)/(/%$/.test(r[1])?100:1)*(/%$/.test(r[1])?255:1),o=parseInt(r[2],10)/(/%$/.test(r[2])?100:1)*(/%$/.test(r[2])?255:1),h=parseInt(r[3],10)/(/%$/.test(r[3])?100:1)*(/%$/.test(r[3])?255:1);return[parseInt(i,10),parseInt(o,10),parseInt(h,10),r[4]?parseFloat(r[4]):1]}},t.Color.fromRgba=s.fromRgb,t.Color.fromHsl=function(e){return s.fromSource(s.sourceFromHsl(e))},t.Color.sourceFromHsl=function(e){var r=e.match(s.reHSLa);if(r){var l,c,u,i=(parseFloat(r[1])%360+360)%360/360,o=parseFloat(r[2])/(/%$/.test(r[2])?100:1),h=parseFloat(r[3])/(/%$/.test(r[3])?100:1);if(0===o)l=c=u=h;else{var d=h<=.5?h*(o+1):h+o-h*o,g=2*h-d;l=a(g,d,i+1/3),c=a(g,d,i),u=a(g,d,i-1/3)}return[Math.round(255*l),Math.round(255*c),Math.round(255*u),r[4]?parseFloat(r[4]):1]}},t.Color.fromHsla=s.fromHsl,t.Color.fromHex=function(e){return s.fromSource(s.sourceFromHex(e))},t.Color.sourceFromHex=function(e){if(e.match(s.reHex)){var r=e.slice(e.indexOf("#")+1),i=3===r.length||4===r.length,o=8===r.length||4===r.length,h=i?r.charAt(0)+r.charAt(0):r.substring(0,2),l=i?r.charAt(1)+r.charAt(1):r.substring(2,4),c=i?r.charAt(2)+r.charAt(2):r.substring(4,6),u=o?i?r.charAt(3)+r.charAt(3):r.substring(6,8):"FF";return[parseInt(h,16),parseInt(l,16),parseInt(c,16),parseFloat((parseInt(u,16)/255).toFixed(2))]}},t.Color.fromSource=function(e){var r=new s;return r.setSource(e),r})}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=["e","se","s","sw","w","nw","n","ne","e"],a=["ns","nesw","ew","nwse"],e={},r="left",i="top",o="right",h="bottom",l="center",c={top:h,bottom:i,left:o,right:r,center:l},u=t.util.radiansToDegrees,d=Math.sign||function(z){return(z>0)-(z<0)||+z};function g(z,y){var f=z.angle+u(Math.atan2(y.y,y.x))+360;return Math.round(f%360/45)}function v(z,y){var f=y.transform.target,p=f.canvas,m=t.util.object.clone(y);m.target=f,p&&p.fire("object:"+z,m),f.fire(z,y)}function w(z,y){var f=y.canvas,m=z[f.uniScaleKey];return f.uniformScaling&&!m||!f.uniformScaling&&m}function T(z){return z.originX===l&&z.originY===l}function E(z,y,f){var p=z.lockScalingX,m=z.lockScalingY;return!!(p&&m||!y&&(p||m)&&f||p&&"x"===y||m&&"y"===y)}function q(z,y,f,p){return{e:z,transform:y,pointer:{x:f,y:p}}}function Y(z){return function(y,f,p,m){var _=f.target,x=_.getCenterPoint(),F=_.translateToOriginPoint(x,f.originX,f.originY),O=z(y,f,p,m);return _.setPositionByOrigin(F,f.originX,f.originY),O}}function Q(z,y){return function(f,p,m,_){var x=y(f,p,m,_);return x&&v(z,q(f,p,m,_)),x}}function et(z,y,f,p,m){var _=z.target,x=_.controls[z.corner],F=_.canvas.getZoom(),O=_.padding/F,k=_.toLocalPoint(new t.Point(p,m),y,f);return k.x>=O&&(k.x-=O),k.x<=-O&&(k.x+=O),k.y>=O&&(k.y-=O),k.y<=O&&(k.y+=O),k.x-=x.offsetX,k.y-=x.offsetY,k}function $(z){return z.flipX!==z.flipY}function S(z,y,f,p,m){if(0!==z[y]){var _=z._getTransformedDimensions()[p];z.set(f,m/_*z[f])}}function R(z,y,f,p){var k,m=y.target,_=m._getTransformedDimensions(0,m.skewY),x=et(y,y.originX,y.originY,f,p),F=Math.abs(2*x.x)-_.x,O=m.skewX;F<2?k=0:(k=u(Math.atan2(F/m.scaleX,_.y/m.scaleY)),y.originX===r&&y.originY===h&&(k=-k),y.originX===o&&y.originY===i&&(k=-k),$(m)&&(k=-k));var G=O!==k;if(G){var X=m._getTransformedDimensions().y;m.set("skewX",k),S(m,"skewY","scaleY","y",X)}return G}function b(z,y,f,p){var k,m=y.target,_=m._getTransformedDimensions(m.skewX,0),x=et(y,y.originX,y.originY,f,p),F=Math.abs(2*x.y)-_.y,O=m.skewY;F<2?k=0:(k=u(Math.atan2(F/m.scaleY,_.x/m.scaleX)),y.originX===r&&y.originY===h&&(k=-k),y.originX===o&&y.originY===i&&(k=-k),$(m)&&(k=-k));var G=O!==k;if(G){var X=m._getTransformedDimensions().x;m.set("skewY",k),S(m,"skewX","scaleX","x",X)}return G}function C(z,y,f,p,m){var k,G,X,J,rt,nt,_=y.target,x=_.lockScalingX,F=_.lockScalingY,O=(m=m||{}).by,it=w(z,_),tt=E(_,O,it),st=y.gestureScale;if(tt)return!1;if(st)G=y.scaleX*st,X=y.scaleY*st;else{if(k=et(y,y.originX,y.originY,f,p),rt="y"!==O?d(k.x):1,nt="x"!==O?d(k.y):1,y.signX||(y.signX=rt),y.signY||(y.signY=nt),_.lockScalingFlip&&(y.signX!==rt||y.signY!==nt))return!1;if(J=_._getTransformedDimensions(),it&&!O){var ot=Math.abs(k.x)+Math.abs(k.y),at=y.original,lt=ot/(Math.abs(J.x*at.scaleX/_.scaleX)+Math.abs(J.y*at.scaleY/_.scaleY));G=at.scaleX*lt,X=at.scaleY*lt}else G=Math.abs(k.x*_.scaleX/J.x),X=Math.abs(k.y*_.scaleY/J.y);T(y)&&(G*=2,X*=2),y.signX!==rt&&"y"!==O&&(y.originX=c[y.originX],G*=-1,y.signX=rt),y.signY!==nt&&"x"!==O&&(y.originY=c[y.originY],X*=-1,y.signY=nt)}var ct=_.scaleX,ut=_.scaleY;return O?("x"===O&&_.set("scaleX",G),"y"===O&&_.set("scaleY",X)):(!x&&_.set("scaleX",G),!F&&_.set("scaleY",X)),ct!==_.scaleX||ut!==_.scaleY}e.scaleCursorStyleHandler=function I(z,y,f){var m=w(z,f),_="";if(0!==y.x&&0===y.y?_="x":0===y.x&&0!==y.y&&(_="y"),E(f,_,m))return"not-allowed";var x=g(f,y);return s[x]+"-resize"},e.skewCursorStyleHandler=function H(z,y,f){if(0!==y.x&&f.lockSkewingY||0!==y.y&&f.lockSkewingX)return"not-allowed";var m=g(f,y)%4;return a[m]+"-resize"},e.scaleSkewCursorStyleHandler=function j(z,y,f){return z[f.canvas.altActionKey]?e.skewCursorStyleHandler(z,y,f):e.scaleCursorStyleHandler(z,y,f)},e.rotationWithSnapping=Q("rotating",Y(function P(z,y,f,p){var m=y,_=m.target,x=_.translateToOriginPoint(_.getCenterPoint(),m.originX,m.originY);if(_.lockRotation)return!1;var G,F=Math.atan2(m.ey-x.y,m.ex-x.x),O=Math.atan2(p-x.y,f-x.x),k=u(O-F+m.theta);if(_.snapAngle>0){var X=_.snapAngle,J=_.snapThreshold||X,it=Math.ceil(k/X)*X,tt=Math.floor(k/X)*X;Math.abs(k-tt)<J?k=tt:Math.abs(k-it)<J&&(k=it)}return k<0&&(k=360+k),G=_.angle!==(k%=360),_.angle=k,G})),e.scalingEqually=Q("scaling",Y(function M(z,y,f,p){return C(z,y,f,p)})),e.scalingX=Q("scaling",Y(function A(z,y,f,p){return C(z,y,f,p,{by:"x"})})),e.scalingY=Q("scaling",Y(function N(z,y,f,p){return C(z,y,f,p,{by:"y"})})),e.scalingYOrSkewingX=function B(z,y,f,p){return z[y.target.canvas.altActionKey]?e.skewHandlerX(z,y,f,p):e.scalingY(z,y,f,p)},e.scalingXOrSkewingY=function W(z,y,f,p){return z[y.target.canvas.altActionKey]?e.skewHandlerY(z,y,f,p):e.scalingX(z,y,f,p)},e.changeWidth=Q("resizing",Y(function U(z,y,f,p){var m=y.target,_=et(y,y.originX,y.originY,f,p),x=m.strokeWidth/(m.strokeUniform?m.scaleX:1),F=T(y)?2:1,O=m.width,k=Math.abs(_.x*F/m.scaleX)-x;return m.set("width",Math.max(k,0)),O!==k})),e.skewHandlerX=function D(z,y,f,p){var x,m=y.target,_=m.skewX,F=y.originY;return!m.lockSkewingX&&(0===_?x=et(y,l,l,f,p).x>0?r:o:(_>0&&(x=F===i?r:o),_<0&&(x=F===i?o:r),$(m)&&(x=x===r?o:r)),y.originX=x,Q("skewing",Y(R))(z,y,f,p))},e.skewHandlerY=function L(z,y,f,p){var x,m=y.target,_=m.skewY,F=y.originX;return!m.lockSkewingY&&(0===_?x=et(y,l,l,f,p).y>0?i:h:(_>0&&(x=F===r?i:h),_<0&&(x=F===r?h:i),$(m)&&(x=x===i?h:i)),y.originY=x,Q("skewing",Y(b))(z,y,f,p))},e.dragHandler=function Z(z,y,f,p){var m=y.target,_=f-y.offsetX,x=p-y.offsetY,F=!m.get("lockMovementX")&&m.left!==_,O=!m.get("lockMovementY")&&m.top!==x;return F&&m.set("left",_),O&&m.set("top",x),(F||O)&&v("moving",q(z,y,f,p)),F||O},e.scaleOrSkewActionName=function V(z,y,f){var p=z[f.canvas.altActionKey];return 0===y.x?p?"skewX":"scaleY":0===y.y?p?"skewY":"scaleX":void 0},e.rotationStyleHandler=function K(z,y,f){return f.lockRotation?"not-allowed":y.cursorStyle},e.fireEvent=v,e.wrapWithFixedAnchor=Y,e.wrapWithFireEvent=Q,e.getLocalPoint=et,t.controlsUtils=e}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.degreesToRadians,a=t.controlsUtils;a.renderCircleControl=function e(i,o,h,l,c){l=l||{};var I,u=this.sizeX||l.cornerSize||c.cornerSize,d=this.sizeY||l.cornerSize||c.cornerSize,g=void 0!==l.transparentCorners?l.transparentCorners:c.transparentCorners,v=g?"stroke":"fill",w=!g&&(l.cornerStrokeColor||c.cornerStrokeColor),T=o,E=h;i.save(),i.fillStyle=l.cornerColor||c.cornerColor,i.strokeStyle=l.cornerStrokeColor||c.cornerStrokeColor,u>d?(I=u,i.scale(1,d/u),E=h*u/d):d>u?(I=d,i.scale(u/d,1),T=o*d/u):I=u,i.lineWidth=1,i.beginPath(),i.arc(T,E,I/2,0,2*Math.PI,!1),i[v](),w&&i.stroke(),i.restore()},a.renderSquareControl=function r(i,o,h,l,c){l=l||{};var u=this.sizeX||l.cornerSize||c.cornerSize,d=this.sizeY||l.cornerSize||c.cornerSize,g=void 0!==l.transparentCorners?l.transparentCorners:c.transparentCorners,v=g?"stroke":"fill",w=!g&&(l.cornerStrokeColor||c.cornerStrokeColor),T=u/2,E=d/2;i.save(),i.fillStyle=l.cornerColor||c.cornerColor,i.strokeStyle=l.cornerStrokeColor||c.cornerStrokeColor,i.lineWidth=1,i.translate(o,h),i.rotate(s(c.angle)),i[v+"Rect"](-T,-E,u,d),w&&i.strokeRect(-T,-E,u,d),i.restore()}}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={});t.Control=function s(a){for(var e in a)this[e]=a[e]},t.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(a,e){return e.cursorStyle},getActionName:function(a,e){return e.actionName},getVisibility:function(a,e){var r=a._controlsVisibility;return r&&void 0!==r[e]?r[e]:this.visible},setVisibility:function(a){this.visible=a},positionHandler:function(a,e){return t.util.transformPoint({x:this.x*a.x+this.offsetX,y:this.y*a.y+this.offsetY},e)},calcCornerCoords:function(a,e,r,i,o){var h,l,c,u,d=o?this.touchSizeX:this.sizeX,g=o?this.touchSizeY:this.sizeY;if(d&&g&&d!==g){var v=Math.atan2(g,d),w=Math.sqrt(d*d+g*g)/2,T=v-t.util.degreesToRadians(a),E=Math.PI/2-v-t.util.degreesToRadians(a);h=w*t.util.cos(T),l=w*t.util.sin(T),c=w*t.util.cos(E),u=w*t.util.sin(E)}else w=.7071067812*(d&&g?d:e),T=t.util.degreesToRadians(45-a),h=c=w*t.util.cos(T),l=u=w*t.util.sin(T);return{tl:{x:r-u,y:i-c},tr:{x:r+h,y:i-l},bl:{x:r-h,y:i+l},br:{x:r+u,y:i+c}}},render:function(a,e,r,i,o){"circle"===((i=i||{}).cornerStyle||o.cornerStyle)?t.controlsUtils.renderCircleControl.call(this,a,e,r,i,o):t.controlsUtils.renderSquareControl.call(this,a,e,r,i,o)}}}("undefined"!=typeof exports?exports:this),function(){function n(r,i){var l,c,u,d,o=r.getAttribute("style"),h=r.getAttribute("offset")||0;if(h=(h=parseFloat(h)/(/%$/.test(h)?100:1))<0?0:h>1?1:h,o){var g=o.split(/\s*;\s*/);for(""===g[g.length-1]&&g.pop(),d=g.length;d--;){var v=g[d].split(/\s*:\s*/),w=v[0].trim(),T=v[1].trim();"stop-color"===w?l=T:"stop-opacity"===w&&(u=T)}}return l||(l=r.getAttribute("stop-color")||"rgb(0,0,0)"),u||(u=r.getAttribute("stop-opacity")),c=(l=new fabric.Color(l)).getAlpha(),u=isNaN(parseFloat(u))?1:parseFloat(u),u*=c*i,{offset:h,color:l.toRgb(),opacity:u}}var a=fabric.util.object.clone;fabric.Gradient=fabric.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(r){r||(r={}),r.coords||(r.coords={});var i,o=this;Object.keys(r).forEach(function(h){o[h]=r[h]}),this.id?this.id+="_"+fabric.Object.__uid++:this.id=fabric.Object.__uid++,i={x1:r.coords.x1||0,y1:r.coords.y1||0,x2:r.coords.x2||0,y2:r.coords.y2||0},"radial"===this.type&&(i.r1=r.coords.r1||0,i.r2=r.coords.r2||0),this.coords=i,this.colorStops=r.colorStops.slice()},addColorStop:function(r){for(var i in r){var o=new fabric.Color(r[i]);this.colorStops.push({offset:parseFloat(i),color:o.toRgb(),opacity:o.getAlpha()})}return this},toObject:function(r){var i={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return fabric.util.populateWithProperties(this,i,r),i},toSVG:function(r,c){var h,l,u,d,o=a(this.coords,!0),g=(c=c||{},a(this.colorStops,!0)),v=o.r1>o.r2,w=this.gradientTransform?this.gradientTransform.concat():fabric.iMatrix.concat(),T=-this.offsetX,E=-this.offsetY,I=!!c.additionalTransform,H="pixels"===this.gradientUnits?"userSpaceOnUse":"objectBoundingBox";if(g.sort(function(Y,Q){return Y.offset-Q.offset}),"objectBoundingBox"===H?(T/=r.width,E/=r.height):(T+=r.width/2,E+=r.height/2),"path"===r.type&&"percentage"!==this.gradientUnits&&(T-=r.pathOffset.x,E-=r.pathOffset.y),w[4]-=T,w[5]-=E,d='id="SVGID_'+this.id+'" gradientUnits="'+H+'"',d+=' gradientTransform="'+(I?c.additionalTransform+" ":"")+fabric.util.matrixToSVG(w)+'" ',"linear"===this.type?u=["<linearGradient ",d,' x1="',o.x1,'" y1="',o.y1,'" x2="',o.x2,'" y2="',o.y2,'">\n']:"radial"===this.type&&(u=["<radialGradient ",d,' cx="',v?o.x1:o.x2,'" cy="',v?o.y1:o.y2,'" r="',v?o.r1:o.r2,'" fx="',v?o.x2:o.x1,'" fy="',v?o.y2:o.y1,'">\n']),"radial"===this.type){if(v)for((g=g.concat()).reverse(),h=0,l=g.length;h<l;h++)g[h].offset=1-g[h].offset;var j=Math.min(o.r1,o.r2);if(j>0){var K=j/Math.max(o.r1,o.r2);for(h=0,l=g.length;h<l;h++)g[h].offset+=K*(1-g[h].offset)}}for(h=0,l=g.length;h<l;h++){var q=g[h];u.push("<stop ",'offset="',100*q.offset+"%",'" style="stop-color:',q.color,void 0!==q.opacity?";stop-opacity: "+q.opacity:";",'"/>\n')}return u.push("linear"===this.type?"</linearGradient>\n":"</radialGradient>\n"),u.join("")},toLive:function(r){var i,h,l,o=fabric.util.object.clone(this.coords);if(this.type){for("linear"===this.type?i=r.createLinearGradient(o.x1,o.y1,o.x2,o.y2):"radial"===this.type&&(i=r.createRadialGradient(o.x1,o.y1,o.r1,o.x2,o.y2,o.r2)),h=0,l=this.colorStops.length;h<l;h++){var c=this.colorStops[h].color,u=this.colorStops[h].opacity,d=this.colorStops[h].offset;void 0!==u&&(c=new fabric.Color(c).setAlpha(u).toRgba()),i.addColorStop(d,c)}return i}}}),fabric.util.object.extend(fabric.Gradient,{fromElement:function(r,i,o,h){var l=parseFloat(o)/(/%$/.test(o)?100:1);l=l<0?0:l>1?1:l,isNaN(l)&&(l=1);var u,w,T,H,c=r.getElementsByTagName("stop"),d="userSpaceOnUse"===r.getAttribute("gradientUnits")?"pixels":"percentage",g=r.getAttribute("gradientTransform")||"",v=[],E=0,I=0;for("linearGradient"===r.nodeName||"LINEARGRADIENT"===r.nodeName?(u="linear",w=function t(r){return{x1:r.getAttribute("x1")||0,y1:r.getAttribute("y1")||0,x2:r.getAttribute("x2")||"100%",y2:r.getAttribute("y2")||0}}(r)):(u="radial",w=function s(r){return{x1:r.getAttribute("fx")||r.getAttribute("cx")||"50%",y1:r.getAttribute("fy")||r.getAttribute("cy")||"50%",r1:0,x2:r.getAttribute("cx")||"50%",y2:r.getAttribute("cy")||"50%",r2:r.getAttribute("r")||"50%"}}(r)),T=c.length;T--;)v.push(n(c[T],l));return H=fabric.parseTransformAttribute(g),function e(r,i,o,h){var l,c;Object.keys(i).forEach(function(u){"Infinity"===(l=i[u])?c=1:"-Infinity"===l?c=0:(c=parseFloat(i[u],10),"string"==typeof l&&/^(\d+\.\d+)%|(\d+)%$/.test(l)&&(c*=.01,"pixels"===h&&(("x1"===u||"x2"===u||"r2"===u)&&(c*=o.viewBoxWidth||o.width),("y1"===u||"y2"===u)&&(c*=o.viewBoxHeight||o.height)))),i[u]=c})}(0,w,h,d),"pixels"===d&&(E=-i.left,I=-i.top),new fabric.Gradient({id:r.getAttribute("id"),type:u,coords:w,colorStops:v,gradientUnits:d,gradientTransform:H,offsetX:E,offsetY:I})}})}(),function(){"use strict";var n=fabric.util.toFixed;fabric.Pattern=fabric.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(t,s){if(t||(t={}),this.id=fabric.Object.__uid++,this.setOptions(t),!t.source||t.source&&"string"!=typeof t.source)s&&s(this);else{var a=this;this.source=fabric.util.createImage(),fabric.util.loadImage(t.source,function(e,r){a.source=e,s&&s(a,r)},null,this.crossOrigin)}},toObject:function(t){var a,e,s=fabric.Object.NUM_FRACTION_DIGITS;return"string"==typeof this.source.src?a=this.source.src:"object"==typeof this.source&&this.source.toDataURL&&(a=this.source.toDataURL()),e={type:"pattern",source:a,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:n(this.offsetX,s),offsetY:n(this.offsetY,s),patternTransform:this.patternTransform?this.patternTransform.concat():null},fabric.util.populateWithProperties(this,e,t),e},toSVG:function(t){var s="function"==typeof this.source?this.source():this.source,a=s.width/t.width,e=s.height/t.height,r=this.offsetX/t.width,i=this.offsetY/t.height,o="";return("repeat-x"===this.repeat||"no-repeat"===this.repeat)&&(e=1,i&&(e+=Math.abs(i))),("repeat-y"===this.repeat||"no-repeat"===this.repeat)&&(a=1,r&&(a+=Math.abs(r))),s.src?o=s.src:s.toDataURL&&(o=s.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+r+'" y="'+i+'" width="'+a+'" height="'+e+'">\n<image x="0" y="0" width="'+s.width+'" height="'+s.height+'" xlink:href="'+o+'"></image>\n</pattern>\n'},setOptions:function(t){for(var s in t)this[s]=t[s]},toLive:function(t){var s=this.source;return s&&(void 0===s.src||s.complete&&0!==s.naturalWidth&&0!==s.naturalHeight)?t.createPattern(s,this.repeat):""}})}(),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.toFixed;t.Shadow?t.warn("fabric.Shadow is already defined."):(t.Shadow=t.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(a){for(var e in"string"==typeof a&&(a=this._parseShadow(a)),a)this[e]=a[e];this.id=t.Object.__uid++},_parseShadow:function(a){var e=a.trim(),r=t.Shadow.reOffsetsAndBlur.exec(e)||[];return{color:(e.replace(t.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)").trim(),offsetX:parseFloat(r[1],10)||0,offsetY:parseFloat(r[2],10)||0,blur:parseFloat(r[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(a){var e=40,r=40,i=t.Object.NUM_FRACTION_DIGITS,o=t.util.rotateVector({x:this.offsetX,y:this.offsetY},t.util.degreesToRadians(-a.angle)),l=new t.Color(this.color);return a.width&&a.height&&(e=100*s((Math.abs(o.x)+this.blur)/a.width,i)+20,r=100*s((Math.abs(o.y)+this.blur)/a.height,i)+20),a.flipX&&(o.x*=-1),a.flipY&&(o.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+r+'%" height="'+(100+2*r)+'%" x="-'+e+'%" width="'+(100+2*e)+'%" >\n\t<feGaussianBlur in="SourceAlpha" stdDeviation="'+s(this.blur?this.blur/2:0,i)+'"></feGaussianBlur>\n\t<feOffset dx="'+s(o.x,i)+'" dy="'+s(o.y,i)+'" result="oBlur" ></feOffset>\n\t<feFlood flood-color="'+l.toRgb()+'" flood-opacity="'+l.getAlpha()+'"/>\n\t<feComposite in2="oBlur" operator="in" />\n\t<feMerge>\n\t\t<feMergeNode></feMergeNode>\n\t\t<feMergeNode in="SourceGraphic"></feMergeNode>\n\t</feMerge>\n</filter>\n'},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var a={},e=t.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(r){this[r]!==e[r]&&(a[r]=this[r])},this),a}}),t.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/)}("undefined"!=typeof exports?exports:this),function(){"use strict";if(fabric.StaticCanvas)fabric.warn("fabric.StaticCanvas is already defined.");else{var n=fabric.util.object.extend,t=fabric.util.getElementOffset,s=fabric.util.removeFromArray,a=fabric.util.toFixed,e=fabric.util.transformPoint,r=fabric.util.invertTransform,i=fabric.util.getNodeCanvas,o=fabric.util.createCanvasElement,h=new Error("Could not initialize `canvas` element");fabric.StaticCanvas=fabric.util.createClass(fabric.CommonMethods,{initialize:function(l,c){c||(c={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(l,c)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:fabric.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(l,c){var u=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(l),this._initOptions(c),this.interactive||this._initRetinaScaling(),c.overlayImage&&this.setOverlayImage(c.overlayImage,u),c.backgroundImage&&this.setBackgroundImage(c.backgroundImage,u),c.backgroundColor&&this.setBackgroundColor(c.backgroundColor,u),c.overlayColor&&this.setOverlayColor(c.overlayColor,u),this.calcOffset()},_isRetinaScaling:function(){return fabric.devicePixelRatio>1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Math.max(1,fabric.devicePixelRatio):1},_initRetinaScaling:function(){if(this._isRetinaScaling()){var l=fabric.devicePixelRatio;this.__initRetinaScaling(l,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(l,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(l,c,u){c.setAttribute("width",this.width*l),c.setAttribute("height",this.height*l),u.scale(l,l)},calcOffset:function(){return this._offset=t(this.lowerCanvasEl),this},setOverlayImage:function(l,c,u){return this.__setBgOverlayImage("overlayImage",l,c,u)},setBackgroundImage:function(l,c,u){return this.__setBgOverlayImage("backgroundImage",l,c,u)},setOverlayColor:function(l,c){return this.__setBgOverlayColor("overlayColor",l,c)},setBackgroundColor:function(l,c){return this.__setBgOverlayColor("backgroundColor",l,c)},__setBgOverlayImage:function(l,c,u,d){return"string"==typeof c?fabric.util.loadImage(c,function(g,v){if(g){var w=new fabric.Image(g,d);this[l]=w,w.canvas=this}u&&u(g,v)},this,d&&d.crossOrigin):(d&&c.setOptions(d),this[l]=c,c&&(c.canvas=this),u&&u(c,!1)),this},__setBgOverlayColor:function(l,c,u){return this[l]=c,this._initGradient(c,l),this._initPattern(c,l,u),this},_createCanvasElement:function(){var l=o();if(!l||(l.style||(l.style={}),void 0===l.getContext))throw h;return l},_initOptions:function(l){var c=this.lowerCanvasEl;this._setOptions(l),this.width=this.width||parseInt(c.width,10)||0,this.height=this.height||parseInt(c.height,10)||0,this.lowerCanvasEl.style&&(c.width=this.width,c.height=this.height,c.style.width=this.width+"px",c.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(l){this.lowerCanvasEl=l&&l.getContext?l:fabric.util.getById(l)||this._createCanvasElement(),fabric.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(l,c){return this.setDimensions({width:l},c)},setHeight:function(l,c){return this.setDimensions({height:l},c)},setDimensions:function(l,c){var u;for(var d in c=c||{},l)u=l[d],c.cssOnly||(this._setBackstoreDimension(d,l[d]),u+="px",this.hasLostContext=!0),c.backstoreOnly||this._setCssDimension(d,u);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop),this._initRetinaScaling(),this.calcOffset(),c.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(l,c){return this.lowerCanvasEl[l]=c,this.upperCanvasEl&&(this.upperCanvasEl[l]=c),this.cacheCanvasEl&&(this.cacheCanvasEl[l]=c),this[l]=c,this},_setCssDimension:function(l,c){return this.lowerCanvasEl.style[l]=c,this.upperCanvasEl&&(this.upperCanvasEl.style[l]=c),this.wrapperEl&&(this.wrapperEl.style[l]=c),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(l){var g,v,w,c=this._activeObject,u=this.backgroundImage,d=this.overlayImage;for(this.viewportTransform=l,v=0,w=this._objects.length;v<w;v++)(g=this._objects[v]).group||g.setCoords(!0);return c&&c.setCoords(),u&&u.setCoords(!0),d&&d.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(l,c){var u=l,d=this.viewportTransform.slice(0);l=e(l,r(this.viewportTransform)),d[0]=c,d[3]=c;var g=e(l,d);return d[4]+=u.x-g.x,d[5]+=u.y-g.y,this.setViewportTransform(d)},setZoom:function(l){return this.zoomToPoint(new fabric.Point(0,0),l),this},absolutePan:function(l){var c=this.viewportTransform.slice(0);return c[4]=-l.x,c[5]=-l.y,this.setViewportTransform(c)},relativePan:function(l){return this.absolutePan(new fabric.Point(-l.x-this.viewportTransform[4],-l.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(l){this.stateful&&l.setupState(),l._set("canvas",this),l.setCoords(),this.fire("object:added",{target:l}),l.fire("added")},_onObjectRemoved:function(l){this.fire("object:removed",{target:l}),l.fire("removed"),delete l.canvas},clearContext:function(l){return l.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){return this.renderCanvas(this.contextContainer,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=fabric.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var l={},c=this.width,u=this.height,d=r(this.viewportTransform);return l.tl=e({x:0,y:0},d),l.br=e({x:c,y:u},d),l.tr=new fabric.Point(l.br.x,l.tl.y),l.bl=new fabric.Point(l.tl.x,l.br.y),this.vptCoords=l,l},cancelRequestedRender:function(){this.isRendering&&(fabric.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(l,c){var u=this.viewportTransform,d=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(l),fabric.util.setImageSmoothing(l,this.imageSmoothingEnabled),this.fire("before:render",{ctx:l}),this._renderBackground(l),l.save(),l.transform(u[0],u[1],u[2],u[3],u[4],u[5]),this._renderObjects(l,c),l.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(l),d&&(d.canvas=this,d.shouldCache(),d._transformDone=!0,d.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(l)),this._renderOverlay(l),this.controlsAboveOverlay&&this.interactive&&this.drawControls(l),this.fire("after:render",{ctx:l})},drawClipPathOnCanvas:function(l){var c=this.viewportTransform,u=this.clipPath;l.save(),l.transform(c[0],c[1],c[2],c[3],c[4],c[5]),l.globalCompositeOperation="destination-in",u.transform(l),l.scale(1/u.zoomX,1/u.zoomY),l.drawImage(u._cacheCanvas,-u.cacheTranslationX,-u.cacheTranslationY),l.restore()},_renderObjects:function(l,c){var u,d;for(u=0,d=c.length;u<d;++u)c[u]&&c[u].render(l)},_renderBackgroundOrOverlay:function(l,c){var u=this[c+"Color"],d=this[c+"Image"],g=this.viewportTransform,v=this[c+"Vpt"];if(u||d){if(u){l.save(),l.beginPath(),l.moveTo(0,0),l.lineTo(this.width,0),l.lineTo(this.width,this.height),l.lineTo(0,this.height),l.closePath(),l.fillStyle=u.toLive?u.toLive(l,this):u,v&&l.transform(g[0],g[1],g[2],g[3],g[4],g[5]),l.transform(1,0,0,1,u.offsetX||0,u.offsetY||0);var w=u.gradientTransform||u.patternTransform;w&&l.transform(w[0],w[1],w[2],w[3],w[4],w[5]),l.fill(),l.restore()}d&&(l.save(),v&&l.transform(g[0],g[1],g[2],g[3],g[4],g[5]),d.render(l),l.restore())}},_renderBackground:function(l){this._renderBackgroundOrOverlay(l,"background")},_renderOverlay:function(l){this._renderBackgroundOrOverlay(l,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},centerObjectH:function(l){return this._centerObject(l,new fabric.Point(this.getCenter().left,l.getCenterPoint().y))},centerObjectV:function(l){return this._centerObject(l,new fabric.Point(l.getCenterPoint().x,this.getCenter().top))},centerObject:function(l){var c=this.getCenter();return this._centerObject(l,new fabric.Point(c.left,c.top))},viewportCenterObject:function(l){var c=this.getVpCenter();return this._centerObject(l,c)},viewportCenterObjectH:function(l){var c=this.getVpCenter();return this._centerObject(l,new fabric.Point(c.x,l.getCenterPoint().y)),this},viewportCenterObjectV:function(l){var c=this.getVpCenter();return this._centerObject(l,new fabric.Point(l.getCenterPoint().x,c.y))},getVpCenter:function(){var l=this.getCenter(),c=r(this.viewportTransform);return e({x:l.left,y:l.top},c)},_centerObject:function(l,c){return l.setPositionByOrigin(c,"center","center"),l.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(l){return this.toDatalessObject(l)},toObject:function(l){return this._toObjectMethod("toObject",l)},toDatalessObject:function(l){return this._toObjectMethod("toDatalessObject",l)},_toObjectMethod:function(l,c){var u=this.clipPath,d={version:fabric.version,objects:this._toObjects(l,c)};return u&&!u.excludeFromExport&&(d.clipPath=this._toObject(this.clipPath,l,c)),n(d,this.__serializeBgOverlay(l,c)),fabric.util.populateWithProperties(this,d,c),d},_toObjects:function(l,c){return this._objects.filter(function(u){return!u.excludeFromExport}).map(function(u){return this._toObject(u,l,c)},this)},_toObject:function(l,c,u){var d;this.includeDefaultValues||(d=l.includeDefaultValues,l.includeDefaultValues=!1);var g=l[c](u);return this.includeDefaultValues||(l.includeDefaultValues=d),g},__serializeBgOverlay:function(l,c){var u={},d=this.backgroundImage,g=this.overlayImage,v=this.backgroundColor,w=this.overlayColor;return v&&v.toObject?v.excludeFromExport||(u.background=v.toObject(c)):v&&(u.background=v),w&&w.toObject?w.excludeFromExport||(u.overlay=w.toObject(c)):w&&(u.overlay=w),d&&!d.excludeFromExport&&(u.backgroundImage=this._toObject(d,l,c)),g&&!g.excludeFromExport&&(u.overlayImage=this._toObject(g,l,c)),u},svgViewportTransformation:!0,toSVG:function(l,c){l||(l={}),l.reviver=c;var u=[];return this._setSVGPreamble(u,l),this._setSVGHeader(u,l),this.clipPath&&u.push('<g clip-path="url(#'+this.clipPath.clipPathId+')" >\n'),this._setSVGBgOverlayColor(u,"background"),this._setSVGBgOverlayImage(u,"backgroundImage",c),this._setSVGObjects(u,c),this.clipPath&&u.push("</g>\n"),this._setSVGBgOverlayColor(u,"overlay"),this._setSVGBgOverlayImage(u,"overlayImage",c),u.push("</svg>"),u.join("")},_setSVGPreamble:function(l,c){c.suppressPreamble||l.push('<?xml version="1.0" encoding="',c.encoding||"UTF-8",'" standalone="no" ?>\n','<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ','"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n')},_setSVGHeader:function(l,c){var g,u=c.width||this.width,d=c.height||this.height,v='viewBox="0 0 '+this.width+" "+this.height+'" ',w=fabric.Object.NUM_FRACTION_DIGITS;c.viewBox?v='viewBox="'+c.viewBox.x+" "+c.viewBox.y+" "+c.viewBox.width+" "+c.viewBox.height+'" ':this.svgViewportTransformation&&(v='viewBox="'+a(-(g=this.viewportTransform)[4]/g[0],w)+" "+a(-g[5]/g[3],w)+" "+a(this.width/g[0],w)+" "+a(this.height/g[3],w)+'" '),l.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',u,'" ','height="',d,'" ',v,'xml:space="preserve">\n',"<desc>Created with Fabric.js ",fabric.version,"</desc>\n","<defs>\n",this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(c),"</defs>\n")},createSVGClipPathMarkup:function(l){var c=this.clipPath;return c?(c.clipPathId="CLIPPATH_"+fabric.Object.__uid++,'<clipPath id="'+c.clipPathId+'" >\n'+this.clipPath.toClipPathSVG(l.reviver)+"</clipPath>\n"):""},createSVGRefElementsMarkup:function(){var l=this;return["background","overlay"].map(function(u){var d=l[u+"Color"];if(d&&d.toLive){var g=l[u+"Vpt"],v=l.viewportTransform;return d.toSVG({width:l.width/(g?v[0]:1),height:l.height/(g?v[3]:1)},{additionalTransform:g?fabric.util.matrixToSVG(v):""})}}).join("")},createSVGFontFacesMarkup:function(){var u,d,g,v,w,E,I,H,l="",c={},j=fabric.fontPaths,V=[];for(this._objects.forEach(function q(Y){V.push(Y),Y._objects&&Y._objects.forEach(q)}),I=0,H=V.length;I<H;I++)if(d=(u=V[I]).fontFamily,-1!==u.type.indexOf("text")&&!c[d]&&j[d]&&(c[d]=!0,u.styles))for(w in g=u.styles)for(E in v=g[w])!c[d=v[E].fontFamily]&&j[d]&&(c[d]=!0);for(var K in c)l+=["\t\t@font-face {\n","\t\t\tfont-family: '",K,"';\n","\t\t\tsrc: url('",j[K],"');\n","\t\t}\n"].join("");return l&&(l=['\t<style type="text/css">',"<![CDATA[\n",l,"]]>","</style>\n"].join("")),l},_setSVGObjects:function(l,c){var u,d,g,v=this._objects;for(d=0,g=v.length;d<g;d++)!(u=v[d]).excludeFromExport&&this._setSVGObject(l,u,c)},_setSVGObject:function(l,c,u){l.push(c.toSVG(u))},_setSVGBgOverlayImage:function(l,c,u){this[c]&&!this[c].excludeFromExport&&this[c].toSVG&&l.push(this[c].toSVG(u))},_setSVGBgOverlayColor:function(l,c){var u=this[c+"Color"],g=this.width,v=this.height;if(u)if(u.toLive){var w=u.repeat,T=fabric.util.invertTransform(this.viewportTransform),I=this[c+"Vpt"]?fabric.util.matrixToSVG(T):"";l.push('<rect transform="'+I+" translate(",g/2,",",v/2,')"',' x="',u.offsetX-g/2,'" y="',u.offsetY-v/2,'" ','width="',"repeat-y"===w||"no-repeat"===w?u.source.width:g,'" height="',"repeat-x"===w||"no-repeat"===w?u.source.height:v,'" fill="url(#SVGID_'+u.id+')"',"></rect>\n")}else l.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',u,'"',"></rect>\n")},sendToBack:function(l){if(!l)return this;var u,d,g,c=this._activeObject;if(l===c&&"activeSelection"===l.type)for(u=(g=c._objects).length;u--;)s(this._objects,d=g[u]),this._objects.unshift(d);else s(this._objects,l),this._objects.unshift(l);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(l){if(!l)return this;var u,d,g,c=this._activeObject;if(l===c&&"activeSelection"===l.type)for(g=c._objects,u=0;u<g.length;u++)s(this._objects,d=g[u]),this._objects.push(d);else s(this._objects,l),this._objects.push(l);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(l,c){if(!l)return this;var d,g,v,w,T,u=this._activeObject,E=0;if(l===u&&"activeSelection"===l.type)for(T=u._objects,d=0;d<T.length;d++)(v=this._objects.indexOf(g=T[d]))>0+E&&(w=v-1,s(this._objects,g),this._objects.splice(w,0,g)),E++;else 0!==(v=this._objects.indexOf(l))&&(w=this._findNewLowerIndex(l,v,c),s(this._objects,l),this._objects.splice(w,0,l));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(l,c,u){var d,g;if(u){for(d=c,g=c-1;g>=0;--g)if(l.intersectsWithObject(this._objects[g])||l.isContainedWithinObject(this._objects[g])||this._objects[g].isContainedWithinObject(l)){d=g;break}}else d=c-1;return d},bringForward:function(l,c){if(!l)return this;var d,g,v,w,T,u=this._activeObject,E=0;if(l===u&&"activeSelection"===l.type)for(d=(T=u._objects).length;d--;)(v=this._objects.indexOf(g=T[d]))<this._objects.length-1-E&&(w=v+1,s(this._objects,g),this._objects.splice(w,0,g)),E++;else(v=this._objects.indexOf(l))!==this._objects.length-1&&(w=this._findNewUpperIndex(l,v,c),s(this._objects,l),this._objects.splice(w,0,l));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(l,c,u){var d,g,v;if(u){for(d=c,g=c+1,v=this._objects.length;g<v;++g)if(l.intersectsWithObject(this._objects[g])||l.isContainedWithinObject(this._objects[g])||this._objects[g].isContainedWithinObject(l)){d=g;break}}else d=c+1;return d},moveTo:function(l,c){return s(this._objects,l),this._objects.splice(c,0,l),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(fabric.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(l){l.dispose&&l.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),fabric.util.setStyle(this.lowerCanvasEl,this._originalCanvasStyle),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),fabric.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),n(fabric.StaticCanvas.prototype,fabric.Observable),n(fabric.StaticCanvas.prototype,fabric.Collection),n(fabric.StaticCanvas.prototype,fabric.DataURLExporter),n(fabric.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(l){var c=o();if(!c||!c.getContext)return null;var u=c.getContext("2d");return u&&"setLineDash"===l?void 0!==u.setLineDash:null}}),fabric.StaticCanvas.prototype.toJSON=fabric.StaticCanvas.prototype.toObject,fabric.isLikelyNode&&(fabric.StaticCanvas.prototype.createPNGStream=function(){var l=i(this.lowerCanvasEl);return l&&l.createPNGStream()},fabric.StaticCanvas.prototype.createJPEGStream=function(l){var c=i(this.lowerCanvasEl);return c&&c.createJPEGStream(l)})}}(),fabric.BaseBrush=fabric.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(n){n.strokeStyle=this.color,n.lineWidth=this.width,n.lineCap=this.strokeLineCap,n.miterLimit=this.strokeMiterLimit,n.lineJoin=this.strokeLineJoin,n.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(n){var t=this.canvas.viewportTransform;n.save(),n.transform(t[0],t[1],t[2],t[3],t[4],t[5])},_setShadow:function(){if(this.shadow){var n=this.canvas,t=this.shadow,s=n.contextTop,a=n.getZoom();n&&n._isRetinaScaling()&&(a*=fabric.devicePixelRatio),s.shadowColor=t.color,s.shadowBlur=t.blur*a,s.shadowOffsetX=t.offsetX*a,s.shadowOffsetY=t.offsetY*a}},needsFullRender:function(){return new fabric.Color(this.color).getAlpha()<1||!!this.shadow},_resetShadow:function(){var n=this.canvas.contextTop;n.shadowColor="",n.shadowBlur=n.shadowOffsetX=n.shadowOffsetY=0},_isOutSideCanvas:function(n){return n.x<0||n.x>this.canvas.getWidth()||n.y<0||n.y>this.canvas.getHeight()}}),fabric.PencilBrush=fabric.util.createClass(fabric.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(n){this.canvas=n,this._points=[]},needsFullRender:function(){return this.callSuper("needsFullRender")||this._hasStraightLine},_drawSegment:function(n,t,s){var a=t.midPointFrom(s);return n.quadraticCurveTo(t.x,t.y,a.x,a.y),a},onMouseDown:function(n,t){!this.canvas._isMainEvent(t.e)||(this.drawStraightLine=t.e[this.straightLineKey],this._prepareForDrawing(n),this._captureDrawingPath(n),this._render())},onMouseMove:function(n,t){if(this.canvas._isMainEvent(t.e)&&(this.drawStraightLine=t.e[this.straightLineKey],(!0!==this.limitedToCanvasSize||!this._isOutSideCanvas(n))&&this._captureDrawingPath(n)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var s=this._points,a=s.length,e=this.canvas.contextTop;this._saveAndTransform(e),this.oldEnd&&(e.beginPath(),e.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(e,s[a-2],s[a-1],!0),e.stroke(),e.restore()}},onMouseUp:function(n){return!this.canvas._isMainEvent(n.e)||(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1)},_prepareForDrawing:function(n){var t=new fabric.Point(n.x,n.y);this._reset(),this._addPoint(t),this.canvas.contextTop.moveTo(t.x,t.y)},_addPoint:function(n){return!(this._points.length>1&&n.eq(this._points[this._points.length-1])||(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(n),0))},_reset:function(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1},_captureDrawingPath:function(n){var t=new fabric.Point(n.x,n.y);return this._addPoint(t)},_render:function(n){var t,s,a=this._points[0],e=this._points[1];if(this._saveAndTransform(n=n||this.canvas.contextTop),n.beginPath(),2===this._points.length&&a.x===e.x&&a.y===e.y){var r=this.width/1e3;a=new fabric.Point(a.x,a.y),e=new fabric.Point(e.x,e.y),a.x-=r,e.x+=r}for(n.moveTo(a.x,a.y),t=1,s=this._points.length;t<s;t++)this._drawSegment(n,a,e),a=this._points[t],e=this._points[t+1];n.lineTo(a.x,a.y),n.stroke(),n.restore()},convertPointsToSVGPath:function(n){return fabric.util.getSmoothPathFromPoints(n,this.width/1e3)},_isEmptySVGPath:function(n){return"M 0 0 Q 0 0 0 0 L 0 0"===fabric.util.joinPath(n)},createPath:function(n){var t=new fabric.Path(n,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,t.shadow=new fabric.Shadow(this.shadow)),t},decimatePoints:function(n,t){if(n.length<=2)return n;var e,s=this.canvas.getZoom(),a=Math.pow(t/s,2),r=n.length-1,i=n[0],o=[i];for(e=1;e<r-1;e++)Math.pow(i.x-n[e].x,2)+Math.pow(i.y-n[e].y,2)>=a&&o.push(i=n[e]);return o.push(n[r]),o},_finalizeAndAddPath:function(){this.canvas.contextTop.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var t=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(t))this.canvas.requestRenderAll();else{var s=this.createPath(t);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:s}),this.canvas.add(s),this.canvas.requestRenderAll(),s.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:s})}}}),fabric.CircleBrush=fabric.util.createClass(fabric.BaseBrush,{width:10,initialize:function(n){this.canvas=n,this.points=[]},drawDot:function(n){var t=this.addPoint(n),s=this.canvas.contextTop;this._saveAndTransform(s),this.dot(s,t),s.restore()},dot:function(n,t){n.fillStyle=t.fill,n.beginPath(),n.arc(t.x,t.y,t.radius,0,2*Math.PI,!1),n.closePath(),n.fill()},onMouseDown:function(n){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(n)},_render:function(){var t,s,n=this.canvas.contextTop,a=this.points;for(this._saveAndTransform(n),t=0,s=a.length;t<s;t++)this.dot(n,a[t]);n.restore()},onMouseMove:function(n){!0===this.limitedToCanvasSize&&this._isOutSideCanvas(n)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(n),this._render()):this.drawDot(n))},onMouseUp:function(){var t,s,n=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;var a=[];for(t=0,s=this.points.length;t<s;t++){var e=this.points[t],r=new fabric.Circle({radius:e.radius,left:e.x,top:e.y,originX:"center",originY:"center",fill:e.fill});this.shadow&&(r.shadow=new fabric.Shadow(this.shadow)),a.push(r)}var i=new fabric.Group(a);i.canvas=this.canvas,this.canvas.fire("before:path:created",{path:i}),this.canvas.add(i),this.canvas.fire("path:created",{path:i}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=n,this.canvas.requestRenderAll()},addPoint:function(n){var t=new fabric.Point(n.x,n.y),s=fabric.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,a=new fabric.Color(this.color).setAlpha(fabric.util.getRandomInt(0,100)/100).toRgba();return t.radius=s,t.fill=a,this.points.push(t),t}}),fabric.SprayBrush=fabric.util.createClass(fabric.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(n){this.canvas=n,this.sprayChunks=[]},onMouseDown:function(n){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(n),this.render(this.sprayChunkPoints)},onMouseMove:function(n){!0===this.limitedToCanvasSize&&this._isOutSideCanvas(n)||(this.addSprayChunk(n),this.render(this.sprayChunkPoints))},onMouseUp:function(){var n=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var t=[],s=0,a=this.sprayChunks.length;s<a;s++)for(var e=this.sprayChunks[s],r=0,i=e.length;r<i;r++){var o=new fabric.Rect({width:e[r].width,height:e[r].width,left:e[r].x+1,top:e[r].y+1,originX:"center",originY:"center",fill:this.color});t.push(o)}this.optimizeOverlapping&&(t=this._getOptimizedRects(t));var h=new fabric.Group(t);this.shadow&&h.set("shadow",new fabric.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:h}),this.canvas.add(h),this.canvas.fire("path:created",{path:h}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=n,this.canvas.requestRenderAll()},_getOptimizedRects:function(n){var s,a,e,t={};for(a=0,e=n.length;a<e;a++)t[s=n[a].left+""+n[a].top]||(t[s]=n[a]);var r=[];for(s in t)r.push(t[s]);return r},render:function(n){var s,a,t=this.canvas.contextTop;for(t.fillStyle=this.color,this._saveAndTransform(t),s=0,a=n.length;s<a;s++){var e=n[s];void 0!==e.opacity&&(t.globalAlpha=e.opacity),t.fillRect(e.x,e.y,e.width,e.width)}t.restore()},_render:function(){var t,s,n=this.canvas.contextTop;for(n.fillStyle=this.color,this._saveAndTransform(n),t=0,s=this.sprayChunks.length;t<s;t++)this.render(this.sprayChunks[t]);n.restore()},addSprayChunk:function(n){this.sprayChunkPoints=[];var t,s,a,r,e=this.width/2;for(r=0;r<this.density;r++){t=fabric.util.getRandomInt(n.x-e,n.x+e),s=fabric.util.getRandomInt(n.y-e,n.y+e),a=this.dotWidthVariance?fabric.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):this.dotWidth;var i=new fabric.Point(t,s);i.width=a,this.randomOpacity&&(i.opacity=fabric.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(i)}this.sprayChunks.push(this.sprayChunkPoints)}}),fabric.PatternBrush=fabric.util.createClass(fabric.PencilBrush,{getPatternSrc:function(){var s=fabric.util.createCanvasElement(),a=s.getContext("2d");return s.width=s.height=25,a.fillStyle=this.color,a.beginPath(),a.arc(10,10,10,0,2*Math.PI,!1),a.closePath(),a.fill(),s},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(n){return n.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(n){this.callSuper("_setBrushStyles",n),n.strokeStyle=this.getPattern(n)},createPath:function(n){var t=this.callSuper("createPath",n),s=t._getLeftTopCoords().scalarAdd(t.strokeWidth/2);return t.stroke=new fabric.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-s.x,offsetY:-s.y}),t}}),function(){var n=fabric.util.getPointer,t=fabric.util.degreesToRadians,s=fabric.util.isTouchEvent;for(var a in fabric.Canvas=fabric.util.createClass(fabric.StaticCanvas,{initialize:function(e,r){r||(r={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(e,r),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=fabric.PencilBrush&&new fabric.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var r,i,o,e=this.getActiveObjects();if(e.length>0&&!this.preserveObjectStacking){i=[],o=[];for(var h=0,l=this._objects.length;h<l;h++)-1===e.indexOf(r=this._objects[h])?i.push(r):o.push(r);e.length>1&&(this._activeObject._objects=o),i.push.apply(i,o)}else i=this._objects;return i},renderAll:function(){return this.contextTopDirty&&!this._groupSelector&&!this.isDrawingMode&&(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1),this.renderCanvas(this.contextContainer,this._chooseObjectsToRender()),this},renderTopLayer:function(e){e.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(e),this.contextTopDirty=!0),e.restore()},renderTop:function(){var e=this.contextTop;return this.clearContext(e),this.renderTopLayer(e),this.fire("after:render"),this},_normalizePointer:function(e,r){var i=e.calcTransformMatrix(),o=fabric.util.invertTransform(i),h=this.restorePointerVpt(r);return fabric.util.transformPoint(h,o)},isTargetTransparent:function(e,r,i){if(e.shouldCache()&&e._cacheCanvas&&e!==this._activeObject){var o=this._normalizePointer(e,{x:r,y:i}),h=Math.max(e.cacheTranslationX+o.x*e.zoomX,0),l=Math.max(e.cacheTranslationY+o.y*e.zoomY,0);return fabric.util.isTransparent(e._cacheContext,Math.round(h),Math.round(l),this.targetFindTolerance)}var c=this.contextCache,u=e.selectionBackgroundColor,d=this.viewportTransform;return e.selectionBackgroundColor="",this.clearContext(c),c.save(),c.transform(d[0],d[1],d[2],d[3],d[4],d[5]),e.render(c),c.restore(),e.selectionBackgroundColor=u,fabric.util.isTransparent(c,r,i,this.targetFindTolerance)},_isSelectionKeyPressed:function(e){return"[object Array]"===Object.prototype.toString.call(this.selectionKey)?!!this.selectionKey.find(function(i){return!0===e[i]}):e[this.selectionKey]},_shouldClearSelection:function(e,r){var i=this.getActiveObjects(),o=this._activeObject;return!r||r&&o&&i.length>1&&-1===i.indexOf(r)&&o!==r&&!this._isSelectionKeyPressed(e)||r&&!r.evented||r&&!r.selectable&&o&&o!==r},_shouldCenterTransform:function(e,r,i){var o;if(e)return"scale"===r||"scaleX"===r||"scaleY"===r||"resizing"===r?o=this.centeredScaling||e.centeredScaling:"rotate"===r&&(o=this.centeredRotation||e.centeredRotation),o?!i:i},_getOriginFromCorner:function(e,r){var i={x:e.originX,y:e.originY};return"ml"===r||"tl"===r||"bl"===r?i.x="right":("mr"===r||"tr"===r||"br"===r)&&(i.x="left"),"tl"===r||"mt"===r||"tr"===r?i.y="bottom":("bl"===r||"mb"===r||"br"===r)&&(i.y="top"),i},_getActionFromCorner:function(e,r,i,o){if(!r||!e)return"drag";var h=o.controls[r];return h.getActionName(i,h,o)},_setupCurrentTransform:function(e,r,i){if(r){var o=this.getPointer(e),h=r.__corner,l=r.controls[h],c=i&&h?l.getActionHandler(e,r,l):fabric.controlsUtils.dragHandler,u=this._getActionFromCorner(i,h,e,r),d=this._getOriginFromCorner(r,h),g=e[this.centeredKey],v={target:r,action:u,actionHandler:c,corner:h,scaleX:r.scaleX,scaleY:r.scaleY,skewX:r.skewX,skewY:r.skewY,offsetX:o.x-r.left,offsetY:o.y-r.top,originX:d.x,originY:d.y,ex:o.x,ey:o.y,lastX:o.x,lastY:o.y,theta:t(r.angle),width:r.width*r.scaleX,shiftKey:e.shiftKey,altKey:g,original:fabric.util.saveObjectTransform(r)};this._shouldCenterTransform(r,u,g)&&(v.originX="center",v.originY="center"),v.original.originX=d.x,v.original.originY=d.y,this._currentTransform=v,this._beforeTransform(e)}},setCursor:function(e){this.upperCanvasEl.style.cursor=e},_drawSelection:function(e){var r=this._groupSelector,i=new fabric.Point(r.ex,r.ey),o=fabric.util.transformPoint(i,this.viewportTransform),h=new fabric.Point(r.ex+r.left,r.ey+r.top),l=fabric.util.transformPoint(h,this.viewportTransform),c=Math.min(o.x,l.x),u=Math.min(o.y,l.y),d=Math.max(o.x,l.x),g=Math.max(o.y,l.y),v=this.selectionLineWidth/2;this.selectionColor&&(e.fillStyle=this.selectionColor,e.fillRect(c,u,d-c,g-u)),this.selectionLineWidth&&this.selectionBorderColor&&(e.lineWidth=this.selectionLineWidth,e.strokeStyle=this.selectionBorderColor,c+=v,u+=v,d-=v,g-=v,fabric.Object.prototype._setLineDash.call(this,e,this.selectionDashArray),e.strokeRect(c,u,d-c,g-u))},findTarget:function(e,r){if(!this.skipTargetFind){var c,u,o=this.getPointer(e,!0),h=this._activeObject,l=this.getActiveObjects(),d=s(e),g=l.length>1&&!r||1===l.length;if(this.targets=[],g&&h._findTargetCorner(o,d)||l.length>1&&!r&&h===this._searchPossibleTargets([h],o))return h;if(1===l.length&&h===this._searchPossibleTargets([h],o)){if(!this.preserveObjectStacking)return h;c=h,u=this.targets,this.targets=[]}var v=this._searchPossibleTargets(this._objects,o);return e[this.altSelectionKey]&&v&&c&&v!==c&&(v=c,this.targets=u),v}},_checkTarget:function(e,r,i){if(r&&r.visible&&r.evented&&r.containsPoint(e)){if(!this.perPixelTargetFind&&!r.perPixelTargetFind||r.isEditing)return!0;if(!this.isTargetTransparent(r,i.x,i.y))return!0}},_searchPossibleTargets:function(e,r){for(var i,h,o=e.length;o--;){var l=e[o],c=l.group?this._normalizePointer(l.group,r):r;if(this._checkTarget(c,l,r)){(i=e[o]).subTargetCheck&&i instanceof fabric.Group&&(h=this._searchPossibleTargets(i._objects,r))&&this.targets.push(h);break}}return i},restorePointerVpt:function(e){return fabric.util.transformPoint(e,fabric.util.invertTransform(this.viewportTransform))},getPointer:function(e,r){if(this._absolutePointer&&!r)return this._absolutePointer;if(this._pointer&&r)return this._pointer;var u,i=n(e),o=this.upperCanvasEl,h=o.getBoundingClientRect(),l=h.width||0,c=h.height||0;(!l||!c)&&("top"in h&&"bottom"in h&&(c=Math.abs(h.top-h.bottom)),"right"in h&&"left"in h&&(l=Math.abs(h.right-h.left))),this.calcOffset(),i.x=i.x-this._offset.left,i.y=i.y-this._offset.top,r||(i=this.restorePointerVpt(i));var d=this.getRetinaScaling();return 1!==d&&(i.x/=d,i.y/=d),{x:i.x*(u=0===l||0===c?{width:1,height:1}:{width:o.width/l,height:o.height/c}).width,y:i.y*u.height}},_createUpperCanvas:function(){var e=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),r=this.lowerCanvasEl,i=this.upperCanvasEl;i?i.className="":(i=this._createCanvasElement(),this.upperCanvasEl=i),fabric.util.addClass(i,"upper-canvas "+e),this.wrapperEl.appendChild(i),this._copyCanvasStyle(r,i),this._applyCanvasStyle(i),this.contextTop=i.getContext("2d")},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=fabric.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),fabric.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),fabric.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(e){var r=this.width||e.width,i=this.height||e.height;fabric.util.setStyle(e,{position:"absolute",width:r+"px",height:i+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),e.width=r,e.height=i,fabric.util.makeElementUnselectable(e)},_copyCanvasStyle:function(e,r){r.style.cssText=e.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var e=this._activeObject;return e?"activeSelection"===e.type&&e._objects?e._objects.slice(0):[e]:[]},_onObjectRemoved:function(e){e===this._activeObject&&(this.fire("before:selection:cleared",{target:e}),this._discardActiveObject(),this.fire("selection:cleared",{target:e}),e.fire("deselected")),e===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",e)},_fireSelectionEvents:function(e,r){var i=!1,o=this.getActiveObjects(),h=[],l=[];e.forEach(function(c){-1===o.indexOf(c)&&(i=!0,c.fire("deselected",{e:r,target:c}),l.push(c))}),o.forEach(function(c){-1===e.indexOf(c)&&(i=!0,c.fire("selected",{e:r,target:c}),h.push(c))}),e.length>0&&o.length>0?i&&this.fire("selection:updated",{e:r,selected:h,deselected:l}):o.length>0?this.fire("selection:created",{e:r,selected:h}):e.length>0&&this.fire("selection:cleared",{e:r,deselected:l})},setActiveObject:function(e,r){var i=this.getActiveObjects();return this._setActiveObject(e,r),this._fireSelectionEvents(i,r),this},_setActiveObject:function(e,r){return!(this._activeObject===e||!this._discardActiveObject(r,e)||e.onSelect({e:r})||(this._activeObject=e,0))},_discardActiveObject:function(e,r){var i=this._activeObject;if(i){if(i.onDeselect({e,object:r}))return!1;this._activeObject=null}return!0},discardActiveObject:function(e){var r=this.getActiveObjects(),i=this.getActiveObject();return r.length&&this.fire("before:selection:cleared",{target:i,e}),this._discardActiveObject(e),this._fireSelectionEvents(r,e),this},dispose:function(){var e=this.wrapperEl;return this.removeListeners(),e.removeChild(this.upperCanvasEl),e.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach(function(r){fabric.util.cleanUpJsdomNode(this[r]),this[r]=void 0}.bind(this)),e.parentNode&&e.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,fabric.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(e){var r=this._activeObject;r&&r._renderControls(e)},_toObject:function(e,r,i){var o=this._realizeGroupTransformOnObject(e),h=this.callSuper("_toObject",e,r,i);return this._unwindGroupTransformOnObject(e,o),h},_realizeGroupTransformOnObject:function(e){if(e.group&&"activeSelection"===e.group.type&&this._activeObject===e.group){var i={};return["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"].forEach(function(o){i[o]=e[o]}),fabric.util.addTransformToObject(e,this._activeObject.calcOwnMatrix()),i}return null},_unwindGroupTransformOnObject:function(e,r){r&&e.set(r)},_setSVGObject:function(e,r,i){var o=this._realizeGroupTransformOnObject(r);this.callSuper("_setSVGObject",e,r,i),this._unwindGroupTransformOnObject(r,o)},setViewportTransform:function(e){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),fabric.StaticCanvas.prototype.setViewportTransform.call(this,e)}}),fabric.StaticCanvas)"prototype"!==a&&(fabric.Canvas[a]=fabric.StaticCanvas[a])}(),function(){var n=fabric.util.addListener,t=fabric.util.removeListener,r={passive:!1};function i(o,h){return o.button&&o.button===h-1}fabric.util.object.extend(fabric.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(n,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(o,h){var l=this.upperCanvasEl,c=this._getEventPrefix();o(fabric.window,"resize",this._onResize),o(l,c+"down",this._onMouseDown),o(l,c+"move",this._onMouseMove,r),o(l,c+"out",this._onMouseOut),o(l,c+"enter",this._onMouseEnter),o(l,"wheel",this._onMouseWheel),o(l,"contextmenu",this._onContextMenu),o(l,"dblclick",this._onDoubleClick),o(l,"dragover",this._onDragOver),o(l,"dragenter",this._onDragEnter),o(l,"dragleave",this._onDragLeave),o(l,"drop",this._onDrop),this.enablePointerEvents||o(l,"touchstart",this._onTouchStart,r),"undefined"!=typeof eventjs&&h in eventjs&&(eventjs[h](l,"gesture",this._onGesture),eventjs[h](l,"drag",this._onDrag),eventjs[h](l,"orientation",this._onOrientationChange),eventjs[h](l,"shake",this._onShake),eventjs[h](l,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(t,"remove");var o=this._getEventPrefix();t(fabric.document,o+"up",this._onMouseUp),t(fabric.document,"touchend",this._onTouchEnd,r),t(fabric.document,o+"move",this._onMouseMove,r),t(fabric.document,"touchmove",this._onMouseMove,r)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._onDrop.bind(this),this.eventsBound=!0)},_onGesture:function(o,h){this.__onTransformGesture&&this.__onTransformGesture(o,h)},_onDrag:function(o,h){this.__onDrag&&this.__onDrag(o,h)},_onMouseWheel:function(o){this.__onMouseWheel(o)},_onMouseOut:function(o){var h=this._hoveredTarget;this.fire("mouse:out",{target:h,e:o}),this._hoveredTarget=null,h&&h.fire("mouseout",{e:o});var l=this;this._hoveredTargets.forEach(function(c){l.fire("mouse:out",{target:h,e:o}),c&&h.fire("mouseout",{e:o})}),this._hoveredTargets=[],this._iTextInstances&&this._iTextInstances.forEach(function(c){c.isEditing&&c.hiddenTextarea.focus()})},_onMouseEnter:function(o){!this._currentTransform&&!this.findTarget(o)&&(this.fire("mouse:over",{target:null,e:o}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(o,h){this.__onOrientationChange&&this.__onOrientationChange(o,h)},_onShake:function(o,h){this.__onShake&&this.__onShake(o,h)},_onLongPress:function(o,h){this.__onLongPress&&this.__onLongPress(o,h)},_onDragOver:function(o){o.preventDefault();var h=this._simpleEventHandler("dragover",o);this._fireEnterLeaveEvents(h,o)},_onDrop:function(o){return this._simpleEventHandler("drop:before",o),this._simpleEventHandler("drop",o)},_onContextMenu:function(o){return this.stopContextMenu&&(o.stopPropagation(),o.preventDefault()),!1},_onDoubleClick:function(o){this._cacheTransformEventData(o),this._handleEvent(o,"dblclick"),this._resetTransformEventData(o)},getPointerId:function(o){var h=o.changedTouches;return h?h[0]&&h[0].identifier:this.enablePointerEvents?o.pointerId:-1},_isMainEvent:function(o){return!0===o.isPrimary||!1!==o.isPrimary&&("touchend"===o.type&&0===o.touches.length||!o.changedTouches||o.changedTouches[0].identifier===this.mainTouchId)},_onTouchStart:function(o){o.preventDefault(),null===this.mainTouchId&&(this.mainTouchId=this.getPointerId(o)),this.__onMouseDown(o),this._resetTransformEventData();var h=this.upperCanvasEl,l=this._getEventPrefix();n(fabric.document,"touchend",this._onTouchEnd,r),n(fabric.document,"touchmove",this._onMouseMove,r),t(h,l+"down",this._onMouseDown)},_onMouseDown:function(o){this.__onMouseDown(o),this._resetTransformEventData();var h=this.upperCanvasEl,l=this._getEventPrefix();t(h,l+"move",this._onMouseMove,r),n(fabric.document,l+"up",this._onMouseUp),n(fabric.document,l+"move",this._onMouseMove,r)},_onTouchEnd:function(o){if(!(o.touches.length>0)){this.__onMouseUp(o),this._resetTransformEventData(),this.mainTouchId=null;var h=this._getEventPrefix();t(fabric.document,"touchend",this._onTouchEnd,r),t(fabric.document,"touchmove",this._onMouseMove,r);var l=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){n(l.upperCanvasEl,h+"down",l._onMouseDown),l._willAddMouseDown=0},400)}},_onMouseUp:function(o){this.__onMouseUp(o),this._resetTransformEventData();var h=this.upperCanvasEl,l=this._getEventPrefix();this._isMainEvent(o)&&(t(fabric.document,l+"up",this._onMouseUp),t(fabric.document,l+"move",this._onMouseMove,r),n(h,l+"move",this._onMouseMove,r))},_onMouseMove:function(o){!this.allowTouchScrolling&&o.preventDefault&&o.preventDefault(),this.__onMouseMove(o)},_onResize:function(){this.calcOffset()},_shouldRender:function(o){var h=this._activeObject;return!!(!!h!=!!o||h&&o&&h!==o)},__onMouseUp:function(o){var h,l=this._currentTransform,c=this._groupSelector,u=!1,d=!c||0===c.left&&0===c.top;if(this._cacheTransformEventData(o),h=this._target,this._handleEvent(o,"up:before"),i(o,3))this.fireRightClick&&this._handleEvent(o,"up",3,d);else{if(i(o,2))return this.fireMiddleClick&&this._handleEvent(o,"up",2,d),void this._resetTransformEventData();if(this.isDrawingMode&&this._isCurrentlyDrawing)this._onMouseUpInDrawingMode(o);else if(this._isMainEvent(o)){if(l&&(this._finalizeCurrentTransform(o),u=l.actionPerformed),!d){var g=h===this._activeObject;this._maybeGroupObjects(o),u||(u=this._shouldRender(h)||!g&&h===this._activeObject)}var v,w;if(h){if(v=h._findTargetCorner(this.getPointer(o,!0),fabric.util.isTouchEvent(o)),h.selectable&&h!==this._activeObject&&"up"===h.activeOn)this.setActiveObject(h,o),u=!0;else{var T=h.controls[v],E=T&&T.getMouseUpHandler(o,h,T);E&&E(o,l,(w=this.getPointer(o)).x,w.y)}h.isMoving=!1}if(l&&(l.target!==h||l.corner!==v)){var I=l.target&&l.target.controls[l.corner],H=I&&I.getMouseUpHandler(o,h,T);w=w||this.getPointer(o),H&&H(o,l,w.x,w.y)}this._setCursorFromEvent(o,h),this._handleEvent(o,"up",1,d),this._groupSelector=null,this._currentTransform=null,h&&(h.__corner=0),u?this.requestRenderAll():d||this.renderTop()}}},_simpleEventHandler:function(o,h){var l=this.findTarget(h),c=this.targets,u={e:h,target:l,subTargets:c};if(this.fire(o,u),l&&l.fire(o,u),!c)return l;for(var d=0;d<c.length;d++)c[d].fire(o,u);return l},_handleEvent:function(o,h,l,c){var u=this._target,d=this.targets||[],g={e:o,target:u,subTargets:d,button:l||1,isClick:c||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};"up"===h&&(g.currentTarget=this.findTarget(o),g.currentSubTargets=this.targets),this.fire("mouse:"+h,g),u&&u.fire("mouse"+h,g);for(var v=0;v<d.length;v++)d[v].fire("mouse"+h,g)},_finalizeCurrentTransform:function(o){var h=this._currentTransform,l=h.target,c={e:o,target:l,transform:h,action:h.action};l._scaling&&(l._scaling=!1),l.setCoords(),(h.actionPerformed||this.stateful&&l.hasStateChanged())&&this._fire("modified",c)},_onMouseDownInDrawingMode:function(o){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(o).requestRenderAll();var h=this.getPointer(o);this.freeDrawingBrush.onMouseDown(h,{e:o,pointer:h}),this._handleEvent(o,"down")},_onMouseMoveInDrawingMode:function(o){if(this._isCurrentlyDrawing){var h=this.getPointer(o);this.freeDrawingBrush.onMouseMove(h,{e:o,pointer:h})}this.setCursor(this.freeDrawingCursor),this._handleEvent(o,"move")},_onMouseUpInDrawingMode:function(o){var h=this.getPointer(o);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e:o,pointer:h}),this._handleEvent(o,"up")},__onMouseDown:function(o){this._cacheTransformEventData(o),this._handleEvent(o,"down:before");var h=this._target;if(i(o,3))this.fireRightClick&&this._handleEvent(o,"down",3);else if(i(o,2))this.fireMiddleClick&&this._handleEvent(o,"down",2);else if(this.isDrawingMode)this._onMouseDownInDrawingMode(o);else if(this._isMainEvent(o)&&!this._currentTransform){this._previousPointer=l=this._pointer;var c=this._shouldRender(h),u=this._shouldGroup(o,h);if(this._shouldClearSelection(o,h)?this.discardActiveObject(o):u&&(this._handleGrouping(o,h),h=this._activeObject),this.selection&&(!h||!h.selectable&&!h.isEditing&&h!==this._activeObject)&&(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),h){var d=h===this._activeObject;h.selectable&&"down"===h.activeOn&&this.setActiveObject(h,o);var g=h._findTargetCorner(this.getPointer(o,!0),fabric.util.isTouchEvent(o));if(h.__corner=g,h===this._activeObject&&(g||!u)){this._setupCurrentTransform(o,h,d);var v=h.controls[g],l=this.getPointer(o),w=v&&v.getMouseDownHandler(o,h,v);w&&w(o,this._currentTransform,l.x,l.y)}}this._handleEvent(o,"down"),(c||u)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(o){this._resetTransformEventData(),this._pointer=this.getPointer(o,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(o)||null},_beforeTransform:function(o){var h=this._currentTransform;this.stateful&&h.target.saveState(),this.fire("before:transform",{e:o,transform:h})},__onMouseMove:function(o){var h,l;if(this._handleEvent(o,"move:before"),this._cacheTransformEventData(o),this.isDrawingMode)this._onMouseMoveInDrawingMode(o);else if(this._isMainEvent(o)){var c=this._groupSelector;c?(c.left=(l=this._absolutePointer).x-c.ex,c.top=l.y-c.ey,this.renderTop()):this._currentTransform?this._transformObject(o):(h=this.findTarget(o)||null,this._setCursorFromEvent(o,h),this._fireOverOutEvents(h,o)),this._handleEvent(o,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(o,h){var l=this._hoveredTarget,c=this._hoveredTargets,u=this.targets,d=Math.max(c.length,u.length);this.fireSyntheticInOutEvents(o,h,{oldTarget:l,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var g=0;g<d;g++)this.fireSyntheticInOutEvents(u[g],h,{oldTarget:c[g],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=o,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(o,h){var l=this._draggedoverTarget,c=this._hoveredTargets,u=this.targets,d=Math.max(c.length,u.length);this.fireSyntheticInOutEvents(o,h,{oldTarget:l,evtOut:"dragleave",evtIn:"dragenter"});for(var g=0;g<d;g++)this.fireSyntheticInOutEvents(u[g],h,{oldTarget:c[g],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=o},fireSyntheticInOutEvents:function(o,h,l){var c,u,v,d=l.oldTarget,w=d!==o,T=l.canvasEvtIn,E=l.canvasEvtOut;w&&(c={e:h,target:o,previousTarget:d},u={e:h,target:d,nextTarget:o}),v=o&&w,d&&w&&(E&&this.fire(E,u),d.fire(l.evtOut,u)),v&&(T&&this.fire(T,c),o.fire(l.evtIn,c))},__onMouseWheel:function(o){this._cacheTransformEventData(o),this._handleEvent(o,"wheel"),this._resetTransformEventData()},_transformObject:function(o){var h=this.getPointer(o),l=this._currentTransform;l.reset=!1,l.shiftKey=o.shiftKey,l.altKey=o[this.centeredKey],this._performTransformAction(o,l,h),l.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(o,h,l){var d=h.action,g=!1,v=h.actionHandler;v&&(g=v(o,h,l.x,l.y)),"drag"===d&&g&&(h.target.isMoving=!0,this.setCursor(h.target.moveCursor||this.moveCursor)),h.actionPerformed=h.actionPerformed||g},_fire:fabric.controlsUtils.fireEvent,_setCursorFromEvent:function(o,h){if(!h)return this.setCursor(this.defaultCursor),!1;var l=h.hoverCursor||this.hoverCursor,c=this._activeObject&&"activeSelection"===this._activeObject.type?this._activeObject:null,u=(!c||!c.contains(h))&&h._findTargetCorner(this.getPointer(o,!0));u?this.setCursor(this.getCornerCursor(u,h,o)):(h.subTargetCheck&&this.targets.concat().reverse().map(function(d){l=d.hoverCursor||l}),this.setCursor(l))},getCornerCursor:function(o,h,l){var c=h.controls[o];return c.cursorStyleHandler(l,c,h)}})}(),function(){var n=Math.min,t=Math.max;fabric.util.object.extend(fabric.Canvas.prototype,{_shouldGroup:function(s,a){var e=this._activeObject;return e&&this._isSelectionKeyPressed(s)&&a&&a.selectable&&this.selection&&(e!==a||"activeSelection"===e.type)&&!a.onSelect({e:s})},_handleGrouping:function(s,a){var e=this._activeObject;e.__corner||a===e&&(!(a=this.findTarget(s,!0))||!a.selectable)||(e&&"activeSelection"===e.type?this._updateActiveSelection(a,s):this._createActiveSelection(a,s))},_updateActiveSelection:function(s,a){var e=this._activeObject,r=e._objects.slice(0);e.contains(s)?(e.removeWithUpdate(s),this._hoveredTarget=s,this._hoveredTargets=this.targets.concat(),1===e.size()&&this._setActiveObject(e.item(0),a)):(e.addWithUpdate(s),this._hoveredTarget=e,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(r,a)},_createActiveSelection:function(s,a){var e=this.getActiveObjects(),r=this._createGroup(s);this._hoveredTarget=r,this._setActiveObject(r,a),this._fireSelectionEvents(e,a)},_createGroup:function(s){var a=this._objects,r=a.indexOf(this._activeObject)<a.indexOf(s)?[this._activeObject,s]:[s,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new fabric.ActiveSelection(r,{canvas:this})},_groupSelectedObjects:function(s){var e,a=this._collectObjects(s);1===a.length?this.setActiveObject(a[0],s):a.length>1&&(e=new fabric.ActiveSelection(a.reverse(),{canvas:this}),this.setActiveObject(e,s))},_collectObjects:function(s){for(var e,a=[],r=this._groupSelector.ex,i=this._groupSelector.ey,o=r+this._groupSelector.left,h=i+this._groupSelector.top,l=new fabric.Point(n(r,o),n(i,h)),c=new fabric.Point(t(r,o),t(i,h)),u=!this.selectionFullyContained,d=r===o&&i===h,g=this._objects.length;g--&&!((e=this._objects[g])&&e.selectable&&e.visible&&(u&&e.intersectsWithRect(l,c,!0)||e.isContainedWithinRect(l,c,!0)||u&&e.containsPoint(l,null,!0)||u&&e.containsPoint(c,null,!0))&&(a.push(e),d)););return a.length>1&&(a=a.filter(function(v){return!v.onSelect({e:s})})),a},_maybeGroupObjects:function(s){this.selection&&this._groupSelector&&this._groupSelectedObjects(s),this.setCursor(this.defaultCursor),this._groupSelector=null}})}(),fabric.util.object.extend(fabric.StaticCanvas.prototype,{toDataURL:function(n){n||(n={});var t=n.format||"png",s=n.quality||1,a=(n.multiplier||1)*(n.enableRetinaScaling?this.getRetinaScaling():1),e=this.toCanvasElement(a,n);return fabric.util.toDataURL(e,t,s)},toCanvasElement:function(n,t){var s=((t=t||{}).width||this.width)*(n=n||1),a=(t.height||this.height)*n,e=this.getZoom(),r=this.width,i=this.height,o=e*n,h=this.viewportTransform,u=this.interactive,d=[o,0,0,o,(h[4]-(t.left||0))*n,(h[5]-(t.top||0))*n],g=this.enableRetinaScaling,v=fabric.util.createCanvasElement(),w=this.contextTop;return v.width=s,v.height=a,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=d,this.width=s,this.height=a,this.calcViewportBoundaries(),this.renderCanvas(v.getContext("2d"),this._objects),this.viewportTransform=h,this.width=r,this.height=i,this.calcViewportBoundaries(),this.interactive=u,this.enableRetinaScaling=g,this.contextTop=w,v}}),fabric.util.object.extend(fabric.StaticCanvas.prototype,{loadFromJSON:function(n,t,s){if(n){var a="string"==typeof n?JSON.parse(n):fabric.util.object.clone(n),e=this,r=a.clipPath,i=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete a.clipPath,this._enlivenObjects(a.objects,function(o){e.clear(),e._setBgOverlay(a,function(){r?e._enlivenObjects([r],function(h){e.clipPath=h[0],e.__setupCanvas.call(e,a,o,i,t)}):e.__setupCanvas.call(e,a,o,i,t)})},s),this}},__setupCanvas:function(n,t,s,a){var e=this;t.forEach(function(r,i){e.insertAt(r,i)}),this.renderOnAddRemove=s,delete n.objects,delete n.backgroundImage,delete n.overlayImage,delete n.background,delete n.overlay,this._setOptions(n),this.renderAll(),a&&a()},_setBgOverlay:function(n,t){var s={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(n.backgroundImage||n.overlayImage||n.background||n.overlay){var a=function(){s.backgroundImage&&s.overlayImage&&s.backgroundColor&&s.overlayColor&&t&&t()};this.__setBgOverlay("backgroundImage",n.backgroundImage,s,a),this.__setBgOverlay("overlayImage",n.overlayImage,s,a),this.__setBgOverlay("backgroundColor",n.background,s,a),this.__setBgOverlay("overlayColor",n.overlay,s,a)}else t&&t()},__setBgOverlay:function(n,t,s,a){var e=this;if(!t)return s[n]=!0,void(a&&a());"backgroundImage"===n||"overlayImage"===n?fabric.util.enlivenObjects([t],function(r){e[n]=r[0],s[n]=!0,a&&a()}):this["set"+fabric.util.string.capitalize(n,!0)](t,function(){s[n]=!0,a&&a()})},_enlivenObjects:function(n,t,s){n&&0!==n.length?fabric.util.enlivenObjects(n,function(a){t&&t(a)},null,s):t&&t([])},_toDataURL:function(n,t){this.clone(function(s){t(s.toDataURL(n))})},_toDataURLWithMultiplier:function(n,t,s){this.clone(function(a){s(a.toDataURLWithMultiplier(n,t))})},clone:function(n,t){var s=JSON.stringify(this.toJSON(t));this.cloneWithoutData(function(a){a.loadFromJSON(s,function(){n&&n(a)})})},cloneWithoutData:function(n){var t=fabric.util.createCanvasElement();t.width=this.width,t.height=this.height;var s=new fabric.Canvas(t);this.backgroundImage?(s.setBackgroundImage(this.backgroundImage.src,function(){s.renderAll(),n&&n(s)}),s.backgroundImageOpacity=this.backgroundImageOpacity,s.backgroundImageStretch=this.backgroundImageStretch):n&&n(s)}}),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.object.extend,a=t.util.object.clone,e=t.util.toFixed,r=t.util.string.capitalize,i=t.util.degreesToRadians;t.Object||(t.Object=t.util.createClass(t.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:!t.isLikelyNode,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(l){l&&this.setOptions(l)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=t.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(l){var c=t.perfLimitSizeTotal,u=l.width,d=l.height,g=t.maxCacheSideLimit,v=t.minCacheSideLimit;if(u<=g&&d<=g&&u*d<=c)return u<v&&(l.width=v),d<v&&(l.height=v),l;var T=t.util.limitDimsByArea(u/d,c),E=t.util.capValue,I=E(v,T.x,g),H=E(v,T.y,g);return u>I&&(l.zoomX/=u/I,l.width=I,l.capped=!0),d>H&&(l.zoomY/=d/H,l.height=H,l.capped=!0),l},_getCacheCanvasDimensions:function(){var l=this.getTotalObjectScaling(),c=this._getTransformedDimensions(0,0),u=c.x*l.scaleX/this.scaleX,d=c.y*l.scaleY/this.scaleY;return{width:u+2,height:d+2,zoomX:l.scaleX,zoomY:l.scaleY,x:u,y:d}},_updateCacheCanvas:function(){var l=this.canvas;if(this.noScaleCache&&l&&l._currentTransform){var u=l._currentTransform.action;if(this===l._currentTransform.target&&u.slice&&"scale"===u.slice(0,5))return!1}var E,I,d=this._cacheCanvas,g=this._limitCacheSize(this._getCacheCanvasDimensions()),v=t.minCacheSideLimit,w=g.width,T=g.height,H=g.zoomX,j=g.zoomY,V=w!==this.cacheWidth||T!==this.cacheHeight,q=V||this.zoomX!==H||this.zoomY!==j,Y=0,Q=0,et=!1;if(V){var $=this._cacheCanvas.width,S=this._cacheCanvas.height,R=w>$||T>S;et=R||(w<.9*$||T<.9*S)&&$>v&&S>v,R&&!g.capped&&(w>v||T>v)&&(Y=.1*w,Q=.1*T)}return this instanceof t.Text&&this.path&&(q=!0,et=!0,Y+=this.getHeightOfLine(0)*this.zoomX,Q+=this.getHeightOfLine(0)*this.zoomY),!!q&&(et?(d.width=Math.ceil(w+Y),d.height=Math.ceil(T+Q)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,d.width,d.height)),E=g.x/2,I=g.y/2,this.cacheTranslationX=Math.round(d.width/2-E)+E,this.cacheTranslationY=Math.round(d.height/2-I)+I,this.cacheWidth=w,this.cacheHeight=T,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(H,j),this.zoomX=H,this.zoomY=j,!0)},setOptions:function(l){this._setOptions(l),this._initGradient(l.fill,"fill"),this._initGradient(l.stroke,"stroke"),this._initPattern(l.fill,"fill"),this._initPattern(l.stroke,"stroke")},transform:function(l){var u=this.calcTransformMatrix(!(this.group&&!this.group._transformDone||this.group&&this.canvas&&l===this.canvas.contextTop));l.transform(u[0],u[1],u[2],u[3],u[4],u[5])},toObject:function(l){var c=t.Object.NUM_FRACTION_DIGITS,u={type:this.type,version:t.version,originX:this.originX,originY:this.originY,left:e(this.left,c),top:e(this.top,c),width:e(this.width,c),height:e(this.height,c),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:e(this.strokeWidth,c),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:e(this.strokeMiterLimit,c),scaleX:e(this.scaleX,c),scaleY:e(this.scaleY,c),angle:e(this.angle,c),flipX:this.flipX,flipY:this.flipY,opacity:e(this.opacity,c),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:e(this.skewX,c),skewY:e(this.skewY,c)};return this.clipPath&&!this.clipPath.excludeFromExport&&(u.clipPath=this.clipPath.toObject(l),u.clipPath.inverted=this.clipPath.inverted,u.clipPath.absolutePositioned=this.clipPath.absolutePositioned),t.util.populateWithProperties(this,u,l),this.includeDefaultValues||(u=this._removeDefaultValues(u)),u},toDatalessObject:function(l){return this.toObject(l)},_removeDefaultValues:function(l){var c=t.util.getKlass(l.type).prototype;return c.stateProperties.forEach(function(d){"left"!==d&&"top"!==d&&(l[d]===c[d]&&delete l[d],"[object Array]"===Object.prototype.toString.call(l[d])&&"[object Array]"===Object.prototype.toString.call(c[d])&&0===l[d].length&&0===c[d].length&&delete l[d])}),l},toString:function(){return"#<fabric."+r(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var l=t.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(l.scaleX),scaleY:Math.abs(l.scaleY)}},getTotalObjectScaling:function(){var l=this.getObjectScaling(),c=l.scaleX,u=l.scaleY;if(this.canvas){var d=this.canvas.getZoom(),g=this.canvas.getRetinaScaling();c*=d*g,u*=d*g}return{scaleX:c,scaleY:u}},getObjectOpacity:function(){var l=this.opacity;return this.group&&(l*=this.group.getObjectOpacity()),l},_set:function(l,c){var d=this[l]!==c,g=!1;return("scaleX"===l||"scaleY"===l)&&(c=this._constrainScale(c)),"scaleX"===l&&c<0?(this.flipX=!this.flipX,c*=-1):"scaleY"===l&&c<0?(this.flipY=!this.flipY,c*=-1):"shadow"!==l||!c||c instanceof t.Shadow?"dirty"===l&&this.group&&this.group.set("dirty",c):c=new t.Shadow(c),this[l]=c,d&&(g=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(l)>-1?(this.dirty=!0,g&&this.group.set("dirty",!0)):g&&this.stateProperties.indexOf(l)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:t.iMatrix.concat()},isNotVisible:function(){return 0===this.opacity||!this.width&&!this.height&&0===this.strokeWidth||!this.visible},render:function(l){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(l.save(),this._setupCompositeOperation(l),this.drawSelectionBackground(l),this.transform(l),this._setOpacity(l),this._setShadow(l,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(l)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(l),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),l.restore())},renderCache:function(l){l=l||{},this._cacheCanvas||this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,l.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&"transparent"!==this.stroke&&0!==this.strokeWidth},hasFill:function(){return this.fill&&"transparent"!==this.fill},needsItsOwnCache:function(){return!!("stroke"===this.paintFirst&&this.hasFill()&&this.hasStroke()&&"object"==typeof this.shadow||this.clipPath)},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(0!==this.shadow.offsetX||0!==this.shadow.offsetY)},drawClipPathOnCache:function(l,c){if(l.save(),l.globalCompositeOperation=c.inverted?"destination-out":"destination-in",c.absolutePositioned){var u=t.util.invertTransform(this.calcTransformMatrix());l.transform(u[0],u[1],u[2],u[3],u[4],u[5])}c.transform(l),l.scale(1/c.zoomX,1/c.zoomY),l.drawImage(c._cacheCanvas,-c.cacheTranslationX,-c.cacheTranslationY),l.restore()},drawObject:function(l,c){var u=this.fill,d=this.stroke;c?(this.fill="black",this.stroke="",this._setClippingProperties(l)):this._renderBackground(l),this._render(l),this._drawClipPath(l,this.clipPath),this.fill=u,this.stroke=d},_drawClipPath:function(l,c){!c||(c.canvas=this.canvas,c.shouldCache(),c._transformDone=!0,c.renderCache({forClipping:!0}),this.drawClipPathOnCache(l,c))},drawCacheOnCanvas:function(l){l.scale(1/this.zoomX,1/this.zoomY),l.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(l){if(this.isNotVisible())return!1;if(this._cacheCanvas&&!l&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&!l){var c=this.cacheWidth/this.zoomX,u=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-c/2,-u/2,c,u)}return!0}return!1},_renderBackground:function(l){if(this.backgroundColor){var c=this._getNonTransformedDimensions();l.fillStyle=this.backgroundColor,l.fillRect(-c.x/2,-c.y/2,c.x,c.y),this._removeShadow(l)}},_setOpacity:function(l){this.group&&!this.group._transformDone?l.globalAlpha=this.getObjectOpacity():l.globalAlpha*=this.opacity},_setStrokeStyles:function(l,c){var u=c.stroke;u&&(l.lineWidth=c.strokeWidth,l.lineCap=c.strokeLineCap,l.lineDashOffset=c.strokeDashOffset,l.lineJoin=c.strokeLineJoin,l.miterLimit=c.strokeMiterLimit,u.toLive?"percentage"===u.gradientUnits||u.gradientTransform||u.patternTransform?this._applyPatternForTransformedGradient(l,u):(l.strokeStyle=u.toLive(l,this),this._applyPatternGradientTransform(l,u)):l.strokeStyle=c.stroke)},_setFillStyles:function(l,c){var u=c.fill;u&&(u.toLive?(l.fillStyle=u.toLive(l,this),this._applyPatternGradientTransform(l,c.fill)):l.fillStyle=u)},_setClippingProperties:function(l){l.globalAlpha=1,l.strokeStyle="transparent",l.fillStyle="#000000"},_setLineDash:function(l,c){!c||0===c.length||(1&c.length&&c.push.apply(c,c),l.setLineDash(c))},_renderControls:function(l,c){var g,v,w,u=this.getViewportTransform(),d=this.calcTransformMatrix();v=void 0!==(c=c||{}).hasBorders?c.hasBorders:this.hasBorders,w=void 0!==c.hasControls?c.hasControls:this.hasControls,d=t.util.multiplyTransformMatrices(u,d),g=t.util.qrDecompose(d),l.save(),l.translate(g.translateX,g.translateY),l.lineWidth=1*this.borderScaleFactor,this.group||(l.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(g.angle-=180),l.rotate(i(this.group?g.angle:this.angle)),c.forActiveSelection||this.group?v&&this.drawBordersInGroup(l,g,c):v&&this.drawBorders(l,c),w&&this.drawControls(l,c),l.restore()},_setShadow:function(l){if(this.shadow){var d,c=this.shadow,u=this.canvas,g=u&&u.viewportTransform[0]||1,v=u&&u.viewportTransform[3]||1;d=c.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),u&&u._isRetinaScaling()&&(g*=t.devicePixelRatio,v*=t.devicePixelRatio),l.shadowColor=c.color,l.shadowBlur=c.blur*t.browserShadowBlurConstant*(g+v)*(d.scaleX+d.scaleY)/4,l.shadowOffsetX=c.offsetX*g*d.scaleX,l.shadowOffsetY=c.offsetY*v*d.scaleY}},_removeShadow:function(l){!this.shadow||(l.shadowColor="",l.shadowBlur=l.shadowOffsetX=l.shadowOffsetY=0)},_applyPatternGradientTransform:function(l,c){if(!c||!c.toLive)return{offsetX:0,offsetY:0};var u=c.gradientTransform||c.patternTransform,d=-this.width/2+c.offsetX||0,g=-this.height/2+c.offsetY||0;return"percentage"===c.gradientUnits?l.transform(this.width,0,0,this.height,d,g):l.transform(1,0,0,1,d,g),u&&l.transform(u[0],u[1],u[2],u[3],u[4],u[5]),{offsetX:d,offsetY:g}},_renderPaintInOrder:function(l){"stroke"===this.paintFirst?(this._renderStroke(l),this._renderFill(l)):(this._renderFill(l),this._renderStroke(l))},_render:function(){},_renderFill:function(l){!this.fill||(l.save(),this._setFillStyles(l,this),"evenodd"===this.fillRule?l.fill("evenodd"):l.fill(),l.restore())},_renderStroke:function(l){if(this.stroke&&0!==this.strokeWidth){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(l),l.save(),this.strokeUniform&&this.group){var c=this.getObjectScaling();l.scale(1/c.scaleX,1/c.scaleY)}else this.strokeUniform&&l.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(l,this.strokeDashArray),this._setStrokeStyles(l,this),l.stroke(),l.restore()}},_applyPatternForTransformedGradient:function(l,c){var g,u=this._limitCacheSize(this._getCacheCanvasDimensions()),d=t.util.createCanvasElement(),v=this.canvas.getRetinaScaling(),w=u.x/this.scaleX/v,T=u.y/this.scaleY/v;d.width=w,d.height=T,(g=d.getContext("2d")).beginPath(),g.moveTo(0,0),g.lineTo(w,0),g.lineTo(w,T),g.lineTo(0,T),g.closePath(),g.translate(w/2,T/2),g.scale(u.zoomX/this.scaleX/v,u.zoomY/this.scaleY/v),this._applyPatternGradientTransform(g,c),g.fillStyle=c.toLive(l),g.fill(),l.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),l.scale(v*this.scaleX/u.zoomX,v*this.scaleY/u.zoomY),l.strokeStyle=g.createPattern(d,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var l=t.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",l.scaleX),this.set("scaleY",l.scaleY),this.angle=l.angle,this.skewX=l.skewX,this.skewY=0}},_removeTransformMatrix:function(l){var c=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),c=t.util.transformPoint(c,this.transformMatrix)),this.transformMatrix=null,l&&(this.scaleX*=l.scaleX,this.scaleY*=l.scaleY,this.cropX=l.cropX,this.cropY=l.cropY,c.x+=l.offsetLeft,c.y+=l.offsetTop,this.width=l.width,this.height=l.height),this.setPositionByOrigin(c,"center","center")},clone:function(l,c){var u=this.toObject(c);this.constructor.fromObject?this.constructor.fromObject(u,l):t.Object._fromObject("Object",u,l)},cloneAsImage:function(l,c){var u=this.toCanvasElement(c);return l&&l(new t.Image(u)),this},toCanvasElement:function(l){l||(l={});var c=t.util,u=c.saveObjectTransform(this),d=this.group,g=this.shadow,v=Math.abs,w=(l.multiplier||1)*(l.enableRetinaScaling?t.devicePixelRatio:1);delete this.group,l.withoutTransform&&c.resetObjectTransform(this),l.withoutShadow&&(this.shadow=null);var H,V,q,T=t.util.createCanvasElement(),E=this.getBoundingRect(!0,!0),I=this.shadow,j={x:0,y:0};I&&(V=I.blur,H=I.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),j.x=2*Math.round(v(I.offsetX)+V)*v(H.scaleX),j.y=2*Math.round(v(I.offsetY)+V)*v(H.scaleY)),q=E.height+j.y,T.width=Math.ceil(E.width+j.x),T.height=Math.ceil(q);var Y=new t.StaticCanvas(T,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});"jpeg"===l.format&&(Y.backgroundColor="#fff"),this.setPositionByOrigin(new t.Point(Y.width/2,Y.height/2),"center","center");var Q=this.canvas;Y.add(this);var et=Y.toCanvasElement(w||1,l);return this.shadow=g,this.set("canvas",Q),d&&(this.group=d),this.set(u).setCoords(),Y._objects=[],Y.dispose(),Y=null,et},toDataURL:function(l){return l||(l={}),t.util.toDataURL(this.toCanvasElement(l),l.format||"png",l.quality||1)},isType:function(l){return this.type===l},complexity:function(){return 1},toJSON:function(l){return this.toObject(l)},rotate:function(l){var c=("center"!==this.originX||"center"!==this.originY)&&this.centeredRotation;return c&&this._setOriginToCenter(),this.set("angle",l),c&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(l,c){c=c||this.canvas.getPointer(l);var u=new t.Point(c.x,c.y),d=this._getLeftTopCoords();return this.angle&&(u=t.util.rotatePoint(u,d,i(-this.angle))),{x:u.x-d.x,y:u.y-d.y}},_setupCompositeOperation:function(l){this.globalCompositeOperation&&(l.globalCompositeOperation=this.globalCompositeOperation)},dispose:function(){t.runningAnimations&&t.runningAnimations.cancelByTarget(this)}}),t.util.createAccessors&&t.util.createAccessors(t.Object),s(t.Object.prototype,t.Observable),t.Object.NUM_FRACTION_DIGITS=2,t.Object.ENLIVEN_PROPS=["clipPath"],t.Object._fromObject=function(l,c,u,d){var g=t[l];c=a(c,!0),t.util.enlivenPatterns([c.fill,c.stroke],function(v){void 0!==v[0]&&(c.fill=v[0]),void 0!==v[1]&&(c.stroke=v[1]),t.util.enlivenObjectEnlivables(c,c,function(){var w=d?new g(c[d],c):new g(c);u&&u(w)})})},t.Object.__uid=0)}("undefined"!=typeof exports?exports:this),function(){var n=fabric.util.degreesToRadians,t={left:-.5,center:0,right:.5},s={top:-.5,center:0,bottom:.5};fabric.util.object.extend(fabric.Object.prototype,{translateToGivenOrigin:function(a,e,r,i,o){var c,u,d,h=a.x,l=a.y;return"string"==typeof e?e=t[e]:e-=.5,"string"==typeof i?i=t[i]:i-=.5,"string"==typeof r?r=s[r]:r-=.5,"string"==typeof o?o=s[o]:o-=.5,u=o-r,((c=i-e)||u)&&(d=this._getTransformedDimensions(),h=a.x+c*d.x,l=a.y+u*d.y),new fabric.Point(h,l)},translateToCenterPoint:function(a,e,r){var i=this.translateToGivenOrigin(a,e,r,"center","center");return this.angle?fabric.util.rotatePoint(i,a,n(this.angle)):i},translateToOriginPoint:function(a,e,r){var i=this.translateToGivenOrigin(a,"center","center",e,r);return this.angle?fabric.util.rotatePoint(i,a,n(this.angle)):i},getCenterPoint:function(){var a=new fabric.Point(this.left,this.top);return this.translateToCenterPoint(a,this.originX,this.originY)},getPointByOrigin:function(a,e){var r=this.getCenterPoint();return this.translateToOriginPoint(r,a,e)},toLocalPoint:function(a,e,r){var o,h,i=this.getCenterPoint();return o=void 0!==e&&void 0!==r?this.translateToGivenOrigin(i,"center","center",e,r):new fabric.Point(this.left,this.top),h=new fabric.Point(a.x,a.y),this.angle&&(h=fabric.util.rotatePoint(h,i,-n(this.angle))),h.subtractEquals(o)},setPositionByOrigin:function(a,e,r){var i=this.translateToCenterPoint(a,e,r),o=this.translateToOriginPoint(i,this.originX,this.originY);this.set("left",o.x),this.set("top",o.y)},adjustPosition:function(a){var h,l,e=n(this.angle),r=this.getScaledWidth(),i=fabric.util.cos(e)*r,o=fabric.util.sin(e)*r;this.left+=i*((l="string"==typeof a?t[a]:a-.5)-(h="string"==typeof this.originX?t[this.originX]:this.originX-.5)),this.top+=o*(l-h),this.setCoords(),this.originX=a},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var a=this.getCenterPoint();this.originX="center",this.originY="center",this.left=a.x,this.top=a.y},_resetOrigin:function(){var a=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=a.x,this.top=a.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}})}(),function(){var t=fabric.util,s=t.degreesToRadians,a=t.multiplyTransformMatrices,e=t.transformPoint;t.object.extend(fabric.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(r,i){return i?r?this.calcACoords():this.calcLineCoords():((!this.aCoords||!this.lineCoords)&&this.setCoords(!0),r?this.aCoords:this.lineCoords)},getCoords:function(r,i){return function n(r){return[new fabric.Point(r.tl.x,r.tl.y),new fabric.Point(r.tr.x,r.tr.y),new fabric.Point(r.br.x,r.br.y),new fabric.Point(r.bl.x,r.bl.y)]}(this._getCoords(r,i))},intersectsWithRect:function(r,i,o,h){var l=this.getCoords(o,h);return"Intersection"===fabric.Intersection.intersectPolygonRectangle(l,r,i).status},intersectsWithObject:function(r,i,o){return"Intersection"===fabric.Intersection.intersectPolygonPolygon(this.getCoords(i,o),r.getCoords(i,o)).status||r.isContainedWithinObject(this,i,o)||this.isContainedWithinObject(r,i,o)},isContainedWithinObject:function(r,i,o){for(var h=this.getCoords(i,o),c=0,u=r._getImageLines(i?r.aCoords:r.lineCoords);c<4;c++)if(!r.containsPoint(h[c],u))return!1;return!0},isContainedWithinRect:function(r,i,o,h){var l=this.getBoundingRect(o,h);return l.left>=r.x&&l.left+l.width<=i.x&&l.top>=r.y&&l.top+l.height<=i.y},containsPoint:function(r,c,o,h){var l=this._getCoords(o,h),u=(c=c||this._getImageLines(l),this._findCrossPoints(r,c));return 0!==u&&u%2==1},isOnScreen:function(r){if(!this.canvas)return!1;var i=this.canvas.vptCoords.tl,o=this.canvas.vptCoords.br;return!(!this.getCoords(!0,r).some(function(l){return l.x<=o.x&&l.x>=i.x&&l.y<=o.y&&l.y>=i.y})&&!this.intersectsWithRect(i,o,!0,r))||this._containsCenterOfCanvas(i,o,r)},_containsCenterOfCanvas:function(r,i,o){return!!this.containsPoint({x:(r.x+i.x)/2,y:(r.y+i.y)/2},null,!0,o)},isPartiallyOnScreen:function(r){if(!this.canvas)return!1;var i=this.canvas.vptCoords.tl,o=this.canvas.vptCoords.br;return!!this.intersectsWithRect(i,o,!0,r)||this.getCoords(!0,r).every(function(l){return(l.x>=o.x||l.x<=i.x)&&(l.y>=o.y||l.y<=i.y)})&&this._containsCenterOfCanvas(i,o,r)},_getImageLines:function(r){return{topline:{o:r.tl,d:r.tr},rightline:{o:r.tr,d:r.br},bottomline:{o:r.br,d:r.bl},leftline:{o:r.bl,d:r.tl}}},_findCrossPoints:function(r,i){var h,l,c,u,g,d=0;for(var v in i)if(!((g=i[v]).o.y<r.y&&g.d.y<r.y||g.o.y>=r.y&&g.d.y>=r.y||(g.o.x===g.d.x&&g.o.x>=r.x?u=g.o.x:(h=(g.d.y-g.o.y)/(g.d.x-g.o.x),l=r.y-0*r.x,c=g.o.y-h*g.o.x,u=-(l-c)/(0-h)),u>=r.x&&(d+=1),2!==d)))break;return d},getBoundingRect:function(r,i){var o=this.getCoords(r,i);return t.makeBoundingBoxFromPoints(o)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(r){return Math.abs(r)<this.minScaleLimit?r<0?-this.minScaleLimit:this.minScaleLimit:0===r?1e-4:r},scale:function(r){return this._set("scaleX",r),this._set("scaleY",r),this.setCoords()},scaleToWidth:function(r,i){var o=this.getBoundingRect(i).width/this.getScaledWidth();return this.scale(r/this.width/o)},scaleToHeight:function(r,i){var o=this.getBoundingRect(i).height/this.getScaledHeight();return this.scale(r/this.height/o)},calcLineCoords:function(){var r=this.getViewportTransform(),i=this.padding,o=s(this.angle),c=t.cos(o)*i,u=t.sin(o)*i,d=c+u,g=c-u,v=this.calcACoords(),w={tl:e(v.tl,r),tr:e(v.tr,r),bl:e(v.bl,r),br:e(v.br,r)};return i&&(w.tl.x-=g,w.tl.y-=d,w.tr.x+=d,w.tr.y-=g,w.bl.x-=d,w.bl.y+=g,w.br.x+=g,w.br.y+=d),w},calcOCoords:function(){var r=this._calcRotateMatrix(),i=this._calcTranslateMatrix(),o=this.getViewportTransform(),h=a(o,i),l=a(h,r),c=(l=a(l,[1/o[0],0,0,1/o[3],0,0]),this._calculateCurrentDimensions()),u={};return this.forEachControl(function(d,g,v){u[g]=d.positionHandler(c,l,v)}),u},calcACoords:function(){var r=this._calcRotateMatrix(),i=this._calcTranslateMatrix(),o=a(i,r),h=this._getTransformedDimensions(),l=h.x/2,c=h.y/2;return{tl:e({x:-l,y:-c},o),tr:e({x:l,y:-c},o),bl:e({x:-l,y:c},o),br:e({x:l,y:c},o)}},setCoords:function(r){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),r||(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords()),this},_calcRotateMatrix:function(){return t.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var r=this.getCenterPoint();return[1,0,0,1,r.x,r.y]},transformMatrixKey:function(r){var i="_",o="";return!r&&this.group&&(o=this.group.transformMatrixKey(r)+i),o+this.top+i+this.left+i+this.scaleX+i+this.scaleY+i+this.skewX+i+this.skewY+i+this.angle+i+this.originX+i+this.originY+i+this.width+i+this.height+i+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(r){var i=this.calcOwnMatrix();if(r||!this.group)return i;var o=this.transformMatrixKey(r),h=this.matrixCache||(this.matrixCache={});return h.key===o?h.value:(this.group&&(i=a(this.group.calcTransformMatrix(!1),i)),h.key=o,h.value=i,i)},calcOwnMatrix:function(){var r=this.transformMatrixKey(!0),i=this.ownMatrixCache||(this.ownMatrixCache={});if(i.key===r)return i.value;var o=this._calcTranslateMatrix(),h={angle:this.angle,translateX:o[4],translateY:o[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return i.key=r,i.value=t.composeMatrix(h),i.value},_getNonTransformedDimensions:function(){var r=this.strokeWidth;return{x:this.width+r,y:this.height+r}},_getTransformedDimensions:function(r,i){void 0===r&&(r=this.skewX),void 0===i&&(i=this.skewY);var o,h,l,c=0===r&&0===i;if(this.strokeUniform?(h=this.width,l=this.height):(h=(o=this._getNonTransformedDimensions()).x,l=o.y),c)return this._finalizeDimensions(h*this.scaleX,l*this.scaleY);var u=t.sizeAfterTransform(h,l,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:r,skewY:i});return this._finalizeDimensions(u.x,u.y)},_finalizeDimensions:function(r,i){return this.strokeUniform?{x:r+this.strokeWidth,y:i+this.strokeWidth}:{x:r,y:i}},_calculateCurrentDimensions:function(){var r=this.getViewportTransform(),i=this._getTransformedDimensions();return e(i,r,!0).scalarAdd(2*this.padding)}})}(),fabric.util.object.extend(fabric.Object.prototype,{sendToBack:function(){return this.group?fabric.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?fabric.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(n){return this.group?fabric.StaticCanvas.prototype.sendBackwards.call(this.group,this,n):this.canvas&&this.canvas.sendBackwards(this,n),this},bringForward:function(n){return this.group?fabric.StaticCanvas.prototype.bringForward.call(this.group,this,n):this.canvas&&this.canvas.bringForward(this,n),this},moveTo:function(n){return this.group&&"activeSelection"!==this.group.type?fabric.StaticCanvas.prototype.moveTo.call(this.group,this,n):this.canvas&&this.canvas.moveTo(this,n),this}}),function(){function n(s,a){if(a){if(a.toLive)return s+": url(#SVGID_"+a.id+"); ";var e=new fabric.Color(a),r=s+": "+e.toRgb()+"; ",i=e.getAlpha();return 1!==i&&(r+=s+"-opacity: "+i.toString()+"; "),r}return s+": none; "}var t=fabric.util.toFixed;fabric.util.object.extend(fabric.Object.prototype,{getSvgStyles:function(s){var a=this.fillRule?this.fillRule:"nonzero",e=this.strokeWidth?this.strokeWidth:"0",r=this.strokeDashArray?this.strokeDashArray.join(" "):"none",i=this.strokeDashOffset?this.strokeDashOffset:"0",o=this.strokeLineCap?this.strokeLineCap:"butt",h=this.strokeLineJoin?this.strokeLineJoin:"miter",l=this.strokeMiterLimit?this.strokeMiterLimit:"4",c=void 0!==this.opacity?this.opacity:"1",u=this.visible?"":" visibility: hidden;",d=s?"":this.getSvgFilter(),g=n("fill",this.fill);return[n("stroke",this.stroke),"stroke-width: ",e,"; ","stroke-dasharray: ",r,"; ","stroke-linecap: ",o,"; ","stroke-dashoffset: ",i,"; ","stroke-linejoin: ",h,"; ","stroke-miterlimit: ",l,"; ",g,"fill-rule: ",a,"; ","opacity: ",c,";",d,u].join("")},getSvgSpanStyles:function(s,a){var e="; ",i=s.fontFamily?"font-family: "+(-1===s.fontFamily.indexOf("'")&&-1===s.fontFamily.indexOf('"')?"'"+s.fontFamily+"'":s.fontFamily)+e:"",r=s.strokeWidth?"stroke-width: "+s.strokeWidth+e:"",o=(i=i,s.fontSize?"font-size: "+s.fontSize+"px"+e:""),h=s.fontStyle?"font-style: "+s.fontStyle+e:"",l=s.fontWeight?"font-weight: "+s.fontWeight+e:"",c=s.fill?n("fill",s.fill):"",u=s.stroke?n("stroke",s.stroke):"",d=this.getSvgTextDecoration(s);return d&&(d="text-decoration: "+d+e),[u,r,i,o,h,l,d,c,s.deltaY?"baseline-shift: "+-s.deltaY+"; ":"",a?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(s){return["overline","underline","line-through"].filter(function(a){return s[a.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(s,a){var e=s?this.calcTransformMatrix():this.calcOwnMatrix();return'transform="'+fabric.util.matrixToSVG(e)+(a||"")+'" '},_setSVGBg:function(s){if(this.backgroundColor){var a=fabric.Object.NUM_FRACTION_DIGITS;s.push("\t\t<rect ",this._getFillAttributes(this.backgroundColor),' x="',t(-this.width/2,a),'" y="',t(-this.height/2,a),'" width="',t(this.width,a),'" height="',t(this.height,a),'"></rect>\n')}},toSVG:function(s){return this._createBaseSVGMarkup(this._toSVG(s),{reviver:s})},toClipPathSVG:function(s){return"\t"+this._createBaseClipPathSVGMarkup(this._toSVG(s),{reviver:s})},_createBaseClipPathSVGMarkup:function(s,a){var e=(a=a||{}).reviver,i=[this.getSvgTransform(!0,a.additionalTransform||""),this.getSvgCommons()].join(""),o=s.indexOf("COMMON_PARTS");return s[o]=i,e?e(s.join("")):s.join("")},_createBaseSVGMarkup:function(s,a){var v,T,e=(a=a||{}).noStyle,r=a.reviver,i=e?"":'style="'+this.getSvgStyles()+'" ',o=a.withShadow?'style="'+this.getSvgFilter()+'" ':"",h=this.clipPath,l=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",c=h&&h.absolutePositioned,u=this.stroke,d=this.fill,g=this.shadow,w=[],E=s.indexOf("COMMON_PARTS"),I=a.additionalTransform;return h&&(h.clipPathId="CLIPPATH_"+fabric.Object.__uid++,T='<clipPath id="'+h.clipPathId+'" >\n'+h.toClipPathSVG(r)+"</clipPath>\n"),c&&w.push("<g ",o,this.getSvgCommons()," >\n"),w.push("<g ",this.getSvgTransform(!1),c?"":o+this.getSvgCommons()," >\n"),v=[i,l,e?"":this.addPaintOrder()," ",I?'transform="'+I+'" ':""].join(""),s[E]=v,d&&d.toLive&&w.push(d.toSVG(this)),u&&u.toLive&&w.push(u.toSVG(this)),g&&w.push(g.toSVG(this)),h&&w.push(T),w.push(s.join("")),w.push("</g>\n"),c&&w.push("</g>\n"),r?r(w.join("")):w.join("")},addPaintOrder:function(){return"fill"!==this.paintFirst?' paint-order="'+this.paintFirst+'" ':""}})}(),function(){var n=fabric.util.object.extend,t="stateProperties";function s(e,r,i){var o={};i.forEach(function(l){o[l]=e[l]}),n(e[r],o,!0)}function a(e,r,i){if(e===r)return!0;if(Array.isArray(e)){if(!Array.isArray(r)||e.length!==r.length)return!1;for(var o=0,h=e.length;o<h;o++)if(!a(e[o],r[o]))return!1;return!0}if(e&&"object"==typeof e){var c,l=Object.keys(e);if(!r||"object"!=typeof r||!i&&l.length!==Object.keys(r).length)return!1;for(o=0,h=l.length;o<h;o++)if("canvas"!==(c=l[o])&&"group"!==c&&!a(e[c],r[c]))return!1;return!0}}fabric.util.object.extend(fabric.Object.prototype,{hasStateChanged:function(e){var r="_"+(e=e||t);return Object.keys(this[r]).length<this[e].length||!a(this[r],this,!0)},saveState:function(e){var r=e&&e.propertySet||t,i="_"+r;return this[i]?(s(this,i,this[r]),e&&e.stateProperties&&s(this,i,e.stateProperties),this):this.setupState(e)},setupState:function(e){var r=(e=e||{}).propertySet||t;return e.propertySet=r,this["_"+r]={},this.saveState(e),this}})}(),function(){var n=fabric.util.degreesToRadians;fabric.util.object.extend(fabric.Object.prototype,{_findTargetCorner:function(t,s){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var r,i,l,a=t.x,e=t.y,o=Object.keys(this.oCoords),h=o.length-1;for(this.__corner=0;h>=0;h--)if(this.isControlVisible(l=o[h])&&(i=this._getImageLines(s?this.oCoords[l].touchCorner:this.oCoords[l].corner),0!==(r=this._findCrossPoints({x:a,y:e},i))&&r%2==1))return this.__corner=l,l;return!1},forEachControl:function(t){for(var s in this.controls)t(this.controls[s],s,this)},_setCornerCoords:function(){var t=this.oCoords;for(var s in t){var a=this.controls[s];t[s].corner=a.calcCornerCoords(this.angle,this.cornerSize,t[s].x,t[s].y,!1),t[s].touchCorner=a.calcCornerCoords(this.angle,this.touchCornerSize,t[s].x,t[s].y,!0)}},drawSelectionBackground:function(t){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;t.save();var s=this.getCenterPoint(),a=this._calculateCurrentDimensions(),e=this.canvas.viewportTransform;return t.translate(s.x,s.y),t.scale(1/e[0],1/e[3]),t.rotate(n(this.angle)),t.fillStyle=this.selectionBackgroundColor,t.fillRect(-a.x/2,-a.y/2,a.x,a.y),t.restore(),this},drawBorders:function(t,s){s=s||{};var a=this._calculateCurrentDimensions(),e=this.borderScaleFactor,r=a.x+e,i=a.y+e,o=void 0!==s.hasControls?s.hasControls:this.hasControls,h=!1;return t.save(),t.strokeStyle=s.borderColor||this.borderColor,this._setLineDash(t,s.borderDashArray||this.borderDashArray),t.strokeRect(-r/2,-i/2,r,i),o&&(t.beginPath(),this.forEachControl(function(l,c,u){l.withConnection&&l.getVisibility(u,c)&&(h=!0,t.moveTo(l.x*r,l.y*i),t.lineTo(l.x*r+l.offsetX,l.y*i+l.offsetY))}),h&&t.stroke()),t.restore(),this},drawBordersInGroup:function(t,s,a){a=a||{};var e=fabric.util.sizeAfterTransform(this.width,this.height,s),r=this.strokeWidth,i=this.strokeUniform,o=this.borderScaleFactor,h=e.x+r*(i?this.canvas.getZoom():s.scaleX)+o,l=e.y+r*(i?this.canvas.getZoom():s.scaleY)+o;return t.save(),this._setLineDash(t,a.borderDashArray||this.borderDashArray),t.strokeStyle=a.borderColor||this.borderColor,t.strokeRect(-h/2,-l/2,h,l),t.restore(),this},drawControls:function(t,s){s=s||{},t.save();var e,r,a=this.canvas.getRetinaScaling();return t.setTransform(a,0,0,a,0,0),t.strokeStyle=t.fillStyle=s.cornerColor||this.cornerColor,this.transparentCorners||(t.strokeStyle=s.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(t,s.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(e=this.group.calcTransformMatrix()),this.forEachControl(function(i,o,h){r=h.oCoords[o],i.getVisibility(h,o)&&(e&&(r=fabric.util.transformPoint(r,e)),i.render(t,r.x,r.y,s,h))}),t.restore(),this},isControlVisible:function(t){return this.controls[t]&&this.controls[t].getVisibility(this,t)},setControlVisible:function(t,s){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[t]=s,this},setControlsVisibility:function(t){for(var s in t||(t={}),t)this.setControlVisible(s,t[s]);return this},onDeselect:function(){},onSelect:function(){}})}(),fabric.util.object.extend(fabric.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(n,t){var s=function(){},a=(t=t||{}).onComplete||s,e=t.onChange||s,r=this;return fabric.util.animate({target:this,startValue:n.left,endValue:this.getCenter().left,duration:this.FX_DURATION,onChange:function(i){n.set("left",i),r.requestRenderAll(),e()},onComplete:function(){n.setCoords(),a()}})},fxCenterObjectV:function(n,t){var s=function(){},a=(t=t||{}).onComplete||s,e=t.onChange||s,r=this;return fabric.util.animate({target:this,startValue:n.top,endValue:this.getCenter().top,duration:this.FX_DURATION,onChange:function(i){n.set("top",i),r.requestRenderAll(),e()},onComplete:function(){n.setCoords(),a()}})},fxRemove:function(n,t){var s=function(){},a=(t=t||{}).onComplete||s,e=t.onChange||s,r=this;return fabric.util.animate({target:this,startValue:n.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(i){n.set("opacity",i),r.requestRenderAll(),e()},onComplete:function(){r.remove(n),a()}})}}),fabric.util.object.extend(fabric.Object.prototype,{animate:function(){if(arguments[0]&&"object"==typeof arguments[0]){var t,n=[],a=[];for(t in arguments[0])n.push(t);for(var e=0,r=n.length;e<r;e++)a.push(this._animate(t=n[e],arguments[0][t],arguments[1],e!==r-1));return a}return this._animate.apply(this,arguments)},_animate:function(n,t,s,a){var r,e=this;t=t.toString(),s=s?fabric.util.object.clone(s):{},~n.indexOf(".")&&(r=n.split("."));var i=e.colorProperties.indexOf(n)>-1||r&&e.colorProperties.indexOf(r[1])>-1,o=r?this.get(r[0])[r[1]]:this.get(n);"from"in s||(s.from=o),i||(t=~t.indexOf("=")?o+parseFloat(t.replace("=","")):parseFloat(t));var h={target:this,startValue:s.from,endValue:t,byValue:s.by,easing:s.easing,duration:s.duration,abort:s.abort&&function(l,c,u){return s.abort.call(e,l,c,u)},onChange:function(l,c,u){r?e[r[0]][r[1]]=l:e.set(n,l),!a&&s.onChange&&s.onChange(l,c,u)},onComplete:function(l,c,u){a||(e.setCoords(),s.onComplete&&s.onComplete(l,c,u))}};return i?fabric.util.animateColor(h.startValue,h.endValue,h.duration,h):fabric.util.animate(h)}}),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.object.extend,a=t.util.object.clone,e={x1:1,x2:1,y1:1,y2:1};function r(i,o){var h=i.origin,l=i.axis1,c=i.axis2,u=i.dimension,d=o.nearest,g=o.center,v=o.farthest;return function(){switch(this.get(h)){case d:return Math.min(this.get(l),this.get(c));case g:return Math.min(this.get(l),this.get(c))+.5*this.get(u);case v:return Math.max(this.get(l),this.get(c))}}}t.Line?t.warn("fabric.Line is already defined"):(t.Line=t.util.createClass(t.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:t.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(i,o){i||(i=[0,0,0,0]),this.callSuper("initialize",o),this.set("x1",i[0]),this.set("y1",i[1]),this.set("x2",i[2]),this.set("y2",i[3]),this._setWidthHeight(o)},_setWidthHeight:function(i){i||(i={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in i?i.left:this._getLeftToOriginX(),this.top="top"in i?i.top:this._getTopToOriginY()},_set:function(i,o){return this.callSuper("_set",i,o),void 0!==e[i]&&this._setWidthHeight(),this},_getLeftToOriginX:r({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:r({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(i){i.beginPath();var o=this.calcLinePoints();i.moveTo(o.x1,o.y1),i.lineTo(o.x2,o.y2),i.lineWidth=this.strokeWidth;var h=i.strokeStyle;i.strokeStyle=this.stroke||i.fillStyle,this.stroke&&this._renderStroke(i),i.strokeStyle=h},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(i){return s(this.callSuper("toObject",i),this.calcLinePoints())},_getNonTransformedDimensions:function(){var i=this.callSuper("_getNonTransformedDimensions");return"butt"===this.strokeLineCap&&(0===this.width&&(i.y-=this.strokeWidth),0===this.height&&(i.x-=this.strokeWidth)),i},calcLinePoints:function(){var i=this.x1<=this.x2?-1:1,o=this.y1<=this.y2?-1:1;return{x1:i*this.width*.5,x2:i*this.width*-.5,y1:o*this.height*.5,y2:o*this.height*-.5}},_toSVG:function(){var i=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',i.x1,'" y1="',i.y1,'" x2="',i.x2,'" y2="',i.y2,'" />\n']}}),t.Line.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),t.Line.fromElement=function(i,o,h){h=h||{};var l=t.parseAttributes(i,t.Line.ATTRIBUTE_NAMES);o(new t.Line([l.x1||0,l.y1||0,l.x2||0,l.y2||0],s(l,h)))},t.Line.fromObject=function(i,o){var l=a(i,!0);l.points=[i.x1,i.y1,i.x2,i.y2],t.Object._fromObject("Line",l,function h(c){delete c.points,o&&o(c)},"points")})}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.degreesToRadians;t.Circle?t.warn("fabric.Circle is already defined."):(t.Circle=t.util.createClass(t.Object,{type:"circle",radius:0,startAngle:0,endAngle:360,cacheProperties:t.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(e,r){return this.callSuper("_set",e,r),"radius"===e&&this.setRadius(r),this},toObject:function(e){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(e))},_toSVG:function(){var e,o=(this.endAngle-this.startAngle)%360;if(0===o)e=["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',this.radius,'" />\n'];else{var h=s(this.startAngle),l=s(this.endAngle),c=this.radius;e=['<path d="M '+t.util.cos(h)*c+" "+t.util.sin(h)*c," A "+c+" "+c," 0 ",+(o>180?"1":"0")+" 1"," "+t.util.cos(l)*c+" "+t.util.sin(l)*c,'" ',"COMMON_PARTS"," />\n"]}return e},_render:function(e){e.beginPath(),e.arc(0,0,this.radius,s(this.startAngle),s(this.endAngle),!1),this._renderPaintInOrder(e)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(e){return this.radius=e,this.set("width",2*e).set("height",2*e)}}),t.Circle.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),t.Circle.fromElement=function(e,r){var i=t.parseAttributes(e,t.Circle.ATTRIBUTE_NAMES);if(!function a(e){return"radius"in e&&e.radius>=0}(i))throw new Error("value of `r` attribute is required and can not be negative");i.left=(i.left||0)-i.radius,i.top=(i.top||0)-i.radius,r(new t.Circle(i))},t.Circle.fromObject=function(e,r){t.Object._fromObject("Circle",e,r)})}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={});t.Triangle?t.warn("fabric.Triangle is already defined"):(t.Triangle=t.util.createClass(t.Object,{type:"triangle",width:100,height:100,_render:function(s){var a=this.width/2,e=this.height/2;s.beginPath(),s.moveTo(-a,e),s.lineTo(0,-e),s.lineTo(a,e),s.closePath(),this._renderPaintInOrder(s)},_toSVG:function(){var s=this.width/2,a=this.height/2;return["<polygon ","COMMON_PARTS",'points="',[-s+" "+a,"0 "+-a,s+" "+a].join(","),'" />']}}),t.Triangle.fromObject=function(s,a){return t.Object._fromObject("Triangle",s,a)})}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=2*Math.PI;t.Ellipse?t.warn("fabric.Ellipse is already defined."):(t.Ellipse=t.util.createClass(t.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:t.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(a){this.callSuper("initialize",a),this.set("rx",a&&a.rx||0),this.set("ry",a&&a.ry||0)},_set:function(a,e){switch(this.callSuper("_set",a,e),a){case"rx":this.rx=e,this.set("width",2*e);break;case"ry":this.ry=e,this.set("height",2*e)}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(a){return this.callSuper("toObject",["rx","ry"].concat(a))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,'" />\n']},_render:function(a){a.beginPath(),a.save(),a.transform(1,0,0,this.ry/this.rx,0,0),a.arc(0,0,this.rx,0,s,!1),a.restore(),this._renderPaintInOrder(a)}}),t.Ellipse.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),t.Ellipse.fromElement=function(a,e){var r=t.parseAttributes(a,t.Ellipse.ATTRIBUTE_NAMES);r.left=(r.left||0)-r.rx,r.top=(r.top||0)-r.ry,e(new t.Ellipse(r))},t.Ellipse.fromObject=function(a,e){t.Object._fromObject("Ellipse",a,e)})}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.object.extend;t.Rect?t.warn("fabric.Rect is already defined"):(t.Rect=t.util.createClass(t.Object,{stateProperties:t.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:t.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(a){this.callSuper("initialize",a),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(a){var e=this.rx?Math.min(this.rx,this.width/2):0,r=this.ry?Math.min(this.ry,this.height/2):0,i=this.width,o=this.height,h=-this.width/2,l=-this.height/2,c=0!==e||0!==r,u=.4477152502;a.beginPath(),a.moveTo(h+e,l),a.lineTo(h+i-e,l),c&&a.bezierCurveTo(h+i-u*e,l,h+i,l+u*r,h+i,l+r),a.lineTo(h+i,l+o-r),c&&a.bezierCurveTo(h+i,l+o-u*r,h+i-u*e,l+o,h+i-e,l+o),a.lineTo(h+e,l+o),c&&a.bezierCurveTo(h+u*e,l+o,h,l+o-u*r,h,l+o-r),a.lineTo(h,l+r),c&&a.bezierCurveTo(h,l+u*r,h+u*e,l,h+e,l),a.closePath(),this._renderPaintInOrder(a)},toObject:function(a){return this.callSuper("toObject",["rx","ry"].concat(a))},_toSVG:function(){return["<rect ","COMMON_PARTS",'x="',-this.width/2,'" y="',-this.height/2,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,'" />\n']}}),t.Rect.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),t.Rect.fromElement=function(a,e,r){if(!a)return e(null);r=r||{};var i=t.parseAttributes(a,t.Rect.ATTRIBUTE_NAMES);i.left=i.left||0,i.top=i.top||0,i.height=i.height||0,i.width=i.width||0;var o=new t.Rect(s(r?t.util.object.clone(r):{},i));o.visible=o.visible&&o.width>0&&o.height>0,e(o)},t.Rect.fromObject=function(a,e){return t.Object._fromObject("Rect",a,e)})}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.object.extend,a=t.util.array.min,e=t.util.array.max,r=t.util.toFixed,i=t.util.projectStrokeOnPoints;t.Polyline?t.warn("fabric.Polyline is already defined"):(t.Polyline=t.util.createClass(t.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:t.Object.prototype.cacheProperties.concat("points"),initialize:function(o,h){h=h||{},this.points=o||[],this.callSuper("initialize",h),this._setPositionDimensions(h)},_projectStrokeOnPoints:function(){return i(this.points,this,!0)},_setPositionDimensions:function(o){var l,h=this._calcDimensions(o),c=this.exactBoundingBox?this.strokeWidth:0;this.width=h.width-c,this.height=h.height-c,o.fromSVG||(l=this.translateToGivenOrigin({x:h.left-this.strokeWidth/2+c/2,y:h.top-this.strokeWidth/2+c/2},"left","top",this.originX,this.originY)),void 0===o.left&&(this.left=o.fromSVG?h.left:l.x),void 0===o.top&&(this.top=o.fromSVG?h.top:l.y),this.pathOffset={x:h.left+this.width/2+c/2,y:h.top+this.height/2+c/2}},_calcDimensions:function(){var o=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,h=a(o,"x")||0,l=a(o,"y")||0;return{left:h,top:l,width:(e(o,"x")||0)-h,height:(e(o,"y")||0)-l}},toObject:function(o){return s(this.callSuper("toObject",o),{points:this.points.concat()})},_toSVG:function(){for(var o=[],h=this.pathOffset.x,l=this.pathOffset.y,c=t.Object.NUM_FRACTION_DIGITS,u=0,d=this.points.length;u<d;u++)o.push(r(this.points[u].x-h,c),",",r(this.points[u].y-l,c)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',o.join(""),'" />\n']},commonRender:function(o){var h,l=this.points.length,c=this.pathOffset.x,u=this.pathOffset.y;if(!l||isNaN(this.points[l-1].y))return!1;o.beginPath(),o.moveTo(this.points[0].x-c,this.points[0].y-u);for(var d=0;d<l;d++)o.lineTo((h=this.points[d]).x-c,h.y-u);return!0},_render:function(o){!this.commonRender(o)||this._renderPaintInOrder(o)},complexity:function(){return this.get("points").length}}),t.Polyline.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat(),t.Polyline.fromElementGenerator=function(o){return function(h,l,c){if(!h)return l(null);c||(c={});var u=t.parsePointsAttribute(h.getAttribute("points")),d=t.parseAttributes(h,t[o].ATTRIBUTE_NAMES);d.fromSVG=!0,l(new t[o](u,s(d,c)))}},t.Polyline.fromElement=t.Polyline.fromElementGenerator("Polyline"),t.Polyline.fromObject=function(o,h){return t.Object._fromObject("Polyline",o,h,"points")})}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.projectStrokeOnPoints;t.Polygon?t.warn("fabric.Polygon is already defined"):(t.Polygon=t.util.createClass(t.Polyline,{type:"polygon",_projectStrokeOnPoints:function(){return s(this.points,this)},_render:function(a){!this.commonRender(a)||(a.closePath(),this._renderPaintInOrder(a))}}),t.Polygon.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat(),t.Polygon.fromElement=t.Polyline.fromElementGenerator("Polygon"),t.Polygon.fromObject=function(a,e){t.Object._fromObject("Polygon",a,e,"points")})}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.array.min,a=t.util.array.max,e=t.util.object.extend,r=t.util.object.clone,i=Object.prototype.toString,o=t.util.toFixed;t.Path?t.warn("fabric.Path is already defined"):(t.Path=t.util.createClass(t.Object,{type:"path",path:null,cacheProperties:t.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:t.Object.prototype.stateProperties.concat("path"),initialize:function(h,l){delete(l=r(l||{})).path,this.callSuper("initialize",l),this._setPath(h||[],l)},_setPath:function(h,l){var c="[object Array]"===i.call(h);this.path=t.util.makePathSimpler(c?h:t.util.parsePath(h)),t.Polyline.prototype._setPositionDimensions.call(this,l||{})},_renderPathCommands:function(h){var l,c=0,u=0,d=0,g=0,T=-this.pathOffset.x,E=-this.pathOffset.y;h.beginPath();for(var I=0,H=this.path.length;I<H;++I)switch(l=this.path[I],l[0]){case"L":h.lineTo((d=l[1])+T,(g=l[2])+E);break;case"M":c=d=l[1],u=g=l[2],h.moveTo(d+T,g+E);break;case"C":h.bezierCurveTo(l[1]+T,l[2]+E,l[3]+T,l[4]+E,(d=l[5])+T,(g=l[6])+E);break;case"Q":h.quadraticCurveTo(l[1]+T,l[2]+E,l[3]+T,l[4]+E),d=l[3],g=l[4];break;case"z":case"Z":d=c,g=u,h.closePath()}},_render:function(h){this._renderPathCommands(h),this._renderPaintInOrder(h)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(h){return e(this.callSuper("toObject",h),{path:this.path.map(function(l){return l.slice()})})},toDatalessObject:function(h){var l=this.toObject(["sourcePath"].concat(h));return l.sourcePath&&delete l.path,l},_toSVG:function(){return["<path ","COMMON_PARTS",'d="',t.util.joinPath(this.path),'" stroke-linecap="round" ',"/>\n"]},_getOffsetTransform:function(){var h=t.Object.NUM_FRACTION_DIGITS;return" translate("+o(-this.pathOffset.x,h)+", "+o(-this.pathOffset.y,h)+")"},toClipPathSVG:function(h){var l=this._getOffsetTransform();return"\t"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:h,additionalTransform:l})},toSVG:function(h){var l=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:h,additionalTransform:l})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var c,w,h=[],l=[],u=0,d=0,g=0,v=0,T=0,E=this.path.length;T<E;++T){switch((c=this.path[T])[0]){case"L":g=c[1],v=c[2],w=[];break;case"M":u=g=c[1],d=v=c[2],w=[];break;case"C":w=t.util.getBoundsOfCurve(g,v,c[1],c[2],c[3],c[4],c[5],c[6]),g=c[5],v=c[6];break;case"Q":w=t.util.getBoundsOfCurve(g,v,c[1],c[2],c[1],c[2],c[3],c[4]),g=c[3],v=c[4];break;case"z":case"Z":g=u,v=d}w.forEach(function(Y){h.push(Y.x),l.push(Y.y)}),h.push(g),l.push(v)}var I=s(h)||0,H=s(l)||0;return{left:I,top:H,width:(a(h)||0)-I,height:(a(l)||0)-H}}}),t.Path.fromObject=function(h,l){"string"==typeof h.sourcePath?t.loadSVGFromURL(h.sourcePath,function(u){var d=u[0];d.setOptions(h),l&&l(d)}):t.Object._fromObject("Path",h,l,"path")},t.Path.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat(["d"]),t.Path.fromElement=function(h,l,c){var u=t.parseAttributes(h,t.Path.ATTRIBUTE_NAMES);u.fromSVG=!0,l(new t.Path(u.d,e(u,c)))})}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.array.min,a=t.util.array.max;t.Group||(t.Group=t.util.createClass(t.Object,t.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(e,r,i){r=r||{},this._objects=[],i&&this.callSuper("initialize",r),this._objects=e||[];for(var o=this._objects.length;o--;)this._objects[o].group=this;if(i)this._updateObjectsACoords();else{var h=r&&r.centerPoint;void 0!==r.originX&&(this.originX=r.originX),void 0!==r.originY&&(this.originY=r.originY),h||this._calcBounds(),this._updateObjectsCoords(h),delete r.centerPoint,this.callSuper("initialize",r)}this.setCoords()},_updateObjectsACoords:function(){for(var r=this._objects.length;r--;)this._objects[r].setCoords(!0)},_updateObjectsCoords:function(r){r=r||this.getCenterPoint();for(var i=this._objects.length;i--;)this._updateObjectCoords(this._objects[i],r)},_updateObjectCoords:function(e,r){e.set({left:e.left-r.x,top:e.top-r.y}),e.group=this,e.setCoords(!0)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(e){var r=!!this.group;return this._restoreObjectsState(),t.util.resetObjectTransform(this),e&&(r&&t.util.removeTransformFromObject(e,this.group.calcTransformMatrix()),this._objects.push(e),e.group=this,e._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,r?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(e){return this._restoreObjectsState(),t.util.resetObjectTransform(this),this.remove(e),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(e){this.dirty=!0,e.group=this,e._set("canvas",this.canvas)},_onObjectRemoved:function(e){this.dirty=!0,delete e.group},_set:function(e,r){var i=this._objects.length;if(this.useSetOnGroup)for(;i--;)this._objects[i].setOnGroup(e,r);if("canvas"===e)for(;i--;)this._objects[i]._set(e,r);t.Object.prototype._set.call(this,e,r)},toObject:function(e){var r=this.includeDefaultValues,i=this._objects.filter(function(h){return!h.excludeFromExport}).map(function(h){var l=h.includeDefaultValues;h.includeDefaultValues=r;var c=h.toObject(e);return h.includeDefaultValues=l,c}),o=t.Object.prototype.toObject.call(this,e);return o.objects=i,o},toDatalessObject:function(e){var r,i=this.sourcePath;if(i)r=i;else{var o=this.includeDefaultValues;r=this._objects.map(function(l){var c=l.includeDefaultValues;l.includeDefaultValues=o;var u=l.toDatalessObject(e);return l.includeDefaultValues=c,u})}var h=t.Object.prototype.toDatalessObject.call(this,e);return h.objects=r,h},render:function(e){this._transformDone=!0,this.callSuper("render",e),this._transformDone=!1},shouldCache:function(){var e=t.Object.prototype.shouldCache.call(this);if(e)for(var r=0,i=this._objects.length;r<i;r++)if(this._objects[r].willDrawShadow())return this.ownCaching=!1,!1;return e},willDrawShadow:function(){if(t.Object.prototype.willDrawShadow.call(this))return!0;for(var e=0,r=this._objects.length;e<r;e++)if(this._objects[e].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(e){for(var r=0,i=this._objects.length;r<i;r++)this._objects[r].render(e);this._drawClipPath(e,this.clipPath)},isCacheDirty:function(e){if(this.callSuper("isCacheDirty",e))return!0;if(!this.statefullCache)return!1;for(var r=0,i=this._objects.length;r<i;r++)if(this._objects[r].isCacheDirty(!0)){if(this._cacheCanvas){var o=this.cacheWidth/this.zoomX,h=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-o/2,-h/2,o,h)}return!0}return!1},_restoreObjectsState:function(){var e=this.calcOwnMatrix();return this._objects.forEach(function(r){t.util.addTransformToObject(r,e),delete r.group,r.setCoords()}),this},destroy:function(){return this._objects.forEach(function(e){e.set("dirty",!0)}),this._restoreObjectsState()},dispose:function(){this.callSuper("dispose"),this.forEachObject(function(e){e.dispose&&e.dispose()}),this._objects=[]},toActiveSelection:function(){if(this.canvas){var e=this._objects,r=this.canvas;this._objects=[];var i=this.toObject();delete i.objects;var o=new t.ActiveSelection([]);return o.set(i),o.type="activeSelection",r.remove(this),e.forEach(function(h){h.group=o,h.dirty=!0,r.add(h)}),o.canvas=r,o._objects=e,r._activeObject=o,o.setCoords(),o}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){return this.forEachObject(function(r){r.setCoords(!0)}),this},_calcBounds:function(e){for(var o,h,l,g,r=[],i=[],c=["tr","br","bl","tl"],u=0,d=this._objects.length,v=c.length;u<d;++u){for(l=(o=this._objects[u]).calcACoords(),g=0;g<v;g++)r.push(l[h=c[g]].x),i.push(l[h].y);o.aCoords=l}this._getBounds(r,i,e)},_getBounds:function(e,r,i){var o=new t.Point(s(e),s(r)),h=new t.Point(a(e),a(r)),l=o.y||0,c=o.x||0,d=h.y-o.y||0;this.width=h.x-o.x||0,this.height=d,i||this.setPositionByOrigin({x:c,y:l},"left","top")},_toSVG:function(e){for(var r=["<g ","COMMON_PARTS"," >\n"],i=0,o=this._objects.length;i<o;i++)r.push("\t\t",this._objects[i].toSVG(e));return r.push("</g>\n"),r},getSvgStyles:function(){var r=this.visible?"":" visibility: hidden;";return[void 0!==this.opacity&&1!==this.opacity?"opacity: "+this.opacity+";":"",this.getSvgFilter(),r].join("")},toClipPathSVG:function(e){for(var r=[],i=0,o=this._objects.length;i<o;i++)r.push("\t",this._objects[i].toClipPathSVG(e));return this._createBaseClipPathSVGMarkup(r,{reviver:e})}}),t.Group.fromObject=function(e,r){var i=e.objects,o=t.util.object.clone(e,!0);delete o.objects,"string"!=typeof i?t.util.enlivenObjects(i,function(h){var l=t.util.object.clone(e,!0);delete l.objects,t.util.enlivenObjectEnlivables(e,l,function(){r&&r(new t.Group(h,l,!0))})}):t.loadSVGFromURL(i,function(h){var l=t.util.groupSVGElements(h,e,i);l.set(o),r&&r(l)})})}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={});t.ActiveSelection||(t.ActiveSelection=t.util.createClass(t.Group,{type:"activeSelection",initialize:function(s,a){a=a||{},this._objects=s||[];for(var e=this._objects.length;e--;)this._objects[e].group=this;a.originX&&(this.originX=a.originX),a.originY&&(this.originY=a.originY),this._calcBounds(),this._updateObjectsCoords(),t.Object.prototype.initialize.call(this,a),this.setCoords()},toGroup:function(){var s=this._objects.concat();this._objects=[];var a=t.Object.prototype.toObject.call(this),e=new t.Group([]);if(delete a.type,e.set(a),s.forEach(function(i){i.canvas.remove(i),i.group=e}),e._objects=s,!this.canvas)return e;var r=this.canvas;return r.add(e),r._activeObject=e,e.setCoords(),e},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(s,a,e){s.save(),s.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",s,a),void 0===(e=e||{}).hasControls&&(e.hasControls=!1),e.forActiveSelection=!0;for(var r=0,i=this._objects.length;r<i;r++)this._objects[r]._renderControls(s,e);s.restore()}}),t.ActiveSelection.fromObject=function(s,a){t.util.enlivenObjects(s.objects,function(e){delete s.objects,a&&a(new t.ActiveSelection(e,s,!0))})})}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=fabric.util.object.extend;n.fabric||(n.fabric={}),n.fabric.Image?fabric.warn("fabric.Image is already defined."):(fabric.Image=fabric.util.createClass(fabric.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:fabric.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:fabric.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(s,a){a||(a={}),this.filters=[],this.cacheKey="texture"+fabric.Object.__uid++,this.callSuper("initialize",a),this._initElement(s,a)},getElement:function(){return this._element||{}},setElement:function(s,a){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=s,this._originalElement=s,this._initConfig(a),0!==this.filters.length&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(s){var a=fabric.filterBackend;a&&a.evictCachesForKey&&a.evictCachesForKey(s)},dispose:function(){this.callSuper("dispose"),this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach(function(s){fabric.util.cleanUpJsdomNode(this[s]),this[s]=void 0}.bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var s=this.getElement();return{width:s.naturalWidth||s.width,height:s.naturalHeight||s.height}},_stroke:function(s){if(this.stroke&&0!==this.strokeWidth){var a=this.width/2,e=this.height/2;s.beginPath(),s.moveTo(-a,-e),s.lineTo(a,-e),s.lineTo(a,e),s.lineTo(-a,e),s.lineTo(-a,-e),s.closePath()}},toObject:function(s){var a=[];this.filters.forEach(function(r){r&&a.push(r.toObject())});var e=t(this.callSuper("toObject",["cropX","cropY"].concat(s)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:a});return this.resizeFilter&&(e.resizeFilter=this.resizeFilter.toObject()),e},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var e,s=[],a=[],r=this._element,i=-this.width/2,o=-this.height/2,h="",l="";if(!r)return[];if(this.hasCrop()){var c=fabric.Object.__uid++;s.push('<clipPath id="imageCrop_'+c+'">\n','\t<rect x="'+i+'" y="'+o+'" width="'+this.width+'" height="'+this.height+'" />\n',"</clipPath>\n"),h=' clip-path="url(#imageCrop_'+c+')" '}if(this.imageSmoothing||(l='" image-rendering="optimizeSpeed'),a.push("\t<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',i-this.cropX,'" y="',o-this.cropY,'" width="',r.width||r.naturalWidth,'" height="',r.height||r.height,l,'"',h,"></image>\n"),this.stroke||this.strokeDashArray){var u=this.fill;this.fill=null,e=["\t<rect ",'x="',i,'" y="',o,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),'"/>\n'],this.fill=u}return"fill"!==this.paintFirst?s.concat(e,a):s.concat(a,e)},getSrc:function(s){var a=s?this._element:this._originalElement;return a?a.toDataURL?a.toDataURL():this.srcFromAttribute?a.getAttribute("src"):a.src:this.src||""},setSrc:function(s,a,e){return fabric.util.loadImage(s,function(r,i){this.setElement(r,e),this._setWidthHeight(),a&&a(this,i)},this,e&&e.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var s=this.resizeFilter,a=this.minimumScaleTrigger,e=this.getTotalObjectScaling(),r=e.scaleX,i=e.scaleY,o=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!s||r>a&&i>a)return this._element=o,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=r,void(this._lastScaleY=i);fabric.filterBackend||(fabric.filterBackend=fabric.initFilterBackend());var h=fabric.util.createCanvasElement(),l=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,c=o.width,u=o.height;h.width=c,h.height=u,this._element=h,this._lastScaleX=s.scaleX=r,this._lastScaleY=s.scaleY=i,fabric.filterBackend.applyFilters([s],o,c,u,this._element,l),this._filterScalingX=h.width/this._originalElement.width,this._filterScalingY=h.height/this._originalElement.height},applyFilters:function(s){if(s=(s=s||this.filters||[]).filter(function(o){return o&&!o.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),0===s.length)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var a=this._originalElement,e=a.naturalWidth||a.width,r=a.naturalHeight||a.height;if(this._element===this._originalElement){var i=fabric.util.createCanvasElement();i.width=e,i.height=r,this._element=i,this._filteredEl=i}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,e,r),this._lastScaleX=1,this._lastScaleY=1;return fabric.filterBackend||(fabric.filterBackend=fabric.initFilterBackend()),fabric.filterBackend.applyFilters(s,this._originalElement,e,r,this._element,this.cacheKey),(this._originalElement.width!==this._element.width||this._originalElement.height!==this._element.height)&&(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(s){fabric.util.setImageSmoothing(s,this.imageSmoothing),!0!==this.isMoving&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(s),this._renderPaintInOrder(s)},drawCacheOnCanvas:function(s){fabric.util.setImageSmoothing(s,this.imageSmoothing),fabric.Object.prototype.drawCacheOnCanvas.call(this,s)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(s){var a=this._element;if(a){var e=this._filterScalingX,r=this._filterScalingY,i=this.width,o=this.height,h=Math.min,l=Math.max,c=l(this.cropX,0),u=l(this.cropY,0),d=a.naturalWidth||a.width,g=a.naturalHeight||a.height,v=c*e,w=u*r,T=h(i*e,d-v),E=h(o*r,g-w),I=-i/2,H=-o/2,j=h(i,d/e-c),V=h(o,g/r-u);a&&s.drawImage(a,v,w,T,E,I,H,j,V)}},_needsResize:function(){var s=this.getTotalObjectScaling();return s.scaleX!==this._lastScaleX||s.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(s,a){this.setElement(fabric.util.getById(s),a),fabric.util.addClass(this.getElement(),fabric.Image.CSS_CANVAS)},_initConfig:function(s){s||(s={}),this.setOptions(s),this._setWidthHeight(s)},_initFilters:function(s,a){s&&s.length?fabric.util.enlivenObjects(s,function(e){a&&a(e)},"fabric.Image.filters"):a&&a()},_setWidthHeight:function(s){s||(s={});var a=this.getElement();this.width=s.width||a.naturalWidth||a.width||0,this.height=s.height||a.naturalHeight||a.height||0},parsePreserveAspectRatioAttribute:function(){var u,s=fabric.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),a=this._element.width,e=this._element.height,r=1,i=1,o=0,h=0,l=0,c=0,d=this.width,g=this.height,v={width:d,height:g};return!s||"none"===s.alignX&&"none"===s.alignY?(r=d/a,i=g/e):("meet"===s.meetOrSlice&&(u=(d-a*(r=i=fabric.util.findScaleToFit(this._element,v)))/2,"Min"===s.alignX&&(o=-u),"Max"===s.alignX&&(o=u),u=(g-e*i)/2,"Min"===s.alignY&&(h=-u),"Max"===s.alignY&&(h=u)),"slice"===s.meetOrSlice&&(u=a-d/(r=i=fabric.util.findScaleToCover(this._element,v)),"Mid"===s.alignX&&(l=u/2),"Max"===s.alignX&&(l=u),u=e-g/i,"Mid"===s.alignY&&(c=u/2),"Max"===s.alignY&&(c=u),a=d/r,e=g/i)),{width:a,height:e,scaleX:r,scaleY:i,offsetLeft:o,offsetTop:h,cropX:l,cropY:c}}}),fabric.Image.CSS_CANVAS="canvas-img",fabric.Image.prototype.getSvgSrc=fabric.Image.prototype.getSrc,fabric.Image.fromObject=function(s,a){var e=fabric.util.object.clone(s);fabric.util.loadImage(e.src,function(r,i){i?a&&a(null,!0):fabric.Image.prototype._initFilters.call(e,e.filters,function(o){e.filters=o||[],fabric.Image.prototype._initFilters.call(e,[e.resizeFilter],function(h){e.resizeFilter=h[0],fabric.util.enlivenObjectEnlivables(e,e,function(){var l=new fabric.Image(r,e);a(l,!1)})})})},null,e.crossOrigin)},fabric.Image.fromURL=function(s,a,e){fabric.util.loadImage(s,function(r,i){a&&a(new fabric.Image(r,e),i)},null,e&&e.crossOrigin)},fabric.Image.ATTRIBUTE_NAMES=fabric.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),fabric.Image.fromElement=function(s,a,e){var r=fabric.parseAttributes(s,fabric.Image.ATTRIBUTE_NAMES);fabric.Image.fromURL(r["xlink:href"],a,t(e?fabric.util.object.clone(e):{},r))})}("undefined"!=typeof exports?exports:this),fabric.util.object.extend(fabric.Object.prototype,{_getAngleValueForStraighten:function(){var n=this.angle%360;return n>0?90*Math.round((n-1)/90):90*Math.round(n/90)},straighten:function(){return this.rotate(this._getAngleValueForStraighten())},fxStraighten:function(n){var t=function(){},s=(n=n||{}).onComplete||t,a=n.onChange||t,e=this;return fabric.util.animate({target:this,startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(r){e.rotate(r),a()},onComplete:function(){e.setCoords(),s()}})}}),fabric.util.object.extend(fabric.StaticCanvas.prototype,{straightenObject:function(n){return n.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(n){return n.fxStraighten({onChange:this.requestRenderAllBound})}}),function(){"use strict";function n(s,a){var e="precision "+a+" float;\nvoid main(){}",r=s.createShader(s.FRAGMENT_SHADER);return s.shaderSource(r,e),s.compileShader(r),!!s.getShaderParameter(r,s.COMPILE_STATUS)}function t(s){s&&s.tileSize&&(this.tileSize=s.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}fabric.isWebglSupported=function(s){if(fabric.isLikelyNode)return!1;s=s||fabric.WebglFilterBackend.prototype.tileSize;var a=document.createElement("canvas"),e=a.getContext("webgl")||a.getContext("experimental-webgl"),r=!1;if(e){fabric.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),r=fabric.maxTextureSize>=s;for(var i=["highp","mediump","lowp"],o=0;o<3;o++)if(n(e,i[o])){fabric.webGlPrecision=i[o];break}}return this.isSupported=r,r},fabric.WebglFilterBackend=t,t.prototype={tileSize:2048,resources:{},setupGLContext:function(s,a){this.dispose(),this.createWebGLCanvas(s,a),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(s,a)},chooseFastestCopyGLTo2DMethod:function(s,a){var r,e=void 0!==window.performance;try{new ImageData(1,1),r=!0}catch(v){r=!1}var i="undefined"!=typeof ArrayBuffer,o="undefined"!=typeof Uint8ClampedArray;if(e&&r&&i&&o){var h=fabric.util.createCanvasElement(),l=new ArrayBuffer(s*a*4);if(fabric.forceGLPutImageData)return this.imageBuffer=l,void(this.copyGLTo2D=copyGLTo2DPutImageData);var u,d,c={imageBuffer:l,destinationWidth:s,destinationHeight:a,targetCanvas:h};h.width=s,h.height=a,u=window.performance.now(),copyGLTo2DDrawImage.call(c,this.gl,c),d=window.performance.now()-u,u=window.performance.now(),copyGLTo2DPutImageData.call(c,this.gl,c),d>window.performance.now()-u?(this.imageBuffer=l,this.copyGLTo2D=copyGLTo2DPutImageData):this.copyGLTo2D=copyGLTo2DDrawImage}},createWebGLCanvas:function(s,a){var e=fabric.util.createCanvasElement();e.width=s,e.height=a;var r={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},i=e.getContext("webgl",r);i||(i=e.getContext("experimental-webgl",r)),i&&(i.clearColor(0,0,0,0),this.canvas=e,this.gl=i)},applyFilters:function(s,a,e,r,i,o){var l,h=this.gl;o&&(l=this.getCachedTexture(o,a));var c={originalWidth:a.width||a.originalWidth,originalHeight:a.height||a.originalHeight,sourceWidth:e,sourceHeight:r,destinationWidth:e,destinationHeight:r,context:h,sourceTexture:this.createTexture(h,e,r,!l&&a),targetTexture:this.createTexture(h,e,r),originalTexture:l||this.createTexture(h,e,r,!l&&a),passes:s.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:i},u=h.createFramebuffer();return h.bindFramebuffer(h.FRAMEBUFFER,u),s.forEach(function(d){d&&d.applyTo(c)}),resizeCanvasIfNeeded(c),this.copyGLTo2D(h,c),h.bindTexture(h.TEXTURE_2D,null),h.deleteTexture(c.sourceTexture),h.deleteTexture(c.targetTexture),h.deleteFramebuffer(u),i.getContext("2d").setTransform(1,0,0,1,0,0),c},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(s,a,e,r){var i=s.createTexture();return s.bindTexture(s.TEXTURE_2D,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),r?s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,r):s.texImage2D(s.TEXTURE_2D,0,s.RGBA,a,e,0,s.RGBA,s.UNSIGNED_BYTE,null),i},getCachedTexture:function(s,a){if(this.textureCache[s])return this.textureCache[s];var e=this.createTexture(this.gl,a.width,a.height,a);return this.textureCache[s]=e,e},evictCachesForKey:function(s){this.textureCache[s]&&(this.gl.deleteTexture(this.textureCache[s]),delete this.textureCache[s])},copyGLTo2D:copyGLTo2DDrawImage,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var s=this.gl,a={renderer:"",vendor:""};if(!s)return a;var e=s.getExtension("WEBGL_debug_renderer_info");if(e){var r=s.getParameter(e.UNMASKED_RENDERER_WEBGL),i=s.getParameter(e.UNMASKED_VENDOR_WEBGL);r&&(a.renderer=r.toLowerCase()),i&&(a.vendor=i.toLowerCase())}return this.gpuInfo=a,a}}}(),function(){"use strict";var n=function(){};function t(){}fabric.Canvas2dFilterBackend=t,t.prototype={evictCachesForKey:n,dispose:n,clearWebGLCaches:n,resources:{},applyFilters:function(s,a,e,r,i){var o=i.getContext("2d");o.drawImage(a,0,0,e,r);var c={sourceWidth:e,sourceHeight:r,imageData:o.getImageData(0,0,e,r),originalEl:a,originalImageData:o.getImageData(0,0,e,r),canvasEl:i,ctx:o,filterBackend:this};return s.forEach(function(u){u.applyTo(c)}),(c.imageData.width!==e||c.imageData.height!==r)&&(i.width=c.imageData.width,i.height=c.imageData.height),o.putImageData(c.imageData,0,0),c}}}(),fabric.Image=fabric.Image||{},fabric.Image.filters=fabric.Image.filters||{},fabric.Image.filters.BaseFilter=fabric.util.createClass({type:"BaseFilter",vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvoid main() {\nvTexCoord = aPosition;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D uTexture;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\n}",initialize:function(n){n&&this.setOptions(n)},setOptions:function(n){for(var t in n)this[t]=n[t]},createProgram:function(n,t,s){t=t||this.fragmentSource,s=s||this.vertexSource,"highp"!==fabric.webGlPrecision&&(t=t.replace(/precision highp float/g,"precision "+fabric.webGlPrecision+" float"));var a=n.createShader(n.VERTEX_SHADER);if(n.shaderSource(a,s),n.compileShader(a),!n.getShaderParameter(a,n.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+n.getShaderInfoLog(a));var e=n.createShader(n.FRAGMENT_SHADER);if(n.shaderSource(e,t),n.compileShader(e),!n.getShaderParameter(e,n.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+n.getShaderInfoLog(e));var r=n.createProgram();if(n.attachShader(r,a),n.attachShader(r,e),n.linkProgram(r),!n.getProgramParameter(r,n.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+n.getProgramInfoLog(r));var i=this.getAttributeLocations(n,r),o=this.getUniformLocations(n,r)||{};return o.uStepW=n.getUniformLocation(r,"uStepW"),o.uStepH=n.getUniformLocation(r,"uStepH"),{program:r,attributeLocations:i,uniformLocations:o}},getAttributeLocations:function(n,t){return{aPosition:n.getAttribLocation(t,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(n,t,s){var a=t.aPosition,e=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,e),n.enableVertexAttribArray(a),n.vertexAttribPointer(a,2,n.FLOAT,!1,0,0),n.bufferData(n.ARRAY_BUFFER,s,n.STATIC_DRAW)},_setupFrameBuffer:function(n){var s,a,t=n.context;n.passes>1?(a=n.destinationHeight,(n.sourceWidth!==(s=n.destinationWidth)||n.sourceHeight!==a)&&(t.deleteTexture(n.targetTexture),n.targetTexture=n.filterBackend.createTexture(t,s,a)),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n.targetTexture,0)):(t.bindFramebuffer(t.FRAMEBUFFER,null),t.finish())},_swapTextures:function(n){n.passes--,n.pass++;var t=n.targetTexture;n.targetTexture=n.sourceTexture,n.sourceTexture=t},isNeutralState:function(){var n=this.mainParameter,t=fabric.Image.filters[this.type].prototype;if(n){if(Array.isArray(t[n])){for(var s=t[n].length;s--;)if(this[n][s]!==t[n][s])return!1;return!0}return t[n]===this[n]}return!1},applyTo:function(n){n.webgl?(this._setupFrameBuffer(n),this.applyToWebGL(n),this._swapTextures(n)):this.applyTo2d(n)},retrieveShader:function(n){return n.programCache.hasOwnProperty(this.type)||(n.programCache[this.type]=this.createProgram(n.context)),n.programCache[this.type]},applyToWebGL:function(n){var t=n.context,s=this.retrieveShader(n);t.bindTexture(t.TEXTURE_2D,0===n.pass&&n.originalTexture?n.originalTexture:n.sourceTexture),t.useProgram(s.program),this.sendAttributeData(t,s.attributeLocations,n.aPosition),t.uniform1f(s.uniformLocations.uStepW,1/n.sourceWidth),t.uniform1f(s.uniformLocations.uStepH,1/n.sourceHeight),this.sendUniformData(t,s.uniformLocations),t.viewport(0,0,n.destinationWidth,n.destinationHeight),t.drawArrays(t.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(n,t,s){n.activeTexture(s),n.bindTexture(n.TEXTURE_2D,t),n.activeTexture(n.TEXTURE0)},unbindAdditionalTexture:function(n,t){n.activeTexture(t),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(n){this[this.mainParameter]=n},sendUniformData:function(){},createHelpLayer:function(n){if(!n.helpLayer){var t=document.createElement("canvas");t.width=n.sourceWidth,t.height=n.sourceHeight,n.helpLayer=t}},toObject:function(){var n={type:this.type},t=this.mainParameter;return t&&(n[t]=this[t]),n},toJSON:function(){return this.toObject()}}),fabric.Image.filters.BaseFilter.fromObject=function(n,t){var s=new fabric.Image.filters[n.type](n);return t&&t(s),s},function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.Image.filters;s.ColorMatrix=(0,t.util.createClass)(s.BaseFilter,{type:"ColorMatrix",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nuniform mat4 uColorMatrix;\nuniform vec4 uConstants;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor *= uColorMatrix;\ncolor += uConstants;\ngl_FragColor = color;\n}",matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(e){this.callSuper("initialize",e),this.matrix=this.matrix.slice(0)},applyTo2d:function(e){var l,c,u,d,g,i=e.imageData.data,o=i.length,h=this.matrix,v=this.colorsOnly;for(g=0;g<o;g+=4)l=i[g],c=i[g+1],u=i[g+2],v?(i[g]=l*h[0]+c*h[1]+u*h[2]+255*h[4],i[g+1]=l*h[5]+c*h[6]+u*h[7]+255*h[9],i[g+2]=l*h[10]+c*h[11]+u*h[12]+255*h[14]):(i[g]=l*h[0]+c*h[1]+u*h[2]+(d=i[g+3])*h[3]+255*h[4],i[g+1]=l*h[5]+c*h[6]+u*h[7]+d*h[8]+255*h[9],i[g+2]=l*h[10]+c*h[11]+u*h[12]+d*h[13]+255*h[14],i[g+3]=l*h[15]+c*h[16]+u*h[17]+d*h[18]+255*h[19])},getUniformLocations:function(e,r){return{uColorMatrix:e.getUniformLocation(r,"uColorMatrix"),uConstants:e.getUniformLocation(r,"uConstants")}},sendUniformData:function(e,r){var i=this.matrix,h=[i[4],i[9],i[14],i[19]];e.uniformMatrix4fv(r.uColorMatrix,!1,[i[0],i[1],i[2],i[3],i[5],i[6],i[7],i[8],i[10],i[11],i[12],i[13],i[15],i[16],i[17],i[18]]),e.uniform4fv(r.uConstants,h)}}),t.Image.filters.ColorMatrix.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.Image.filters;s.Brightness=(0,t.util.createClass)(s.BaseFilter,{type:"Brightness",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBrightness;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += uBrightness;\ngl_FragColor = color;\n}",brightness:0,mainParameter:"brightness",applyTo2d:function(e){if(0!==this.brightness){var o,i=e.imageData.data,h=i.length,l=Math.round(255*this.brightness);for(o=0;o<h;o+=4)i[o]=i[o]+l,i[o+1]=i[o+1]+l,i[o+2]=i[o+2]+l}},getUniformLocations:function(e,r){return{uBrightness:e.getUniformLocation(r,"uBrightness")}},sendUniformData:function(e,r){e.uniform1f(r.uBrightness,this.brightness)}}),t.Image.filters.Brightness.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.object.extend,a=t.Image.filters;a.Convolute=(0,t.util.createClass)(a.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_3_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_5_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_5_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_7_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_7_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_9_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_9_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}"},retrieveShader:function(r){var i=Math.sqrt(this.matrix.length),o=this.type+"_"+i+"_"+(this.opaque?1:0),h=this.fragmentSource[o];return r.programCache.hasOwnProperty(o)||(r.programCache[o]=this.createProgram(r.context,h)),r.programCache[o]},applyTo2d:function(r){var T,E,I,H,j,V,K,q,Y,Q,et,$,S,i=r.imageData,o=i.data,h=this.matrix,l=Math.round(Math.sqrt(h.length)),c=Math.floor(l/2),u=i.width,d=i.height,g=r.ctx.createImageData(u,d),v=g.data,w=this.opaque?1:0;for(et=0;et<d;et++)for(Q=0;Q<u;Q++){for(j=4*(et*u+Q),T=0,E=0,I=0,H=0,S=0;S<l;S++)for($=0;$<l;$++)V=Q+$-c,!((K=et+S-c)<0||K>=d||V<0||V>=u)&&(T+=o[q=4*(K*u+V)]*(Y=h[S*l+$]),E+=o[q+1]*Y,I+=o[q+2]*Y,w||(H+=o[q+3]*Y));v[j]=T,v[j+1]=E,v[j+2]=I,v[j+3]=w?o[j+3]:H}r.imageData=g},getUniformLocations:function(r,i){return{uMatrix:r.getUniformLocation(i,"uMatrix"),uOpaque:r.getUniformLocation(i,"uOpaque"),uHalfSize:r.getUniformLocation(i,"uHalfSize"),uSize:r.getUniformLocation(i,"uSize")}},sendUniformData:function(r,i){r.uniform1fv(i.uMatrix,this.matrix)},toObject:function(){return s(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),t.Image.filters.Convolute.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.Image.filters;s.Grayscale=(0,t.util.createClass)(s.BaseFilter,{type:"Grayscale",fragmentSource:{average:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat average = (color.r + color.b + color.g) / 3.0;\ngl_FragColor = vec4(average, average, average, color.a);\n}",lightness:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;\ngl_FragColor = vec4(average, average, average, col.a);\n}",luminosity:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;\ngl_FragColor = vec4(average, average, average, col.a);\n}"},mode:"average",mainParameter:"mode",applyTo2d:function(e){var o,l,i=e.imageData.data,h=i.length,c=this.mode;for(o=0;o<h;o+=4)"average"===c?l=(i[o]+i[o+1]+i[o+2])/3:"lightness"===c?l=(Math.min(i[o],i[o+1],i[o+2])+Math.max(i[o],i[o+1],i[o+2]))/2:"luminosity"===c&&(l=.21*i[o]+.72*i[o+1]+.07*i[o+2]),i[o]=l,i[o+1]=l,i[o+2]=l},retrieveShader:function(e){var r=this.type+"_"+this.mode;return e.programCache.hasOwnProperty(r)||(e.programCache[r]=this.createProgram(e.context,this.fragmentSource[this.mode])),e.programCache[r]},getUniformLocations:function(e,r){return{uMode:e.getUniformLocation(r,"uMode")}},sendUniformData:function(e,r){e.uniform1i(r.uMode,1)},isNeutralState:function(){return!1}}),t.Image.filters.Grayscale.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.Image.filters;s.Invert=(0,t.util.createClass)(s.BaseFilter,{type:"Invert",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uInvert;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nif (uInvert == 1) {\ngl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);\n} else {\ngl_FragColor = color;\n}\n}",invert:!0,mainParameter:"invert",applyTo2d:function(e){var o,i=e.imageData.data,h=i.length;for(o=0;o<h;o+=4)i[o]=255-i[o],i[o+1]=255-i[o+1],i[o+2]=255-i[o+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(e,r){return{uInvert:e.getUniformLocation(r,"uInvert")}},sendUniformData:function(e,r){e.uniform1i(r.uInvert,this.invert)}}),t.Image.filters.Invert.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.object.extend,a=t.Image.filters;a.Noise=(0,t.util.createClass)(a.BaseFilter,{type:"Noise",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uStepH;\nuniform float uNoise;\nuniform float uSeed;\nvarying vec2 vTexCoord;\nfloat rand(vec2 co, float seed, float vScale) {\nreturn fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);\n}\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;\ngl_FragColor = color;\n}",mainParameter:"noise",noise:0,applyTo2d:function(r){if(0!==this.noise){var h,l,u,o=r.imageData.data,c=this.noise;for(h=0,l=o.length;h<l;h+=4)u=(.5-Math.random())*c,o[h]+=u,o[h+1]+=u,o[h+2]+=u}},getUniformLocations:function(r,i){return{uNoise:r.getUniformLocation(i,"uNoise"),uSeed:r.getUniformLocation(i,"uSeed")}},sendUniformData:function(r,i){r.uniform1f(i.uNoise,this.noise/255),r.uniform1f(i.uSeed,Math.random())},toObject:function(){return s(this.callSuper("toObject"),{noise:this.noise})}}),t.Image.filters.Noise.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.Image.filters;s.Pixelate=(0,t.util.createClass)(s.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBlocksize;\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nfloat blockW = uBlocksize * uStepW;\nfloat blockH = uBlocksize * uStepW;\nint posX = int(vTexCoord.x / blockW);\nint posY = int(vTexCoord.y / blockH);\nfloat fposX = float(posX);\nfloat fposY = float(posY);\nvec2 squareCoords = vec2(fposX * blockW, fposY * blockH);\nvec4 color = texture2D(uTexture, squareCoords);\ngl_FragColor = color;\n}",applyTo2d:function(e){var l,c,u,d,g,v,w,T,E,I,H,r=e.imageData,i=r.data,o=r.height,h=r.width;for(c=0;c<o;c+=this.blocksize)for(u=0;u<h;u+=this.blocksize)for(d=i[l=4*c*h+4*u],g=i[l+1],v=i[l+2],w=i[l+3],I=Math.min(c+this.blocksize,o),H=Math.min(u+this.blocksize,h),T=c;T<I;T++)for(E=u;E<H;E++)i[l=4*T*h+4*E]=d,i[l+1]=g,i[l+2]=v,i[l+3]=w},isNeutralState:function(){return 1===this.blocksize},getUniformLocations:function(e,r){return{uBlocksize:e.getUniformLocation(r,"uBlocksize"),uStepW:e.getUniformLocation(r,"uStepW"),uStepH:e.getUniformLocation(r,"uStepH")}},sendUniformData:function(e,r){e.uniform1f(r.uBlocksize,this.blocksize)}}),t.Image.filters.Pixelate.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.object.extend,a=t.Image.filters;a.RemoveColor=(0,t.util.createClass)(a.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uLow;\nuniform vec4 uHigh;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\nif(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {\ngl_FragColor.a = 0.0;\n}\n}",distance:.02,useAlpha:!1,applyTo2d:function(r){var h,c,u,d,o=r.imageData.data,l=255*this.distance,g=new t.Color(this.color).getSource(),v=[g[0]-l,g[1]-l,g[2]-l],w=[g[0]+l,g[1]+l,g[2]+l];for(h=0;h<o.length;h+=4)u=o[h+1],d=o[h+2],(c=o[h])>v[0]&&u>v[1]&&d>v[2]&&c<w[0]&&u<w[1]&&d<w[2]&&(o[h+3]=0)},getUniformLocations:function(r,i){return{uLow:r.getUniformLocation(i,"uLow"),uHigh:r.getUniformLocation(i,"uHigh")}},sendUniformData:function(r,i){var o=new t.Color(this.color).getSource(),h=parseFloat(this.distance),c=[o[0]/255+h,o[1]/255+h,o[2]/255+h,1];r.uniform4fv(i.uLow,[0+o[0]/255-h,0+o[1]/255-h,0+o[2]/255-h,1]),r.uniform4fv(i.uHigh,c)},toObject:function(){return s(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),t.Image.filters.RemoveColor.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.Image.filters,a=t.util.createClass,e={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var r in e)s[r]=a(s.ColorMatrix,{type:r,matrix:e[r],mainParameter:!1,colorsOnly:!0}),t.Image.filters[r].fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric,s=t.Image.filters;s.BlendColor=(0,t.util.createClass)(s.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:"gl_FragColor.rgb *= uColor.rgb;\n",screen:"gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);\n",add:"gl_FragColor.rgb += uColor.rgb;\n",diff:"gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);\n",subtract:"gl_FragColor.rgb -= uColor.rgb;\n",lighten:"gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);\n",darken:"gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);\n",exclusion:"gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);\n",overlay:"if (uColor.r < 0.5) {\ngl_FragColor.r *= 2.0 * uColor.r;\n} else {\ngl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);\n}\nif (uColor.g < 0.5) {\ngl_FragColor.g *= 2.0 * uColor.g;\n} else {\ngl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);\n}\nif (uColor.b < 0.5) {\ngl_FragColor.b *= 2.0 * uColor.b;\n} else {\ngl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);\n}\n",tint:"gl_FragColor.rgb *= (1.0 - uColor.a);\ngl_FragColor.rgb += uColor.rgb;\n"},buildSource:function(e){return"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ngl_FragColor = color;\nif (color.a > 0.0) {\n"+this.fragmentSource[e]+"}\n}"},retrieveShader:function(e){var i,r=this.type+"_"+this.mode;return e.programCache.hasOwnProperty(r)||(i=this.buildSource(this.mode),e.programCache[r]=this.createProgram(e.context,i)),e.programCache[r]},applyTo2d:function(e){var h,l,c,u,d,g,v,i=e.imageData.data,o=i.length,w=1-this.alpha;h=(v=new t.Color(this.color).getSource())[0]*this.alpha,l=v[1]*this.alpha,c=v[2]*this.alpha;for(var T=0;T<o;T+=4)switch(u=i[T],d=i[T+1],g=i[T+2],this.mode){case"multiply":i[T]=u*h/255,i[T+1]=d*l/255,i[T+2]=g*c/255;break;case"screen":i[T]=255-(255-u)*(255-h)/255,i[T+1]=255-(255-d)*(255-l)/255,i[T+2]=255-(255-g)*(255-c)/255;break;case"add":i[T]=u+h,i[T+1]=d+l,i[T+2]=g+c;break;case"diff":case"difference":i[T]=Math.abs(u-h),i[T+1]=Math.abs(d-l),i[T+2]=Math.abs(g-c);break;case"subtract":i[T]=u-h,i[T+1]=d-l,i[T+2]=g-c;break;case"darken":i[T]=Math.min(u,h),i[T+1]=Math.min(d,l),i[T+2]=Math.min(g,c);break;case"lighten":i[T]=Math.max(u,h),i[T+1]=Math.max(d,l),i[T+2]=Math.max(g,c);break;case"overlay":i[T]=h<128?2*u*h/255:255-2*(255-u)*(255-h)/255,i[T+1]=l<128?2*d*l/255:255-2*(255-d)*(255-l)/255,i[T+2]=c<128?2*g*c/255:255-2*(255-g)*(255-c)/255;break;case"exclusion":i[T]=h+u-2*h*u/255,i[T+1]=l+d-2*l*d/255,i[T+2]=c+g-2*c*g/255;break;case"tint":i[T]=h+u*w,i[T+1]=l+d*w,i[T+2]=c+g*w}},getUniformLocations:function(e,r){return{uColor:e.getUniformLocation(r,"uColor")}},sendUniformData:function(e,r){var i=new t.Color(this.color).getSource();i[0]=this.alpha*i[0]/255,i[1]=this.alpha*i[1]/255,i[2]=this.alpha*i[2]/255,i[3]=this.alpha,e.uniform4fv(r.uColor,i)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),t.Image.filters.BlendColor.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric,s=t.Image.filters;s.BlendImage=(0,t.util.createClass)(s.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nuniform mat3 uTransformMatrix;\nvoid main() {\nvTexCoord = aPosition;\nvTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:{multiply:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.rgba *= color2.rgba;\ngl_FragColor = color;\n}",mask:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.a = color2.a;\ngl_FragColor = color;\n}"},retrieveShader:function(e){var r=this.type+"_"+this.mode,i=this.fragmentSource[this.mode];return e.programCache.hasOwnProperty(r)||(e.programCache[r]=this.createProgram(e.context,i)),e.programCache[r]},applyToWebGL:function(e){var r=e.context,i=this.createTexture(e.filterBackend,this.image);this.bindAdditionalTexture(r,i,r.TEXTURE1),this.callSuper("applyToWebGL",e),this.unbindAdditionalTexture(r,r.TEXTURE1)},createTexture:function(e,r){return e.getCachedTexture(r.cacheKey,r._element)},calculateMatrix:function(){var e=this.image;return[1/e.scaleX,0,0,0,1/e.scaleY,0,-e.left/e._element.width,-e.top/e._element.height,1]},applyTo2d:function(e){var u,d,g,v,w,T,E,I,H,j,K,r=e.imageData,i=e.filterBackend.resources,o=r.data,h=o.length,l=r.width,c=r.height,V=this.image;i.blendImage||(i.blendImage=t.util.createCanvasElement()),j=(H=i.blendImage).getContext("2d"),H.width!==l||H.height!==c?(H.width=l,H.height=c):j.clearRect(0,0,l,c),j.setTransform(V.scaleX,0,0,V.scaleY,V.left,V.top),j.drawImage(V._element,0,0,l,c),K=j.getImageData(0,0,l,c).data;for(var q=0;q<h;q+=4)switch(w=o[q],T=o[q+1],E=o[q+2],I=o[q+3],u=K[q],d=K[q+1],g=K[q+2],v=K[q+3],this.mode){case"multiply":o[q]=w*u/255,o[q+1]=T*d/255,o[q+2]=E*g/255,o[q+3]=I*v/255;break;case"mask":o[q+3]=v}},getUniformLocations:function(e,r){return{uTransformMatrix:e.getUniformLocation(r,"uTransformMatrix"),uImage:e.getUniformLocation(r,"uImage")}},sendUniformData:function(e,r){var i=this.calculateMatrix();e.uniform1i(r.uImage,1),e.uniformMatrix3fv(r.uTransformMatrix,!1,i)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),t.Image.filters.BlendImage.fromObject=function(e,r){t.Image.fromObject(e.image,function(i){var o=t.util.object.clone(e);o.image=i,r(new t.Image.filters.BlendImage(o))})}}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=Math.pow,a=Math.floor,e=Math.sqrt,r=Math.abs,i=Math.round,o=Math.sin,h=Math.ceil,l=t.Image.filters;l.Resize=(0,t.util.createClass)(l.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(u,d){return{uDelta:u.getUniformLocation(d,"uDelta"),uTaps:u.getUniformLocation(d,"uTaps")}},sendUniformData:function(u,d){u.uniform2fv(d.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),u.uniform1fv(d.uTaps,this.taps)},retrieveShader:function(u){var d=this.getFilterWindow(),g=this.type+"_"+d;if(!u.programCache.hasOwnProperty(g)){var v=this.generateShader(d);u.programCache[g]=this.createProgram(u.context,v)}return u.programCache[g]},getFilterWindow:function(){return Math.ceil(this.lanczosLobes/this.tempScale)},getTaps:function(){for(var u=this.lanczosCreate(this.lanczosLobes),d=this.tempScale,g=this.getFilterWindow(),v=new Array(g),w=1;w<=g;w++)v[w-1]=u(w*d);return v},generateShader:function(v){for(var d=new Array(v),g=this.fragmentSourceTOP,w=1;w<=v;w++)d[w-1]=w+".0 * uDelta";return g+="uniform float uTaps["+v+"];\n",g+="void main() {\n",g+="  vec4 color = texture2D(uTexture, vTexCoord);\n",g+="  float sum = 1.0;\n",d.forEach(function(T,E){g+="  color += texture2D(uTexture, vTexCoord + "+T+") * uTaps["+E+"];\n",g+="  color += texture2D(uTexture, vTexCoord - "+T+") * uTaps["+E+"];\n",g+="  sum += 2.0 * uTaps["+E+"];\n"}),g+="  gl_FragColor = color / sum;\n",g+="}"},fragmentSourceTOP:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\n",applyTo:function(u){u.webgl?(u.passes++,this.width=u.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=u.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),u.destinationWidth=this.dW,this._setupFrameBuffer(u),this.applyToWebGL(u),this._swapTextures(u),u.sourceWidth=u.destinationWidth,this.height=u.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),u.destinationHeight=this.dH,this._setupFrameBuffer(u),this.applyToWebGL(u),this._swapTextures(u),u.sourceHeight=u.destinationHeight):this.applyTo2d(u)},isNeutralState:function(){return 1===this.scaleX&&1===this.scaleY},lanczosCreate:function(u){return function(d){if(d>=u||d<=-u)return 0;if(d<1.1920929e-7&&d>-1.1920929e-7)return 1;var g=(d*=Math.PI)/u;return o(d)/d*o(g)/g}},applyTo2d:function(u){var d=u.imageData,g=this.scaleX,v=this.scaleY;this.rcpScaleX=1/g,this.rcpScaleY=1/v;var H,w=d.width,T=d.height,E=i(w*g),I=i(T*v);"sliceHack"===this.resizeType?H=this.sliceByTwo(u,w,T,E,I):"hermite"===this.resizeType?H=this.hermiteFastResize(u,w,T,E,I):"bilinear"===this.resizeType?H=this.bilinearFiltering(u,w,T,E,I):"lanczos"===this.resizeType&&(H=this.lanczosResize(u,w,T,E,I)),u.imageData=H},sliceByTwo:function(u,d,g,v,w){var q,Y,T=u.imageData,E=.5,I=!1,H=!1,j=d*E,V=g*E,K=t.filterBackend.resources,Q=0,et=0,$=d,S=0;for(K.sliceByTwo||(K.sliceByTwo=document.createElement("canvas")),((q=K.sliceByTwo).width<1.5*d||q.height<g)&&(q.width=1.5*d,q.height=g),(Y=q.getContext("2d")).clearRect(0,0,1.5*d,g),Y.putImageData(T,0,0),v=a(v),w=a(w);!I||!H;)d=j,g=V,v<a(j*E)?j=a(j*E):(j=v,I=!0),w<a(V*E)?V=a(V*E):(V=w,H=!0),Y.drawImage(q,Q,et,d,g,$,S,j,V),Q=$,et=S,S+=V;return Y.getImageData(Q,et,v,w)},lanczosResize:function(u,d,g,v,w){var E=u.imageData.data,I=u.ctx.createImageData(v,w),H=I.data,j=this.lanczosCreate(this.lanczosLobes),V=this.rcpScaleX,K=this.rcpScaleY,q=2/this.rcpScaleX,Y=2/this.rcpScaleY,Q=h(V*this.lanczosLobes/2),et=h(K*this.lanczosLobes/2),$={},S={},R={};return function T(b){var D,L,P,C,M,A,N,B,W,U,Z;for(S.x=(b+.5)*V,R.x=a(S.x),D=0;D<w;D++){for(S.y=(D+.5)*K,R.y=a(S.y),M=0,A=0,N=0,B=0,W=0,L=R.x-Q;L<=R.x+Q;L++)if(!(L<0||L>=d)){U=a(1e3*r(L-S.x)),$[U]||($[U]={});for(var z=R.y-et;z<=R.y+et;z++)z<0||z>=g||(Z=a(1e3*r(z-S.y)),$[U][Z]||($[U][Z]=j(e(s(U*q,2)+s(Z*Y,2))/1e3)),(P=$[U][Z])>0&&(M+=P,A+=P*E[C=4*(z*d+L)],N+=P*E[C+1],B+=P*E[C+2],W+=P*E[C+3]))}H[C=4*(D*v+b)]=A/M,H[C+1]=N/M,H[C+2]=B/M,H[C+3]=W/M}return++b<v?T(b):I}(0)},bilinearFiltering:function(u,d,g,v,w){var j,V,K,q,Y,Q,et,R,S=0,b=this.rcpScaleX,D=this.rcpScaleY,L=4*(d-1),C=u.imageData.data,M=u.ctx.createImageData(v,w),A=M.data;for(K=0;K<w;K++)for(q=0;q<v;q++)for(Y=b*q-(j=a(b*q)),Q=D*K-(V=a(D*K)),R=4*(V*d+j),et=0;et<4;et++)A[S++]=C[R+et]*(1-Y)*(1-Q)+C[R+4+et]*Y*(1-Q)+C[R+L+et]*Q*(1-Y)+C[R+L+4+et]*Y*Q;return M},hermiteFastResize:function(u,d,g,v,w){for(var T=this.rcpScaleX,E=this.rcpScaleY,I=h(T/2),H=h(E/2),V=u.imageData.data,K=u.ctx.createImageData(v,w),q=K.data,Y=0;Y<w;Y++)for(var Q=0;Q<v;Q++){for(var et=4*(Q+Y*v),$=0,S=0,R=0,b=0,D=0,L=0,P=0,C=(Y+.5)*E,M=a(Y*E);M<(Y+1)*E;M++)for(var A=r(C-(M+.5))/H,N=(Q+.5)*T,B=A*A,W=a(Q*T);W<(Q+1)*T;W++){var U=r(N-(W+.5))/I,Z=e(B+U*U);Z>1&&Z<-1||($=2*Z*Z*Z-3*Z*Z+1)>0&&(P+=$*V[3+(U=4*(W+M*d))],R+=$,V[U+3]<255&&($=$*V[U+3]/250),b+=$*V[U],D+=$*V[U+1],L+=$*V[U+2],S+=$)}q[et]=b/S,q[et+1]=D/S,q[et+2]=L/S,q[et+3]=P/R}return K},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),t.Image.filters.Resize.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.Image.filters;s.Contrast=(0,t.util.createClass)(s.BaseFilter,{type:"Contrast",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uContrast;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));\ncolor.rgb = contrastF * (color.rgb - 0.5) + 0.5;\ngl_FragColor = color;\n}",contrast:0,mainParameter:"contrast",applyTo2d:function(e){if(0!==this.contrast){var i,o=e.imageData.data,h=o.length,l=Math.floor(255*this.contrast),c=259*(l+255)/(255*(259-l));for(i=0;i<h;i+=4)o[i]=c*(o[i]-128)+128,o[i+1]=c*(o[i+1]-128)+128,o[i+2]=c*(o[i+2]-128)+128}},getUniformLocations:function(e,r){return{uContrast:e.getUniformLocation(r,"uContrast")}},sendUniformData:function(e,r){e.uniform1f(r.uContrast,this.contrast)}}),t.Image.filters.Contrast.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.Image.filters;s.Saturation=(0,t.util.createClass)(s.BaseFilter,{type:"Saturation",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uSaturation;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat rgMax = max(color.r, color.g);\nfloat rgbMax = max(rgMax, color.b);\ncolor.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;\ncolor.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;\ncolor.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;\ngl_FragColor = color;\n}",saturation:0,mainParameter:"saturation",applyTo2d:function(e){if(0!==this.saturation){var l,c,i=e.imageData.data,o=i.length,h=-this.saturation;for(l=0;l<o;l+=4)c=Math.max(i[l],i[l+1],i[l+2]),i[l]+=c!==i[l]?(c-i[l])*h:0,i[l+1]+=c!==i[l+1]?(c-i[l+1])*h:0,i[l+2]+=c!==i[l+2]?(c-i[l+2])*h:0}},getUniformLocations:function(e,r){return{uSaturation:e.getUniformLocation(r,"uSaturation")}},sendUniformData:function(e,r){e.uniform1f(r.uSaturation,-this.saturation)}}),t.Image.filters.Saturation.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.Image.filters;s.Vibrance=(0,t.util.createClass)(s.BaseFilter,{type:"Vibrance",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uVibrance;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat max = max(color.r, max(color.g, color.b));\nfloat avg = (color.r + color.g + color.b) / 3.0;\nfloat amt = (abs(max - avg) * 2.0) * uVibrance;\ncolor.r += max != color.r ? (max - color.r) * amt : 0.00;\ncolor.g += max != color.g ? (max - color.g) * amt : 0.00;\ncolor.b += max != color.b ? (max - color.b) * amt : 0.00;\ngl_FragColor = color;\n}",vibrance:0,mainParameter:"vibrance",applyTo2d:function(e){if(0!==this.vibrance){var l,c,d,i=e.imageData.data,o=i.length,h=-this.vibrance;for(l=0;l<o;l+=4)c=Math.max(i[l],i[l+1],i[l+2]),d=2*Math.abs(c-(i[l]+i[l+1]+i[l+2])/3)/255*h,i[l]+=c!==i[l]?(c-i[l])*d:0,i[l+1]+=c!==i[l+1]?(c-i[l+1])*d:0,i[l+2]+=c!==i[l+2]?(c-i[l+2])*d:0}},getUniformLocations:function(e,r){return{uVibrance:e.getUniformLocation(r,"uVibrance")}},sendUniformData:function(e,r){e.uniform1f(r.uVibrance,-this.vibrance)}}),t.Image.filters.Vibrance.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.Image.filters;s.Blur=(0,t.util.createClass)(s.BaseFilter,{type:"Blur",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\nconst float nSamples = 15.0;\nvec3 v3offset = vec3(12.9898, 78.233, 151.7182);\nfloat random(vec3 scale) {\nreturn fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);\n}\nvoid main() {\nvec4 color = vec4(0.0);\nfloat total = 0.0;\nfloat offset = random(v3offset);\nfor (float t = -nSamples; t <= nSamples; t++) {\nfloat percent = (t + offset - 0.5) / nSamples;\nfloat weight = 1.0 - abs(percent);\ncolor += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;\ntotal += weight;\n}\ngl_FragColor = color / total;\n}",blur:0,mainParameter:"blur",applyTo:function(e){e.webgl?(this.aspectRatio=e.sourceWidth/e.sourceHeight,e.passes++,this._setupFrameBuffer(e),this.horizontal=!0,this.applyToWebGL(e),this._swapTextures(e),this._setupFrameBuffer(e),this.horizontal=!1,this.applyToWebGL(e),this._swapTextures(e)):this.applyTo2d(e)},applyTo2d:function(e){e.imageData=this.simpleBlur(e)},simpleBlur:function(e){var i,o,r=e.filterBackend.resources,h=e.imageData.width,l=e.imageData.height;r.blurLayer1||(r.blurLayer1=t.util.createCanvasElement(),r.blurLayer2=t.util.createCanvasElement()),o=r.blurLayer2,((i=r.blurLayer1).width!==h||i.height!==l)&&(o.width=i.width=h,o.height=i.height=l);var g,v,w,T,c=i.getContext("2d"),u=o.getContext("2d"),d=15,E=.06*this.blur*.5;for(c.putImageData(e.imageData,0,0),u.clearRect(0,0,h,l),T=-d;T<=d;T++)w=E*(v=T/d)*h+(g=(Math.random()-.5)/4),u.globalAlpha=1-Math.abs(v),u.drawImage(i,w,g),c.drawImage(o,0,0),u.globalAlpha=1,u.clearRect(0,0,o.width,o.height);for(T=-d;T<=d;T++)w=E*(v=T/d)*l+(g=(Math.random()-.5)/4),u.globalAlpha=1-Math.abs(v),u.drawImage(i,g,w),c.drawImage(o,0,0),u.globalAlpha=1,u.clearRect(0,0,o.width,o.height);e.ctx.drawImage(i,0,0);var I=e.ctx.getImageData(0,0,i.width,i.height);return c.globalAlpha=1,c.clearRect(0,0,i.width,i.height),I},getUniformLocations:function(e,r){return{delta:e.getUniformLocation(r,"uDelta")}},sendUniformData:function(e,r){var i=this.chooseRightDelta();e.uniform2fv(r.delta,i)},chooseRightDelta:function(){var i,e=1,r=[0,0];return this.horizontal?this.aspectRatio>1&&(e=1/this.aspectRatio):this.aspectRatio<1&&(e=this.aspectRatio),i=e*this.blur*.12,this.horizontal?r[0]=i:r[1]=i,r}}),s.Blur.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.Image.filters;s.Gamma=(0,t.util.createClass)(s.BaseFilter,{type:"Gamma",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec3 uGamma;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec3 correction = (1.0 / uGamma);\ncolor.r = pow(color.r, correction.r);\ncolor.g = pow(color.g, correction.g);\ncolor.b = pow(color.b, correction.b);\ngl_FragColor = color;\ngl_FragColor.rgb *= color.a;\n}",gamma:[1,1,1],mainParameter:"gamma",initialize:function(e){this.gamma=[1,1,1],s.BaseFilter.prototype.initialize.call(this,e)},applyTo2d:function(e){var d,i=e.imageData.data,o=this.gamma,h=i.length,l=1/o[0],c=1/o[1],u=1/o[2];for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),d=0,h=256;d<h;d++)this.rVals[d]=255*Math.pow(d/255,l),this.gVals[d]=255*Math.pow(d/255,c),this.bVals[d]=255*Math.pow(d/255,u);for(d=0,h=i.length;d<h;d+=4)i[d]=this.rVals[i[d]],i[d+1]=this.gVals[i[d+1]],i[d+2]=this.bVals[i[d+2]]},getUniformLocations:function(e,r){return{uGamma:e.getUniformLocation(r,"uGamma")}},sendUniformData:function(e,r){e.uniform3fv(r.uGamma,this.gamma)}}),t.Image.filters.Gamma.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.Image.filters;s.Composed=(0,t.util.createClass)(s.BaseFilter,{type:"Composed",subFilters:[],initialize:function(e){this.callSuper("initialize",e),this.subFilters=this.subFilters.slice(0)},applyTo:function(e){e.passes+=this.subFilters.length-1,this.subFilters.forEach(function(r){r.applyTo(e)})},toObject:function(){return t.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(e){return e.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(e){return!e.isNeutralState()})}}),t.Image.filters.Composed.fromObject=function(e,r){var o=(e.subFilters||[]).map(function(l){return new t.Image.filters[l.type](l)}),h=new t.Image.filters.Composed({subFilters:o});return r&&r(h),h}}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.Image.filters;s.HueRotation=(0,t.util.createClass)(s.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var e=this.rotation*Math.PI,r=t.util.cos(e),i=t.util.sin(e),o=1/3,h=Math.sqrt(o)*i,l=1-r;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=r+l/3,this.matrix[1]=o*l-h,this.matrix[2]=o*l+h,this.matrix[5]=o*l+h,this.matrix[6]=r+o*l,this.matrix[7]=o*l-h,this.matrix[10]=o*l-h,this.matrix[11]=o*l+h,this.matrix[12]=r+o*l},isNeutralState:function(e){return this.calculateMatrix(),s.BaseFilter.prototype.isNeutralState.call(this,e)},applyTo:function(e){this.calculateMatrix(),s.BaseFilter.prototype.applyTo.call(this,e)}}),t.Image.filters.HueRotation.fromObject=t.Image.filters.BaseFilter.fromObject}("undefined"!=typeof exports?exports:this),function(n){"use strict";var t=n.fabric||(n.fabric={}),s=t.util.object.clone;if(t.Text)t.warn("fabric.Text is already defined");else{var a="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");t.Text=t.util.createClass(t.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:t.Object.prototype.stateProperties.concat(a),cacheProperties:t.Object.prototype.cacheProperties.concat(a),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(e,r){this.styles=r&&r.styles||{},this.text=e,this.__skipDimension=!0,this.callSuper("initialize",r),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var e=this.path;e&&(e.segmentsInfo=t.util.getPathSegmentsInfo(e.path))},getMeasuringContext:function(){return t._measuringContext||(t._measuringContext=this.canvas&&this.canvas.contextCache||t.util.createCanvasElement().getContext("2d")),t._measuringContext},_splitText:function(){var e=this._splitTextIntoLines(this.text);return this.textLines=e.lines,this._textLines=e.graphemeLines,this._unwrappedTextLines=e._unwrappedLines,this._text=e.graphemeText,e},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),-1!==this.textAlign.indexOf("justify")&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var e,r,o,h,l,c,u=0,d=this._textLines.length;u<d;u++)if(("justify"===this.textAlign||u!==d-1&&!this.isEndOfWrapping(u))&&(o=0,h=this._textLines[u],(r=this.getLineWidth(u))<this.width&&(c=this.textLines[u].match(this._reSpacesAndTabs)))){e=(this.width-r)/c.length;for(var g=0,v=h.length;g<=v;g++)l=this.__charBounds[u][g],this._reSpaceAndTab.test(h[g])?(l.width+=e,l.kernedWidth+=e,l.left+=o,o+=e):l.left+=o}},isEndOfWrapping:function(e){return e===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var e=this.callSuper("_getCacheCanvasDimensions"),r=this.fontSize;return e.width+=r*e.zoomX,e.height+=r*e.zoomY,e},_render:function(e){var r=this.path;r&&!r.isNotVisible()&&r._render(e),this._setTextStyles(e),this._renderTextLinesBackground(e),this._renderTextDecoration(e,"underline"),this._renderText(e),this._renderTextDecoration(e,"overline"),this._renderTextDecoration(e,"linethrough")},_renderText:function(e){"stroke"===this.paintFirst?(this._renderTextStroke(e),this._renderTextFill(e)):(this._renderTextFill(e),this._renderTextStroke(e))},_setTextStyles:function(e,r,i){if(e.textBaseline="alphabetical",this.path)switch(this.pathAlign){case"center":e.textBaseline="middle";break;case"ascender":e.textBaseline="top";break;case"descender":e.textBaseline="bottom"}e.font=this._getFontDeclaration(r,i)},calcTextWidth:function(){for(var e=this.getLineWidth(0),r=1,i=this._textLines.length;r<i;r++){var o=this.getLineWidth(r);o>e&&(e=o)}return e},_renderTextLine:function(e,r,i,o,h,l){this._renderChars(e,r,i,o,h,l)},_renderTextLinesBackground:function(e){if(this.textBackgroundColor||this.styleHas("textBackgroundColor")){for(var r,i,h,l,v,w,E,o=e.fillStyle,c=this._getLeftOffset(),u=this._getTopOffset(),d=0,g=0,T=this.path,I=0,H=this._textLines.length;I<H;I++)if(r=this.getHeightOfLine(I),this.textBackgroundColor||this.styleHas("textBackgroundColor",I)){h=this._textLines[I],i=this._getLineLeftOffset(I),g=0,d=0,l=this.getValueOfPropertyAt(I,0,"textBackgroundColor");for(var j=0,V=h.length;j<V;j++)v=this.__charBounds[I][j],w=this.getValueOfPropertyAt(I,j,"textBackgroundColor"),T?(e.save(),e.translate(v.renderLeft,v.renderTop),e.rotate(v.angle),e.fillStyle=w,w&&e.fillRect(-v.width/2,-r/this.lineHeight*(1-this._fontSizeFraction),v.width,r/this.lineHeight),e.restore()):w!==l?(E=c+i+d,"rtl"===this.direction&&(E=this.width-E-g),e.fillStyle=l,l&&e.fillRect(E,u,g,r/this.lineHeight),d=v.left,g=v.width,l=w):g+=v.kernedWidth;w&&!T&&(E=c+i+d,"rtl"===this.direction&&(E=this.width-E-g),e.fillStyle=w,e.fillRect(E,u,g,r/this.lineHeight)),u+=r}else u+=r;e.fillStyle=o,this._removeShadow(e)}},getFontCache:function(e){var r=e.fontFamily.toLowerCase();t.charWidthsCache[r]||(t.charWidthsCache[r]={});var i=t.charWidthsCache[r],o=e.fontStyle.toLowerCase()+"_"+(e.fontWeight+"").toLowerCase();return i[o]||(i[o]={}),i[o]},_measureChar:function(e,r,i,o){var g,v,w,E,h=this.getFontCache(r),u=i+e,d=this._getFontDeclaration(r)===this._getFontDeclaration(o),T=r.fontSize/this.CACHE_FONT_SIZE;if(i&&void 0!==h[i]&&(w=h[i]),void 0!==h[e]&&(E=g=h[e]),d&&void 0!==h[u]&&(E=(v=h[u])-w),void 0===g||void 0===w||void 0===v){var I=this.getMeasuringContext();this._setTextStyles(I,r,!0)}return void 0===g&&(E=g=I.measureText(e).width,h[e]=g),void 0===w&&d&&i&&(w=I.measureText(i).width,h[i]=w),d&&void 0===v&&(v=I.measureText(u).width,h[u]=v,E=v-w),{width:g*T,kernedWidth:E*T}},getHeightOfChar:function(e,r){return this.getValueOfPropertyAt(e,r,"fontSize")},measureLine:function(e){var r=this._measureLine(e);return 0!==this.charSpacing&&(r.width-=this._getWidthOfCharSpacing()),r.width<0&&(r.width=0),r},_measureLine:function(e){var i,o,l,c,v,w,r=0,h=this._textLines[e],d=new Array(h.length),g=0,T=this.path,E="right"===this.pathSide;for(this.__charBounds[e]=d,i=0;i<h.length;i++)c=this._getGraphemeBox(o=h[i],e,i,l),d[i]=c,r+=c.kernedWidth,l=o;if(d[i]={left:c?c.left+c.width:0,width:0,kernedWidth:0,height:this.fontSize},T){switch(w=T.segmentsInfo[T.segmentsInfo.length-1].length,(v=t.util.getPointOnPath(T.path,0,T.segmentsInfo)).x+=T.pathOffset.x,v.y+=T.pathOffset.y,this.textAlign){case"left":g=E?w-r:0;break;case"center":g=(w-r)/2;break;case"right":g=E?0:w-r}for(g+=this.pathStartOffset*(E?-1:1),i=E?h.length-1:0;E?i>=0:i<h.length;E?i--:i++)g>w?g%=w:g<0&&(g+=w),this._setGraphemeOnPath(g,c=d[i],v),g+=c.kernedWidth}return{width:r,numOfSpaces:0}},_setGraphemeOnPath:function(e,r,i){var h=this.path,l=t.util.getPointOnPath(h.path,e+r.kernedWidth/2,h.segmentsInfo);r.renderLeft=l.x-i.x,r.renderTop=l.y-i.y,r.angle=l.angle+("right"===this.pathSide?Math.PI:0)},_getGraphemeBox:function(e,r,i,o,h){var v,l=this.getCompleteStyleDeclaration(r,i),c=o?this.getCompleteStyleDeclaration(r,i-1):{},u=this._measureChar(e,l,o,c),d=u.kernedWidth,g=u.width;0!==this.charSpacing&&(g+=v=this._getWidthOfCharSpacing(),d+=v);var w={width:g,left:0,height:l.fontSize,kernedWidth:d,deltaY:l.deltaY};if(i>0&&!h){var T=this.__charBounds[r][i-1];w.left=T.left+T.width+u.kernedWidth-u.width}return w},getHeightOfLine:function(e){if(this.__lineHeights[e])return this.__lineHeights[e];for(var r=this._textLines[e],i=this.getHeightOfChar(e,0),o=1,h=r.length;o<h;o++)i=Math.max(this.getHeightOfChar(e,o),i);return this.__lineHeights[e]=i*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var e,r=0,i=0,o=this._textLines.length;i<o;i++)e=this.getHeightOfLine(i),r+=i===o-1?e/this.lineHeight:e;return r},_getLeftOffset:function(){return"ltr"===this.direction?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(e,r){e.save();for(var i=0,o=this._getLeftOffset(),h=this._getTopOffset(),l=0,c=this._textLines.length;l<c;l++){var u=this.getHeightOfLine(l),d=u/this.lineHeight,g=this._getLineLeftOffset(l);this._renderTextLine(r,e,this._textLines[l],o+g,h+i+d,l),i+=u}e.restore()},_renderTextFill:function(e){!this.fill&&!this.styleHas("fill")||this._renderTextCommon(e,"fillText")},_renderTextStroke:function(e){(!this.stroke||0===this.strokeWidth)&&this.isEmptyStyles()||(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(e),e.save(),this._setLineDash(e,this.strokeDashArray),e.beginPath(),this._renderTextCommon(e,"strokeText"),e.closePath(),e.restore())},_renderChars:function(e,r,i,o,h,l){var d,g,w,E,c=this.getHeightOfLine(l),u=-1!==this.textAlign.indexOf("justify"),v="",T=0,I=this.path,H=!u&&0===this.charSpacing&&this.isEmptyStyles(l)&&!I,j="ltr"===this.direction,V="ltr"===this.direction?1:-1,q=r.canvas.getAttribute("dir");if(r.save(),q!==this.direction&&(r.canvas.setAttribute("dir",j?"ltr":"rtl"),r.direction=j?"ltr":"rtl",r.textAlign=j?"left":"right"),h-=c*this._fontSizeFraction/this.lineHeight,H)return this._renderChar(e,r,l,0,i.join(""),o,h,c),void r.restore();for(var Y=0,Q=i.length-1;Y<=Q;Y++)E=Y===Q||this.charSpacing||I,v+=i[Y],w=this.__charBounds[l][Y],0===T?(o+=V*(w.kernedWidth-w.width),T+=w.width):T+=w.kernedWidth,u&&!E&&this._reSpaceAndTab.test(i[Y])&&(E=!0),E||(d=d||this.getCompleteStyleDeclaration(l,Y),g=this.getCompleteStyleDeclaration(l,Y+1),E=this._hasStyleChanged(d,g)),E&&(I?(r.save(),r.translate(w.renderLeft,w.renderTop),r.rotate(w.angle),this._renderChar(e,r,l,Y,v,-T/2,0,c),r.restore()):this._renderChar(e,r,l,Y,v,o,h,c),v="",d=g,o+=V*T,T=0);r.restore()},_applyPatternGradientTransformText:function(e){var i,r=t.util.createCanvasElement(),o=this.width+this.strokeWidth,h=this.height+this.strokeWidth;return r.width=o,r.height=h,(i=r.getContext("2d")).beginPath(),i.moveTo(0,0),i.lineTo(o,0),i.lineTo(o,h),i.lineTo(0,h),i.closePath(),i.translate(o/2,h/2),i.fillStyle=e.toLive(i),this._applyPatternGradientTransform(i,e),i.fill(),i.createPattern(r,"no-repeat")},handleFiller:function(e,r,i){var o,h;return i.toLive?"percentage"===i.gradientUnits||i.gradientTransform||i.patternTransform?(e.translate(o=-this.width/2,h=-this.height/2),e[r]=this._applyPatternGradientTransformText(i),{offsetX:o,offsetY:h}):(e[r]=i.toLive(e,this),this._applyPatternGradientTransform(e,i)):(e[r]=i,{offsetX:0,offsetY:0})},_setStrokeStyles:function(e,r){return e.lineWidth=r.strokeWidth,e.lineCap=this.strokeLineCap,e.lineDashOffset=this.strokeDashOffset,e.lineJoin=this.strokeLineJoin,e.miterLimit=this.strokeMiterLimit,this.handleFiller(e,"strokeStyle",r.stroke)},_setFillStyles:function(e,r){return this.handleFiller(e,"fillStyle",r.fill)},_renderChar:function(e,r,i,o,h,l,c){var w,T,u=this._getStyleDeclaration(i,o),d=this.getCompleteStyleDeclaration(i,o),g="fillText"===e&&d.fill,v="strokeText"===e&&d.stroke&&d.strokeWidth;!v&&!g||(r.save(),g&&(w=this._setFillStyles(r,d)),v&&(T=this._setStrokeStyles(r,d)),r.font=this._getFontDeclaration(d),u&&u.textBackgroundColor&&this._removeShadow(r),u&&u.deltaY&&(c+=u.deltaY),g&&r.fillText(h,l-w.offsetX,c-w.offsetY),v&&r.strokeText(h,l-T.offsetX,c-T.offsetY),r.restore())},setSuperscript:function(e,r){return this._setScript(e,r,this.superscript)},setSubscript:function(e,r){return this._setScript(e,r,this.subscript)},_setScript:function(e,r,i){var o=this.get2DCursorLocation(e,!0),h=this.getValueOfPropertyAt(o.lineIndex,o.charIndex,"fontSize"),l=this.getValueOfPropertyAt(o.lineIndex,o.charIndex,"deltaY");return this.setSelectionStyles({fontSize:h*i.size,deltaY:l+h*i.baseline},e,r),this},_hasStyleChanged:function(e,r){return e.fill!==r.fill||e.stroke!==r.stroke||e.strokeWidth!==r.strokeWidth||e.fontSize!==r.fontSize||e.fontFamily!==r.fontFamily||e.fontWeight!==r.fontWeight||e.fontStyle!==r.fontStyle||e.deltaY!==r.deltaY},_hasStyleChangedForSvg:function(e,r){return this._hasStyleChanged(e,r)||e.overline!==r.overline||e.underline!==r.underline||e.linethrough!==r.linethrough},_getLineLeftOffset:function(e){var r=this.getLineWidth(e),i=this.width-r,o=this.textAlign,h=this.direction,l=0,c=this.isEndOfWrapping(e);return"justify"===o||"justify-center"===o&&!c||"justify-right"===o&&!c||"justify-left"===o&&!c?0:("center"===o&&(l=i/2),"right"===o&&(l=i),"justify-center"===o&&(l=i/2),"justify-right"===o&&(l=i),"rtl"===h&&(l-=i),l)},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var e=this._forceClearCache;return e||(e=this.hasStateChanged("_dimensionAffectingProps")),e&&(this.dirty=!0,this._forceClearCache=!1),e},getLineWidth:function(e){if(void 0!==this.__lineWidths[e])return this.__lineWidths[e];var i=this.measureLine(e).width;return this.__lineWidths[e]=i,i},_getWidthOfCharSpacing:function(){return 0!==this.charSpacing?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(e,r,i){var o=this._getStyleDeclaration(e,r);return o&&void 0!==o[i]?o[i]:this[i]},_renderTextDecoration:function(e,r){if(this[r]||this.styleHas(r)){for(var i,o,h,l,c,u,d,g,T,E,I,H,j,V,K,q,v=this._getLeftOffset(),w=this._getTopOffset(),Y=this.path,Q=this._getWidthOfCharSpacing(),et=this.offsets[r],$=0,S=this._textLines.length;$<S;$++)if(i=this.getHeightOfLine($),this[r]||this.styleHas(r,$)){d=this._textLines[$],V=i/this.lineHeight,l=this._getLineLeftOffset($),E=0,I=0,g=this.getValueOfPropertyAt($,0,r),q=this.getValueOfPropertyAt($,0,"fill"),T=w+V*(1-this._fontSizeFraction),o=this.getHeightOfChar($,0),c=this.getValueOfPropertyAt($,0,"deltaY");for(var R=0,b=d.length;R<b;R++)if(H=this.__charBounds[$][R],j=this.getValueOfPropertyAt($,R,r),K=this.getValueOfPropertyAt($,R,"fill"),h=this.getHeightOfChar($,R),u=this.getValueOfPropertyAt($,R,"deltaY"),Y&&j&&K)e.save(),e.fillStyle=q,e.translate(H.renderLeft,H.renderTop),e.rotate(H.angle),e.fillRect(-H.kernedWidth/2,et*h+u,H.kernedWidth,this.fontSize/15),e.restore();else if((j!==g||K!==q||h!==o||u!==c)&&I>0){var D=v+l+E;"rtl"===this.direction&&(D=this.width-D-I),g&&q&&(e.fillStyle=q,e.fillRect(D,T+et*o+c,I,this.fontSize/15)),E=H.left,I=H.width,g=j,q=K,o=h,c=u}else I+=H.kernedWidth;D=v+l+E,"rtl"===this.direction&&(D=this.width-D-I),e.fillStyle=K,j&&K&&e.fillRect(D,T+et*o+c,I-Q,this.fontSize/15),w+=i}else w+=i;this._removeShadow(e)}},_getFontDeclaration:function(e,r){var i=e||this,o=this.fontFamily,h=t.Text.genericFonts.indexOf(o.toLowerCase())>-1,l=void 0===o||o.indexOf("'")>-1||o.indexOf(",")>-1||o.indexOf('"')>-1||h?i.fontFamily:'"'+i.fontFamily+'"';return[t.isLikelyNode?i.fontWeight:i.fontStyle,t.isLikelyNode?i.fontStyle:i.fontWeight,r?this.CACHE_FONT_SIZE+"px":i.fontSize+"px",l].join(" ")},render:function(e){!this.visible||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",e))},_splitTextIntoLines:function(e){for(var r=e.split(this._reNewline),i=new Array(r.length),o=["\n"],h=[],l=0;l<r.length;l++)i[l]=t.util.string.graphemeSplit(r[l]),h=h.concat(i[l],o);return h.pop(),{_unwrappedLines:i,lines:r,graphemeText:h,graphemeLines:i}},toObject:function(e){var r=a.concat(e),i=this.callSuper("toObject",r);return i.styles=s(this.styles,!0),i.path&&(i.path=this.path.toObject()),i},set:function(e,r){this.callSuper("set",e,r);var i=!1,o=!1;if("object"==typeof e)for(var h in e)"path"===h&&this.setPathInfo(),i=i||-1!==this._dimensionAffectingProps.indexOf(h),o=o||"path"===h;else i=-1!==this._dimensionAffectingProps.indexOf(e),o="path"===e;return o&&this.setPathInfo(),i&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),t.Text.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),t.Text.DEFAULT_SVG_FONT_SIZE=16,t.Text.fromElement=function(e,r,i){if(!e)return r(null);var o=t.parseAttributes(e,t.Text.ATTRIBUTE_NAMES),h=o.textAnchor||"left";if((i=t.util.object.extend(i?s(i):{},o)).top=i.top||0,i.left=i.left||0,o.textDecoration){var l=o.textDecoration;-1!==l.indexOf("underline")&&(i.underline=!0),-1!==l.indexOf("overline")&&(i.overline=!0),-1!==l.indexOf("line-through")&&(i.linethrough=!0),delete i.textDecoration}"dx"in o&&(i.left+=o.dx),"dy"in o&&(i.top+=o.dy),"fontSize"in i||(i.fontSize=t.Text.DEFAULT_SVG_FONT_SIZE);var c="";"textContent"in e?c=e.textContent:"firstChild"in e&&null!==e.firstChild&&"data"in e.firstChild&&null!==e.firstChild.data&&(c=e.firstChild.data),c=c.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var u=i.strokeWidth;i.strokeWidth=0;var d=new t.Text(c,i),g=d.getScaledHeight()/d.height,w=((d.height+d.strokeWidth)*d.lineHeight-d.height)*g,T=d.getScaledHeight()+w,E=0;"center"===h&&(E=d.getScaledWidth()/2),"right"===h&&(E=d.getScaledWidth()),d.set({left:d.left-E,top:d.top-(T-d.fontSize*(.07+d._fontSizeFraction))/d.lineHeight,strokeWidth:void 0!==u?u:1}),r(d)},t.Text.fromObject=function(e,r){var i=s(e),o=e.path;return delete i.path,t.Object._fromObject("Text",i,function(h){o?t.Object._fromObject("Path",o,function(l){h.set("path",l),r(h)},"path"):r(h)},"text")},t.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],t.util.createAccessors&&t.util.createAccessors(t.Text)}}("undefined"!=typeof exports?exports:this),fabric.util.object.extend(fabric.Text.prototype,{isEmptyStyles:function(n){if(!this.styles||void 0!==n&&!this.styles[n])return!0;var t=void 0===n?this.styles:{line:this.styles[n]};for(var s in t)for(var a in t[s])for(var e in t[s][a])return!1;return!0},styleHas:function(n,t){if(!this.styles||!n||""===n||void 0!==t&&!this.styles[t])return!1;var s=void 0===t?this.styles:{0:this.styles[t]};for(var a in s)for(var e in s[a])if(void 0!==s[a][e][n])return!0;return!1},cleanStyle:function(n){if(!this.styles||!n||""===n)return!1;var a,e,t=this.styles,s=0,r=!0,i=0;for(var h in t){for(var l in a=0,t[h]){var o;s++,(o=t[h][l]).hasOwnProperty(n)?(e?o[n]!==e&&(r=!1):e=o[n],o[n]===this[n]&&delete o[n]):r=!1,0!==Object.keys(o).length?a++:delete t[h][l]}0===a&&delete t[h]}for(var u=0;u<this._textLines.length;u++)i+=this._textLines[u].length;r&&s===i&&(this[n]=e,this.removeStyle(n))},removeStyle:function(n){if(this.styles&&n&&""!==n){var s,a,e,t=this.styles;for(a in t){for(e in s=t[a])delete s[e][n],0===Object.keys(s[e]).length&&delete s[e];0===Object.keys(s).length&&delete t[a]}}},_extendStyles:function(n,t){var s=this.get2DCursorLocation(n);this._getLineStyle(s.lineIndex)||this._setLineStyle(s.lineIndex),this._getStyleDeclaration(s.lineIndex,s.charIndex)||this._setStyleDeclaration(s.lineIndex,s.charIndex,{}),fabric.util.object.extend(this._getStyleDeclaration(s.lineIndex,s.charIndex),t)},get2DCursorLocation:function(n,t){void 0===n&&(n=this.selectionStart);for(var s=t?this._unwrappedTextLines:this._textLines,a=s.length,e=0;e<a;e++){if(n<=s[e].length)return{lineIndex:e,charIndex:n};n-=s[e].length+this.missingNewlineOffset(e)}return{lineIndex:e-1,charIndex:s[e-1].length<n?s[e-1].length:n}},getSelectionStyles:function(n,t,s){void 0===n&&(n=this.selectionStart||0),void 0===t&&(t=this.selectionEnd||n);for(var a=[],e=n;e<t;e++)a.push(this.getStyleAtPosition(e,s));return a},getStyleAtPosition:function(n,t){var s=this.get2DCursorLocation(n);return(t?this.getCompleteStyleDeclaration(s.lineIndex,s.charIndex):this._getStyleDeclaration(s.lineIndex,s.charIndex))||{}},setSelectionStyles:function(n,t,s){void 0===t&&(t=this.selectionStart||0),void 0===s&&(s=this.selectionEnd||t);for(var a=t;a<s;a++)this._extendStyles(a,n);return this._forceClearCache=!0,this},_getStyleDeclaration:function(n,t){var s=this.styles&&this.styles[n];return s?s[t]:null},getCompleteStyleDeclaration:function(n,t){for(var e,s=this._getStyleDeclaration(n,t)||{},a={},r=0;r<this._styleProperties.length;r++)a[e=this._styleProperties[r]]=void 0===s[e]?this[e]:s[e];return a},_setStyleDeclaration:function(n,t,s){this.styles[n][t]=s},_deleteStyleDeclaration:function(n,t){delete this.styles[n][t]},_getLineStyle:function(n){return!!this.styles[n]},_setLineStyle:function(n){this.styles[n]={}},_deleteLineStyle:function(n){delete this.styles[n]}}),function(){function n(t){t.textDecoration&&(t.textDecoration.indexOf("underline")>-1&&(t.underline=!0),t.textDecoration.indexOf("line-through")>-1&&(t.linethrough=!0),t.textDecoration.indexOf("overline")>-1&&(t.overline=!0),delete t.textDecoration)}fabric.IText=fabric.util.createClass(fabric.Text,fabric.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(t,s){this.callSuper("initialize",t,s),this.initBehavior()},setSelectionStart:function(t){t=Math.max(t,0),this._updateAndFire("selectionStart",t)},setSelectionEnd:function(t){t=Math.min(t,this.text.length),this._updateAndFire("selectionEnd",t)},_updateAndFire:function(t,s){this[t]!==s&&(this._fireSelectionChanged(),this[t]=s),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(t){this.clearContextTop(),this.callSuper("render",t),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(t){this.callSuper("_render",t)},clearContextTop:function(t){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var s=this.canvas.contextTop,a=this.canvas.viewportTransform;s.save(),s.transform(a[0],a[1],a[2],a[3],a[4],a[5]),this.transform(s),this._clearTextArea(s),t||s.restore()}},renderCursorOrSelection:function(){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var t=this._getCursorBoundaries(),s=this.canvas.contextTop;this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(t,s):this.renderSelection(t,s),s.restore()}},_clearTextArea:function(t){var s=this.width+4,a=this.height+4;t.clearRect(-s/2,-a/2,s,a)},_getCursorBoundaries:function(t){void 0===t&&(t=this.selectionStart);var s=this._getLeftOffset(),a=this._getTopOffset(),e=this._getCursorBoundariesOffsets(t);return{left:s,top:a,leftOffset:e.left,topOffset:e.top}},_getCursorBoundariesOffsets:function(t){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var s,a,e,o,r=0,i=0,h=this.get2DCursorLocation(t);e=h.charIndex,a=h.lineIndex;for(var l=0;l<a;l++)r+=this.getHeightOfLine(l);s=this._getLineLeftOffset(a);var c=this.__charBounds[a][e];return c&&(i=c.left),0!==this.charSpacing&&e===this._textLines[a].length&&(i-=this._getWidthOfCharSpacing()),o={top:r,left:s+(i>0?i:0)},"rtl"===this.direction&&(o.left*=-1),this.cursorOffsetCache=o,this.cursorOffsetCache},renderCursor:function(t,s){var a=this.get2DCursorLocation(),e=a.lineIndex,r=a.charIndex>0?a.charIndex-1:0,i=this.getValueOfPropertyAt(e,r,"fontSize"),o=this.scaleX*this.canvas.getZoom(),h=this.cursorWidth/o,l=t.topOffset,c=this.getValueOfPropertyAt(e,r,"deltaY");l+=(1-this._fontSizeFraction)*this.getHeightOfLine(e)/this.lineHeight-i*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(t,s),s.fillStyle=this.cursorColor||this.getValueOfPropertyAt(e,r,"fill"),s.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,s.fillRect(t.left+t.leftOffset-h/2,l+t.top+c,h,i)},renderSelection:function(t,s){for(var a=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,e=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,r=-1!==this.textAlign.indexOf("justify"),i=this.get2DCursorLocation(a),o=this.get2DCursorLocation(e),h=i.lineIndex,l=o.lineIndex,c=i.charIndex<0?0:i.charIndex,u=o.charIndex<0?0:o.charIndex,d=h;d<=l;d++){var w,g=this._getLineLeftOffset(d)||0,v=this.getHeightOfLine(d),T=0,E=0;if(d===h&&(T=this.__charBounds[h][c].left),d>=h&&d<l)E=r&&!this.isEndOfWrapping(d)?this.width:this.getLineWidth(d)||5;else if(d===l)if(0===u)E=this.__charBounds[l][u].left;else{var I=this._getWidthOfCharSpacing();E=this.__charBounds[l][u-1].left+this.__charBounds[l][u-1].width-I}w=v,(this.lineHeight<1||d===l&&this.lineHeight>1)&&(v/=this.lineHeight);var H=t.left+g+T,j=E-T,V=v,K=0;this.inCompositionMode?(s.fillStyle=this.compositionColor||"black",V=1,K=v):s.fillStyle=this.selectionColor,"rtl"===this.direction&&(H=this.width-H-j),s.fillRect(H,t.top+t.topOffset+K,j,V),t.topOffset+=w}},getCurrentCharFontSize:function(){var t=this._getCurrentCharIndex();return this.getValueOfPropertyAt(t.l,t.c,"fontSize")},getCurrentCharColor:function(){var t=this._getCurrentCharIndex();return this.getValueOfPropertyAt(t.l,t.c,"fill")},_getCurrentCharIndex:function(){var t=this.get2DCursorLocation(this.selectionStart,!0);return{l:t.lineIndex,c:t.charIndex>0?t.charIndex-1:0}}}),fabric.IText.fromObject=function(t,s){if(n(t),t.styles)for(var a in t.styles)for(var e in t.styles[a])n(t.styles[a][e]);fabric.Object._fromObject("IText",t,s,"text")}}(),function(){var n=fabric.util.object.clone;fabric.util.object.extend(fabric.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var t=this;this.on("added",function(){var s=t.canvas;s&&(s._hasITextHandlers||(s._hasITextHandlers=!0,t._initCanvasHandlers(s)),s._iTextInstances=s._iTextInstances||[],s._iTextInstances.push(t))})},initRemovedHandler:function(){var t=this;this.on("removed",function(){var s=t.canvas;s&&(s._iTextInstances=s._iTextInstances||[],fabric.util.removeFromArray(s._iTextInstances,t),0===s._iTextInstances.length&&(s._hasITextHandlers=!1,t._removeCanvasHandlers(s)))})},_initCanvasHandlers:function(t){t._mouseUpITextHandler=function(){t._iTextInstances&&t._iTextInstances.forEach(function(s){s.__isMousedown=!1})},t.on("mouse:up",t._mouseUpITextHandler)},_removeCanvasHandlers:function(t){t.off("mouse:up",t._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(t,s,a,e){var r;return r={isAborted:!1,abort:function(){this.isAborted=!0}},t.animate("_currentCursorOpacity",s,{duration:a,onComplete:function(){r.isAborted||t[e]()},onChange:function(){t.canvas&&t.selectionStart===t.selectionEnd&&t.renderCursorOrSelection()},abort:function(){return r.isAborted}}),r},_onTickComplete:function(){var t=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){t._currentTickCompleteState=t._animateCursor(t,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(t){var s=this,a=t?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){s._tick()},a)},abortCursorAnimation:function(){var t=this._currentTickState||this._currentTickCompleteState,s=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,t&&s&&s.clearContext(s.contextTop||s.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(t){var s=0,a=t-1;if(this._reSpace.test(this._text[a]))for(;this._reSpace.test(this._text[a]);)s++,a--;for(;/\S/.test(this._text[a])&&a>-1;)s++,a--;return t-s},findWordBoundaryRight:function(t){var s=0,a=t;if(this._reSpace.test(this._text[a]))for(;this._reSpace.test(this._text[a]);)s++,a++;for(;/\S/.test(this._text[a])&&a<this._text.length;)s++,a++;return t+s},findLineBoundaryLeft:function(t){for(var s=0,a=t-1;!/\n/.test(this._text[a])&&a>-1;)s++,a--;return t-s},findLineBoundaryRight:function(t){for(var s=0,a=t;!/\n/.test(this._text[a])&&a<this._text.length;)s++,a++;return t+s},searchWordBoundary:function(t,s){for(var a=this._text,e=this._reSpace.test(a[t])?t-1:t,r=a[e],i=fabric.reNonWord;!i.test(r)&&e>0&&e<a.length;)r=a[e+=s];return i.test(r)&&(e+=1===s?0:1),e},selectWord:function(t){var s=this.searchWordBoundary(t=t||this.selectionStart,-1),a=this.searchWordBoundary(t,1);this.selectionStart=s,this.selectionEnd=a,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(t){var s=this.findLineBoundaryLeft(t=t||this.selectionStart),a=this.findLineBoundaryRight(t);return this.selectionStart=s,this.selectionEnd=a,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(t){if(!this.isEditing&&this.editable)return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(t),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this},exitEditingOnOthers:function(t){t._iTextInstances&&t._iTextInstances.forEach(function(s){s.selected=!1,s.isEditing&&s.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(t){if(this.__isMousedown&&this.isEditing){var s=this.getSelectionStartFromPointer(t.e),a=this.selectionStart,e=this.selectionEnd;(s!==this.__selectionStartOnMouseDown||a===e)&&(a===s||e===s)||(s>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=s):(this.selectionStart=s,this.selectionEnd=this.__selectionStartOnMouseDown),(this.selectionStart!==a||this.selectionEnd!==e)&&(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(t,s,a){var e=a.slice(0,t),r=fabric.util.string.graphemeSplit(e).length;if(t===s)return{selectionStart:r,selectionEnd:r};var i=a.slice(t,s);return{selectionStart:r,selectionEnd:r+fabric.util.string.graphemeSplit(i).length}},fromGraphemeToStringSelection:function(t,s,a){var r=a.slice(0,t).join("").length;return t===s?{selectionStart:r,selectionEnd:r}:{selectionStart:r,selectionEnd:r+a.slice(t,s).join("").length}},_updateTextarea:function(){if(this.cursorOffsetCache={},this.hiddenTextarea){if(!this.inCompositionMode){var t=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=t.selectionStart,this.hiddenTextarea.selectionEnd=t.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var t=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=t.selectionEnd,this.inCompositionMode||(this.selectionStart=t.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var t=this._calcTextareaPosition();this.hiddenTextarea.style.left=t.left,this.hiddenTextarea.style.top=t.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var t=this.inCompositionMode?this.compositionStart:this.selectionStart,s=this._getCursorBoundaries(t),a=this.get2DCursorLocation(t),i=this.getValueOfPropertyAt(a.lineIndex,a.charIndex,"fontSize")*this.lineHeight,o=s.leftOffset,h=this.calcTransformMatrix(),l={x:s.left+o,y:s.top+s.topOffset+i},c=this.canvas.getRetinaScaling(),u=this.canvas.upperCanvasEl,d=u.width/c,g=u.height/c,v=d-i,w=g-i,T=u.clientWidth/d,E=u.clientHeight/g;return l=fabric.util.transformPoint(l,h),(l=fabric.util.transformPoint(l,this.canvas.viewportTransform)).x*=T,l.y*=E,l.x<0&&(l.x=0),l.x>v&&(l.x=v),l.y<0&&(l.y=0),l.y>w&&(l.y=w),l.x+=this.canvas._offset.left,l.y+=this.canvas._offset.top,{left:l.x+"px",top:l.y+"px",fontSize:i+"px",charHeight:i}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){!this._savedProps||(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var t=this._textBeforeEdit!==this.text,s=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,s&&(s.blur&&s.blur(),s.parentNode&&s.parentNode.removeChild(s)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),t&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),t&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var t in this.styles)this._textLines[t]||delete this.styles[t]},removeStyleFromTo:function(t,s){var l,c,a=this.get2DCursorLocation(t,!0),e=this.get2DCursorLocation(s,!0),r=a.lineIndex,i=a.charIndex,o=e.lineIndex,h=e.charIndex;if(r!==o){if(this.styles[r])for(l=i;l<this._unwrappedTextLines[r].length;l++)delete this.styles[r][l];if(this.styles[o])for(l=h;l<this._unwrappedTextLines[o].length;l++)(c=this.styles[o][l])&&(this.styles[r]||(this.styles[r]={}),this.styles[r][i+l-h]=c);for(l=r+1;l<=o;l++)delete this.styles[l];this.shiftLineStyles(o,r-o)}else if(this.styles[r]){c=this.styles[r];var d,g,u=h-i;for(l=i;l<h;l++)delete c[l];for(g in this.styles[r])(d=parseInt(g,10))>=h&&(c[d-u]=c[g],delete c[g])}},shiftLineStyles:function(t,s){var a=n(this.styles);for(var e in this.styles){var r=parseInt(e,10);r>t&&(this.styles[r+s]=a[r],a[r-s]||delete this.styles[r])}},restartCursorIfNeeded:function(){(!this._currentTickState||this._currentTickState.isAborted||!this._currentTickCompleteState||this._currentTickCompleteState.isAborted)&&this.initDelayedCursor()},insertNewlineStyleObject:function(t,s,a,e){var r,i={},o=!1,h=this._unwrappedTextLines[t].length===s;for(var l in a||(a=1),this.shiftLineStyles(t,a),this.styles[t]&&(r=this.styles[t][0===s?s:s-1]),this.styles[t]){var c=parseInt(l,10);c>=s&&(o=!0,i[c-s]=this.styles[t][l],h&&0===s||delete this.styles[t][l])}var u=!1;for(o&&!h&&(this.styles[t+a]=i,u=!0),u&&a--;a>0;)e&&e[a-1]?this.styles[t+a]={0:n(e[a-1])}:r?this.styles[t+a]={0:n(r)}:delete this.styles[t+a],a--;this._forceClearCache=!0},insertCharStyleObject:function(t,s,a,e){this.styles||(this.styles={});var r=this.styles[t],i=r?n(r):{};for(var o in a||(a=1),i){var h=parseInt(o,10);h>=s&&(r[h+a]=i[h],i[h-a]||delete r[h])}if(this._forceClearCache=!0,e)for(;a--;)!Object.keys(e[a]).length||(this.styles[t]||(this.styles[t]={}),this.styles[t][s+a]=n(e[a]));else if(r)for(var l=r[s?s-1:1];l&&a--;)this.styles[t][s+a]=n(l)},insertNewStyleBlock:function(t,s,a){for(var e=this.get2DCursorLocation(s,!0),r=[0],i=0,o=0;o<t.length;o++)"\n"===t[o]?r[++i]=0:r[i]++;for(r[0]>0&&(this.insertCharStyleObject(e.lineIndex,e.charIndex,r[0],a),a=a&&a.slice(r[0]+1)),i&&this.insertNewlineStyleObject(e.lineIndex,e.charIndex+r[0],i),o=1;o<i;o++)r[o]>0?this.insertCharStyleObject(e.lineIndex+o,0,r[o],a):a&&this.styles[e.lineIndex+o]&&a[0]&&(this.styles[e.lineIndex+o][0]=a[0]),a=a&&a.slice(r[o]+1);r[o]>0&&this.insertCharStyleObject(e.lineIndex+o,0,r[o],a)},setSelectionStartEndWithShift:function(t,s,a){a<=t?(s===t?this._selectionDirection="left":"right"===this._selectionDirection&&(this._selectionDirection="left",this.selectionEnd=t),this.selectionStart=a):a>t&&a<s?"right"===this._selectionDirection?this.selectionEnd=a:this.selectionStart=a:(s===t?this._selectionDirection="right":"left"===this._selectionDirection&&(this._selectionDirection="right",this.selectionStart=s),this.selectionEnd=a)},setSelectionInBoundaries:function(){var t=this.text.length;this.selectionStart>t?this.selectionStart=t:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>t?this.selectionEnd=t:this.selectionEnd<0&&(this.selectionEnd=0)}})}(),fabric.util.object.extend(fabric.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(n){if(this.canvas){this.__newClickTime=+new Date;var t=n.pointer;this.isTripleClick(t)&&(this.fire("tripleclick",n),this._stopEvent(n.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=t,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(n){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===n.x&&this.__lastPointer.y===n.y},_stopEvent:function(n){n.preventDefault&&n.preventDefault(),n.stopPropagation&&n.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(n){!this.isEditing||this.selectWord(this.getSelectionStartFromPointer(n.e))},tripleClickHandler:function(n){!this.isEditing||this.selectLine(this.getSelectionStartFromPointer(n.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(n){!this.canvas||!this.editable||n.e.button&&1!==n.e.button||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(n.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(n){!this.canvas||!this.editable||n.e.button&&1!==n.e.button||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(n){if(this.__isMousedown=!1,!(!this.editable||this.group||n.transform&&n.transform.actionPerformed||n.e.button&&1!==n.e.button)){if(this.canvas){var t=this.canvas._activeObject;if(t&&t!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(n.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(n){var t=this.getSelectionStartFromPointer(n);n.shiftKey?this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,t):(this.selectionStart=t,this.selectionEnd=t),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(n){for(var h,t=this.getLocalPointer(n),s=0,a=0,e=0,r=0,i=0,l=0,c=this._textLines.length;l<c&&e<=t.y;l++)e+=this.getHeightOfLine(l)*this.scaleY,i=l,l>0&&(r+=this._textLines[l-1].length+this.missingNewlineOffset(l-1));a=this._getLineLeftOffset(i)*this.scaleX,h=this._textLines[i],"rtl"===this.direction&&(t.x=this.width*this.scaleX-t.x+a);for(var u=0,d=h.length;u<d&&(s=a,(a+=this.__charBounds[i][u].kernedWidth*this.scaleX)<=t.x);u++)r++;return this._getNewSelectionStartFromOffset(t,s,a,r,d)},_getNewSelectionStartFromOffset:function(n,t,s,a,e){var i=s-n.x,h=a+(i>n.x-t||i<0?0:1);return this.flipX&&(h=e-h),h>this._text.length&&(h=this._text.length),h}}),fabric.util.object.extend(fabric.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=fabric.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var n=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+n.top+"; left: "+n.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding\uff70top: "+n.fontSize+";",this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):fabric.document.body.appendChild(this.hiddenTextarea),fabric.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),fabric.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),fabric.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),fabric.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),fabric.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),fabric.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),fabric.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),fabric.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),fabric.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(fabric.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(n){if(this.isEditing){var t="rtl"===this.direction?this.keysMapRtl:this.keysMap;if(n.keyCode in t)this[t[n.keyCode]](n);else{if(!(n.keyCode in this.ctrlKeysMapDown)||!n.ctrlKey&&!n.metaKey)return;this[this.ctrlKeysMapDown[n.keyCode]](n)}n.stopImmediatePropagation(),n.preventDefault(),n.keyCode>=33&&n.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(n){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:n.keyCode in this.ctrlKeysMapUp&&(n.ctrlKey||n.metaKey)&&(this[this.ctrlKeysMapUp[n.keyCode]](n),n.stopImmediatePropagation(),n.preventDefault(),this.canvas&&this.canvas.requestRenderAll())},onInput:function(n){var t=this.fromPaste;if(this.fromPaste=!1,n&&n.stopPropagation(),this.isEditing){var r,i,u,d,g,s=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,a=this._text.length,e=s.length,o=e-a,h=this.selectionStart,l=this.selectionEnd,c=h!==l;if(""===this.hiddenTextarea.value)return this.styles={},this.updateFromTextArea(),this.fire("changed"),void(this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll()));var v=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),w=h>v.selectionStart;c?(r=this._text.slice(h,l),o+=l-h):e<a&&(r=w?this._text.slice(l+o,l):this._text.slice(h,h-o)),i=s.slice(v.selectionEnd-o,v.selectionEnd),r&&r.length&&(i.length&&(u=this.getSelectionStyles(h,h+1,!1),u=i.map(function(){return u[0]})),c?(d=h,g=l):w?(d=l-r.length,g=l):(d=l,g=l+r.length),this.removeStyleFromTo(d,g)),i.length&&(t&&i.join("")===fabric.copiedText&&!fabric.disableStyleCopyPaste&&(u=fabric.copiedTextStyle),this.insertNewStyleBlock(i,h,u)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(n){this.compositionStart=n.target.selectionStart,this.compositionEnd=n.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(fabric.copiedText=this.getSelectedText(),fabric.copiedTextStyle=fabric.disableStyleCopyPaste?null:this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(n){return n&&n.clipboardData||fabric.window.clipboardData},_getWidthBeforeCursor:function(n,t){var a,s=this._getLineLeftOffset(n);return t>0&&(s+=(a=this.__charBounds[n][t-1]).left+a.width),s},getDownCursorOffset:function(n,t){var s=this._getSelectionForOffset(n,t),a=this.get2DCursorLocation(s),e=a.lineIndex;if(e===this._textLines.length-1||n.metaKey||34===n.keyCode)return this._text.length-s;var r=a.charIndex,i=this._getWidthBeforeCursor(e,r),o=this._getIndexOnLine(e+1,i);return this._textLines[e].slice(r).length+o+1+this.missingNewlineOffset(e)},_getSelectionForOffset:function(n,t){return n.shiftKey&&this.selectionStart!==this.selectionEnd&&t?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(n,t){var s=this._getSelectionForOffset(n,t),a=this.get2DCursorLocation(s),e=a.lineIndex;if(0===e||n.metaKey||33===n.keyCode)return-s;var r=a.charIndex,i=this._getWidthBeforeCursor(e,r),o=this._getIndexOnLine(e-1,i),h=this._textLines[e].slice(0,r),l=this.missingNewlineOffset(e-1);return-this._textLines[e-1].length+o-h.length+(1-l)},_getIndexOnLine:function(n,t){for(var i,o,s=this._textLines[n],e=this._getLineLeftOffset(n),r=0,h=0,l=s.length;h<l;h++)if((e+=i=this.__charBounds[n][h].width)>t){o=!0;var u=e,d=Math.abs(e-i-t);r=Math.abs(u-t)<d?h:h-1;break}return o||(r=s.length-1),r},moveCursorDown:function(n){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",n)},moveCursorUp:function(n){0===this.selectionStart&&0===this.selectionEnd||this._moveCursorUpOrDown("Up",n)},_moveCursorUpOrDown:function(n,t){var a=this["get"+n+"CursorOffset"](t,"right"===this._selectionDirection);t.shiftKey?this.moveCursorWithShift(a):this.moveCursorWithoutShift(a),0!==a&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(n){return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,"left"===this._selectionDirection?this.selectionStart+n:this.selectionEnd+n),0!==n},moveCursorWithoutShift:function(n){return n<0?(this.selectionStart+=n,this.selectionEnd=this.selectionStart):(this.selectionEnd+=n,this.selectionStart=this.selectionEnd),0!==n},moveCursorLeft:function(n){0===this.selectionStart&&0===this.selectionEnd||this._moveCursorLeftOrRight("Left",n)},_move:function(n,t,s){var a;if(n.altKey)a=this["findWordBoundary"+s](this[t]);else{if(!n.metaKey&&35!==n.keyCode&&36!==n.keyCode)return this[t]+="Left"===s?-1:1,!0;a=this["findLineBoundary"+s](this[t])}if(void 0!==typeof a&&this[t]!==a)return this[t]=a,!0},_moveLeft:function(n,t){return this._move(n,t,"Left")},_moveRight:function(n,t){return this._move(n,t,"Right")},moveCursorLeftWithoutShift:function(n){var t=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&0!==this.selectionStart&&(t=this._moveLeft(n,"selectionStart")),this.selectionEnd=this.selectionStart,t},moveCursorLeftWithShift:function(n){return"right"===this._selectionDirection&&this.selectionStart!==this.selectionEnd?this._moveLeft(n,"selectionEnd"):0!==this.selectionStart?(this._selectionDirection="left",this._moveLeft(n,"selectionStart")):void 0},moveCursorRight:function(n){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",n)},_moveCursorLeftOrRight:function(n,t){var s="moveCursor"+n+"With";this._currentCursorOpacity=1,this[s+=t.shiftKey?"Shift":"outShift"](t)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(n){return"left"===this._selectionDirection&&this.selectionStart!==this.selectionEnd?this._moveRight(n,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection="right",this._moveRight(n,"selectionEnd")):void 0},moveCursorRightWithoutShift:function(n){var t=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(t=this._moveRight(n,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,t},removeChars:function(n,t){void 0===t&&(t=n+1),this.removeStyleFromTo(n,t),this._text.splice(n,t-n),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(n,t,s,a){void 0===a&&(a=s),a>s&&this.removeStyleFromTo(s,a);var e=fabric.util.string.graphemeSplit(n);this.insertNewStyleBlock(e,s,t),this._text=[].concat(this._text.slice(0,s),e,this._text.slice(a)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),function(){var n=fabric.util.toFixed,t=/  +/g;fabric.util.object.extend(fabric.Text.prototype,{_toSVG:function(){var s=this._getSVGLeftTopOffsets(),a=this._getSVGTextAndBg(s.textTop,s.textLeft);return this._wrapSVGTextAndBg(a)},toSVG:function(s){return this._createBaseSVGMarkup(this._toSVG(),{reviver:s,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(s){var e=this.getSvgTextDecoration(this);return[s.textBgRects.join(""),'\t\t<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",e?'text-decoration="'+e+'" ':"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",s.textSpans.join(""),"</text>\n"]},_getSVGTextAndBg:function(s,a){var o,e=[],r=[],i=s;this._setSVGBg(r);for(var h=0,l=this._textLines.length;h<l;h++)o=this._getLineLeftOffset(h),(this.textBackgroundColor||this.styleHas("textBackgroundColor",h))&&this._setSVGTextLineBg(r,h,a+o,i),this._setSVGTextLineText(e,h,a+o,i),i+=this.getHeightOfLine(h);return{textSpans:e,textBgRects:r}},_createTextCharSpan:function(s,a,e,r){var i=s!==s.trim()||s.match(t),o=this.getSvgSpanStyles(a,i),h=o?'style="'+o+'"':"",l=a.deltaY,c="",u=fabric.Object.NUM_FRACTION_DIGITS;return l&&(c=' dy="'+n(l,u)+'" '),['<tspan x="',n(e,u),'" y="',n(r,u),'" ',c,h,">",fabric.util.string.escapeXml(s),"</tspan>"].join("")},_setSVGTextLineText:function(s,a,e,r){var h,l,u,d,w,i=this.getHeightOfLine(a),o=-1!==this.textAlign.indexOf("justify"),c="",g=0,v=this._textLines[a];r+=i*(1-this._fontSizeFraction)/this.lineHeight;for(var T=0,E=v.length-1;T<=E;T++)w=T===E||this.charSpacing,c+=v[T],u=this.__charBounds[a][T],0===g?(e+=u.kernedWidth-u.width,g+=u.width):g+=u.kernedWidth,o&&!w&&this._reSpaceAndTab.test(v[T])&&(w=!0),w||(h=h||this.getCompleteStyleDeclaration(a,T),l=this.getCompleteStyleDeclaration(a,T+1),w=this._hasStyleChangedForSvg(h,l)),w&&(d=this._getStyleDeclaration(a,T)||{},s.push(this._createTextCharSpan(c,d,e,r)),c="",h=l,e+=g,g=0)},_pushTextBgRect:function(s,a,e,r,i,o){var h=fabric.Object.NUM_FRACTION_DIGITS;s.push("\t\t<rect ",this._getFillAttributes(a),' x="',n(e,h),'" y="',n(r,h),'" width="',n(i,h),'" height="',n(o,h),'"></rect>\n')},_setSVGTextLineBg:function(s,a,e,r){for(var c,u,i=this._textLines[a],o=this.getHeightOfLine(a)/this.lineHeight,h=0,l=0,d=this.getValueOfPropertyAt(a,0,"textBackgroundColor"),g=0,v=i.length;g<v;g++)c=this.__charBounds[a][g],(u=this.getValueOfPropertyAt(a,g,"textBackgroundColor"))!==d?(d&&this._pushTextBgRect(s,d,e+l,r,h,o),l=c.left,h=c.width,d=u):h+=c.kernedWidth;u&&this._pushTextBgRect(s,u,e+l,r,h,o)},_getFillAttributes:function(s){var a=s&&"string"==typeof s?new fabric.Color(s):"";return a&&a.getSource()&&1!==a.getAlpha()?'opacity="'+a.getAlpha()+'" fill="'+a.setAlpha(1).toRgb()+'"':'fill="'+s+'"'},_getSVGLineTopOffset:function(s){for(var e,a=0,r=0;r<s;r++)a+=this.getHeightOfLine(r);return e=this.getHeightOfLine(r),{lineTop:a,offset:(this._fontSizeMult-this._fontSizeFraction)*e/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(s){return fabric.Object.prototype.getSvgStyles.call(this,s)+" white-space: pre;"}})}(),function(n){"use strict";var t=n.fabric||(n.fabric={});t.Textbox=t.util.createClass(t.IText,t.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:t.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),-1!==this.textAlign.indexOf("justify")&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(s){for(var a=0,e=0,r=0,i={},o=0;o<s.graphemeLines.length;o++)"\n"===s.graphemeText[r]&&o>0?(e=0,r++,a++):!this.splitByGrapheme&&this._reSpaceAndTab.test(s.graphemeText[r])&&o>0&&(e++,r++),i[o]={line:a,offset:e},r+=s.graphemeLines[o].length,e+=s.graphemeLines[o].length;return i},styleHas:function(s,a){if(this._styleMap&&!this.isWrapping){var e=this._styleMap[a];e&&(a=e.line)}return t.Text.prototype.styleHas.call(this,s,a)},isEmptyStyles:function(s){if(!this.styles)return!0;var r,i,a=0,o=!1,h=this._styleMap[s],l=this._styleMap[s+1];for(var c in h&&(s=h.line,a=h.offset),l&&(o=l.line===s,r=l.offset),i=void 0===s?this.styles:{line:this.styles[s]})for(var u in i[c])if(u>=a&&(!o||u<r))for(var d in i[c][u])return!1;return!0},_getStyleDeclaration:function(s,a){if(this._styleMap&&!this.isWrapping){var e=this._styleMap[s];if(!e)return null;s=e.line,a=e.offset+a}return this.callSuper("_getStyleDeclaration",s,a)},_setStyleDeclaration:function(s,a,e){var r=this._styleMap[s];this.styles[s=r.line][a=r.offset+a]=e},_deleteStyleDeclaration:function(s,a){var e=this._styleMap[s];delete this.styles[s=e.line][a=e.offset+a]},_getLineStyle:function(s){return!!this.styles[this._styleMap[s].line]},_setLineStyle:function(s){this.styles[this._styleMap[s].line]={}},_wrapText:function(s,a){var r,e=[];for(this.isWrapping=!0,r=0;r<s.length;r++)e=e.concat(this._wrapLine(s[r],r,a));return this.isWrapping=!1,e},_measureWord:function(s,a,e){var i,r=0;e=e||0;for(var h=0,l=s.length;h<l;h++)r+=this._getGraphemeBox(s[h],a,h+e,i,!0).kernedWidth,i=s[h];return r},_wrapLine:function(s,a,e,H){var i=0,o=this.splitByGrapheme,h=[],l=[],c=o?t.util.string.graphemeSplit(s):s.split(this._wordJoiners),u="",d=0,g=o?"":" ",v=0,w=0,T=0,E=!0,I=this._getWidthOfCharSpacing();H=H||0,0===c.length&&c.push([]),e-=H;for(var j=0;j<c.length;j++)u=o?c[j]:t.util.string.graphemeSplit(c[j]),v=this._measureWord(u,a,d),d+=u.length,(i+=w+v-I)>e&&!E?(h.push(l),l=[],i=v,E=!0):i+=I,!E&&!o&&l.push(g),l=l.concat(u),w=o?0:this._measureWord([g],a,d),d++,E=!1,v>T&&(T=v);return j&&h.push(l),T+H>this.dynamicMinWidth&&(this.dynamicMinWidth=T-I+H),h},isEndOfWrapping:function(s){return!this._styleMap[s+1]||this._styleMap[s+1].line!==this._styleMap[s].line},missingNewlineOffset:function(s){return this.splitByGrapheme?this.isEndOfWrapping(s)?1:0:1},_splitTextIntoLines:function(s){for(var a=t.Text.prototype._splitTextIntoLines.call(this,s),e=this._wrapText(a.lines,this.width),r=new Array(e.length),i=0;i<e.length;i++)r[i]=e[i].join("");return a.lines=r,a.graphemeLines=e,a},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var s={};for(var a in this._styleMap)this._textLines[a]&&(s[this._styleMap[a].line]=1);for(var a in this.styles)s[a]||delete this.styles[a]},toObject:function(s){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(s))}}),t.Textbox.fromObject=function(s,a){return t.Object._fromObject("Textbox",s,a,"text")}}("undefined"!=typeof exports?exports:this),function(){var n=fabric.controlsUtils,t=n.scaleSkewCursorStyleHandler,s=n.scaleCursorStyleHandler,a=n.scalingEqually,e=n.scalingYOrSkewingX,r=n.scalingXOrSkewingY,i=n.scaleOrSkewActionName,o=fabric.Object.prototype.controls;if(o.ml=new fabric.Control({x:-.5,y:0,cursorStyleHandler:t,actionHandler:r,getActionName:i}),o.mr=new fabric.Control({x:.5,y:0,cursorStyleHandler:t,actionHandler:r,getActionName:i}),o.mb=new fabric.Control({x:0,y:.5,cursorStyleHandler:t,actionHandler:e,getActionName:i}),o.mt=new fabric.Control({x:0,y:-.5,cursorStyleHandler:t,actionHandler:e,getActionName:i}),o.tl=new fabric.Control({x:-.5,y:-.5,cursorStyleHandler:s,actionHandler:a}),o.tr=new fabric.Control({x:.5,y:-.5,cursorStyleHandler:s,actionHandler:a}),o.bl=new fabric.Control({x:-.5,y:.5,cursorStyleHandler:s,actionHandler:a}),o.br=new fabric.Control({x:.5,y:.5,cursorStyleHandler:s,actionHandler:a}),o.mtr=new fabric.Control({x:0,y:-.5,actionHandler:n.rotationWithSnapping,cursorStyleHandler:n.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),fabric.Textbox){var h=fabric.Textbox.prototype.controls={};h.mtr=o.mtr,h.tr=o.tr,h.br=o.br,h.tl=o.tl,h.bl=o.bl,h.mt=o.mt,h.mb=o.mb,h.mr=new fabric.Control({x:.5,y:0,actionHandler:n.changeWidth,cursorStyleHandler:t,actionName:"resizing"}),h.ml=new fabric.Control({x:-.5,y:0,actionHandler:n.changeWidth,cursorStyleHandler:t,actionName:"resizing"})}}(),function(){if(!window.OpenSeadragon)return void console.error("[openseadragon-canvas-overlay] requires OpenSeadragon");OpenSeadragon.Viewer.prototype.fabricjsOverlay=function(s){return this._fabricjsOverlayInfo=new t(this,s.static),this._fabricjsOverlayInfo._scale=s&&s.scale?s.scale:1,this._fabricjsOverlayInfo};let n=function(){let s=1;return function(){return s++}}(),t=function(s,a,e={}){e.enablePointerEvents=null!=window.PointerEvent;let r=this;this._viewer=s,this._containerWidth=0,this._containerHeight=0,this._canvasdiv=document.createElement("div"),this._canvasdiv.style.position="absolute",this._canvasdiv.style.left="0px",this._canvasdiv.style.top="0px",this._canvasdiv.style.width="100%",this._canvasdiv.style.height="100%",this._viewer.canvas.appendChild(this._canvasdiv),this._canvas=document.createElement("canvas"),this._id="osd-overlaycanvas-"+n(),this._canvas.setAttribute("id",this._id),this._canvasdiv.appendChild(this._canvas),this.resize(),this._fabricCanvas=a?new fabric.StaticCanvas(this._canvas,e):new fabric.Canvas(this._canvas,e),this._fabricCanvas.selection=!1,this._fabricCanvas.on("mouse:down",function(i){i.target&&(i.e.preventDefaultAction=!0,i.e.preventDefault(),i.e.stopPropagation())}),this._fabricCanvas.on("mouse:up",function(i){i.target&&(i.e.preventDefaultAction=!0,i.e.preventDefault(),i.e.stopPropagation())}),this._viewer.addHandler("update-viewport",function(){r.resize(),r.resizeCanvas(),r.render()}),this._viewer.addHandler("open",function(){r.resize(),r.resizeCanvas()}),window.addEventListener("resize",function(){r.resize(),r.resizeCanvas()})};t.prototype={canvas:function(){return this._canvas},fabricCanvas:function(){return this._fabricCanvas},clear:function(){this._fabricCanvas.clear()},render:function(){this._fabricCanvas.renderAll()},resize:function(){this._containerWidth!==this._viewer.container.clientWidth&&(this._containerWidth=this._viewer.container.clientWidth,this._canvasdiv.setAttribute("width",this._containerWidth),this._canvas.setAttribute("width",this._containerWidth)),this._containerHeight!==this._viewer.container.clientHeight&&(this._containerHeight=this._viewer.container.clientHeight,this._canvasdiv.setAttribute("height",this._containerHeight),this._canvas.setAttribute("height",this._containerHeight))},resizeCanvas:function(){let s=new OpenSeadragon.Point(0,0),a=this._viewer.viewport.getZoom(!0);this._fabricCanvas.setWidth(this._containerWidth),this._fabricCanvas.setHeight(this._containerHeight),this._fabricCanvas.setZoom(this._viewer.viewport._containerInnerSize.x*a/this._scale);let r=this._viewer.viewport.viewportToWindowCoordinates(s),i=r.x,o=r.y,h=this._canvasdiv.getBoundingClientRect(),l=OpenSeadragon.getPageScroll();this._fabricCanvas.absolutePan(new fabric.Point(h.left-i+l.x,h.top-o+l.y))}}}();