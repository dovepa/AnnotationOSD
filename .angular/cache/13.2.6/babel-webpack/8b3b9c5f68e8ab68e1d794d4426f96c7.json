{"ast":null,"code":"\"use strict\";\n\nconst idlUtils = require(\"../../living/generated/utils\");\nconst {\n  fireAnEvent\n} = require(\"../../living/helpers/events\");\nmodule.exports = class PerDocumentResourceLoader {\n  constructor(document) {\n    this._document = document;\n    this._defaultEncoding = document._encoding;\n    this._resourceLoader = document._defaultView ? document._defaultView._resourceLoader : null;\n    this._requestManager = document._requestManager;\n    this._queue = document._queue;\n    this._deferQueue = document._deferQueue;\n    this._asyncQueue = document._asyncQueue;\n  }\n  fetch(url, {\n    element,\n    onLoad,\n    onError\n  }) {\n    const request = this._resourceLoader.fetch(url, {\n      cookieJar: this._document._cookieJar,\n      element: idlUtils.wrapperForImpl(element),\n      referrer: this._document.URL\n    });\n    if (request === null) {\n      return null;\n    }\n    this._requestManager.add(request);\n    const onErrorWrapped = error => {\n      this._requestManager.remove(request);\n      if (onError) {\n        onError(error);\n      }\n      fireAnEvent(\"error\", element);\n      const err = new Error(`Could not load ${element.localName}: \"${url}\"`);\n      err.type = \"resource loading\";\n      err.detail = error;\n      this._document._defaultView._virtualConsole.emit(\"jsdomError\", err);\n      return Promise.resolve();\n    };\n    const onLoadWrapped = data => {\n      this._requestManager.remove(request);\n      this._addCookies(url, request.response ? request.response.headers : {});\n      try {\n        const result = onLoad ? onLoad(data) : undefined;\n        return Promise.resolve(result).then(() => {\n          fireAnEvent(\"load\", element);\n          return Promise.resolve();\n        }).catch(err => {\n          return onErrorWrapped(err);\n        });\n      } catch (err) {\n        return onErrorWrapped(err);\n      }\n    };\n    if (element.localName === \"script\" && element.hasAttributeNS(null, \"async\")) {\n      this._asyncQueue.push(request, onLoadWrapped, onErrorWrapped, this._queue.getLastScript());\n    } else if (element.localName === \"script\" && element.hasAttributeNS(null, \"defer\")) {\n      this._deferQueue.push(request, onLoadWrapped, onErrorWrapped, false, element);\n    } else {\n      this._queue.push(request, onLoadWrapped, onErrorWrapped, false, element);\n    }\n    return request;\n  }\n  _addCookies(url, headers) {\n    let cookies = headers[\"set-cookie\"];\n    if (!cookies) {\n      return;\n    }\n    if (!Array.isArray(cookies)) {\n      cookies = [cookies];\n    }\n    cookies.forEach(cookie => {\n      this._document._cookieJar.setCookieSync(cookie, url, {\n        http: true,\n        ignoreError: true\n      });\n    });\n  }\n};","map":{"version":3,"names":["idlUtils","require","fireAnEvent","module","exports","PerDocumentResourceLoader","constructor","document","_document","_defaultEncoding","_encoding","_resourceLoader","_defaultView","_requestManager","_queue","_deferQueue","_asyncQueue","fetch","url","element","onLoad","onError","request","cookieJar","_cookieJar","wrapperForImpl","referrer","URL","add","onErrorWrapped","error","remove","err","Error","localName","type","detail","_virtualConsole","emit","Promise","resolve","onLoadWrapped","data","_addCookies","response","headers","result","undefined","then","catch","hasAttributeNS","push","getLastScript","cookies","Array","isArray","forEach","cookie","setCookieSync","http","ignoreError"],"sources":["/home/dove/Documents/tchek/AnnotationOSD/projects/annotation-osd/node_modules/jsdom/lib/jsdom/browser/resources/per-document-resource-loader.js"],"sourcesContent":["\"use strict\";\nconst idlUtils = require(\"../../living/generated/utils\");\nconst { fireAnEvent } = require(\"../../living/helpers/events\");\n\nmodule.exports = class PerDocumentResourceLoader {\n  constructor(document) {\n    this._document = document;\n    this._defaultEncoding = document._encoding;\n    this._resourceLoader = document._defaultView ? document._defaultView._resourceLoader : null;\n    this._requestManager = document._requestManager;\n    this._queue = document._queue;\n    this._deferQueue = document._deferQueue;\n    this._asyncQueue = document._asyncQueue;\n  }\n\n  fetch(url, { element, onLoad, onError }) {\n    const request = this._resourceLoader.fetch(url, {\n      cookieJar: this._document._cookieJar,\n      element: idlUtils.wrapperForImpl(element),\n      referrer: this._document.URL\n    });\n\n    if (request === null) {\n      return null;\n    }\n\n    this._requestManager.add(request);\n\n    const onErrorWrapped = error => {\n      this._requestManager.remove(request);\n\n      if (onError) {\n        onError(error);\n      }\n\n      fireAnEvent(\"error\", element);\n\n      const err = new Error(`Could not load ${element.localName}: \"${url}\"`);\n      err.type = \"resource loading\";\n      err.detail = error;\n\n      this._document._defaultView._virtualConsole.emit(\"jsdomError\", err);\n\n      return Promise.resolve();\n    };\n\n    const onLoadWrapped = data => {\n      this._requestManager.remove(request);\n\n      this._addCookies(url, request.response ? request.response.headers : {});\n\n      try {\n        const result = onLoad ? onLoad(data) : undefined;\n\n        return Promise.resolve(result)\n          .then(() => {\n            fireAnEvent(\"load\", element);\n\n            return Promise.resolve();\n          })\n          .catch(err => {\n            return onErrorWrapped(err);\n          });\n      } catch (err) {\n        return onErrorWrapped(err);\n      }\n    };\n\n    if (element.localName === \"script\" && element.hasAttributeNS(null, \"async\")) {\n      this._asyncQueue.push(request, onLoadWrapped, onErrorWrapped, this._queue.getLastScript());\n    } else if (element.localName === \"script\" && element.hasAttributeNS(null, \"defer\")) {\n      this._deferQueue.push(request, onLoadWrapped, onErrorWrapped, false, element);\n    } else {\n      this._queue.push(request, onLoadWrapped, onErrorWrapped, false, element);\n    }\n\n    return request;\n  }\n\n  _addCookies(url, headers) {\n    let cookies = headers[\"set-cookie\"];\n\n    if (!cookies) {\n      return;\n    }\n\n    if (!Array.isArray(cookies)) {\n      cookies = [cookies];\n    }\n\n    cookies.forEach(cookie => {\n      this._document._cookieJar.setCookieSync(cookie, url, { http: true, ignoreError: true });\n    });\n  }\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}